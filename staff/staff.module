<?php
include(drupal_get_path('module', 'eduerp') . '/eduerp_global.inc');

function staff_menu() {
  $items['staff/semester'] = array(
    'title' => 'Semester Administration',
    'page callback' => 'semester_admin',
    'access arguments' => array('staff register course'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => -36,
  );

  $items['staff/list']=array(
    'title'=>'Staff List',
    'page callback' => 'search_staff_list',
    'access arguments' => array('staff list'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/department']=array(
    'title'=>'Staff List',
    'page callback' => 'staff_department_list',
    'access arguments' => array('staff department list'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/viewlecturer']=array(
    'title'=>'Staff List',
    'page callback' => 'staff_course_list',
    'access arguments' => array('staff view lecturer'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/view']=array(
    'title'=>'Staff Summary',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_view_form'),
    'access arguments' => array('staff list'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/assignrole'] = array(
    'title' => 'Staff Roles',
    'page callback' => 'staff_assign_role',
    'access arguments' => array('staff assign role'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/ajax']=array(
    'title' => 'AJAX Routines',
    'page callback' => '_staff_ajax',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/createeditfaculty'] = array(
    'title' => 'Create/Modify Faculty',
    'page callback' => 'staff_create_edit_faculty',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK
  );
  $items['staff/createeditdept'] = array(
    'title' => 'Create/Modify Department',
    'page callback' => 'staff_create_edit_dept',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK
  );
  $items['staff/createeditcourse']=array(
    'title'=>'Create/Modify a Course',
    'page callback' => 'staff_create_edit_course',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/createmodifyprog']=array(
    'title'=>'Create/Modify a Programme',
    'page callback' => 'staff_create_edit_programme',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/specifycourse']=array(
    'title'=>'Specify Courses for a Programme',
    'page callback' => 'staff_specify_course_for_programme',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/verifycourse']=array(
    'title'=>'Verify all Courses needed for a Programme are being run for a Semester',
    'page callback' => 'staff_verify_assigned_course',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/studentprogress']=array(
    'title'=>'Student Progress towards Graduation',
    'page callback' => 'staff_student_progress_qualification',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/unregstudents']=array(
    'title'=>'List of Students who have Not Registered for a Semester',
    'page callback' => 'staff_unregistered_students',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/dropcoursereg']=array(
    'title'=>'Mark a Course Registration as Dropped',
    'page callback' => 'staff_drop_registered_course',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/manualcoursereg']=array(
    'title'=>'Manually Register a Student in a Course',
    'page callback' => 'staff_manual_course_reg',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/changeprogmme']=array(
    'title'=>"Change a Student's Programme",
    'page callback' => 'staff_change_student_programme',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/checkverifyprogmme']=array(
    'title'=>"Check have all existing Courses required for all Programmes been Verified",
    'page callback' => 'staff_check_verify_programme_courses',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/missingcourses']=array(
    'title'=>'Check for Missing Courses for a Semester',
    'page callback' => 'staff_check_for_missing_courses',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  //fee menus starts here
  $items['staff/schoolfeesadmin'] = array(
    'title' => 'School Fees Administration',
    'page callback' => 'staff_school_fees_admin',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  $items['staff/createmodifyfeeitem'] = array(
    'title' => 'Create / Modify School Fee Item',
    'page callback' => 'staff_school_fees_create_modify_school_fee_item',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  $items['staff/createmodifyfeestup'] = array(
    'title' => 'Create / Modify School Fee Setup',
    'page callback' => 'staff_school_fees_create_modify_school_fee_setup',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  $items['staff/updatesettings'] = array(
    'title' => 'Update Fee Settings',
    'page callback' => 'staff_school_fees_update_settings',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  $items['staff/scholarshippayment'] = array(
    'title' => 'Authorise Scholarship',
    'page callback' => 'staff_school_fees_scholarship_payment',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  $items['staff/authoriseinstalment'] = array(
    'title' => 'Authorise Instalment Payment',
    'page callback' => 'staff_school_fees_authorise_instalment_payment',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );


   $items['staff/testattributes'] = array(
    'title' => 'Testing Attributes and Options',
    'page callback' => 'staff_school_fees_test_attr',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK
  );

  //fee menus ends here
  return $items;
}



function _staff_ajax() {
  global $user;
  $task = arg(2);

  switch ($task):
    case 'course':
      $courses[""] = "";

      $program = $_POST['programme_id'];
      $level = $_POST['level'];

      // Retrieve available courses that have not been assigned
      //we want to put the courses of the department for the level selected at the top and then others will follow
      //get the programme info
      $programInfo = db_fetch_object(get_programmes($program));
      //get the courses not assigned for the level for the department
      $sql = "SELECT DISTINCT (c.nid) AS course_id, c.field_code_value AS course_code FROM {content_type_course} c
          INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
          INNER JOIN {content_type_program} p ON p.field_department_id_nid=d.nid
        WHERE c.field_level_value = '". $level ."' AND d.nid = ". $programInfo->department_nid ."
        ORDER BY field_programme_name_value, c.field_level_value, c.field_semester_value, c.field_code_value ";
        /*
        c.nid NOT IN
        (SELECT pc.course_id FROM {program_course} pc WHERE pc.programme_id=". $program ." AND pc.level='". $level ."' AND pc.historical=0)
        AND
        */
      $rs = db_query($sql); $courses1 = array();
      if(db_affected_rows($rs) > 0) {
        while ($row = db_fetch_object($rs)) {
          $courses1[$row->course_id] = $row->course_code;
        }
      }
      //get the courses not assigned for other levels for the department
      $sql = "SELECT DISTINCT (c.nid) AS course_id, c.field_code_value AS course_code FROM {content_type_course} c
          INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
          INNER JOIN {content_type_program} p ON p.field_department_id_nid=d.nid
        WHERE c.field_level_value != '". $level ."' AND d.nid = ". $programInfo->department_nid ."
        ORDER BY field_programme_name_value, c.field_level_value, c.field_semester_value, c.field_code_value ";
        /*
        c.nid NOT IN
        (SELECT pc.course_id FROM {program_course} pc WHERE pc.programme_id=". $program ." AND pc.level='". $level ."' AND pc.historical=0)
        AND
        */
       $rs = db_query($sql); $courses2 = array();
      if(db_affected_rows($rs) > 0) {
        while ($row = db_fetch_object($rs)) {
          $courses2[$row->course_id] = $row->course_code;
        }
      }

        //get the courses not assigned for levels for other departments
      $sql = "SELECT DISTINCT (c.nid) AS course_id, c.field_code_value AS course_code FROM {content_type_course} c
          INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
          INNER JOIN {content_type_program} p ON p.field_department_id_nid=d.nid
        WHERE d.nid != ". $programInfo->department_nid ."
        ORDER BY d.field_department_name_value, field_programme_name_value, c.field_level_value, c.field_semester_value, c.field_code_value ";
        /*
         c.nid NOT IN
        (SELECT pc.course_id FROM {program_course} pc WHERE pc.programme_id=". $program ." AND pc.level='". $level ."' AND pc.historical=0)
        AND
        */
      $rs = db_query($sql); $courses3 = array();
      if(db_affected_rows($rs) > 0) {
        while ($row = db_fetch_object($rs)) {
          $courses3[$row->course_id] = $row->course_code;
        }
      }
       //order it as required
      $courses = $courses1 + $courses2 + $courses3;
        /*
      $sql = "SELECT c.nid AS course_id, c.field_code_value AS course_code FROM {content_type_course} c
        WHERE c.nid NOT IN (SELECT pc.course_id FROM {program_course} pc WHERE pc.programme_id=%d AND pc.level='%s' AND pc.historical=0)
        ORDER BY c.field_code_value ASC";
      $rs = db_query($sql, $program, $level);
      while ($row = db_fetch_object($rs)) {
        $courses[$row->course_id] = $row->course_code;
      }
      */
      $form['course_id'] = array(
        '#type' => 'select',
        '#title' => 'Course',
        '#options' => $courses,
        '#attributes' => array('style' => 'width:100px'),
        '#required' => TRUE);

      $output = _staff_ahah_render($form, 'course_id');
      print drupal_to_js(array('data' => $output, 'status' => true));
      break;
    case 'delete':
      $allocation_id = arg(3);

      // Delete this allocation
      $sql = "UPDATE {program_course} SET historical=1 WHERE program_course_id=%d";
      $rs = db_query($sql, $allocation_id);

      if (db_affected_rows() > 0) echo "OK";
      else echo "FAIL";
      break;
    case 'deleteassignprog':
      $allocation_id = arg(3);
      //$_SESSION['eduerp_showCourseAssignment'] = 1;
      // Delete this allocation
      $sql = "UPDATE {program_course} SET historical=1 WHERE program_course_id=%d";
      $rs = db_query($sql, $allocation_id);

      if (db_affected_rows() > 0) echo "OK";
      else echo "FAIL";
      break;
    case 'modifyassignprog':
      //$allocation_id = arg(3);
      $_SESSION['eduerp_showCourseAssignment'] = 1;

      break;
    case 'makeavailable':
      $allocation_id = arg(3);
      // Delete this allocation
      $sql = "UPDATE {program_course} SET historical=0 WHERE program_course_id=%d";
      $rs = db_query($sql, $allocation_id);

    break;
     case 'fix_course':
      $allocation_id = arg(4);
      // get the record to be used as defaults
      $sql = "SELECT course_id, programme_id, level, semester, course_type, lecturer_id FROM {program_course} WHERE program_course_id=%d";
      $rs = db_query($sql, $allocation_id);
      $row = db_fetch_object($rs);
      $_SESSION['eduerp_fix_course']->field_course_id_nid = $row->course_id;
      $_SESSION['eduerp_fix_course']->field_semester_name_value = $row->semester;
      $_SESSION['eduerp_fix_course']->field_lecturer_uid = $row->lecturer_id;
      $_SESSION['eduerp_fix_course']->session = $_SESSION['eduerp_verify']['session'];
      $_SESSION['eduerp_fix_course']->semester = $_SESSION['eduerp_verify']['semester'];
      $_SESSION['eduerp_return_url'] = "staff/verifycourse/" . arg(3);
    break;

    case 'programmelevel':
          $programme_nid = $_POST['programme_nid'];
          //get the levels for the programme
      $sql = "SELECT DISTINCT(level) level FROM {program_level_semester} WHERE programme_id = %d ORDER BY level ";
      $rs = db_query($sql, $programme_nid);
      while($row = db_fetch_object($rs))
        $levels[$row->level] = $row->level;

      $form['level_name'] = array(
        '#type' => 'select',
        '#options' => $levels,
        '#title' => 'New Start Level',
        '#attributes' => array(
      'style' => 'width:100px'),
        '#required' => TRUE
      );

      $output = _staff_ahah_render($form, 'level_name');
      print drupal_to_js(array('data' => $output, 'status' => true));
      break;
    case 'getdeflecturer':
    	 $course_nid = $_POST['course_nid']; $id = "";
    	 //get the default lecturer for the course
        $sql = "SELECT lecturer_id id FROM {program_course} WHERE course_id = %d LIMIT 1 ";
        $rs = db_query($sql, $course_nid);
        while($row = db_fetch_object($rs))
          $id = $row->id;

  	$form['chief_staff_nid'] = array(
      '#type' => 'select',
      '#options' => array(''=>'') + get_Staff_in_Department(),
      '#title' => 'Chief Lecturer',
      '#required'  => TRUE,
      '#default_value' => $id
        );
        $output = _staff_ahah_render($form, 'chief_staff_nid');
        print drupal_to_js(array('data' => $output, 'status' => true));
    	    break;
    case 'getblocks': //case 'getallocblocks':
    	 $hostel_nid = $_POST['hostel_nid']; $id = "";
    	 /*
    	if($task == 'getallocblocks'){
    	  $sql = "SELECT nid, field_block_name_value FROM {content_type_blocks} WHERE field_hostel_id_nid = %d ";

    	  switch($_SESSION['eduerp_reserve_room']['gender']):
		  case 'male':
		    $sql .= " AND (field_block_type_value = 1 OR field_block_type_value = 0) "; //get blocks that are male only or mixed
			break;
		  case 'female':
		    $sql .= " AND (field_block_type_value = 2 OR field_block_type_value = 0) "; //get blocks that are female only or mixed
		    break;
		  endswitch;


    	}else
    	*/
          $sql = "SELECT nid, field_block_name_value FROM {content_type_blocks} WHERE field_hostel_id_nid = %d ";

        $rs = db_query($sql, $hostel_nid);
        while($row = db_fetch_object($rs))
          $blocks[$row->nid] = $row->field_block_name_value;

  	$form['block_nid'] = array(
      '#type' => 'select',
      '#options' => $blocks,
      '#title' => 'Block Name',
      '#attributes' => array(
      'style' => 'width:100px'),
      '#prefix' => "<div id='shwblocks'>",
      '#suffix' => "</div>",
      '#required' => TRUE

        );
        $output = _staff_ahah_render($form, 'block_nid');
        print drupal_to_js(array('data' => $output, 'status' => true));
    	break;
    case 'getroomsinblock':
    	 $block_nid = $_POST['block_nid']; $id = "";

          $sql = "SELECT nid, field_room_name_value FROM {content_type_rooms} WHERE field_block_id_nid = %d ";

        $rs = db_query($sql, $block_nid);
        while($row = db_fetch_object($rs))
        $rooms[$row->nid] = $row->field_room_name_value;

  	$form['room_nid'] = array(
    '#title' => 'Room Name',
    '#type' => 'select',
    '#options' => $rooms,
    '#attributes' => array(
      'style' => 'width:100px'),
      '#prefix' => "<div id='shwrooms'>",
      '#suffix' => "</div>",
      //'#disabled' => TRUE,
    '#required' => TRUE
    );
        $output = _staff_ahah_render($form, 'room_nid');
         print drupal_to_js(array('data' => $output, 'status' => true));
    	break;
  endswitch;
  exit();
}


/*
  This function is largely based on the poll module, its been simplified for reuse.
  $fields is the specific form elements you want to attach via ahah,
  $name is the form fields array key... e.g. the name for $form['title'] is "title"
*/
function _staff_ahah_render($fields, $name) {

  drupal_alter('form', $fields, array(), 'staff_course_form');
  //$name = $fromHostel ? "block_nid" : "staff-course-assign-form1";
  $form_state = array('submitted' => FALSE,'#values'=>$_POST);
  $form_build_id = $_POST['form_build_id'];
  // Add the new element to the stored form. Without adding the element to the
  // form, Drupal is not aware of this new elements existence and will not
  // process it. We retreive the cached form, add the element, and resave.
  $form = form_get_cache($form_build_id, $form_state);
  if($form[$name]['#required'] == true){
    $fields['#required'] =  true;
  }
  $form[$name] = $fields;
  form_set_cache($form_build_id, $form, $form_state);
  $form += array(
    '#post' => $_POST,
    '#programmed' => FALSE,
  );
   $form_state = array('submitted' => FALSE);

  // Rebuild the form.
  $form = form_builder($_POST['form_id'], $form, $form_state);

  // Render the new output.
  $new_form = $form[$name];
  return drupal_render($new_form);
}


/*Function to get the staff permission.*/
function staff_perm() {
  return array('staff register','staff assign role','staff register course','staff view lecturer','staff department list','staff list', 'student data', 'staff data', 'student payments', 'student list students', 'view grading');
}


function staff_assign_role() {
  global $user;
  if (!staff_has_eduerp_role($user->uid, 0, 0, array('Role Assigner'))) {
      drupal_set_message('You are not authorized to access this page.');
      drupal_goto('user');
  }

  $_SESSION['eduerpassignrole']->uid = arg(2);

  $user_profile = new UserProfile($_SESSION['eduerpassignrole']->uid);
  $staffname = '';
  if (!empty($user_profile->profile_first_name) && !empty($user_profile->profile_last_name)) {
    $middle = '';
    if (!empty($user_profile->profile_middle_name)) $middle = ' ' . $user_profile->profile_middle_name;
    $staffname = "{$user_profile->profile_last_name}, {$user_profile->profile_first_name}{$middle}";
  }
  $_SESSION['eduerpassignrole']->name = $staffname;
  if (!empty($user_profile->profile_department_id)) {
    $_SESSION['eduerpassignrole']->department_id = $user_profile->profile_department_id;
    $result = db_query("SELECT field_college_id_nid FROM {content_type_department} WHERE nid=%d");
    $row = db_fetch_object($result, $user_profile->profile_department_id);
    $_SESSION['eduerpassignrole']->college_id = $row->field_college_id_nid;
  }
  else {
    $_SESSION['eduerpassignrole']->department_id = 0;
    $_SESSION['eduerpassignrole']->college_id = 0;
  }

  ob_start();

  echo "<b>Assign Roles or move Home Department for {$staffname}...</b><br />";

  echo '<br /><br /><hr /><br />';
  echo drupal_get_form('department_role_form');
  echo '<br /><br /><hr /><br />';
  echo drupal_get_form('faculty_role_form');
  echo '<br /><br /><hr /><br />';
  echo drupal_get_form('university_role_form');
  echo '<br /><br /><hr /><br />';
  echo drupal_get_form('current_roles_list_form');
  echo '<br /><br /><hr /><br />';
  echo drupal_get_form('move_department_form');
  echo '<br /><br /><hr />';

  describeroles();

  return ob_get_clean();
}


function department_role_form($form_state) {
  $form['top'] = array('#value' => "Give another Department role to {$_SESSION['eduerpassignrole']->name}:");

  $form['role'] = array(
    '#type' => 'select',
    '#options' => eduerp_department_roles(),
    '#title' => 'Role',
    '#default_value' => 'Department Examination Officer',
    '#required' => TRUE);

  $form['department'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department',
    '#default_value' => $_SESSION['eduerpassignrole']->department_id,
    '#required' => TRUE);
    if (empty($_SESSION['eduerpassignrole']->department_id)) unset($form['department']['#default_value']);

  $form['uid'] = array('#type' => 'value', '#value' => $_SESSION['eduerpassignrole']->uid);

  $form['submit'] = array('#type' => 'submit', '#value' => "Assign new role to {$_SESSION['eduerpassignrole']->name}");
  return $form;
}


function faculty_role_form($form_state) {
  $form['top'] = array('#value' => "Give another Faculty role to {$_SESSION['eduerpassignrole']->name}:");

  $form['role'] = array(
    '#type' => 'select',
    '#options' => eduerp_faculty_roles(),
    '#title' => 'Role',
    '#default_value' => 'Faculty Examination Officer',
    '#required' => TRUE);

  $form['faculty'] = array(
    '#type' => 'select',
    '#options' => faculty(),
    '#title' => 'Faculty',
    '#default_value' => $_SESSION['eduerpassignrole']->college_id,
    '#required' => TRUE);
    if (empty($_SESSION['eduerpassignrole']->college_id)) unset($form['faculty']['#default_value']);

  $form['uid'] = array('#type' => 'value', '#value' => $_SESSION['eduerpassignrole']->uid);

  $form['submit'] = array('#type' => 'submit', '#value' => "Assign new role to {$_SESSION['eduerpassignrole']->name}");
  return $form;
}


function university_role_form($form_state) {
  $form['top'] = array('#value' => "Give another University role to {$_SESSION['eduerpassignrole']->name}:");

  $form['role'] = array(
    '#type' => 'select',
    '#options' => eduerp_university_roles(),
    '#title' => 'Role',
    '#default_value' => 'University Examination Viewer',
    '#required' => TRUE);

  $form['uid'] = array('#type' => 'value', '#value' => $_SESSION['eduerpassignrole']->uid);

  $form['submit'] = array('#type' => 'submit', '#value' => "Assign new role to {$_SESSION['eduerpassignrole']->name}");
  return $form;
}


function eduerp_department_roles() {
  $options = array(
    'Department Examination Officer' => 'Department Examination Officer',
    'Department Grade Editor' => 'Department Grade Editor',
    'Head of Department' => 'Head of Department'
  );
  return $options;
}


function eduerp_faculty_roles() {
  $options = array(
    'Faculty Examination Officer' => 'Faculty Examination Officer',
    'Faculty Grade Editor' => 'Faculty Grade Editor',
    'Dean of Faculty' => 'Dean of Faculty'
  );
  return $options;
}


function eduerp_university_roles() {
  $options = array(
    'Non-Academic Staff' => 'Non-Academic Staff',
    'Academic Staff' => 'Academic Staff',
    'University Examination Viewer' => 'University Examination Viewer',
    'University Grade Editor' => 'University Grade Editor',
    'Bursar' => 'Bursar',
    'Bursary' => 'Bursary',
    'Registry' => 'Registry',
    'Registrar' => 'Registrar',
    'Vice-Chancellor' => 'Vice-Chancellor',
    'Student Affairs Officer' => 'Student Affairs Officer',
    'Role Assigner' => 'Role Assigner'
  );
  return $options;
}


function staff_has_eduerp_role($uid, $department_id, $faculty_id, $roles) {
  $result = db_query("SELECT er.role FROM {eduerp_roles} er WHERE er.uid=%d AND er.department_id=%d AND er.college_id=%d", $uid, $department_id, $faculty_id);

  while ($row = db_fetch_object($result)) {
    if (in_array($row->role, $roles)) return TRUE;
  }
  return FALSE;
}


function faculty($facultyNID=0) {
  static $options;
  if (!$options) {
    $options = array();
    if($facultyNID==0)
      $r = db_query("SELECT nid, field_college_name_value AS value FROM {content_type_college} ORDER BY field_college_name_value");
    else
      $r = db_query("SELECT nid, field_college_name_value AS value FROM {content_type_college} WHERE nid=%d ORDER BY field_college_name_value", $facultyNID);

    while ($f = db_fetch_object($r))
      $options[$f->nid] = $f->value;
  }
  return  $options;
}


function current_roles_list_form($form_state) {
  $form['top'] = array('#value' => "All current roles for {$_SESSION['eduerpassignrole']->name}:<br />");

  $result = db_query("SELECT er.eduerp_role_id,
      CONCAT(er.role, IFNULL(CONCAT(' (', d.field_department_name_value, ')'), IFNULL(CONCAT(' (', c.field_college_name_value, ')'), ''))) AS name
    FROM {eduerp_roles} er
    LEFT JOIN {content_type_department} d ON er.department_id=d.nid
    LEFT JOIN {content_type_college}    c ON er.college_id=c.nid
    WHERE er.uid=%d ORDER BY er.role", $_SESSION['eduerpassignrole']->uid);

  $form['roles'] = array('#tree' => TRUE);
  $found = FALSE;
  while ($row = db_fetch_object($result)) {
    $found = TRUE;
    $form['roles'][$row->eduerp_role_id] = array(
      '#type' => 'checkbox',
      '#title' => $row->name,
      '#default_value' => TRUE
    );
  }

  $form['uid'] = array('#type' => 'value', '#value' => $_SESSION['eduerpassignrole']->uid);

  if ($found) {
    $form['submit'] = array('#type' => 'submit', '#value' => "Remove any roles unchecked above from {$_SESSION['eduerpassignrole']->name}");
  }
  else {
    $form['noroles'] = array('#value' => '<br />No Roles Assigned<br />');
  }
  return $form;
}


function move_department_form($form_state) {
  $user_profile = new UserProfile($_SESSION['eduerpassignrole']->uid);
  if (empty($user_profile->profile_department_id)) {
    $dept_text = 'Does not currently have a department';
  }
  else {
    $department_array = department($user_profile->profile_department_id);
    $dept_text = "Department is currently: {$department_array[$user_profile->profile_department_id]}";
  }

  $form['top'] = array('#value' => "Move {$_SESSION['eduerpassignrole']->name} to a new department:<br />({$dept_text})");

  $form['department'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department',
    '#default_value' => $_SESSION['eduerpassignrole']->department_id,
    '#required' => TRUE);
    if (empty($_SESSION['eduerpassignrole']->department_id)) unset($form['department']['#default_value']);

  $form['uid'] = array('#type' => 'value', '#value' => $_SESSION['eduerpassignrole']->uid);

  $form['submit'] = array('#type' => 'submit', '#value' => "Move {$_SESSION['eduerpassignrole']->name} to the above department");
  return $form;
}


function department_role_form_submit($form, &$form_state) {
  addrole($form_state['values']['uid'], $form_state['values']['department'], 0, $form_state['values']['role']);
}


function faculty_role_form_submit($form, &$form_state) {
  addrole($form_state['values']['uid'], 0, $form_state['values']['faculty'], $form_state['values']['role']);
}


function university_role_form_submit($form, &$form_state) {
  addrole($form_state['values']['uid'], 0, 0, $form_state['values']['role']);
}


function addrole($uid, $department_id, $college_id, $role) {
  $result = db_query("SELECT 1 FROM {eduerp_roles} er WHERE er.uid=%d AND er.department_id=%d AND er.college_id=%d AND er.role='%s'",
    $uid, $department_id, $college_id, $role);
  if (!db_fetch_object($result)) {
    db_query("INSERT INTO {eduerp_roles} SET uid=%d, department_id=%d, college_id=%d, role='%s'",
      $uid, $department_id, $college_id, $role);
    drupal_set_message('Role Assigned');
  }

  if ($role === 'Registry' || $role === 'Registrar' || $role === 'Vice-Chancellor') {
    assign_drupal_role($uid, 'Registry');
  }
  if ($role === 'Bursary' || $role === 'Bursar' || $role === 'Vice-Chancellor') {
    assign_drupal_role($uid, 'Bursary');
  }
  if ($role === 'Student Affairs Officer') {
    assign_drupal_role($uid, 'SA');
  }
  if ($role === 'Academic Staff' || $role === 'Non-Academic Staff') {
    // 'Staff' role allocation is now a manual admin process
    // assign_drupal_role($uid, 'Staff');
  }
}


function assign_drupal_role($uid, $role) {
  $result = db_query("SELECT rid FROM {role} WHERE name='%s'", $role);
  $row = db_fetch_object($result);

  $staff_user = user_load($uid);
  $roles = $staff_user->roles;
  $roles[$row->rid] = $role; // If it is new, it will be added, ($role is not relevent, must be something)

  user_save($staff_user, array('roles' => $roles));
}


function current_roles_list_form_submit($form, &$form_state) {
  $i = 0;
  if (!empty($form_state['values']['roles'])) {
    foreach ($form_state['values']['roles'] as $eduerp_role_id => $checked) {
      if (!$checked) {
        droprole($form_state['values']['uid'], $eduerp_role_id);
        $i++;
      }
    }
  }

  if ($i == 1) drupal_set_message('Role Removed');
  else drupal_set_message("$i Roles Removed");
}


function droprole($uid, $eduerp_role_id) {
  $result = db_query("SELECT role FROM {eduerp_roles} WHERE eduerp_role_id=%d", $eduerp_role_id);
  if ($row = db_fetch_object($result)) {
    db_query("DELETE FROM {eduerp_roles} WHERE eduerp_role_id=%d", $eduerp_role_id);
  }

  if (!staff_has_eduerp_role($uid, 0, 0, array('Registry', 'Registrar', 'Vice-Chancellor'))) {
    drop_drupal_role($uid, 'Registry');
  }
  if (!staff_has_eduerp_role($uid, 0, 0, array('Bursary', 'Bursar', 'Vice-Chancellor'))) {
    drop_drupal_role($uid, 'Bursary');
  }
  if (!staff_has_eduerp_role($uid, 0, 0, array('Student Affairs Officer'))) {
    drop_drupal_role($uid, 'SA');
  }
  if (!staff_has_eduerp_role($uid, 0, 0, array('Academic Staff', 'Non-Academic Staff'))) {
    // 'Staff' role allocation is now a manual admin process
    // drop_drupal_role($uid, 'Staff');
  }
}


function drop_drupal_role($uid, $role) {
  $result = db_query("SELECT rid FROM {role} WHERE name='%s'", $role);
  $row = db_fetch_object($result);

  $staff_user = user_load($uid);
  $roles = $staff_user->roles;
  unset($roles[$row->rid]);

  user_save($staff_user, array('roles' => $roles));
}


function move_department_form_submit($form, &$form_state) {
  $user_profile = new UserProfile($form_state['values']['uid']);
  $user_profile->profile_department_id = $form_state['values']['department'];
  $user_profile->save();

  drupal_set_message("Department Moved");
}


function search_staff_list() {
  ob_start();

//  echo  drupal_get_form('staff_search_form');

  staff_search_list();

  return ob_get_clean();
}


function staff_course_list() {
  ob_start();
  for ($i = 1; $i <= 3; $i++) {
    $query = "SELECT courses.*, CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS staff_name
      FROM
        (SELECT
          c.field_code_value AS code,
          c.field_coursetitle_value AS course_title,
          ci.field_lecturer_uid AS uid
        FROM {content_type_course} c, {content_type_course_instance} ci
        WHERE
          c.field_department_nid_nid=%d AND c.nid=ci.field_course_id_nid AND
          ci.field_sess_name_value='" .  variable_get('eduerp_current_session', '')  . "' AND
          ci.field_semester_name_value='{$i}'
        ) AS courses
      LEFT JOIN {node} npro ON courses.uid=npro.uid AND npro.type='profile'
      LEFT JOIN {content_type_profile} pro ON npro.vid=pro.vid
      ORDER by code";
    $result = db_query($query, arg(2));
    echo "<b><br />Courses Running in Current Session, Semester {$i}...</b>";
?>
    <table border='1' align='center'  cellpadding="5" cellspacing="5">
    <tr bgcolor='#ACCFCC'><td><b>Code</b></td><td><b>Lecturer</b></td><td><b>Course</b></td></tr>
<?php
    while ($f = db_fetch_object($result)) {
?>
      <tr>
      <td><? echo $f->code; ?></td>
      <td><a href="view/<?php echo $f->uid?>"><? echo $f->staff_name; ?></a></td>
      <td><? echo $f->course_title; ?></td>
      </tr>
<?php
    }
?>
    </table>
<?php
  }

  $query = "SELECT c.field_code_value AS code, c.field_coursetitle_value AS course_title FROM {content_type_course} c WHERE c.field_department_nid_nid=%d ORDER by code";
  $result = db_query($query, arg(2));
  echo "<b><br />All Courses In this Department...</b>";
?>
  <table border='1' align='center'  cellpadding="5" cellspacing="5">
  <tr bgcolor='#ACCFCC'><td><b>Code</b></td><td><b>Course</b></td></tr>
<?php
  while ($f = db_fetch_object($result)) {
?>
    <tr>
    <td><? echo $f->code; ?></td>
    <td><? echo $f->course_title; ?></td>
    </tr>
<?php
    }
?>
    </table>
<?php

  return ob_get_clean();
}


function staff_department_list() {
  ob_start();
  $r = db_query("SELECT
      d.nid AS department_id,
      d.field_department_name_value AS department_name,
      er.uid AS hod_uid,
      CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS hod_name
    FROM {content_type_department} d
    LEFT JOIN {eduerp_roles} er ON d.nid=er.department_id AND er.role='Head of Department'
    LEFT JOIN {node} npro ON er.uid=npro.uid AND npro.type='profile'
    LEFT JOIN {content_type_profile} pro ON npro.vid=pro.vid
    ORDER BY department_name");
?>
    <table border='1' align='center'  cellpadding="5" cellspacing="5">
    <tr bgcolor='#ACCFCC'><td><b>Department</b></td><td><b>HOD</b></td><td><b>Action</b></td></tr>
<?php
  while ($f = db_fetch_object($r)) {
?>
      <tr>
      <td><? echo $f->department_name; ?></td>
      <td><a href="view/<?php echo $f->hod_uid?>"><? echo $f->hod_name; ?></a></td>
      <td><a href="viewlecturer/<? echo $f->department_id; ?>">View Courses/Lecturers</a></td>
      </tr>
<?php
  }
?>
    </table>
<?php
  return ob_get_clean();
}


function staff_search_list() {
  /*
  $search_keys = array('gender', 'department_id', 'staff_type_id', 'grade_level_id', 'state');
  $search_values = array(
    'gender' => '',
    'department_id',
    'staff_type_id',
    'grade_level_id',
    'state');
  $data = array_filter($_POST);
  $condition = array();
  foreach ($search_keys as $value) {
    if (isset($data['$value'])) {
      $condition[] = "s .". $value ."='". $data[$value] ."'";
    }
  }
  if (implode(' and ', $condition) != '') {
    $condition = " where ". implode(' and ', $condition);
  }
  else {*/
    $condition  = '';
  /*}*/
  $query = "SELECT ur.uid,
      CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS name,
      GROUP_CONCAT(CONCAT(er.role, IFNULL(CONCAT('(', d.field_department_name_value, ')'), ''), IFNULL(CONCAT('(', c.field_college_name_value, ')'), '')) ORDER BY er.role SEPARATOR ', ') AS role_name
    FROM {users_roles} ur
    INNER JOIN {role} r ON ur.rid=r.rid AND name='Staff'
    LEFT JOIN {node} npro ON ur.uid=npro.uid AND npro.type='profile'
    LEFT JOIN {content_type_profile} pro ON npro.vid=pro.vid
    LEFT JOIN {eduerp_roles} er ON ur.uid=er.uid
    LEFT JOIN {content_type_department} d ON er.department_id=d.nid
    LEFT JOIN {content_type_college} c ON er.college_id=c.nid
    $condition
    GROUP BY ur.uid ORDER BY name";
  $result = db_query($query);
?>
    <table border='1' align='center'>
    <tr bgcolor='#ACCFCC'><td colspan='4'><b>Staff List</b></td></tr>
    <tr><td><b>Name</b></td><td><b>Roles</b></td><td><b>View</b></td><td><b>Action</b></td></tr>
<?php
  while ($f = db_fetch_object($result)) {
?>
      <tr>
      <td><?php echo $f->name ?></td>
      <td><? echo $f->role_name; ?></td>
      <td><a href="view/<? echo $f->uid; ?>">View</a></td>
      <td><a href="<?php echo url('staff/assignrole/'. $f->uid)?>">Assign Roles</a></td>
      </tr>
<?php
  }
?>
    </table>
<?php
  describeroles();
}


function describeroles() {
  echo "<br />
<b>Description of roles</b><br />
Note any combination of roles can be assigned to the one staff member.<br />
<br />
<b>Department roles...</b><br />
<br />
Note these roles can be given to a staff member for more than one department and it is not necessarily for their \"own\" department.<br />
<br />
<b><i>'Department Examination Officer'</i></b> allows a staff member to see grades for all courses in the specified department (and all grades for students in that department who have taken courses in other departments).<br />
They will also be able to see GPA and cGPA for all students in the specified department.<br />
They will be notified when a lecturer submits grades for a course in the specified department.<br />
<br />

<b><i>'Department Grade Editor'</i></b> has the same rights as <b><i>'Department Examination Officer'</i></b>.<br />
Additionally they will have the same rights as a course lecturer to edit and submit any grades for all courses in the specified department.<br />
They can also approve grades for all courses in the specified department.<br />
They can also unlock grades to allow a lecturer (or themselves) re-edit and re-submit changes.<br />
They can create or modify courses for the specified department.<br />
They can create or modify programmes for the specified department.<br />
<br />

<b><i>'Head of Department'</i></b> has the same rights as <b><i>'Department Examination Officer'</i></b>.<br />
Additionally they can approve grades for all courses in the specified department.<br />
They can also unlock grades to allow a lecturer re-edit and re-submit changes.<br />
They can create or modify courses for the specified department.<br />
They can create or modify programmes for the specified department.<br />
<br />

<b>Faculty roles...</b><br />
<br />
Note these roles can be given to a staff member for more than one faculty and it is not necessarily for their \"own\" faculty.<br />
<br />

<b><i>'Faculty Examination Officer'</i></b> allows a staff member to see grades for all courses in the specified faculty (and all grades for students in that faculty who have taken courses in other faculties).<br />
They will also be able to see GPA and cGPA for all students in the specified faculty.<br />
They will be notified when a lecturer submits grades for a course in the specified faculty.<br />
They will be notified when grades are approved for a course in the specified faculty.<br />
<br />

<b><i>'Faculty Grade Editor'</i></b> has the same rights as <b><i>'Faculty Examination Officer'</i></b>.<br />
Additionally they will have the same rights as a course lecturer to edit and submit any grades for all courses in the specified faculty.<br />
They can also approve grades for all courses in the specified faculty.<br />
They can also unlock grades to allow a lecturer (or themselves) re-edit and re-submit changes.<br />
They can also second level approve grades for all courses in the specified faculty.<br />
<br />

<b><i>'Dean of Faculty'</i></b> has the same rights as <b><i>'Faculty Examination Officer'</i></b>.<br />
Additionally they can second level approve grades for all courses in the specified faculty.<br />
<br />

<b>University roles...</b><br />
<br />
<b><i>'University Examination Viewer'</i></b> allows a staff member to see grades for all courses.<br />
They will also be able to see GPA and cGPA for all students.<br />
<br />

<b><i>'University Grade Editor'</i></b> has the same rights as <b><i>'University Examination Viewer'</i></b>.<br />
Additionally will have the same rights as a course lecturer to edit and submit any grades for all courses.<br />
They will be notified when a lecturer submits grades for a course.<br />
They can also approve grades for all courses.<br />
They can also unlock grades to allow a lecturer (or themselves) re-edit and re-submit changes.<br />
They will be notified when grades are approved for a course.<br />
They can also second level approve grades for all courses.<br />
They can also approve grades for all departments in place of the <b><i>'Registrar'</i></b> (if the <b><i>'Registrar'</i></b> does approve grades in this university).<br />
They can also finally approve grades for all departments in place of the Vice-Chancellor.<br />
They can edit a students's exam results even after then have been finally approved by the <b><i>'Vice-Chancellor'</i></b>. The student's GPA and cGPA will be appropriately adjusted without any further approval or notification. A record will be kept that a change has been made (as happens also for all approvals).<br />
<br />

<b><i>'Registrar'</i></b> has the same rights as <b><i>'University Examination Viewer'</i></b>.<br />
Additionally they can approve grades for all departments (if the Registrar is part of the approval chain in this university).<br />
They can perform any actions on the Semester/Programmes Admin Screen.<br />
They also can do all the same things as <b><i>'Registry'</i></b>.<br />
<br />

<b><i>'Registry'</i></b><br />
They can perform manual additions of course registrations for a particular student including the 3rd Semester.<br />
They can mark a particular course registration for a specific student as dropped (so the student is not required to take the exam).<br />
They can change a student's programme.<br />
They can view all fully approved grading.<br />
They can see all student profiles.<br />
They can perform clearances of student applications to the university.<br />
They can see all staff profile data (except pay).<br />
<br />

<b><i>'Bursary'</i></b><br />
They can see all staff profile data (except pay).<br />
They can see all student payments.<br />
<br />

<b><i>'Bursar'</i></b> has the same rights as <b><i>'Bursary'</i></b>.<br />
They can see all staff profile data (including pay).<br />
They can set the various fee levels for students.<br />
They can authorise scholarships for individual students.<br />
They can authorise fee payment by instalments for individual students.<br />
<br />

<b><i>'Vice-Chancellor'</i></b> has the same rights as <b><i>'University Examination Viewer'</i></b>.<br />
Additionally they can finally approve grades for all departments.<br />
They also can do all the same things as <b><i>'Registry'</i></b>.<br />
They also can do all the same things as <b><i>'Bursary'</i></b>.<br />
<br />

<b><i>'Student Affairs Officer'</i></b><br />
They can administer hostels.<br />
They can see student profile data.<br />
<br />

<b><i>'Non-Academic Staff'</i></b> all staff should be given either <b><i>'Academic Staff'</i></b> or <b><i>'Non-Academic Staff'</i></b> but <b><i>'Non-Academic Staff'</i></b> does not actually provide anything. (Any registered Staff Drupal user does however have some basic access to the system).<br />
<br />

<b><i>'Academic Staff'</i></b><br />
They can view all fully approved grading.<br />
They can be a lecturer in a course.<br />
<br />

<b><i>'Role Assigner'</i></b><br />
They can assign any of the above roles to any Staff Drupal user.<br />
They can create or modify Faculties or Departments.<br />";
}


function staff_view_form(&$obj) {
  $query = "SELECT
      CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS staff_name,
      GROUP_CONCAT(er.role SEPARATOR ', ') AS role_name,
      d.field_department_name_value,
      stpro.field_profile_staff_no_value AS staff_no,
      stpro.field_profile_room_value AS room_number,
      DATE_FORMAT(stpro.field_profile_appointment_date_value, '%%D %%b %%Y') AS appointment_date
    FROM {eduerp_roles} er
    INNER JOIN {node} npro ON er.uid=npro.uid AND npro.type='profile'
    INNER JOIN {content_type_profile} pro ON npro.vid=pro.vid
    INNER JOIN {node} nstpro ON er.uid=nstpro.uid AND nstpro.type='staff_profile'
    INNER JOIN {content_type_staff_profile} stpro ON nstpro.vid=stpro.vid
    LEFT  JOIN {content_type_department} d ON pro.field_profile_department_id_nid=d.nid
    WHERE er.uid=%d GROUP BY er.uid";
  $result = db_query($query, arg(2));
  $data = db_fetch_object($result);

  $form['staff_name'] = array(
    '#type' => 'item',
    '#title' => 'Staff Name',
    '#value' => $data->staff_name);
  $form['staff_number'] = array(
  '#title' => 'Staff Number',
    '#type' => 'item',
    '#size' => 20,
    '#value' => $data->staff_no);
  $form['staff_department'] = array(
    '#type' => 'item',
    '#title' => 'Department',
    '#value' => $data->field_department_name_value);
  $form['staff_room'] = array(
    '#title' => 'Room',
    '#type' => 'item',
    '#size' => 20,
    '#value' => $data->room_number);
  $form['appointment_date'] = array(
    '#type' => 'item',
    '#title' => 'Appointment date',
    '#value' => $data->appointment_date);
  $form['staff_role'] = array(
    '#value' => '<b>Roles:</b><br />' . $data->role_name);
  return $form;
}


function staff_level() {
  $titles['']="";
  $r=db_query("select * from `level` order by level_name");
    while ($f=db_fetch_object($r))
      $titles[$f->level_name] = $f->level_name;
  return  $titles;
}


function staff_course() {
  $titles[''] = '';
  $r = db_query("SELECT nid, field_code_value AS value FROM {content_type_course} ORDER BY field_level_value, field_semester_value, field_code_value ");
  //$r = db_query("SELECT nid, CONCAT(field_coursetitle_value, ' (', field_code_value , ')') AS value FROM {content_type_course} ORDER BY field_level_value, field_semester_value, field_code_value ");
  while ($f = db_fetch_object($r))
    $titles[$f->nid] = $f->value;
  return  $titles;
}


function department($department_nid=0) {

    $titles = array();
    if($department_nid !=0)
      $r = db_query("SELECT nid, field_department_name_value AS value FROM {content_type_department} WHERE nid=%d ORDER BY field_department_name_value", $department_nid);
    else
      $r = db_query("SELECT nid, field_department_name_value AS value FROM {content_type_department} ORDER BY field_department_name_value");
    while ($f = db_fetch_object($r))
      $titles[$f->nid] = $f->value;

  return  $titles;
}


function get_programmes($programme_nid = 0, $forSelectList = false) {
    $where = ""; $args = "";

    if ($programme_nid != 0) {
      $where = " WHERE p.nid=$programme_nid ";
      //$args = "";
      //$args = $programme_nid;
    }
    $r = db_query("SELECT p.nid programme_nid, field_college_name_value faculty_name, d.nid department_nid, field_department_name_value AS department_name,
          field_programme_name_value programme_name, c.nid faculty_nid,
          field_duration_value duration, field_program_type_value programme_type, field_max_duration_value max_duration,
          field_min_credit_load_program_value min_credit_load, field_programme_abbr_value programme_abbr
          FROM {content_type_program} p
          INNER JOIN {content_type_department} d ON d.nid = p.field_department_id_nid
          INNER JOIN {content_type_college} c ON c.nid = d.field_college_id_nid
          ". $where ."
          ORDER BY faculty_name, department_name, programme_name ");

 if ($forSelectList) {
   if (db_affected_rows($r) > 0) {
     while ($row = db_fetch_object($r))
       $programmes[$row->programme_nid] = $row->programme_name;
   }
   else
    $programmes[] = strip_tags(Error_Types(106));

  return $programmes;
 }
 else
   return $r;
}


function programme($programme_nid=0) {


    if($programme_nid !=0)
      $r = db_query("SELECT nid, CONCAT(field_programme_name_value, ' (', field_programme_abbr_value, ')') AS value FROM { content_type_program} WHERE nid=%d ORDER BY field_programme_name_value", $programme_nid);
    else
      $r = db_query("SELECT nid, CONCAT(field_programme_name_value, ' (', field_programme_abbr_value, ')') AS value FROM { content_type_program} ORDER BY field_programme_name_value");


    if (db_affected_rows($r) > 0) {
      while ($f = db_fetch_object($r))
        $programmes[$f->nid] = $f->value;
    }
    else
      $programmes[] = strip_tags(Error_Types(106));

  return  $programmes;
}


function course($department_nid, $semester = 0) {

  $course = array();
  if ($semester != 0) {
    $r = db_query("SELECT nid, field_code_value AS value FROM {content_type_course} WHERE field_department_nid_nid=%d AND field_semester_value=%d ORDER BY field_level_value, field_code_value", $department_nid, $semester);
    while ($f = db_fetch_object($r)) {
      $course[$f->nid] = $f->value;
    }

    // Add any other department courses at the bottom of the list
    $r = db_query("SELECT nid, field_code_value AS value FROM {content_type_course} WHERE field_department_nid_nid=%d AND field_semester_value!=%d ORDER BY field_level_value, field_code_value", $department_nid, $semester);
    while ($f = db_fetch_object($r)) {
      $course[$f->nid] = $f->value;
    }

    if (empty($course)) $course[] = strip_tags(Error_Types(106));

    return  $course;
  }
  else
    $r = db_query("SELECT nid, field_code_value AS value FROM {content_type_course} WHERE field_department_nid_nid=%d ORDER BY field_level_value, field_code_value", $department_nid);
  if (db_affected_rows($r) > 0) {
    while ($f = db_fetch_object($r))
      $course[$f->nid] = $f->value;
  }
  else
    $course[] = strip_tags(Error_Types(106));

  return  $course;
}


function semester_admin() {
  ob_start();

  echo '<br /><hr /><br />';

  echo drupal_get_form('set_session_form');
  echo '<br /><hr /><br />';

  echo '<a href="' . url('staff/missingcourses') . '">Check for Missing Courses for a Semester (no Lecturer or Timetable Assigned)</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/checkverifyprogmme') . '">Check if all existing Courses required for all Programmes have been Verified (associated with the Programme)</a>';
  echo '<br /><br /><hr /><br />';

  //echo 'List the Fees for all Programmes by Level & Semester[Feature #444]';
  echo '<a href="' . url('staff/schoolfeesadmin') . '">School Fees Administration</a>';
  echo '<br /><br /><hr /><br />';

  echo drupal_get_form('open_close_student_registration_form');
  echo '<br /><hr /><br />';

  echo drupal_get_form('open_close_student_course_registration_form');
  echo '<br /><hr /><br />';

  echo '<a href="' . url('grading/statsuni') . '">Grading Statistics for University</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/studentprogress') . '">Student Progress towards Graduation</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/unregstudents') . '">List of Students who have Not Registered for a Semester</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/department') . '">View Departments and Courses</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('liststaff') . '">List Staff</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/createeditcourse') . '">Create or Modify Courses for a Department</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/createmodifyprog') . '">Create or Modify a University Programme</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/createeditdept') . '">Create or Modify a Department</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/createeditfaculty') . '">Create or Modify a Faculty</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/list') . '">List Staff and Assign Roles</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/manualcoursereg') . '">Manually Register a Student in a Course</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/dropcoursereg') . '">Mark a Student as Not being Required to take an Exam for a course they have enrolled in</a>';
  echo '<br /><br /><hr /><br />';

  echo '<a href="' . url('staff/changeprogmme') . '">Change a Student to a Different Programme</a>';
  echo '<br /><br /><hr /><br />';

  return ob_get_clean();
}


function set_session_form($form_state) {
  global $user;

  $form['top'] = array('#value' => 'The current Session is: ' . variable_get('eduerp_current_session', '') . ' and current Semester is: ' . variable_get('eduerp_current_semester', ''));

  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registrar'))) {
    $current_year = intval(date('Y'));
    $sessions = array();
    $sessions[sprintf("%s/%s", $current_year - 0, $current_year + 1)] = sprintf("%s/%s", $current_year - 0, $current_year + 1);
    $sessions[sprintf("%s/%s", $current_year - 1, $current_year - 0)] = sprintf("%s/%s", $current_year - 1, $current_year - 0);
    $sessions[sprintf("%s/%s", $current_year - 2, $current_year - 1)] = sprintf("%s/%s", $current_year - 2, $current_year - 1);
    $sessions[sprintf("%s/%s", $current_year - 3, $current_year - 2)] = sprintf("%s/%s", $current_year - 3, $current_year - 2);

    $form['eduerp_current_session'] = array(
      '#type' => 'select',
      '#options' => $sessions,
      '#title' => 'Current Session',
      '#default_value' => variable_get('eduerp_current_session', sprintf("%s/%s", $current_year - 1, $current_year)),
      '#description' => 'Please specify the current session'
    );

    $form['eduerp_current_semester'] = array(
      '#type' => 'select',
      '#options' => array(1 => '1', 2 => '2'),
      '#title' => 'Current Semester',
      '#default_value' => variable_get('eduerp_current_semester', 1),
      '#description' => 'Please specify the current semester'
    );

    $form['submit'] = array('#type' => 'submit', '#value' => 'Set the Session and Semester');
  }
  return $form;
}


function set_session_form_submit($form, &$form_state) {

  variable_set('eduerp_current_session', $form_state['values']['eduerp_current_session']);
  variable_set('eduerp_current_semester', $form_state['values']['eduerp_current_semester']);

  $text = preg_replace('#registering: [0-9]{4,4}/[0-9]{4,4}#', 'registering: ' . $form_state['values']['eduerp_current_session'], variable_get('user_registration_help', ''));
  variable_set('user_registration_help', $text);

  // Check if the current session is in the session table
  $session_rs = db_query("SELECT sess_name FROM {session} WHERE sess_name = '%s'", $form_state['values']['eduerp_current_session']);
  if (!db_result($session_rs)) {
    db_query("INSERT INTO {session} (sess_name) VALUES ('%s')", $form_state['values']['eduerp_current_session']);
  }

  module_invoke_all('createsession', $form_state['values']['eduerp_current_session']);
}


function open_close_student_registration_form($form_state) {
  global $user;

  // We could add a from element with more options that just on/off
  if (variable_get('user_register', 1)) { // This a system setting (0 => no self registrations, 1 => yes, 2 => yes, admin approval needed)
    $open = 'Open';
    $closeverb = 'Close';
  }
  else {
    $open = 'Closed';
    $closeverb = 'Open';
  }

  $form['top'] = array('#value' => "Student Registrations and Initial Payment are $open for the Session " . variable_get('eduerp_current_session', '') . '<br />');

  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registrar'))) {
    $form['submit'] = array('#type' => 'submit', '#value' => "$closeverb Student Registrations for the Session");
  }
  return $form;
}


function open_close_student_registration_form_submit($form, &$form_state) {

  if (variable_get('user_register', 1)) {
    variable_set('user_register', 0);
  }
  else {
    variable_set('user_register', 1);
  }
}


function open_close_student_course_registration_form($form_state) {
  global $user;

  $form['top'] = array('#value' => 'Here are the Programmes (& Level) currenly Open for Course Registrations this Semester: ' . listofopenprogrammes());

  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registrar'))) {

    $programmestoopen = selectlistofprogrammestoopen();
    if (!empty($programmestoopen)) {
        $form['programmestoopen'] = array(
          '#type' => 'select',
          '#options' => $programmestoopen,
          '#title' => 'Programme(level) to Open OR Open ALL',
          '#description' => 'Please specify one Programme Level to Open for Course Registrations or Open ALL'
        );
    }

    $programmestoclose = selectlistofprogrammestoclose();
    if (!empty($programmestoclose)) {
        $form['programmestoclose'] = array(
          '#type' => 'select',
          '#options' => $programmestoclose,
          '#title' => 'Programme(level) to Close OR Close ALL',
          '#description' => 'Please specify one Programme Level to Close for Course Registrations or Close ALL'
        );
    }

    if (empty($programmestoclose)) $openverb = 'Open';
    elseif (empty($programmestoopen)) $openverb = 'Close';
    else $openverb = 'Open or Close';

    $form['submit'] = array('#type' => 'submit', '#value' => "$openverb Course Registrations for this Semester");
  }
  return $form;
}


function listofopenprogrammes() {
  $semester = variable_get('eduerp_current_semester', 1);

  $names = array();
  $sql = "SELECT CONCAT(p.field_programme_name_value, '(', pls.level, ')') AS name
    FROM {program_level_semester} pls, {content_type_program} p
    WHERE pls.open_for_registrations=1 AND pls.semester='%s' AND pls.programme_id=p.nid ORDER BY name ASC";
  $rows = db_query($sql, $semester);
  while ($row = db_fetch_object($rows)) {
    $names[] = $row->name;
  }
  if (empty($names)) return 'None';
  return implode('; ', $names);
}


function selectlistofprogrammestoopen() {
  $semester = variable_get('eduerp_current_semester', 1);

  $names = array();
  $names[''] = '';
  $names[999999] = 'ALL';
  $noprogrammes = TRUE;
  $sql = "SELECT
      CONCAT(pls.programme_id, ',', pls.level, ',', pls.semester) AS id,
      CONCAT(p.field_programme_name_value, '(', pls.level, ')') AS name
    FROM {program_level_semester} pls, {content_type_program} p
    WHERE pls.open_for_registrations=0 AND pls.semester='%s' AND pls.programme_id=p.nid ORDER BY name ASC";
  $rows = db_query($sql, $semester);
  while ($row = db_fetch_object($rows)) {
    $noprogrammes = FALSE;
    $names[$row->id] = $row->name;
  }
  if ($noprogrammes) return FALSE;
  return $names;
}


function selectlistofprogrammestoclose() {
  $semester = variable_get('eduerp_current_semester', 1);

  $names = array();
  $names[''] = '';
  $names[999999] = 'ALL';
  $noprogrammes = TRUE;
  $sql = "SELECT
      CONCAT(pls.programme_id, ',', pls.level, ',', pls.semester) AS id,
      CONCAT(p.field_programme_name_value, '(', pls.level, ')') AS name
    FROM {program_level_semester} pls, {content_type_program} p
    WHERE pls.open_for_registrations=1 AND pls.semester='%s' AND pls.programme_id=p.nid ORDER BY name ASC";
  $rows = db_query($sql, $semester);
  while ($row = db_fetch_object($rows)) {
    $noprogrammes = FALSE;
    $names[$row->id] = $row->name;
  }
  if ($noprogrammes) return FALSE;
  return $names;
}


function open_close_student_course_registration_form_submit($form, &$form_state) {
  $semester = variable_get('eduerp_current_semester', 1);

  if     (!empty($form_state['values']['programmestoopen']) && $form_state['values']['programmestoopen'] == 999999) {
    if (variable_get('RegisterAllCoursesatStartofSession', 0)) $semesterselect = '';
    else $semesterselect = "WHERE pls.semester=$semester";

    db_query("UPDATE {program_level_semester} pls SET pls.open_for_registrations=1 $semesterselect");
  }
  elseif (!empty($form_state['values']['programmestoclose']) && $form_state['values']['programmestoclose'] == 999999) {
    if (variable_get('RegisterAllCoursesatStartofSession', 0)) $semesterselect = '';
    else $semesterselect = "WHERE pls.semester=$semester";

    db_query("UPDATE {program_level_semester} pls SET pls.open_for_registrations=0 $semesterselect");
  }
  elseif (!empty($form_state['values']['programmestoopen'])) {
    $prog_lev_sem = explode(',', $form_state['values']['programmestoopen']);

    if (variable_get('RegisterAllCoursesatStartofSession', 0)) $semesterselect = '';
    else $semesterselect = "AND pls.semester={$prog_lev_sem[2]}";

    db_query("UPDATE {program_level_semester} pls SET pls.open_for_registrations=1 WHERE pls.programme_id=%d AND pls.level=%d $semesterselect", $prog_lev_sem[0], $prog_lev_sem[1]);
  }
  elseif (!empty($form_state['values']['programmestoclose'])) {
    $prog_lev_sem = explode(',', $form_state['values']['programmestoclose']);

    if (variable_get('RegisterAllCoursesatStartofSession', 0)) $semesterselect = '';
    else $semesterselect = "AND pls.semester={$prog_lev_sem[2]}";

    db_query("UPDATE {program_level_semester} pls SET pls.open_for_registrations=0 WHERE pls.programme_id=%d AND pls.level=%d $semesterselect", $prog_lev_sem[0], $prog_lev_sem[1]);
  }
}


function get_faculties() {
  $r = db_query("SELECT nid, field_college_name_value AS name, field_college_abbreviation_value AS abbr, field_college_email_subdomain_value AS fac_email_subdomain FROM {content_type_college} ORDER BY field_college_name_value");
  while ($f = db_fetch_object($r)){
    $faculties[$f->nid]['faculty_name'] = $f->name;
    $faculties[$f->nid]['faculty_abbr'] = $f->abbr;
    $faculties[$f->nid]['faculty_nid'] = $f->nid;
    $faculties[$f->nid]['faculty_email_subdomain'] = $f->fac_email_subdomain;
  }
  return $faculties;
}


function get_departments() {
  $r = db_query("SELECT d.nid nid, field_department_name_value AS dept_name, field_college_name_value AS fac_name, field_college_abbreviation_value AS fac_abbr, field_department_code_value AS dept_code
      FROM {content_type_department} d INNER JOIN {content_type_college} c ON d.field_college_id_nid=c.nid
      ORDER BY field_college_name_value, dept_name");
  $departments = array();
  while ($f = db_fetch_object($r)){
    $departments[$f->nid]['faculty_name'] = $f->fac_name;
    $departments[$f->nid]['faculty_abbr'] = $f->fac_abbr;
    $departments[$f->nid]['dept_nid'] = $f->nid;
    $departments[$f->nid]['dept_name'] = $f->dept_name;
    $departments[$f->nid]['dept_code'] = $f->dept_code;
  }
  return $departments;
}


function get_Available_Courses($department_nid = 0, $course_nid = 0) {
  $where = ""; $arg = 0;
  if ($department_nid != 0) {
    $where = " WHERE k.field_department_nid_nid = %d";
    $arg = $department_nid;
  }
  if ($course_nid != 0) {
    $where = " WHERE k.nid = %d";
    $arg = $course_nid;
  }

  $r = db_query("SELECT k.nid nid, field_level_value AS course_level, field_code_value AS course_code,
      field_coursetitle_value AS course_title, field_creditload_value AS credit_load, field_prerequisite_value AS prerequisite_desc,
      field_prerequisite_codes_value AS prerequisite_codes, field_semester_value AS course_semester, field_course_description_value AS course_description,
      field_department_name_value AS dept_name, field_college_name_value AS fac_name, field_college_abbreviation_value AS fac_abbr
      FROM {content_type_course} k
      INNER JOIN {content_type_department} d ON k.field_department_nid_nid = d.nid
      INNER JOIN {content_type_college} c ON d.field_college_id_nid = c.nid
      ". $where ."
      ORDER BY field_college_name_value, dept_name, course_level, course_code ", $arg);

  return  $r;
}


function staff_display_available_courses($session, $semester, $departmentInfo = array(), $type = 0) {
  //$type; 0=available course, 1=assigned courses, 2=unassigned courses
  $department_nid = 0;$forassigned=false;
  $str = "";
  if (sizeof($departmentInfo)) {
    $key = array_keys($departmentInfo);
    $department_nid = $key[0];
  }
  switch ($type) {
    case '1':
      $courses = get_Assigned_Courses($session, $department_nid); break;//variable_get('eduerp_current_session', '')
    case '2':
      // ALAN 20110109 Does not seem to be used, verify and remove
      $courses = get_UnAssigned_Courses($session, $department_nid); break;
    case '3':
      $courses = get_department_running_courses($session, $department_nid, $semester); break; //variable_get('eduerp_current_semester', '')
    default:
      $courses = get_Available_Courses($department_nid);
  }
  if ($department_nid){
    if ($type == 1){
      $forassigned=true;
      $str  = "<b>Assigned Courses for ". $departmentInfo[$department_nid] ." Department</b> for <b>". $session ."</b> Session<br />";
    }
    elseif ($type == 2)
      $str  = "<b>UnAssigned Courses for ". $departmentInfo[$department_nid] ." Department</b> for <b>". $session ."</b> Session </b><br />";
    elseif ($type == 3)
      $str  = "<b>List of courses that need to be run for ". $departmentInfo[$department_nid] ." Department</b> for <b>". $session ."</b> Session for Semester <b>". $semester ."</b><br />";
    else
      $str  = "<b>Available Courses for ". $departmentInfo[$department_nid] ." Department</b><br />";
  }
  else
    $str  = "<b>Available Courses</b><br />";


  if (db_affected_rows($courses) <= 0) {
    $str .= Error_Types(106);
  }
  else {

  $str .= "<div id='assigned_courses'>";
    $str .= "
    <table border=1>
      <tr>
        <th><b>#</b></th>";
        if ($type == 3)
          $str .="
          <th><b>Chief Lecturer</b></th>";
        if ($type != 0)
          $str .="
        <th><b>Programme Name</b></th>";
        $str .="
        <th><b>Course Level</b></th>
        <th><b>Course Code</b></th>
        <th><b>Course Title</b></th>
        <th><b>Credit load</b></th>
        <th><b>Prerequisite Codes</b></th>
        <th><b>Prerequisite Description</b></th>
        <th><b>Course Description</b></th>
        <th><b>Course Semester</b></th>";
        if ($forassigned)
          $str .="
          <th><b>Time Table</b></th>";
          $str .="
      </tr>";$i = 1; $found = false;

      while($course = db_fetch_object($courses)){
        if ($i%2){$rcolor = "#E5E5E5";} else {$rcolor = "#FFFFFF";}
        //check for course to be highlighted in red
        if ($type !=0 && $course->clean_nid == "") {
          $found = true;
          $rowColor = "color='#FF0000'";

        }
        else
          $rowColor = "color='#000000'";
          $str .= "
             <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
               <td>". $i++ ."</td>";
               if ($type == 3){
                 //get the staff name
                 if ($course->clean_nid != "") {
                   $staffInfo = get_Staff_in_Department(0, $course->lecturer_uid);
                   $course->staff_name = $staffInfo[$course->lecturer_uid];
                 }
                 else
                   $course->staff_name = "<i>Not Assigned yet!</i>";

                   $str .="
                 <td><font $rowColor >". $course->staff_name ."</font></td>";

               }
               if ($type != 0)
               $str .="
               <td><font $rowColor >". $course->programme_name ."</font></td>";

               $str .="
               <td><font $rowColor >". $course->course_level ."</font></td>
               <td><font $rowColor >". check_markup($course->course_code, FILTER_FORMAT_DEFAULT, FALSE) ."</font></td>
               <td><font $rowColor >". $course->course_title ."</font></td>
               <td><font $rowColor >". $course->credit_load ."</font></td>
               <td><font $rowColor >". $course->prerequisite_codes ."</font></td>
               <td><font $rowColor >". check_markup($course->prerequisite_desc, FILTER_FORMAT_DEFAULT, FALSE) ."</font></td>
               <td><font $rowColor >". check_markup($course->course_description, FILTER_FORMAT_DEFAULT, FALSE) ."</font></td>
               <td><font $rowColor >". $course->course_semester ."</font></td>";
               if ($forassigned)
                 $str .="
               <td><font $rowColor >". check_markup($course->timetable, FILTER_FORMAT_DEFAULT, FALSE) ."</font></td>";
               $str .="

             </tr>";
      }
      $str .= "
      </table>
      </div>";
  }
  $str .= "<br /><br />";
  if ($found)
    $str .= "<b><font color='#ff0000'>Note: The HODs for the course(s) highlighted in Red above will have to assign a lecturer for the course(s) for this semester<br />
       If you are the HOD for those courses, you will be able to fix the problem yourself.<br />In any case, when the problem is resolved, you MUST come back to this screen to complete verification!</font></b>";

  return $str;

}


function staff_display_available_programmes() {

  $str  = "<b>Available Programme</b><br />";

  $programmes = get_programmes();
  if (db_affected_rows($programmes) <= 0) {
    $str .= Error_Types(106);
  }
  else {

    $str .= "
    <table width = '50%'>
      <tr>
        <td><b>#</b></td>
        <td><b>Faculty Name</b></td>
        <td><b>Department Name</b></td>
        <td><b>Programme Name</b></td>
        <td><b>Programme Abbreviation</b></td>
        <td><b>Duration</b></td>
        <td><b>Max Duration</b></td>
        <td><b>Min. Credit Load</b></td>
        <td><b>Type</b></td>
      </tr>";$i = 1;
      $programTypes = programme_types();
      while($programme = db_fetch_object($programmes)){
        if ($i%2){$rcolor = "#E5E5E5";} else {$rcolor = "#FFFFFF";}
          $str .= "
             <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
               <td>". $i++ ."</td>
               <td>". $programme->faculty_name ."</td>
               <td>". $programme->department_name ."</td>
               <td>". $programme->programme_name ."</td>
               <td>". $programme->programme_abbr ."</td>
               <td>". $programme->duration ."</td>
               <td>". $programme->max_duration ."</td>
               <td>". $programme->min_credit_load ."</td>
               <td>". $programTypes[$programme->programme_type] ."</td>

             </tr>";
      }
      $str .= "
      </table>";
  }
  return $str;

}


function staff_create_edit_faculty() {
  global $user;
  ob_start();

  if (! staff_has_eduerp_role($user->uid, 0, 0, array('Role Assigner'))) $isAuthorized = false; else $isAuthorized = true;

  echo '<br /><hr /><br />';

  if (! $isAuthorized) {
    //echo Error_Types(104);
    drupal_set_message(Error_Types(104), 'error');
  }
  else {
    //if (isset($_POST['faculty_nid']))
    if (arg(2)){
      echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditfaculty') ."'>Create/Modify Faculty</a>&nbsp; &raquo; &nbsp;Modify Faculty</font><br /><br />";
      echo '<hr /><br />';
      echo "<b>Modify Faculty</b> - Make any required changes to the faculty<br />";
    }
    else{
      echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Create Faculty</font><br /><br />";
      echo '<hr /><br />';
      echo "<b>Create Faculty</b> - Fill the form below to create a new Faculty<br />";

    }

    echo drupal_get_form('staff_create_edit_faculty_form');
  }

  echo '<br /><hr /><br />';
  //$me = me_gen_matno(947);
  //echo $me[0];
  //drupal_set_message(print_r($me));
  //drupal_set_message(substr(variable_get('eduerp_current_session', ''), -3, 3));
  //$user_profile = new UserProfile(947);
  //$user_profile->university_email = '';
  //$user_profile->save();
  //drupal_set_message(print_r($user_profile));//drupal_set_message($user_profile->field_profile_mode_of_entry); //
  //me_gen_createsession('2012/2013');
  //VUG-BSC-09-205
  //$student = user_load(947);
  //$student->name = $me[0];
  //drupal_set_message(print_r($student));
  //print_r(user_save($student, array('name'=>'VUG-BSC-09-205')));

  if (! arg(2)) {
    if (! $isAuthorized) {
      //echo Error_Types(105);
      drupal_set_message(Error_Types(105), 'error');
    }
    else {
      //if edit was selected then do not show the rest of the page
      echo "<b>Modify Faculty</b> - Select a Faculty to edit it<br />";
      echo drupal_get_form('staff_update_faculty_form');
    }
    echo '<br /><hr /><br />';

    //display existing faculties here
    echo staff_display_available_faculties();
  }
  return ob_get_clean();
}


function staff_create_edit_dept() {
  global $user;
  ob_start();

  if (! staff_has_eduerp_role($user->uid, 0, 0, array('Role Assigner'))) $isAuthorized = false; else $isAuthorized = true;

  echo '<br /><hr /><br />';

  if (! $isAuthorized) {
    //echo Error_Types(104);
    drupal_set_message(Error_Types(104), 'error');
  }
  else {
      if (arg(2)){
      	echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditdept') ."'>Create/Modify Department</a>&nbsp; &raquo; &nbsp;Modify Department</font><br /><br />";
        echo '<hr /><br />';
        echo "<b>Modify Department</b> - Make any required changes to the Department<br />";
      }
      else{
      	echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Create Department</font><br /><br />";
        echo '<hr /><br />';
        echo "<b>Create Department</b> - Fill the form below to create a new Department<br />";
      }

      echo drupal_get_form('staff_create_edit_dept_form');
  }
  echo '<br /><hr /><br />';
  if (! arg(2)) {
    if (! $isAuthorized) {
      //echo Error_Types(105);
      drupal_set_message(Error_Types(105), 'error');
    }
    else {
      //if edit was selected then do not show the rest of the page
      echo "<b>Modify Department</b> - Select a Department to edit it<br />";
      echo drupal_get_form('staff_update_dept_form');

      echo '<br /><hr /><br />';
    }
    //display existing departments here
    echo staff_display_available_departments();

  }

  return ob_get_clean();
}


function staff_create_edit_faculty_form() {

 //if (isset($_SESSION['eduerp_fac_nid']))$_POST['faculty_nid'] = $_SESSION['eduerp_fac_nid'];

  if (arg(2) && is_valid_faculty(arg(2))) {
    if (empty($_POST['faculty_name'])) {
      $result = db_query('SELECT field_college_name_value AS name, field_college_abbreviation_value AS abbr, field_college_email_subdomain_value AS fac_subdomain FROM {content_type_college} WHERE nid = %d', arg(2));
      $fac_edit_record = db_fetch_object($result);
    }
  }
  $form['#title'] = 'Create New Faculty';
  $form['faculty_name'] = array(
    '#title' => 'Faculty Name',
    '#type' => 'textfield',
    '#size' => 40,
    '#required' => TRUE
  );
  if ($fac_edit_record) $form['faculty_name']['#value'] = $fac_edit_record->name;

  $form['faculty_abbreviation'] = array(
    '#title' => 'Faculty Code',
    '#type' => 'textfield',
    '#size' => 6,
    '#required' => TRUE
  );
  if ($fac_edit_record) $form['faculty_abbreviation']['#value'] = $fac_edit_record->abbr;

  $form['faculty_subdomain'] = array(
    '#title' => 'Faculty E-mail Subdomain e.g. science.xyz.com',
    '#type' => 'textfield',
    '#size' => 50,
    //'#required' => TRUE
  );
  if ($fac_edit_record) $form['faculty_subdomain']['#value'] = $fac_edit_record->fac_subdomain;

  /*
  if (isset($_POST['faculty_nid'])) {
    $form['faculty_nid'] = array(
    '#title' => 'Faculty nid',
    '#type' => 'hidden',
    '#value' => $_POST['faculty_nid']
    );

  }
  */
  $form['submit'] = array(
    '#value' => 'Create Faculty',
    '#type' => 'submit'
  );
  if ($fac_edit_record) $form['submit']['#value'] = 'Update Faculty';

  return $form;
}


function staff_update_faculty_form() {
  $form['#title'] = 'Update Faculty';
  $form['faculty_id'] = array(
    '#type' => 'select',
    '#options' => faculty(),
    '#title' => 'Faculty Name');
  $form['submit'] = array(
    '#value' => 'Modify Faculty',
    '#type' => 'submit'
  );
  return $form;
}


function staff_update_dept_form() {
  $form['#title'] = 'Update Department';
  $form['department_nid'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department Name');
  $form['submit'] = array(
    '#value' => 'Modify Department',
    '#type' => 'submit'
  );
  return $form;
}


function staff_create_edit_faculty_form_validate($form, &$form_state) {
  //unset($_SESSION['eduerp_fac_nid']);

  if (arg(2) && is_valid_faculty(arg(2))) {//validate EDIT
    if (is_Faculty_Name_Existing($form_state['values']['faculty_name'], arg(2)))
      form_set_error('faculty_name', Error_Types(101));

    if (is_Faculty_Abbreviation_Existing($form_state['values']['faculty_abbreviation'], arg(2)))
      form_set_error('faculty_abbreviation', Error_Types(102));
  }
  else {//validate CREATE
    if (is_Faculty_Name_Existing($form_state['values']['faculty_name']))
      form_set_error('faculty_name', Error_Types(101));

    if (is_Faculty_Abbreviation_Existing($form_state['values']['faculty_abbreviation']))
      form_set_error('faculty_abbreviation', Error_Types(102));
  }

  // Security checks
  $formFields = array("faculty_name", "faculty_abbreviation", "faculty_subdomain");
  foreach($formFields as $v){
    $text = $form_state['values'][$v];
    if (!empty($text)) {
      if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
        form_set_error($v, Error_Types(168));
      }
    }
  }
}


function staff_create_edit_faculty_form_submit($form, &$form_state) {

  //if (isset($form_state['values']['faculty_nid']) && ! preg_match("/^[0-9]{1,12}$/", $form_state['values']['faculty_nid'])) {//the user is trying to edit a given faculty
  if(arg(2) && is_valid_faculty(arg(2))){
    $node = node_load(arg(2));
    $node->title                                  = $form_state['values']['faculty_name'];
    $node->field_college_name[0]['value']         = $form_state['values']['faculty_name'];
    $node->field_college_abbreviation[0]['value'] = $form_state['values']['faculty_abbreviation'];
    $node->field_college_email_subdomain[0]['value'] = $form_state['values']['faculty_subdomain'];

    drupal_set_message($form_state['values']['faculty_name'] . ' Faculty was updated!<br />');

  }
  else {
    $node = new stdClass();
    $node->type                                   = 'college';
    $node->uid                                    = 1;  // Admin
    $node->status                                 = 1;  // Published
    $node->promote                                = 0;
    $node->sticky                                 = 0;
    $node->comment                                = 0;
    $node->title                                  = $form_state['values']['faculty_name'];
    $node->field_college_name[0]['value']         = $form_state['values']['faculty_name'];
    $node->field_college_abbreviation[0]['value'] = $form_state['values']['faculty_abbreviation'];
    $node->field_college_email_subdomain[0]['value'] = $form_state['values']['faculty_subdomain'];

    drupal_set_message($form_state['values']['faculty_name'] . ' Faculty has been created!<br />');
  }

  node_save($node);

  module_invoke_all('updFacultyInfo', $node->nid, variable_get('eduerp_current_session', ''), $form_state['values']['faculty_subdomain']);
  //unset($_SESSION['eduerp_fac_nid']);
  drupal_goto("staff/createeditfaculty");


}


function staff_create_edit_dept_form_validate($form, &$form_state) {

  //if (isset($_POST['department_nid'])) {//validate EDIT
  if (arg(2)) {//validate EDIT
    if (is_Department_Name_Existing($form_state['values']['department_name'], arg(2)))
      form_set_error('department_name', Error_Types(103));

  }
  else {//validate CREATE
    if(is_Department_Name_Existing($form_state['values']['department_name']))
      form_set_error('department_name', Error_Types(103));
  }

  // Security checks
  $formFields = array("department_name", "department_code");
  foreach($formFields as $v){
    $text = $form_state['values'][$v];
    if (!empty($text)) {
      if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
        form_set_error($v, Error_Types(168));
      }
    }
  }

}


function staff_create_edit_dept_form_submit($form, &$form_state) {

  //if (isset($form_state['values']['department_nid']) && ! preg_match("/^[0-9]{1,12}$/", $form_state['values']['department_nid'])) {//the user is trying to edit a given department. OK!
  if (arg(2) && is_valid_department(arg(2))) {//the user is trying to edit a given department. OK!
    $node = node_load(arg(2));
    $node->title                                = $form_state['values']['department_name'];
    $node->field_department_name[0]['value']    = $form_state['values']['department_name'];
    $node->field_college_id[0]['nid']           = $form_state['values']['faculty_nid'];//
    $node->field_department_code[0]['value']    = $form_state['values']['department_code'];

    drupal_set_message($form_state['values']['department_name'] . ' Department was updated!<br />');
    unset($_SESSION['eduerp_dept_nid']);
  }
  else {
    $node = new stdClass();
    $node->type                              = 'department';
    $node->uid                               = 1;  // Admin
    $node->status                            = 1;  // Published
    $node->promote                           = 0;
    $node->sticky                            = 0;
    $node->comment                           = 0;
    $node->title                             = $form_state['values']['department_name'];
    $node->field_department_name[0]['value'] = $form_state['values']['department_name'];
    $node->field_college_id[0]['nid']        = $form_state['values']['faculty_nid'];
    $node->field_department_code[0]['value'] = $form_state['values']['department_code'];

    //$department = $node->nid;

    drupal_set_message($form_state['values']['department_name'] . ' Department has been created!<br />');
  }

  node_save($node);
  drupal_goto("staff/createeditdept");

}


function staff_create_edit_dept_form() {

  //if (isset($_SESSION['eduerp_dept_nid']))$_POST['department_nid'] = $_SESSION['eduerp_dept_nid'];
  if (arg(2) && is_valid_department(arg(2))) {
    if (empty($_POST['department_name'])) {
      $result = db_query('SELECT field_college_id_nid AS college_nid, field_department_name_value AS dept_name, field_department_code_value AS dept_code FROM {content_type_department} WHERE nid = %d', arg(2));
      $dept_edit_record = db_fetch_object($result);
    }
  }


  $form['#title'] = 'Create New Department';
  $form['faculty_nid'] = array(
    '#type' => 'select',
    '#title' => 'Faculty Name');
  if ($dept_edit_record){
    $form['faculty_nid']['#default_value'] = $dept_edit_record->college_nid;
    $form['faculty_nid']['#options'] = faculty($dept_edit_record->college_nid);
  }
  else
    $form['faculty_nid']['#options'] = faculty();

  $form['department_name'] = array(
    '#title' => 'Department Name',
    '#type' => 'textfield',
    '#size' => 100,
    '#required' => TRUE
  );
  if ($dept_edit_record) $form['department_name']['#value'] = $dept_edit_record->dept_name;

  $form['department_code'] = array(
    '#title' => 'Department Code',
    '#type' => 'textfield',
    '#size' => 20,
    //'#required' => TRUE
  );
  if ($dept_edit_record) $form['department_code']['#value'] = $dept_edit_record->dept_code;
  /*
  if (isset($_POST['department_nid'])) {
    $form['department_nid'] = array(
    '#title' => 'Department nid',
    '#type' => 'hidden',
    '#value' => $_POST['department_nid']
    );
  }
  */
  $form['submit'] = array(
    '#value' => 'Create Department',
    '#type' => 'submit'
  );
  if ($dept_edit_record) $form['submit']['#value'] = 'Update Department';

  return $form;
}


function staff_update_faculty_form_validate($form, &$form_state) {
  if ($form_state['values']['faculty_id'] == 0)
    form_set_error('faculty_id', Error_Types(114));
}


function staff_update_faculty_form_submit($form, &$form_state) {

  //$_SESSION['eduerp_fac_nid'] = $form_state['values']['faculty_id'];
  drupal_goto("staff/createeditfaculty/" . $form_state['values']['faculty_id']);
}


function staff_update_dept_form_validate($form, &$form_state) {
  if ($form_state['values']['department_nid'] == 0)
    form_set_error('department_nid', Error_Types(114));
}


function staff_update_dept_form_submit($form, &$form_state) {

  //$_SESSION['eduerp_dept_nid'] = $form_state['values']['department_nid'];
   drupal_goto("staff/createeditdept/" . $form_state['values']['department_nid']);
}


function staff_create_edit_course() {
  global $user, $departmentInfo, $canCreateModify;
  ob_start();
  $canCreateModify = false;$hideOthers = false;

  if (isset($_SESSION['eduerp_showFullForm'])) $_POST['showFullForm'] = 1;
  if (isset($_SESSION['eduerp_showCourseAssignment'])) $_POST['showCourseAssignment'] = 1;


  echo '<br /><hr /><br />';
  $authorizeCourseEdit = false;
  if (arg(2) && is_Valid_Department(arg(2))) {//the department is valid
    //get the departments info
    $departmentInfo = department(arg(2));
    //check that he can create/modify courses
    if (staff_has_eduerp_role($user->uid, arg(2), 0, array('Head of Department', 'Department Grade Editor'))) {//allow for one db call only
      $canCreateModify = true;
    }

    //if ($canCreateModify) {
      //check to know if proceed with course assignment was clicked
      if (isset($_POST['showCourseAssignment']) || isset($_SESSION['eduerp_fix_course'])) {
        //allow for some easy navigation
        $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse/'. arg(2)) ."'>". $departmentInfo[arg(2)] ." Department</a>&nbsp; &raquo; &nbsp;<b>Course Assignment</b></font><br /><br />";
        $navi .= '<br /><hr /><br />';
        echo $navi;
        echo staff_show_assign_course();
        $hideOthers=true;
      }
      else {
        //check if user is trying to edit record
         if (arg(3) && is_valid_course(arg(3)) && course_belongs_to_department(arg(2), arg(3))) {
          $authorizeCourseEdit = true;$hideOthers=true;
          //get the course info
          $course = db_fetch_object(get_Available_Courses(0,arg(3)));
          //allow for some easy navigation
          $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse/'. arg(2)) ."'>". $departmentInfo[arg(2)] ." Department</a>&nbsp; &raquo; &nbsp;Modify Course: <b>". $course->course_code ."</b></font><br /><br />";
          $navi .= '<br /><hr /><br />';
          $navi .= "<b>Modify Course</b> - Make any required changes to the Course: <b>". $course->course_code ."</b><br />";
        }
        else {
          //allow for some easy navigation
          $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse/'.arg(2)) ."'>". $departmentInfo[arg(2)] ." Department</a>&nbsp; &raquo; &nbsp;Create New Course</font><br /><br />";
          $navi .= '<br /><hr /><br />';
          $navi .= "<b>Create New Course</b> - Please fill the form<br />";
          ;
        }

        if (isset($_POST['showFullForm']) || arg(3)) {//expand the course creation form
          if ($canCreateModify) {
            echo $navi;
            echo drupal_get_form('staff_create_course_form');
            $hideOthers = true;
            echo '<br /><hr /><br />';
            echo staff_display_available_courses(variable_get('eduerp_current_session', ''), variable_get('eduerp_current_semester', ''), $departmentInfo);
          }
          else {
            echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;". $departmentInfo[arg(2)] ." Department</font><br /><br />";
            echo '<br /><hr /><br />';
            //echo Error_Types(104);
            drupal_set_message(Error_Types(104), 'error');
          }
        }
        else {//some small navigation
          if ($canCreateModify) {
            echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;". $departmentInfo[arg(2)] ." Department</font><br /><br />";
            echo '<br /><hr /><br />';
            echo "<b>Create Course</b> - Click to proceed with Course creation<br /><br />";
            echo drupal_get_form('staff_create_course_mini_form');
          }
          else {
            echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createeditcourse') ."'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;". $departmentInfo[arg(2)] ." Department</font><br /><br />";
            echo '<br /><hr /><br />';
            //echo Error_Types(104);
            drupal_set_message(Error_Types(104), 'error');
          }
        }
      }//end of else of if proceed with course assignment
    //}
    /*
    else {//the user cannot create records
      echo "<font size = '1px'><a href = '/staff/semester'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '/staff/createeditcourse'>Create/Modify a Course</a>&nbsp; &raquo; &nbsp;". $departmentInfo[arg(2)] ." Department</font><br /><br />";
      echo '<br /><hr /><br />';
      echo Error_Types(104);
    }
    */
    if (! $hideOthers) {//only show these things in none edit mode
      echo '<br /><hr /><br />';
      if ($canCreateModify) {
        echo "<b>Modify Course</b> - Select a Course to modify it<br />";
        echo drupal_get_form('staff_edit_course_form');
      }
      else {//user cannot modify records
        //echo Error_Types(105);
        drupal_set_message(Error_Types(105), 'error');
      }
      //display form for proceed to Course assignment
      echo '<br /><hr /><br />';
      echo '<b>Assign Lecturers and Timetables for Courses - Click to proceed with assigning lecturers and timetables for courses<br /><br />';
      echo drupal_get_form('staff_assign_course_proceed_form');

      //display existing courses in the departmens here
      echo '<br /><hr /><br />';
      echo staff_display_available_courses(variable_get('eduerp_current_session', ''), variable_get('eduerp_current_semester', ''), $departmentInfo);

    }
  }
  else {

    //allow for some easy navigation
    echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Create/Modify a Course</font><br /><br />";
    echo "<b>Create/Modify Course</b> - To begin select a department and Click Continue<br />";
    echo drupal_get_form('staff_create_edit_course_select_dept_form');

    echo '<br /><hr /><br />';
    //display existing departmens here
    echo staff_display_available_departments();
  }


  unset($_SESSION['eduerp_showFullForm']);unset($_SESSION['eduerp_showCourseAssignment']);
  return ob_get_clean();

}


function staff_create_edit_course_select_dept_form($form_state) {

  $form['#title'] = 'Select Department';
  $form['department_nid'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department Name');
  $form['submit'] = array(
    '#value' => 'Continue',
    '#type' => 'submit'
  );

  return $form;

}


function staff_create_edit_course_select_dept_form_validate($form, $form_state) {
  if ($form_state['values']['department_nid'] == 0)
    form_set_error('programme_nid', Error_Types(114));
}


function staff_create_edit_course_select_dept_form_submit($form, $form_state) {
  drupal_goto("staff/createeditcourse/" . $form_state['values']['department_nid']);
}


function staff_display_available_faculties() {
  $str = "<b>Available Faculties</b><br />
  <table border=1>
    <tr>
      <td><b>#</b></td>
      <td><b>Faculty Name</b></td>
      <td><b>Faculty Code</b></td>
      <td><b>Faculty E-mail Subdomain</b></td>
    </tr>";$i = 1;$color = 0;
    $faculties = get_faculties();
    foreach ($faculties as $v) {
      if ($i%2)$rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
      $str .= "
      <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
        <td>". $i++ ."</td>
        <td>". $v['faculty_name'] ."</td>
        <td>". $v['faculty_abbr'] ."</td>
        <td>". $v['faculty_email_subdomain'] ."</td>
      </tr>";
      }
  $str .= "
  </table>";
  return $str;
}


function staff_display_available_departments() {
  $str = "
  <div id='assigned_courses'>
  <b>Available Departments</b><br />";

  $departments = get_departments();

  if(! is_array($departments) || ! sizeof($departments))
    return $str .= Error_Types(106);

  $str .="
  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Faculty Name</b></th>
      <th><b>Faculty Code</b></th>
      <th><b>Department Name</b></th>
      <th><b>Department Code</b></th>
    </tr>";$i = 1;

    foreach ($departments as $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $str .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td>". $i++ ."</td>
           <td>". $v['faculty_name'] ."</td>
           <td>". $v['faculty_abbr'] ."</td>
           <td>". $v['dept_name'] ."</td>
           <td>". $v['dept_code'] ."</td>
         </tr>";
      }

  //}
  $str .= "
  </table>
  </div>";
  return $str;

}


function is_Faculty_Name_Existing($faculty_name, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_college} WHERE field_college_name_value = '%s' AND nid != %d ", $faculty_name, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_college} WHERE field_college_name_value = '%s' ", $faculty_name);

  if (db_fetch_object($result)) return true;

  return false;
}


function is_Programme_Name_Existing($programme_name, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_program} WHERE field_programme_name_value = '%s' AND nid != %d ", $programme_name, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_program} WHERE field_programme_name_value = '%s' ", $programme_name);

  if (db_fetch_object($result)) return true;

  return false;
}


function is_Programme_Abbr_Existing($programme_abbr, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_program} WHERE field_programme_abbr_value = '%s' AND nid != %d ", $programme_abbr, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_program} WHERE field_programme_abbr_value = '%s' ", $programme_abbr);

  if (db_fetch_object($result)) return true;

  return false;
}


function is_Faculty_Abbreviation_Existing($faculty_abbreviation, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_college} WHERE field_college_abbreviation_value = '%s' AND nid != %d ", $faculty_abbreviation, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_college} WHERE field_college_abbreviation_value = '%s' ", $faculty_abbreviation);

  if (db_fetch_object($result)) return true;

  return false;
}


function is_Department_Name_Existing($department_name, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_department} WHERE field_department_name_value = '%s' AND nid != %d ", $department_name, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_department} WHERE field_department_name_value='%s' ", $department_name);

  if (db_fetch_object($result)) return true;

  return false;
}


function is_Course_Code_Existing($course_code, $nid = 0) {
  //now if nid is zero then the check is coming from CREATE else it is coming from UPDATE
  if ($nid != 0)
    $result = db_query("SELECT nid FROM {content_type_course} WHERE field_code_value='%s' AND nid !=%d ", $course_code, $nid);
  else
    $result = db_query("SELECT nid FROM {content_type_course} WHERE field_code_value='%s' ", $course_code);

  if (db_fetch_object($result)) return true;

  return false;
}


function Error_Types($num = 0) {
  $prifix1 = "Sorry, "; $prifix2 = "Warning! "; $prifix3 = "Test failed! ";
  switch($num){
  case '101': $msg = $prifix1 . 'Faculty Name already exists!<br />'; break;
  case '102': $msg = $prifix1 . 'Faculty Code already exists!<br />'; break;
  case '103': $msg = $prifix1 . 'Department Name already exists!<br />'; break;
  case '104': $msg = $prifix1 . 'You do not have permission to Create new Records!<br />'; break;
  case '105': $msg = $prifix1 . 'You do not have permission to Modify Records!<br /><br /><br />'; break;
  case '106': $msg = $prifix1 . 'No record(s) exists!<br />'; break;
  case '107': $msg = $prifix1 . 'Positive numeric value expected!<br />'; break;
  case '108': $msg = $prifix1 . 'Course Name already exists!<br />'; break;
  case '109': $msg = $prifix1 . 'Spaces are not allowed in Course Code!<br />'; break;
  case '110': $msg = $prifix1 . 'At least one of the Course Codes entered for Prerequisites Codes either does not exist or is invalid!<br />'; break;
  case '111': $msg = $prifix1 . 'Cannot reference self for Prerequisite Course!<br />'; break;
  case '112': $msg = $prifix1 . 'You do not have permission to Access the Department!<br />'; break;
  case '113': $msg = $prifix1 . 'Course Assignment already exists for the Course, for the Timetable, for the Semester and for the Session!<br />'; break;
  case '114': $msg = $prifix1 . 'Invalid Data was supplied!<br />'; break;
  case '115': $msg = $prifix1 . 'Programme Name already exists!<br />'; break;
  case '116': $msg = $prifix1 . 'Prerequisite Description cannot be empty!<br />'; break;
  case '117': $msg = $prifix1 . 'You do not have permission to Create or Modify records in the selected Department!<br /><br /><br />'; break;
  case '118': $msg = $prifix1 . 'Input Data not in expected format!<br />'; break;
  case '119': $msg = $prifix1 . 'Minimum Credit Load cannot be greater than Maximum Credit Load!<br />'; break;
  case '120': $msg = $prifix1 . 'Programme Abbreviation already exists!<br />'; break;
  case '121': $msg = $prifix1 . 'You do not have permission to Create or Modify records in the selected Programme!<br />'; break;
  case '122': $msg = $prifix1 . 'There is a problem with the setup of this Programme!<br />'; break;
  case '123': $msg = $prifix1 . 'The selected Course already exists for the Semester, for the Programme and for the Level!<br />'; break;
  case '124': $msg = $prifix1 . 'Either no Course Registration information exists or all have been dropped for the student for the selected Session and Semester!<br />'; break;
  case '125': $msg = $prifix1 . 'Either the Matriculation/JAMB Number does not exist or it is invalid!<br />'; break;
  case '126': $msg = $prifix1 . 'No more record(s) exists!<br />'; break;
  case '127': $msg = $prifix1 . 'You do not have permission to access this module!<br /><br /><br />'; break;
  case '128': $msg = $prifix1 . 'Either Courses have not been setup or the student has fully registered all courses for the selected Session and Semester!<br />'; break;
  case '129': $msg = $prifix1 . 'The arithmetic sum of all CA + Exam marks must be 100!<br />'; break;
  case '130': $msg = $prifix1 . 'Numeric values not greater than 3 digits expected!<br />'; break;
  case '131': $msg = $prifix1 . 'Hostel Name already exists!<br />'; break;
  case '132': $msg = $prifix1 . 'Block Name already exists in the selected Hostel!<br />'; break;
  case '133': $msg = $prifix1 . 'Room Name already exists in the selected Block!<br />'; break;
  case '134': $msg = $prifix1 . 'Room Capacity must be of Numeric type!<br />'; break;
  case '135': $msg = $prifix1 . 'The allocated and available space must be equal!<br />'; break;
  case '136': $msg = $prifix1 . 'No Room exists in the selected Block!'; break;
  case '137': $msg = $prifix1 . 'Invalid date specified!'; break;
  case '138': $msg = $prifix1 . 'Reservation already exists for the student!'; break;
  case '139': $msg = $prifix1 . 'Room allocation already exists for the student!'; break;
  case '140': $msg = $prifix1 . 'Either the student does not belong to any active category or No free Bedspace was found!'; break;
  case '141': $msg = $prifix1 . 'No Allocation Rules exists for the Block!'; break;
  case '142': $msg = $prifix1 . 'The operation was not successful. No Allocation Rules exists for at least one of the Blocks!'; break;
  case '143': $msg = $prifix1 . 'The student profile may not have been properly setup!'; break;
  case '144': $msg = $prifix1 . 'Invalid format specified for Price!'; break;
  case '145': $msg = $prifix1 . 'Either your Reservation as expired or no Reservation information was found!'; break;
  case '146': $msg = $prifix1 . 'Hostel setup error encountered. Please contact your Administrator!'; break;
  case '147': $msg = $prifix1 . 'Hostel Reservation period has expired!'; break;
  case '148': $msg = $prifix1 . 'Hostel Reservation period has not yet reached!'; break;
  case '149': $msg = $prifix1 . 'Hostel Reservation has been temporarily stopped. Please try again later!'; break;
  case '150': $msg = $prifix1 . 'The operation was not successful. Allocation Number cannot be less than Alloted Number!'; break;
  case '151': $msg = $prifix1 . 'Room Allocation failed. Please contact your Administrator!'; break; //payment was successful but for some reason the allocation was not done
  case '152': $msg = $prifix1 . 'School Fee Item already exists!<br />'; break;
  case '153': $msg = $prifix1 . "There are no existing Fee Items. Please click <a href='". url('staff/createmodifyfeeitem') ."'>HERE</a> to create Fee Items!<br />"; break;
  case '154': $msg = $prifix1 . 'First and Second Installments MUST be activated together!<br />'; break;
  case '155': $msg = $prifix1 . 'Sum Total of First and Second Installments MUST equal Sum Total of Fee Amount!<br />'; break;
  case '156': $msg = $prifix1 . 'The Fee Setup combination already exists. Please try modifying it instead!<br />'; break;
  case '157': $msg = $prifix3 . 'No Fee Steup information was found!<br />'; break;
  case '158': $msg = $prifix3 . 'Fee Setup is not complete!<br />'; break;
  case '159': $msg = $prifix1 . 'No School Fee Setup matching the Student was found!<br />'; break;
  case '160': $msg = $prifix1 . 'School Fee Payment already exists for the Student for the current Session!<br />'; break;
  case '161': $msg = $prifix1 . 'Input Data required!<br />'; break;
  case '162': $msg = $prifix1 . 'Scholarship Authorisation already exists for the Student!<br />'; break;
  case '163': $msg = $prifix1 . 'Instalment Authorisation already exists for the Student!<br />'; break;
  case '164': $msg = $prifix1 . 'First Instalment MUST be less then Full Amount!<br />'; break;
  case '165': $msg = $prifix1 . 'Full Amount MUST be specified!<br />'; break;
  case '166': $msg = $prifix1 . 'Full Amount MUST be entered for at least one Fee Item in each Fee Block!<br />'; break;
  case '167': $msg = $prifix1 . 'A similar Fee Structure already exists. Kindly consider Editing it instead!<br />'; break;
  case '168': $msg = $prifix1 . 'double quote, less than or greater than characters are not allowed!<br />'; break;
  case '169': $msg = $prifix1 . 'Multiple Room Names cannot be specified in Edit Mode!<br />'; break;

  default:
    $msg =  $prifix2 .'Something fatal occured!<br /><br /><br />';
  }
  return $msg;
}

function is_Valid_Faculty ($faculty_nid) {
  $result = db_query("SELECT nid FROM {content_type_college} WHERE nid =%d ", $faculty_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;
}


function is_Valid_Department ($department_nid) {
  $result = db_query("SELECT nid FROM {content_type_department} WHERE nid =%d ", $department_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;
}


function is_valid_programme ($programme_nid) {
  $result = db_query("SELECT nid FROM {content_type_program} WHERE nid =%d ", $programme_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;
}


function is_valid_programme_course_id ($programme_nid, $programme_course_nid) {
  $result = db_query("SELECT program_course_id FROM {program_course} WHERE program_course_id=%d AND programme_id=%d ", $programme_course_nid, $programme_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;
}


function is_valid_course($course_nid) {
  $result = db_query("SELECT nid FROM {content_type_course} WHERE nid =%d ", $course_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;

}


function is_valid_course_instance($instance_nid) {
  $result = db_query("SELECT nid FROM {content_type_course_instance} WHERE nid =%d ", $instance_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;

}


function is_valid_course_code($course_code) {
  $result = db_query("SELECT nid FROM {content_type_course} WHERE field_code_value ='%s' ", $course_code);
  if (db_affected_rows($result) > 0 ) return true;

  return false;

}


function course_belongs_to_department($department_nid, $course_nid) {
  $result = db_query("SELECT nid FROM {content_type_course} WHERE nid =%d AND field_department_nid_nid =%d", $course_nid, $department_nid);
  if (db_affected_rows($result) > 0 ) return true;

  return false;

}


function course_instance_match_department_and_session($department_nid, $course_instance_nid, $session) {
  $result = db_query("SELECT i.nid FROM {content_type_course_instance} i
        INNER JOIN {content_type_course} c ON i.field_course_id_nid = c.nid

        WHERE c.field_department_nid_nid =%d AND i.nid =%d AND i.field_sess_name_value='%s' ", $department_nid, $course_instance_nid, $session);
  if (db_affected_rows($result) > 0 ) return true;

  return false;

}


function staff_create_course_form() {

 $authorizeCourseEdit = false;
 if (arg(3) && arg(2) && is_valid_course(arg(3)) && course_belongs_to_department(arg(2), arg(3))) {
   $authorizeCourseEdit = true;
   if (empty($_POST['course_code'])) {//trying to edit
     $result = get_Available_Courses(0, arg(3));
     $course = db_fetch_object($result);
   }
  }

  $form['#title'] = 'Create New Course';
  $form['course_level'] = array(
    '#type' => 'select',
    '#options' => course_levels(),
    '#title' => 'Course Level');
  if ($course) $form['course_level']['#default_value'] = $course->course_level;

  $form['course_code'] = array(
    '#title' => 'Course Code',
    '#type' => 'textfield',
    '#size' => 50,
    '#required' => TRUE
  );
  if ($course) $form['course_code']['#value'] = $course->course_code;

  $form['course_title'] = array(
    '#title' => 'Course Title',
    '#type' => 'textfield',
    '#size' => 255,
    '#required' => TRUE
  );
  if ($course) $form['course_title']['#value'] = $course->course_title;

  $form['course_description'] = array(
    '#title' => 'Course Description',
    '#type' => 'textarea',
    '#size' => 255,
    '#required' => TRUE
  );
  if ($course) $form['course_description']['#value'] = $course->course_description;


  $form['credit_load'] = array(
    '#title' => 'Credit Load',
    '#type' => 'textfield',
    '#size' => 3,
    '#required' => TRUE
  );
  if ($course) $form['credit_load']['#value'] = $course->credit_load;

  $form['prerequisites_codes'] = array(
    '#title' => 'Prerequisite Codes - List of course_code(s), comma separated that have to be completed before this course, code1/code2/code3 will be alternatives, one of which must be completed',
    '#type' => 'textfield',
    '#size' => 255

  );
  if ($course) $form['prerequisites_codes']['#value'] = $course->prerequisite_codes;


    $form['prerequisite_desc'] = array(
    '#title' => 'Prerequisite Description - Description of prerequisites',
    '#type' => 'textarea',
    '#size' => 255

  );
  if ($course) $form['prerequisite_desc']['#value'] = $course->prerequisite_desc;

  $form['course_semester'] = array(
    '#type' => 'select',
    '#options' => semesters(),
    '#title' => 'Course Semester',
    '#required' => TRUE);
  if ($course) $form['course_semester']['#default_value'] = $course->course_semester;

  if (isset($_POST['showFullForm'])) {
    //$form['showFullForm'] = array('#showFullForm' => '1');/*
    $form['showFullForm'] = array(
    '#title' => 'Course Description',
    '#type' => 'hidden',
    '#default_value'=> 1
   );

  }
 $form['assessment'] = array(
      '#type' => 'fieldset',
      '#title' => t('Continuous Assessment Maximum Marks'),
      '#description' => t('e.g. If the number of CA\'s for this course is 2, select 2 in <b>Number of CA\'s</b>, enter appropriate values in fields <b>Max. Mark 1<sup>st</sup> CA</b>, <b>Max. Mark 2<sup>nd</sup> CA</b> and <b>Max. Exam Mark</b> then enter 0 (zero) in fields <b>Max. Mark 3<sup>rd</sup> CA.</b> and <b>Max. Mark 4<sup>th</sup> CA</b>. <br /><b>Note:</b> Arithmetic Sum of all marks MUST be equal to 100!'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
    );
 //print_r($_SESSION['eduerp_course_grade_weightings']);
 $caApproval = array (0 => 'Approved Along with Exams', 1 => 'Approved Individually');
 $caNum = array(0=>'0', 1=>'1', 2=>'2', 3=>'3', 4=>'4');

 $form['assessment']['caNum'] = array('#type' => 'select', '#title' => t('Number of CA\'s'), '#options' => $caNum, '#description' => t('Describes total number of CA\'s for the course'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['caNum']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['number_of_ca'];

 $form['assessment']['caApproval'] = array('#type' => 'select', '#title' => t('CA Approval Method'), '#options' => $caApproval, '#description' => t('Describes how the CA\'s should be approved'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['caApproval']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['ca_approved_onebyone'];

 $form['assessment']['ca1'] = array('#type' => 'textfield', '#title' => t('Max. Mark 1<sup>st</sup> CA'), '#description' => t('Maximum allowable marks for 1<sup>st</sup> CA.'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['ca1']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['max_mark_ca1'];

 $form['assessment']['ca2'] = array('#type' => 'textfield', '#title' => t('Max. Mark 2<sup>nd</sup> CA'), '#description' => t('Maximum allowable marks for 2<sup>nd</sup> CA.'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['ca2']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['max_mark_ca2'];

 $form['assessment']['ca3'] = array('#type' => 'textfield', '#title' => t('Max. Mark 3<sup>rd</sup> CA'), '#description' => t('Maximum allowable marks for 3<sup>rd</sup> CA.'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['ca3']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['max_mark_ca3'];

 $form['assessment']['ca4'] = array('#type' => 'textfield', '#title' => t('Max. Mark 4<sup>th</sup> CA'), '#description' => t('Maximum allowable marks for 4<sup>th</sup> CA.'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['ca4']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['max_mark_ca4'];

 $form['assessment']['exam_mark'] = array('#type' => 'textfield', '#title' => t('Max. Exam Mark'), '#description' => t('Note: If the exam is a repeat, this will be overridden to 100'), '#required' => True);
 if(isset($_SESSION['eduerp_course_grade_weightings'])) $form['assessment']['exam_mark']['#default_value'] = $_SESSION['eduerp_course_grade_weightings']['max_mark_exam'];


 if(isset($_SESSION['eduerp_course_grade_weightings'])) unset($_SESSION['eduerp_course_grade_weightings']);

  $form['submit'] = array(
    '#value' => 'Create Course',
    '#type' => 'submit'
  );
  if ($authorizeCourseEdit) $form['submit']['#value'] = 'Update Course';

  return $form;

}


function staff_create_course_form_validate($form, $form_state) {
  //if(isset($form_state['showFullForm'])) $_POST['showFullForm'] = 1; //$form['showFullForm'];
  if (isset($form_state['values']['showFullForm'])) $_POST['showFullForm'] = $form_state['values']['showFullForm'];

  if (arg(3)) {//validate EDIT
    if (is_Course_Code_Existing($form_state['values']['course_code'], arg(3)))
      form_set_error('course_code', Error_Types(108));

  }
  else {//validate CREATE
    if (is_Course_Code_Existing($form_state['values']['course_code']))
      form_set_error('course_code', Error_Types(108));
  }
  $form_state['values']['credit_load'] = (int) $form_state['values']['credit_load'];
  if (! preg_match("/^[0-9]{1,3}$/", $form_state['values']['credit_load']) || $form_state['values']['credit_load'] < 0)
      form_set_error('credit_load', Error_Types(107));

  //make sure that no spaces in course code
  if (strpos($form_state['values']['course_code'], " ") !== FALSE)
    form_set_error('course_code', Error_Types(109));

  // Security checks
  $text = $form_state['values']['course_code'];
  if (!empty($text)) {
    if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
      form_set_error('course_code', Error_Types(168));
    }
  }
  $text = $form_state['values']['course_title'];
  if (!empty($text)) {
    if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
      form_set_error('course_title', Error_Types(168));
    }
  }
  $text = $form_state['values']['prerequisites_codes'];
  if (!empty($text)) {
    if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
      form_set_error('prerequisites_codes', Error_Types(168));
    }
  }

  //if prerequisites is not empty then make sure it conforms
  if (! empty($form_state['values']['prerequisites_codes'])) {
    $bits = explode(",", $form_state['values']['prerequisites_codes']);
    if (is_array($bits) && sizeof($bits)) {
      //looks like he entered more than one course codes
      foreach ($bits as $v) {
        $v = trim($v);
        if(! empty($v)){
          if (strpos($v, '/')) {
            //a / was found..ok
            //lets break it up
            $morebits =  explode("/", $v);
            if (is_array($morebits) && sizeof($morebits)) {
              //fine now test each
              foreach ($morebits as $h) {
                $h = trim($h);
                if(! empty($h)){
                  //the data is single so check for valid course code
                  if (! is_valid_course_code($h)) //$h == $form_state['values']['course_code'] means do not allow prereqisite to reference itself
                    form_set_error('prerequisites_codes', Error_Types(110));
                  elseif (strtolower($h) == strtolower($form_state['values']['course_code']))
                    form_set_error('prerequisites_codes', Error_Types(111));//cannot reference self
                }
              }
            }
            else {
              //something spooky is going on
              form_set_error('prerequisites_codes', Error_Types(110));
            }
          }
          else {
            //the data is single so check for valid course code
            if (! is_valid_course_code($v))
              form_set_error('prerequisites_codes', Error_Types(110));
            elseif (strtolower($v) == strtolower($form_state['values']['course_code']))
              form_set_error('prerequisites_codes', Error_Types(111));//cannot reference self
          }
        }
      }
    }
    else {//seems he entered only one course code. well lets see
      //check for valid course code
      if (! is_valid_course_code(trim($form_state['values']['prerequisites_codes'])))
        form_set_error('prerequisites_codes', Error_Types(110));
      elseif (trim(strtolower($form_state['values']['prerequisites_codes'])) == strtolower($form_state['values']['course_code']))
        form_set_error('prerequisites_codes', Error_Types(111));//cannot reference self
    }

    //make sure that the description field is not empty
    if(empty($form_state['values']['prerequisite_desc']))
      form_set_error('prerequisite_desc', Error_Types(116));
  }
  $values = $form_state['values'];
  //validate continuos assessment
  //drupal_set_message($values['exam_mark']);
  if(! preg_match("/^[0-9]{1,3}$/", $values['exam_mark'])) form_set_error('exam_mark', Error_Types(130));
  if(! preg_match("/^[0-9]{1,3}$/", $values['ca1'])) form_set_error('ca1', Error_Types(130));
  if(! preg_match("/^[0-9]{1,3}$/", $values['ca2'])) form_set_error('ca2', Error_Types(130));
  if(! preg_match("/^[0-9]{1,3}$/", $values['ca3'])) form_set_error('ca3', Error_Types(130));
  if(! preg_match("/^[0-9]{1,3}$/", $values['ca4'])) form_set_error('ca4', Error_Types(130));

  // add up the enteries and make sure it is not < 0 or > 100
  $totalMarks = $values['ca1'] + $values['ca2'] + $values['ca3'] + $values['ca4'] + $values['exam_mark'];
  if ($totalMarks < 0 || $totalMarks > 100) {
    form_set_error('exam_mark', Error_Types(129));
  }
}


function staff_create_course_form_submit($form, &$form_state){
  //if(isset($form_state['values']['course_nid']) && is_numeric($form_state['values']['course_nid'])){//the user is trying to edit a given faculty
  $values = $form_state['values'];
  //check for changes in default course weighting settings
  $defaults = get_course_grade_weighting();
  $found = false;
  //form=>dbfields
  $dbFields = array('caNum'=>'number_of_ca', 'caApproval'=>'ca_approved_onebyone', 'ca1'=>'max_mark_ca1', 'ca2'=>'max_mark_ca2', 'ca3'=>'max_mark_ca3', 'ca4'=>'max_mark_ca4', 'exam_mark'=>'max_mark_exam');
  foreach($dbFields as $k => $v) {
    if ($defaults[$v] != $values[$k]) { //some changes were made
      $found = true;
      break;
    }

  }

  //get default values again
  $_SESSION['eduerp_course_grade_weightings'] = $defaults;

  if(! arg(3)) $_SESSION['eduerp_showFullForm'] = 1;
  if(arg(3)){

    $node =  node_load(arg(3));
    $node->title                                = $form_state['values']['course_title'];
    $node->field_department_nid[0]['nid']       = arg(2);
    $node->field_code[0]['value']               = $form_state['values']['course_code'];
    $node->field_coursetitle[0]['value']        = $form_state['values']['course_title'];
    $node->field_course_description[0]['value'] = $form_state['values']['course_description'];
    $node->field_creditload[0]['value']         = $form_state['values']['credit_load'];
    $node->field_prerequisite_codes[0]['value'] = ( ! empty($form_state['values']['prerequisites_codes'])) ? $form_state['values']['prerequisites_codes'] : ' '; //List of Course code(s), comma separated that have to be completed before this course, code1/code2/code3 will be alternatives, one of which must be completed
    $node->field_prerequisite[0]['value']       = ( ! empty($form_state['values']['prerequisite_desc'])) ? $form_state['values']['prerequisite_desc'] : ' ';
    $node->field_level[0]['value']              = $form_state['values']['course_level'];
    $node->field_semester[0]['value']           = $form_state['values']['course_semester'];
    node_save($node);

    $values['course_nid'] = $node->nid;
    if ($found) create_course_weighting_entries($values);

    drupal_set_message($form_state['values']['course_code'] . ' Course was updated!<br />');

    drupal_goto("staff/createeditcourse/" . arg(2));
  }
  else {

    // course CCK
    $node = new stdClass();
    $node->type                                 = 'course';
    $node->uid                                  = 1;  // Admin
    $node->status                               = 1;  // Published
    $node->promote                              = 0;
    $node->sticky                               = 0;
    $node->comment                              = 0;
    $node->title                                = $form_state['values']['course_title'];
    $node->field_department_nid[0]['nid']       = arg(2);
    $node->field_code[0]['value']               = $form_state['values']['course_code'];
    $node->field_coursetitle[0]['value']        = $form_state['values']['course_title'];
    $node->field_course_description[0]['value'] = $form_state['values']['course_description'];
    $node->field_creditload[0]['value']         = $form_state['values']['credit_load'];
    $node->field_prerequisite_codes[0]['value'] = ( ! empty($form_state['values']['prerequisites_codes'])) ? $form_state['values']['prerequisites_codes'] : ' '; //List of Course code(s), comma separated that have to be completed before this course, code1/code2/code3 will be alternatives, one of which must be completed
    $node->field_prerequisite[0]['value']       = ( ! empty($form_state['values']['prerequisite_desc'])) ? $form_state['values']['prerequisite_desc'] : ' ';
    $node->field_level[0]['value']              = $form_state['values']['course_level'];
    $node->field_semester[0]['value']           = $form_state['values']['course_semester'];

    drupal_set_message($form_state['values']['course_code'] . ' Course has been created!<br />');
  }

  node_save($node);

  $values['course_nid'] = $node->nid;
  if ($found) create_course_weighting_entries($values);
}


function staff_edit_course_form(){
  $form['#title'] = 'Update Course';


    $form['course_nid'] = array(
      '#type' => 'select',
      '#options' => course(arg(2)),
      '#title' => 'Course Code');

    $form['submit'] = array(
      '#value' => 'Modify Course',
      '#type' => 'submit'
    );


  return $form;
}


function staff_edit_course_form_validate($form, $form_state){
  if ($form_state['values']['course_nid'] == 0)
    form_set_error('course_nid', Error_Types(114));

}


function staff_edit_course_form_submit($form, $form_state){
  //get the course weightings
  $_SESSION['eduerp_course_grade_weightings'] = get_course_grade_weighting($form_state['values']['course_nid']);
  drupal_goto(drupal_goto("staff/createeditcourse/" . arg(2) .'/'. $form_state['values']['course_nid']));
}


function course_levels() {
  foreach (range(100, 900, 100) as $number) {
    $levels[$number] = $number;
  }
  foreach (range(1, 9) as $number) {
    $levels[$number] = $number;
  }
  return $levels;
}


function semesters() {
  foreach (range(1, 3) as $number) {
    $semester[$number] = $number;
  }
  return $semester;
}


function user_has_access_to_department($department_nid) {
  global $user;
  $result = db_query("SELECT er.role FROM {eduerp_roles} er WHERE er.uid=%d AND er.department_id=%d ", $user->uid, $department_nid);

  if(db_Affected_Rows() > 0) return true;
  return false;
}


function staff_create_course_mini_form() {
  $form['#title'] = 'Start Course Creation';

  $form['submit'] = array(
    '#value' => 'Start Course Creation',
    '#type' => 'submit'
  );

  return $form;
}


function staff_create_course_mini_form_submit($form, &$form_state) {

  $_SESSION['eduerp_showFullForm'] = 1;
  //load default course_grade_weightings
  $_SESSION['eduerp_course_grade_weightings'] = get_course_grade_weighting();
}


function get_Staff_in_Department($department_nid = 0, $staff_uid = 0) {
  $where = "";
  if ($department_nid != 0) {
    $where = " WHERE er.department_id=". $department_nid ."";
  }
  elseif ($staff_uid != 0)
      $where = " WHERE ur.uid = ". $staff_uid ." ";

  $sql = "
  SELECT ur.uid,
      CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS name
    FROM {users_roles} ur
    INNER JOIN {role} r ON ur.rid=r.rid AND name='Staff'
    LEFT JOIN {node} npro ON ur.uid=npro.uid AND npro.type='profile'
    LEFT JOIN {content_type_profile} pro ON npro.vid=pro.vid
    LEFT JOIN {eduerp_roles} er ON ur.uid=er.uid AND er.role='Academic Staff'
    LEFT JOIN {content_type_department} d ON er.department_id=d.nid
    LEFT JOIN {content_type_college} c ON er.college_id=c.nid
    ". $where ."
    ORDER BY name
  ";//GROUP BY ur.uid ORDER BY name

  $result = db_query($sql);

  if (db_affected_rows($result) > 0) {
    while($row = db_fetch_object($result)){
      $stafflist[$row->uid] = $row->name;
    }
  }
  else {
    $stafflist[] = strip_tags(Error_Types(106));
  }
  return $stafflist;
}


function staff_show_assign_course() {
  global $departmentInfo, $canCreateModify;

  //because of referal from LIST OF COURSES NOT RUNNING, WE SHALL DEFAULT THE SESSION AND SEMESTER
  if(isset($_SESSION['eduerp_fix_course'])) {
    $_SESSION['eduerp_assign_course_session'] = $_SESSION['eduerp_fix_course']->session;
    $_SESSION['eduerp_assign_course_semester'] = $_SESSION['eduerp_fix_course']->semester;
  }
  if(! isset($_SESSION['eduerp_assign_course_session'])) variable_get('eduerp_current_session', '');
  if(! isset($_SESSION['eduerp_assign_course_semester'])) variable_get('eduerp_current_semester', '');

  //variable_get('eduerp_current_session', '') variable_get('eduerp_current_semester', '')
  if (arg(3))
    echo "<b>Modify Assigned Lecturers and Timetables for Courses</b> | Sesssion: <b>". $_SESSION['eduerp_assign_course_session'] ."</b> | Semester: <b>". $_SESSION['eduerp_assign_course_semester'] ."</b><br /><br />";
  else
    echo "<b>Assign Lecturers and Timetables for Courses</b> | Sesssion: <b>". $_SESSION['eduerp_assign_course_session'] ."</b> | Semester: <b>". $_SESSION['eduerp_assign_course_semester'] ."</b><br /><br />";

  //echo "Below is a list of all availabel Staff and Course(s) that belong to <b>". $departmentInfo[arg(2)] ."</b> Department.<br /><br />";
  if ($canCreateModify)
    echo drupal_get_form('staff_assign_course_form');
  else{
    //echo Error_Types(104);
    drupal_set_message(Error_Types(104), 'error');
  }


  if (! arg(3)) {
    //show edit form
    echo '<br /><hr /><br />';
    echo "<b>Modify Assigned Lecturers and Timetables for Courses</b><br /> ";
    if ($canCreateModify)
      echo drupal_get_form('staff_edit_assigned_course_form');
    else{
      //echo Error_Types(105);
     drupal_set_message(Error_Types(105), 'error');
    }

    //display missing courses in the department here
    echo '<br /><hr /><br />';
    echo staff_display_available_courses($_SESSION['eduerp_assign_course_session'], $_SESSION['eduerp_assign_course_semester'], $departmentInfo, 3);

    //display unassigned existing courses in the department here
    //echo '<br /><hr /><br />';
    //echo staff_display_available_courses($departmentInfo, 2);


    //display assigned existing courses in the department here
    //echo '<br /><hr /><br />';
    //echo staff_display_available_courses($departmentInfo, 1);
  }

  if(isset($_SESSION['eduerp_fix_course'])) unset($_SESSION['eduerp_fix_course']); if(isset($_SESSION['eduerp_return_url'])) unset($_SESSION['eduerp_return_url']);
}


function staff_assign_course_form() {
  if ($_SESSION['eduerp_fix_course']) //the user is trying to fix course issues
    $course_instance = $_SESSION['eduerp_fix_course'];

  //if (arg(3) && arg(2) && is_valid_course_instance(arg(3)) && course_instance_match_department_and_session(arg(2), arg(3), variable_get('eduerp_current_session', ''))) {
  if (arg(3) && arg(2) && is_valid_course_instance(arg(3)) && course_instance_match_department_and_session(arg(2), arg(3), $_SESSION['eduerp_assign_course_session'])) {
   //the record is already for the current session so no more checks...we are fine!
   $authorizeCourseEdit = true;
   if (empty($_POST['location'])) {//trying to edit
     $result = get_Course_Instance(arg(3));
     $course_instance = db_fetch_object($result);
     $courses[$course_instance->nid] = $course_instance->course_code;
   }
  }

  if(! isset($courses))
  $courses = course(arg(2), $_SESSION['eduerp_assign_course_semester']);

  $form['#title'] = 'Assign Lecturers and Timetable for Course';

  $form['course_nid'] = array(
  '#type' => 'select',
  '#options' => $courses,
  '#title' => 'Course Code',
  '#ahah' => array('path' => 'staff/ajax/getdeflecturer', 'event' => 'change', 'method' => 'replace', 'wrapper' => 'getdeflecturerz'),
  '#required'  => TRUE
  );

  if ($course_instance) $form['course_nid']['#default_value'] = $course_instance->field_course_id_nid;

  $form['chief_staff_nid'] = array(
      '#type' => 'select',
      '#options' => array(''=>'') + get_Staff_in_Department(), //arg(2)),
      '#title' => 'Chief Lecturer',
      '#attributes' => array(
      'style' => 'width:100px'),
      '#prefix' => "<div id='getdeflecturerz'>",
      '#suffix' => "</div>",
      '#disabled' => TRUE,
      '#required'  => TRUE

      );
  if ($course_instance) {$form['chief_staff_nid']['#default_value'] = $course_instance->field_lecturer_uid; $form['chief_staff_nid']['#disabled'] = FALSE; }

  $form['assist_staff_nid'] = array(
      '#type' => 'select',
      '#options' => array(0=>'N/A') + get_Staff_in_Department(), //arg(2)),
      '#title' => 'Assistant Lecturer'

      );
  if ($course_instance) $form['assist_staff_nid']['#default_value'] = (int) $course_instance->field_lecturer_alternate_uid ;

   $form['timetable'] = array(
      '#type' => 'textarea',
      '#title' => 'Time Table',
      '#required' => TRUE
      );
   if ($course_instance) $form['timetable']['#default_value'] = $course_instance->field_timetable_value;

   $form['showCourseAssignment'] = array( //used to keep showing the form
      '#type' => 'hidden',
      '#default_value' => 1
      );

  $form['submit'] = array(
      '#value' => 'Assign',
      '#type' => 'submit'
    );
  if (arg(3)) $form['submit']['#value'] = "Update Assignment";
  if(isset($_SESSION['eduerp_fix_course'])) unset($_SESSION['eduerp_fix_course']);
  return $form;
}


function staff_assign_course_proceed_form() {
  $form['#title'] = 'Start Assigning Lecturers to Courses';

  $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#title' => 'Session',
    '#default_value'=>variable_get('eduerp_current_session', ''),
    '#required' => TRUE,

    );
  $form['semester'] = array(
    '#type' => 'select',
    '#options' => array(1=>'1', 2=>'2', 3=>'3'),
    '#title' => 'Semester',
    '#default_value'=>variable_get('eduerp_current_semester', ''),
    '#required' => TRUE,

    );
  $form['submit'] = array(
    '#value' => 'Start Assigning Lecturers to Courses',
    '#type' => 'submit'
  );

  return $form;
}


function staff_assign_course_proceed_form_submit($form, &$state) {
  $values = $state['values'];
  $_SESSION['eduerp_assign_course_session'] = $values['session'];
  $_SESSION['eduerp_assign_course_semester'] = $values['semester'];
  $_SESSION['eduerp_showCourseAssignment'] = 1;
}


function staff_assign_course_form_validate($form, &$form_state) {
  //make sure it is unique for course/semester/session

  if (arg(3)) {//validate EDIT variable_get('eduerp_current_session', '') variable_get('eduerp_current_semester', '')
    if (is_course_assignment_existing($form_state['values']['course_nid'], $_SESSION['eduerp_assign_course_semester'], $_SESSION['eduerp_assign_course_session'], $form_state['values']['timetable'], arg(3))) {
      form_set_error('course_code', Error_Types(113));
    }

  }
  else {
    if (is_course_assignment_existing($form_state['values']['course_nid'], $_SESSION['eduerp_assign_course_semester'], $_SESSION['eduerp_assign_course_session'], $form_state['values']['timetable'])) {
      form_set_error('course_code', Error_Types(113));
    }
  }
}


function staff_assign_course_form_submit($form, &$form_state) {
  $_SESSION['eduerp_showCourseAssignment'] = 1;

  $course = db_fetch_object(get_Available_Courses(0,$form_state['values']['course_nid']));
  //if(! arg(3)) $_SESSION['eduerp_showFullForm'] = 1;
  if(arg(3)){

    $node =  node_load(arg(3));
    $node->title                              = $course->course_code .' - '. $_SESSION['eduerp_assign_course_session'] .' - '. $_SESSION['eduerp_assign_course_semester'] .' - '. $course->course_level .' - '. $form_state['values']['location']; //[Course Title] . ' - ' . [Session Name] . ' - ' . [Semester Name] . ' - ' . [Level Name];
    //$node->field_course_id[0]['nid']          = $form_state['values']['course_nid'];
    $node->field_lecturer[0]['uid']           = $form_state['values']['chief_staff_nid'];
    $node->field_lecturer_alternate[0]['uid'] = ($form_state['values']['assist_staff_nid'] != 0) ? $form_state['values']['assist_staff_nid'] : NULL;
    $node->field_sess_name[0]['value']        = $_SESSION['eduerp_assign_course_session'];
    $node->field_semester_name[0]['value']    = $_SESSION['eduerp_assign_course_semester'];
    $node->field_repeat[0]['value']           = ($_SESSION['eduerp_assign_course_semester'] == 3) ? 1 : 0;
    //$node->field_location[0]['value']         = $form_state['values']['location'];
    $node->field_timetable[0]['value']        = $form_state['values']['timetable'];
    node_save($node);
    drupal_set_message($course->course_code .' Course was updated!<br />');

    drupal_goto("staff/createeditcourse/" . arg(2));
  }
  else {
    $location = 1;
    //this check is to know wether to increase the value of Location
    if (is_course_assignment_existing($form_state['values']['course_nid'], $_SESSION['eduerp_assign_course_semester'], $_SESSION['eduerp_assign_course_session'], $form_state['values']['timetable'], 0, true )) {
      //it means this course already has an instance for the semester and for the session
      //now get the max Location ID
      $max = get_Max_Location_ID($form_state['values']['course_nid'], $_SESSION['eduerp_assign_course_semester'], $_SESSION['eduerp_assign_course_session']);
      $location = $max->num + 1;

    }
    // course_instance CCK
    $node = new stdClass();
    $node->type                               = 'course_instance';
    $node->uid                                = 1;  // Admin
    $node->status                             = 1;  // Published
    $node->promote                            = 0;
    $node->sticky                             = 0;
    $node->comment                            = 0;
    $node->title                              = $course->course_code .' - '. variable_get('eduerp_current_session', '') .' - '. variable_get('eduerp_current_semester', '') .' - '. $course->course_level .' - '. $form_state['values']['location']; //[Course Title] . ' - ' . [Session Name] . ' - ' . [Semester Name] . ' - ' . [Level Name];
    $node->field_course_id[0]['nid']          = $form_state['values']['course_nid'];
    $node->field_lecturer[0]['uid']           = $form_state['values']['chief_staff_nid'];
    $node->field_lecturer_alternate[0]['uid'] = ($form_state['values']['assist_staff_nid'] != 0) ? $form_state['values']['assist_staff_nid'] : NULL;
    $node->field_sess_name[0]['value']        = $_SESSION['eduerp_assign_course_session'];
    $node->field_semester_name[0]['value']    = $_SESSION['eduerp_assign_course_semester'];
    $node->field_repeat[0]['value']           = ($_SESSION['eduerp_assign_course_semester'] == 3) ? 1 : 0;;
    $node->field_location[0]['value']         = $location;
    $node->field_timetable[0]['value']        = $form_state['values']['timetable'];

    //$course_instance = $node->nid;

    drupal_set_message($course->course_code. ' Course has been Assigned!<br />');
  }

  node_save($node);
  if ($_SESSION['eduerp_return_url']) drupal_goto($_SESSION['eduerp_return_url']);

}


function staff_edit_assigned_course_form(){
  $form['#title'] = 'Update Assigned Courses';
 //get all assigned courses for the department
 $assigned = get_Assigned_Courses($_SESSION['eduerp_assign_course_session'], arg(2), $_SESSION['eduerp_assign_course_semester']);
 if (db_affected_rows() > 0) {
   while ($row = db_fetch_object($assigned)){
     if ($row->course_instance_id != "")
       $assignedCourses[$row->course_instance_id] = check_plain($row->code);
   }
 }
 else
   $assignedCourses[] = strip_tags(Error_Types(106));

 $form['course_instance_nid'] = array(
      '#type' => 'select',
      '#options' => $assignedCourses,
      '#title' => 'Course Code');
 $form['showCourseAssignment'] = array( //used to keep showing the form
      '#type' => 'hidden',
      '#default_value' => 1
      );
 $form['submit'] = array(
      '#value' => 'Modify Assignment',
      '#type' => 'submit'
    );

  return $form;
}


function staff_edit_assigned_course_form_validate($form, &$form_state) {
  if ($form_state['values']['course_instance_nid'] == '0')
    form_set_error('course_instance_nid', Error_Types(114));
}


function staff_edit_assigned_course_form_submit($form, $form_state) {
  $_SESSION['eduerp_showCourseAssignment'] = 1;
  drupal_goto("staff/createeditcourse/" . arg(2) .'/'. $form_state['values']['course_instance_nid']);
}


function get_Assigned_Courses($session, $department_nid, $semester) {
  $sql = "SELECT
  ci.nid AS course_instance_id,
  CONCAT(c.field_code_value, IF(ci.field_location_value > 1, CONCAT(' (', CAST(ci.field_location_value AS CHAR), ': ', LEFT(ci.field_timetable_value, 100), ')'), '')) AS code
  FROM {content_type_course} c, {content_type_course_instance} ci
    WHERE
      c.field_department_nid_nid=%d AND
      c.nid=ci.field_course_id_nid AND
      ci.field_sess_name_value='%s' AND
      ci.field_semester_name_value='%s'
      ORDER BY code";
      $r = db_query($sql,$department_nid, $session, $semester);
  return $r;
}


function get_department_running_courses($session, $department_nid, $semester = 0) {
  $morewhere = "";
  if ($semester != 0)
    $morewhere = " pc.semester='". $semester ."' AND ";

  $sql = "SELECT DISTINCT
        pc.level course_level,
        c.field_code_value course_code,
        p.field_programme_name_value programme_name,
        d.field_department_name_value dept_name,
        co.field_college_name_value,
        ci.nid clean_nid,
        ci.field_lecturer_uid lecturer_uid,
        pc.credit_load AS credit_load,
        field_prerequisite_codes_value AS prerequisite_codes,
        field_prerequisite_value AS prerequisite_desc,
        pc.semester course_semester,
        field_course_description_value AS course_description,
        field_coursetitle_value AS course_title,
        c.nid nid
      FROM {program_course} pc
      INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
      LEFT JOIN {content_type_course_instance} ci
      ON
        c.nid=ci.field_course_id_nid AND
        pc.semester=ci.field_semester_name_value AND
        ci.field_sess_name_value='". $session ."'
      INNER JOIN {content_type_program} p ON pc.programme_id=p.nid
      INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
      INNER JOIN {content_type_college} co ON d.field_college_id_nid=co.nid
      WHERE  $morewhere d.nid='". $department_nid ."'
      ORDER BY co.field_college_name_value, d.field_department_name_value, c.field_code_value, p.field_programme_name_value, pc.level ";
    $r = db_query($sql);
  return $r;
}


function get_unassigned_courses($session, $department_nid = 0) {
  // ALAN 20110109 Does not seem to be used, verify and remove
  $where = ""; $args = "";
  if ($department_nid != 0) {
     $where = "
     WHERE k.nid NOT IN (
        SELECT course.field_course_id_nid
    FROM {content_type_course_instance} AS course
    INNER JOIN {content_type_course} AS q ON q.nid = course.field_course_id_nid
    INNER JOIN {content_type_department} AS dept ON q.field_department_nid_nid = dept.nid
    WHERE dept.nid =$department_nid AND course.field_sess_name_value = '". $session ."' )
  AND k.field_department_nid_nid =$department_nid ";
  }

  $sql = "
  SELECT k.nid nid, field_level_value AS course_level, field_code_value AS course_code, field_coursetitle_value AS course_title,
      field_creditload_value AS credit_load, field_prerequisite_value AS prerequisite_desc, field_prerequisite_codes_value AS prerequisite_codes,
      field_semester_value AS course_semester, field_course_description_value AS course_description, field_department_name_value AS dept_name,
      field_college_name_value AS fac_name, field_college_abbreviation_value AS fac_abbr, field_programme_name_value programme_name
      FROM {content_type_course} AS k
      INNER JOIN {content_type_department} AS d ON k.field_department_nid_nid = d.nid
      INNER JOIN {content_type_college} AS c ON d.field_college_id_nid = c.nid
      INNER JOIN {content_type_program} AS p ON p.field_department_id_nid = d.nid
      ". $where ."
      ORDER BY field_college_name_value, dept_name, programme_name, course_level, course_code ";


  $r = db_query($sql);

  return $r;
}


function get_Max_Location_ID($course_nid, $semester, $session) {
  $result = db_query("SELECT IFNULL(MAX(field_location_value), 0) num FROM {content_type_course_instance}
      WHERE field_course_id_nid=%d AND field_semester_name_value='%s' AND field_sess_name_value='%s' ", $course_nid, $semester, $session);
  return $row = db_fetch_object($result);
}


function is_course_assignment_existing($course_nid, $semester, $session, $timetable, $instance_nid = 0, $for_location_checks=false) {
  if ($for_location_checks) {//no need to include timetable
    if ($instance_nid != 0) {
      $result = db_query("SELECT nid FROM {content_type_course_instance}
      WHERE field_course_id_nid=%d AND field_semester_name_value='%s' AND field_sess_name_value='%s' AND nid !=%d ", $course_nid, $semester, $session, $instance_nid);

    }
    else {
      $result = db_query("SELECT nid FROM {content_type_course_instance}
      WHERE field_course_id_nid=%d AND field_semester_name_value='%s' AND field_sess_name_value='%s' ", $course_nid, $semester, $session);
    }

  }
  else {//include timetable
    if ($instance_nid != 0) {
      $result = db_query("SELECT nid FROM {content_type_course_instance}
      WHERE field_course_id_nid=%d AND field_semester_name_value='%s' AND field_sess_name_value='%s' AND nid !=%d AND field_timetable_value = '%s' ", $course_nid, $semester, $session, $instance_nid, $timetable);

    }
    else {
      $result = db_query("SELECT nid FROM {content_type_course_instance}
      WHERE field_course_id_nid=%d AND field_semester_name_value='%s' AND field_sess_name_value='%s'  AND field_timetable_value = '%s' ", $course_nid, $semester, $session, $timetable);
    }
  }
  if (db_affected_rows() > 0) return true;

  return false;

}


function get_Course_Instance($course_instance_nid) {
  $result = db_query("SELECT field_code_value course_code, ci.nid, ci.field_lecturer_uid, ci.field_sess_name_value, ci.field_semester_name_value, ci.field_lecturer_alternate_uid, ci.field_repeat_value, ci.field_course_id_nid,  ci.field_location_value, ci.field_timetable_value
      FROM {content_type_course_instance} ci
      INNER JOIN {content_type_course} c0 ON ci.field_course_id_nid = c0.nid
      WHERE ci.nid=%d ", $course_instance_nid);
  return $result;
}


function staff_create_edit_programme() {
  global $user, $programmeInfo, $canCreateModify, $authorizeEdit;
  $canCreateModify = false;
  //$hideOthers = false;

  if (isset($_SESSION['eduerp_showOn'])) $_POST['showOn'] = 1;
  if (isset($_SESSION['eduerp_showCourseAssignment'])) $_POST['showCourseAssignment'] = 1;
  ob_start();
  echo '<br /><hr /><br />';
  $authorizeEdit = false;

  //check if user is trying to edit record
  if (arg(2) && is_valid_programme(arg(2))) {//the programme is valid
    //get the programme info
    $programmeInfo = db_fetch_object(get_programmes(arg(2)));
    $authorizeEdit = true;$hideOthers=true;
    /*
    if (isset($_POST['showCourseAssignment'])) {
        //allow for some easy navigation
        $navi = "<font size = '1px'><a href = '/staff/semester/'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '/staff/createmodifyprog'>Create/Modify a Programme</a>&nbsp; &raquo; &nbsp;<a href = '/staff/createmodifyprog/". arg(2) ."'>". $programmeInfo->programme_name ." Programme</a>&nbsp; &raquo; &nbsp;<b>Course Assignment</b></font><br /><br />";
        $navi .= '<br /><hr /><br />';
        echo $navi;
        echo show_Specify_Course_for_Programme();
        $hideOthers=true;
    }
    */
    //else {
      //allow for some easy navigation
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createmodifyprog') ."'>Create/Modify a University Programme</a>&nbsp; &raquo; &nbsp;Modify Programme: <b>". $programmeInfo->programme_name . ' ('. $programmeInfo->programme_abbr . ')' ."</b></font><br /><br />";
      $navi .= '<br /><hr /><br />';

      if (! isset($_POST['showOn'])) {
        echo $navi;
        echo "<b>Modify Programme...Step 1 of 2</b> - Please make all required changes<br /><br />";
        echo drupal_get_form('staff_create_programme_form');
        //$hideOthers = true;
      }
      else {
        echo $navi;
        echo drupal_get_form('staff_create_programme_back_form') . "<br />";
        echo "<b>Modify Programme continued...Step 2 of 2</b> - Please make all required changes<br /><br />";
        if (isset($_POST['showOn'])) {
          echo "Programme Name: <b>" . $_SESSION['eduerp_bkinfo']->programme_name . "</b><br /><br />";
          echo "Programme Duration: <b>" . $_SESSION['eduerp_bkinfo']->duration . "</b><br />";
        }
        echo drupal_get_form('staff_create_programme_form2') . "<br />";
        echo drupal_get_form('staff_create_programme_back_form') . "<br />";
        //echo drupal_get_form('staff_create_programme_cancel_form');
      }
    //}
  }
  else { //not in edit mode

    //allow for some easy navigation
    echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Create/Modify a Programme</font><br /><br />";
    echo '<br /><hr /><br /><br />';

    if (! isset($_POST['showOn'])) {
      echo "<b>Create Programme...Step 1 of 2</b> - Please fill the form<br /><br />";
      echo drupal_get_form('staff_create_programme_form');


      echo '<br /><hr /><br />';
      echo "<b>Modify Programme</b> - Select a Programme to modify it<br /><br />";
      echo drupal_get_form('staff_modify_programme_form');

      echo '<br /><hr /><br />';
      echo '<b>Specify Courses for a Programme</b> - Click to proceed with specifying course for a programme<br /><br />';
      echo drupal_get_form('staff_specify_course_proceed_form');


      echo '<br /><hr /><br />';
      echo '<b>Verify all Courses needed for a Programme are being run for a Semester</b> - Click to proceed with verifying courses<br /><br />';
      echo drupal_get_form('staff_verify_course_proceed_form');

      //display existing programmes here
      echo '<br /><hr /><br />';
      echo staff_display_available_programmes($programmeInfo);

    }
    else {
      echo drupal_get_form('staff_create_programme_back_form') . "<br />";
      echo "<b>Create Programme continued...Step 2 of 2</b> - Please fill the form<br /><br />";
      if (isset($_POST['showOn'])) {
        echo "Programme Name: <b>" . $_SESSION['eduerp_bkinfo']->programme_name . "</b><br /><br />";
        echo "Programme Duration: <b>" . $_SESSION['eduerp_bkinfo']->duration . "</b><br />";

      }
      echo drupal_get_form('staff_create_programme_form2') . "<br />";
      echo drupal_get_form('staff_create_programme_back_form') . "<br />";
      //echo drupal_get_form('staff_create_programme_cancel_form');
    }


  }


  unset($_SESSION['eduerp_showOn']); unset($_SESSION['eduerp_goBack']);

  return ob_get_clean();

}


function staff_create_programme_form() {
  global $authorizeEdit, $programmeInfo;

 //i am now using global variables as u can see above. Before getting here (for editing), most checks have been done. lets not do anymore db calls hmmm..
 if (isset($_SESSION['eduerp_goBack']) && $_SESSION['eduerp_bkinfo']) {$programme = $_SESSION['eduerp_bkinfo']; }

  if ($authorizeEdit) {
    if (empty($_POST['programme_name'])) {//trying to edit
      //check if data exists in program_level_semester
      if($_SESSION['eduerp_bkinfo'])
        $programme = $_SESSION['eduerp_bkinfo'];
      else
        $programme = $programmeInfo; //$_SESSION['eduerp_bkinfo']; //$programmeInfo;
      //ok fine we need to get the previous start_level that was set

      $result = db_query("SELECT * FROM {program_level_semester} WHERE programme_id = %d ORDER BY level ",arg(2));
      if (db_affected_rows($result) > 0) {
        $row = db_fetch_object($result);
        $programmeInfo->start_level = $row->level;
      }

    }
  }

  $form['#title'] = 'Create New Programme';
  $form['programme_name'] = array(
    '#title' => 'Programme Name',
    '#type' => 'textfield',
    '#size' => 100,
    '#required' => TRUE
  );
  if ($programme) $form['programme_name']['#default_value'] = $programme->programme_name;

  $form['programme_abbr'] = array(
    '#type' => 'textfield',
    '#title' => 'Programme Abbreviation',
    '#required' => TRUE
  );
  if ($programme) $form['programme_abbr']['#default_value'] = $programme->programme_abbr;

  //during modification, department_nid should not be changed so lets deal with it
  if ($programme) {//for modification
    $id = $programme->department_nid;
  }
  else {
    $id = 0;
  }

  $form['department_nid'] = array(
    '#type' => 'select',
    '#options' => department($id),
    '#title' => 'Department');
  if ($programme) $form['department_nid']['#default_value'] = $programme->department_nid;

  $form['duration'] = array(
    '#title' => 'Programme Duration - Duration in years of this programme e.g. 4',
    '#type' => 'textfield',
    '#size' => 2,
    '#required' => TRUE
  );
  if ($programme) $form['duration']['#value'] = $programme->duration;

  $form['max_duration'] = array(
    '#title' => 'Maximum Duration - Maximum semesters a student may spend completing this programme e.g. 12',
    '#type' => 'textfield',
    '#size' => 2,
    '#required' => TRUE
  );
  if ($programme) $form['max_duration']['#value'] = $programme->max_duration;

  $form['min_credit_load'] = array(
    '#title' => 'Minimum Credit Load - Minimum completed credit load before graduation',
    '#type' => 'textfield',
    '#size' => 4,
    '#required' => TRUE
  );
  if ($programme) $form['min_credit_load']['#value'] = $programme->min_credit_load;

  $form['programme_type'] = array(
    '#type' => 'select',
    '#options' => programme_types(),
    '#title' => 'Programme Type',
    '#required' => TRUE);
  if ($programme) $form['programme_type']['#default_value'] = $programme->programme_type;

  $form['start_level'] = array(
    '#type' => 'select',
    '#options' => array(100 => '100', 1 => '1'),
    '#title' => 'Start Level',
    '#required' => TRUE);
  if ($programme) $form['start_level']['#default_value'] = $programme->start_level;


  $form['submit'] = array(
    '#value' => 'Continue',
    '#type' => 'submit'
  );
  if ($authorizeEdit || isset($_POST['showOn'])) $form['submit']['#value'] = 'Continue Update Programme';

  return $form;

}


function staff_create_programme_form_validate($form, &$form_state) {
  global $user;
  unset($_SESSION['eduerp_bkinfo']);
  //make sure he can create/modify

  if (staff_has_eduerp_role($user->uid, $form_state['values']['department_nid'], 0, array('Head of Department', 'Department Grade Editor'))) {

    //make sure no duplicates
    if (arg(2)) {//validate EDIT
      if (is_Programme_Name_Existing($form_state['values']['programme_name'], arg(2)))
        form_set_error('programme_name', Error_Types(101));

      if (is_Programme_Abbr_Existing($form_state['values']['programme_abbr'], arg(2)))
        form_set_error('programme_abbr', Error_Types(120));
    }
    else {//validate CREATE
      if (is_Programme_Name_Existing($form_state['values']['programme_name']))
        form_set_error('programme_name', Error_Types(115));

      if (is_Programme_Abbr_Existing($form_state['values']['programme_abbr']))
        form_set_error('programme_abbr', Error_Types(120));
    }

    //validate for int entry

    if(! preg_match("/^[0-9]{1,2}$/", trim($form_state['values']['duration'])) || $form_state['values']['duration'] <= 0) form_set_error('duration', Error_Types(107));


    if(! preg_match("/^[0-9]{1,2}$/", trim($form_state['values']['max_duration'])) || $form_state['values']['max_duration'] <= 0) form_set_error('max_duration', Error_Types(107));


    if(! preg_match("/^[0-9]{1,3}$/", trim($form_state['values']['min_credit_load'])) || $form_state['values']['min_credit_load'] <= 0) form_set_error('min_credit_load', Error_Types(107));

    // Security checks
    $text = $form_state['values']['programme_name'];
    if (!empty($text)) {
      if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
        form_set_error('programme_name', Error_Types(168));
      }
    }
    $text = $form_state['values']['programme_abbr'];
    if (!empty($text)) {
      if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
        form_set_error('programme_abbr', Error_Types(168));
      }
    }
  }
  else
    form_set_error('department_nid', Error_Types(117));
}


function staff_create_programme_form_submit($form, &$form_state) {

  //the form has been validated. put all in a session variable and show the next form
  $_SESSION['eduerp_showOn'] = 2; $_POST['showOn'] = 2;
  foreach ($form_state['values'] as $k  => $v)
    $bkinfo->{$k} = $v;

  $_SESSION['eduerp_bkinfo'] = $bkinfo;

}


function staff_create_programme_form2() {
  global $authorizeEdit;
  if (isset($_SESSION['eduerp_bkinfo'])) {

    $form['#title'] = 'Create New Programme continued...';
    if ($authorizeEdit && empty($_POST['credit_desc11'])) {
      //check if previous rec exists in program_level_semester table
      $result = db_query("SELECT * FROM {program_level_semester} WHERE programme_id = %d ORDER BY level", arg(2));
      if (db_affected_rows($result) > 0 && db_affected_rows($result) ==  ($_SESSION['eduerp_bkinfo']->duration * 2)) {
        //the record is up for edit and the user did not change the duration. so show whats in the db as defaults
        if (strlen($_SESSION['eduerp_bkinfo']->start_level) > 1) $mul = 100; else $mul = 1;$id=$mul;$g=1;
        while($row = db_fetch_object($result)) {
          $credit_desc[$id][$row->semester] = $row->min_credit_load .', '. $row->max_credit_load;
          if ($g >= 2) {$id += $mul; $g=1;} else $g++;
        }
      }
    }

    for ($i = 1; $i <= $_SESSION['eduerp_bkinfo']->duration; $i++) {
      for ($p = 1; $p <= 2; $p++) {
        $form['credit_desc'.$i.$p] = array(
          '#title' => 'Level '. $i * $_SESSION['eduerp_bkinfo']->start_level .', Semester '. $p .':<br /> Minimum and Maximum Credit Load a Student is allowed select when Registering Courses for this Semester. Note: (The Min and Max must be separated by \', \' e.g. 10,60) ',
          '#type' => 'textfield',
          '#size' => 10,
          '#required' => TRUE
        );
        if ($credit_desc) $form['credit_desc'.$i.$p]['#default_value'] = $credit_desc[$i * $_SESSION['eduerp_bkinfo']->start_level][$p];
        //we need to override the above line of some data previously existed on this page
        //if(isset($_SESSION['eduerp_page_2_bkinfo'][$i.$p]))
        //  $form['credit_desc'.$i.$p]['#default_value'] = $_SESSION['eduerp_page_2_bkinfo'][$i.$p]; //$credit_desc[$i * $_SESSION['eduerp_bkinfo']->start_level][$p];
      }

    }
   $form['showOn'] = array(//keep showing the form
    '#title' => 'Show On',
    '#type' => 'hidden',
    '#default_value' => 1
  );

    $form['submit'] = array(
      '#value' => 'Create Programme',
      '#type' => 'submit'
    );
    if ($authorizeEdit) $form['submit']['#value'] = 'Update Programme';

    return $form;
  }
}


function staff_create_programme_form2_validate($form, &$form_state) {

  for ($i = 1; $i <= $_SESSION['eduerp_bkinfo']->duration; $i++) {
      for ($p = 1; $p <= 2; $p++) {
        if (strpos($form_state['values']['credit_desc'.$i.$p], ",")) {
          $prog_credit_load = explode(',', $form_state['values']['credit_desc'.$i.$p]);
          if (sizeof($prog_credit_load) != 2) form_set_error('credit_desc'.$i.$p, Error_Types(118)); //not in expected format

          else {//check each to match int
            foreach ($prog_credit_load as $v) {
                if(! preg_match("/^[0-9]{1,3}$/", trim($v))) form_set_error('credit_desc'.$i.$p, Error_Types(107));
            }
            if ($prog_credit_load[0] > $prog_credit_load[1]) form_set_error('credit_desc'.$i.$p, Error_Types(119)); //min shld not b greater than max
          }
        }
        else{
          form_set_error('credit_desc'.$i.$p, Error_Types(118)); //not in expected format

        }

      }
    }
}


function staff_create_programme_form2_submit($form, &$form_state) {

  if(arg(2)){
    $node =  node_load(arg(2));
    $node->title                            = $_SESSION['eduerp_bkinfo']->programme_name;
    $node->field_programme_name[0]['value'] = $_SESSION['eduerp_bkinfo']->programme_name;
    $node->field_programme_abbr[0]['value'] = $_SESSION['eduerp_bkinfo']->programme_abbr;
    $node->field_department_id[0]['nid']    = $_SESSION['eduerp_bkinfo']->department_nid;
    $node->field_duration[0]['value']       = $_SESSION['eduerp_bkinfo']->duration;
    $node->field_max_duration[0]['value']   = $_SESSION['eduerp_bkinfo']->max_duration;
    $node->field_min_credit_load_program[0]['value'] = $_SESSION['eduerp_bkinfo']->min_credit_load;
    $node->field_program_type[0]['value']   = $_SESSION['eduerp_bkinfo']->programme_type;

    node_save($node);
    drupal_set_message($_SESSION['eduerp_bkinfo']->programme_name .' Programme was updated!<br />');

    //get the status of open_for_registrations for the program
    $sql = "SELECT programme_id, level, semester, open_for_registrations FROM program_level_semester WHERE programme_id = '". arg(2) ."'";
    $rs = db_query($sql);
    //arrange in 2 dim array
    while($r = db_fetch_object($rs)){
      $open_for_reg_value[$r->level][$r->semester] = $r->open_for_registrations;

    }

    //delete all entries reping the programme.
    db_query("DELETE FROM program_level_semester WHERE programme_id = '". arg(2) ."'");

    //insert program_level_semester
    if (isset($_SESSION['eduerp_bkinfo'])) {
      $sql = "INSERT INTO program_level_semester (programme_id, level, semester, min_credit_load, max_credit_load, open_for_registrations) VALUES  ";
      for ($i = 1; $i <= $_SESSION['eduerp_bkinfo']->duration; $i++) {
        for ($p = 1; $p <= 2; $p++) {
          $level = $_SESSION['eduerp_bkinfo']->start_level * $i;
          $open_for_reg = isset($open_for_reg_value[$level][$p]) ? $open_for_reg_value[$level][$p] : 0;
          $prog_credit_load = explode(',', $form_state['values']['credit_desc'.$i.$p]);
          $sql .= "('". arg(2) ."', '". $level ."', '". $p ."', '". trim($prog_credit_load[0]) ."', '". trim($prog_credit_load[1]) ."', '". $open_for_reg ."' ), ";
        }

      }
      $sql = substr($sql, 0, -2);
      db_query($sql);
      unset($_SESSION['eduerp_bkinfo']);
    }
    $_POST['showOn'] = null;
    $_SESSION['eduerp_showOn'] = null;
    drupal_goto("staff/createmodifyprog");
  }
  else {

    // program CCK
    $node = new stdClass();
    $node->type                             = 'program';
    $node->uid                              = 1;  // Admin
    $node->status                           = 1;  // Published
    $node->promote                          = 0;
    $node->sticky                           = 0;
    $node->comment                          = 0;
    $node->title                            = $_SESSION['eduerp_bkinfo']->programme_name;
    $node->field_programme_name[0]['value'] = $_SESSION['eduerp_bkinfo']->programme_name;
    $node->field_programme_abbr[0]['value'] = $_SESSION['eduerp_bkinfo']->programme_abbr;
    $node->field_department_id[0]['nid']    = $_SESSION['eduerp_bkinfo']->department_nid;
    $node->field_duration[0]['value']       = $_SESSION['eduerp_bkinfo']->duration;
    $node->field_max_duration[0]['value']   = $_SESSION['eduerp_bkinfo']->max_duration;
    $node->field_min_credit_load_program[0]['value'] = $_SESSION['eduerp_bkinfo']->min_credit_load;
    $node->field_program_type[0]['value']   = $_SESSION['eduerp_bkinfo']->programme_type;
    node_save($node);
    $programme_nid = $node->nid;
    drupal_set_message($_SESSION['eduerp_bkinfo']->programme_name .' Programme was created!<br />');

    //insert into program_level_semester
    if (isset($_SESSION['eduerp_bkinfo'])) {
      $sql = "INSERT INTO program_level_semester (programme_id, level, semester, min_credit_load, max_credit_load, open_for_registrations) VALUES  ";
      for ($i = 1; $i <= $_SESSION['eduerp_bkinfo']->duration; $i++) {
        for ($p = 1; $p <= 2; $p++) {
          $prog_credit_load = explode(',', $form_state['values']['credit_desc'.$i.$p]);
          $level = $_SESSION['eduerp_bkinfo']->start_level * $i;
          $sql .= "('". $programme_nid ."', '". $level ."', '". $p ."', '". trim($prog_credit_load[0]) ."', '". trim($prog_credit_load[1]) ."', 0), ";
        }

      }
      $sql = substr($sql, 0, -2);
      db_query($sql);
      unset($_SESSION['eduerp_bkinfo']);
    }
  }
  $_POST['showOn'] = null;
  $_SESSION['eduerp_showOn'] = null;
}


function staff_create_programme_back_form() {
  //$form['#title'] = 'Create New Programme Back';
  $form['showOn'] = array(//keep showing the form
    '#title' => 'Show On',
    '#type' => 'hidden',
    '#default_value' => 1
  );

  $form['submit'] = array(
      '#value' => 'go Back',
      '#type' => 'submit'
    );

    return $form;
}


function staff_create_programme_back_form_validate($form, &$form_state) {
  $_SESSION['eduerp_goBack'] = 1;



}


function staff_create_programme_back_form_submit($form, &$form_state) {
  $_SESSION['eduerp_goBack'] = 1;
  $_SESSION['eduerp_showOn'] = null;
  //$_POST['showOn'] = null;

}


function staff_create_programme_cancel_form() {
  $form['#title'] = 'Create New Programme Cancel';
  $form['submit'] = array(
      '#value' => 'Cancel',
      '#type' => 'submit'
    );

    return $form;
}


function staff_create_programme_cancel_form_submit($form, &$form_state) {
  ;

}


function programme_types() {
 return array(1 => 'Full Time Undergraduate', 2 => 'Part Time Undergraduate', 3 => 'Medicine Type Grades', '-1' => 'Closed to new entrants, Full Time Undergraduate', '-2' => 'Closed to new entrants, Part Time Undergraduate', '-3' => 'Closed to new entrants, Medicine Type Grades');
}


function staff_modify_programme_form(){
  $form['#title'] = 'Modify Programme';


    $form['programme_nid'] = array(
      '#type' => 'select',
      '#options' => programme(),
      '#title' => 'Programme Name');

    $form['submit'] = array(
      '#value' => 'Modify Programme',
      '#type' => 'submit'
    );


  return $form;
}


function staff_modify_programme_form_validate($form, &$form_state) {
  global $user;
  unset($_SESSION['eduerp_bkinfo']);
  //get the department attached to the programme

  $program = get_programmes($form_state['values']['programme_nid']);
  if (db_affected_rows($program) > 0) {
    $programInfo = db_fetch_object($program);
    if (staff_has_eduerp_role($user->uid, $programInfo->department_nid, 0, array('Head of Department', 'Department Grade Editor'))) {
      $authorizeEdit = true;

    }
    else
      form_set_error('programme_nid', Error_Types(121));
  }
  else
    form_set_error('programme_nid', Error_Types(114));


}


function staff_modify_programme_form_submit($form, &$form_state) {
  drupal_goto("staff/createmodifyprog/" . $form_state['values']['programme_nid']);
}


function staff_specify_course_for_programme() {
  global $user, $programmeInfo, $canCreateModify, $progCourse;
  ob_start();
  $programmeInfo = db_fetch_object(get_programmes(arg(2)));
  $canCreateModify = false;

  if (! arg(2) || ! is_valid_programme(arg(2)))
    drupal_goto("/staff/createmodifyprog");

  if (staff_has_eduerp_role($user->uid, $programmeInfo->department_nid, 0, array('Head of Department', 'Department Grade Editor')))
    $canCreateModify = true;
  if (arg(3)) {
    if (! is_valid_programme_course_id(arg(2), arg(3)))
      drupal_goto("/staff/specifycourse/". arg(2));
    else {
        $sql = "SELECT course_id, programme_id, level, semester, course_type, lecturer_id  FROM {program_course} WHERE program_course_id=%d";
        $sql = "SELECT course_id, programme_id, level, semester, course_type, lecturer_id, credit_load FROM {program_course} WHERE program_course_id=%d";
        $rs = db_query($sql, arg(3));
        $progCourse = db_fetch_object($rs);

    }
  }

  $arg = arg(2);

  $delete_assignment_js =<<< EOD
  function delete_assignment(id) {

    if (confirm('Are you sure you want to delete this course assignment?')) {
      $.get('/staff/ajax/deleteassignprog/'+id, function(data) { location.href='/staff/specifycourse/$arg'; });
    }
  }


  function make_available(id) {
    if (confirm('Are you sure you want to make the Course available for New Registrations?')) {
      $.get('/staff/ajax/makeavailable/'+id, function(data) { location.href='/staff/specifycourse/$arg'; });
    }
  }
  function edit_assignment(id) {
      $.get('/staff/ajax/modifyassignprog/'+id, function(data) { location.href='/staff/specifycourse/$arg/'+id; });
  }
EOD;


  drupal_add_js($delete_assignment_js, 'inline');

  echo '<br /><hr /><br />';
  if (arg(3)) {
    $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createmodifyprog') ."'>Create/Modify a Programme</a>&nbsp; &raquo; &nbsp;<a href='". url('staff/specifycourse/'. arg(2)) ."'>Specify Course(s): <b>". $programmeInfo->programme_name ."</b> Programme</a>&nbsp; &raquo; &nbsp;Edit Course</font><br /><br />";
    $navi .= '<br /><hr /><br />';
    echo $navi;
    echo "<b>Modify Specified Course(s) for Programme</b> | Programme: <b>". $programmeInfo->programme_name ."</b><br /><br />"; //. variable_get('eduerp_current_session', '') ."</b> | Semester: <b>". variable_get('eduerp_current_semester', '') ."</b><br /><br />";
  }
  else {
    $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createmodifyprog') ."'>Create/Modify a Programme</a>&nbsp; &raquo; &nbsp;Specify Course(s): <b>". $programmeInfo->programme_name ."</b> Programme</font><br /><br />";
    $navi .= '<br /><hr /><br />';
    echo $navi;
    echo "<b>Specify Course(s) for Programme</b> | Programme: <b>". $programmeInfo->programme_name ."</b><br /><br />"; // variable_get('eduerp_current_session', '') ."</b> | Semester: <b>". variable_get('eduerp_current_semester', '') ."</b><br /><br />";

  }

  //echo "Below is a list of all availabel Course(s) that belong to <b>". $programmeInfo->department_name ."</b> Department.<br /><br />";

  if ($canCreateModify)
    echo drupal_get_form('staff_assign_course_to_programme_form');
  else{
    //echo Error_Types(104);
    drupal_set_message(Error_Types(104), 'error');
  }


  if(! arg(3)) {

    $runningCourse = get_programme_running_courses ($programmeInfo->programme_nid, variable_get('eduerp_current_session', ''), variable_get('eduerp_current_semester', '') );
    echo '<br /><hr /><br />';
    echo "<b>List of courses that need to be run this semester for ". $programmeInfo->programme_name  ." Programme</b><br/><br />";
    echo "<div id='assigned_courses'>";
    //show_running_courses($runningCourse);
    //drupal_set_message($programmeInfo->programme_nid);
    //course_specify_list($programmeInfo->programme_nid);
    course_specify_list($runningCourse);
    echo "</div>";

    echo '<br /><hr /><br />';
    echo "<b>Historical Courses not available for New Registrations</b><br/><br />";
    echo "<div id='assigned_courses'>";
    historical_course_list($programmeInfo->programme_nid);
    echo "</div>";
  }
  return ob_get_clean();
}


function staff_verify_assigned_course() {
  global $user, $all_sessions, $programmeInfo;
  ob_start();

  if (! arg(2) || ! is_valid_programme(arg(2)))
    drupal_goto("/staff/createmodifyprog");

  $all_sessions = get_all_sessions();
  $programmeInfo = db_fetch_object(get_programmes(arg(2)));
  echo '<br /><hr /><br />';
    $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/createmodifyprog') ."'>Create/Modify a Programme</a>&nbsp; &raquo; &nbsp;Verified Assigned Course(s): <b>". $programmeInfo->programme_name ."</b> Programme</font><br /><br />";
    $navi .= '<br /><hr /><br />';
    echo $navi;
    echo "<b>Verify all Courses needed for a Programme are being run for</b> | Session: <b>". $_SESSION['eduerp_verify']['session'] ."</b> | Semester: <b>". $_SESSION['eduerp_verify']['semester'] ."</b> | Programme: <b>". $programmeInfo->programme_name ."</b><br /><br />"; //. variable_get('eduerp_current_session', '') ."</b> | Semester: <b>". variable_get('eduerp_current_semester', '') ."</b><br /><br />";

    echo '<br /><hr /><br />';
    //run the verify code
    verify_assigned_courses($programmeInfo->programme_nid, $_SESSION['eduerp_verify']['session'], $_SESSION['eduerp_verify']['semester']);

    //test to see if all courses for the programme have been assigned
    $unassignedRecords = get_unassigned_for_programme($programmeInfo->programme_nid, $_SESSION['eduerp_verify']['session'], $_SESSION['eduerp_verify']['semester']);
    if (db_affected_rows($unassignedRecords) > 0) {
      //there are unassigned courses

      echo "<b>List of Missing Courses for <b>". $programmeInfo->programme_name  ."</b> Programme for ". $_SESSION['eduerp_verify']['session'] ." Session for Semester ". $_SESSION['eduerp_verify']['semester'] ."</b><br/><br />";
      echo "<div id='assigned_courses'>";
      display_course_result($unassignedRecords, true);
      echo "</div>";
      echo '<br /><hr /><br />';
    }
    else
      echo "<b>All Courses for ". $programmeInfo->programme_name ." HAVE BEEN VERIFIED (assigned a lecturer & timetable) for <b>". $_SESSION['eduerp_verify']['session'] ." Session</b> and <b>Semester ". $_SESSION['eduerp_verify']['semester'] ."</b>!!!</b><br /><br /><br /><hr /><br />";

    //test for unassigned courses for the programme
    $runningCourse = get_programme_running_courses ($programmeInfo->programme_nid, $_SESSION['eduerp_verify']['session'], $_SESSION['eduerp_verify']['semester']);

      echo "<b>List of Courses that need to be run for <b>". $programmeInfo->programme_name  ."</b> Programme for ". $_SESSION['eduerp_verify']['session'] ." Session for Semester ". $_SESSION['eduerp_verify']['semester'] ."</b><br/><br />";
      echo "<div id='assigned_courses'>";
      display_course_result($runningCourse);
      echo "</div><br /><br />";

      unset($_SESSION['eduerp_return_url']);
  return ob_get_clean();
}


function verify_assigned_courses($programme_nid, $session, $semester) {

  db_query("DELETE FROM {program_course_instance} WHERE session='%s' AND semester='%s' AND programme_id=%d", $session, $semester, $programme_nid);
   $sql = "INSERT INTO {program_course_instance}
     SELECT DISTINCT
       ci.nid AS course_instance_id,
       pc.programme_id AS programme_id,
       ci.field_sess_name_value AS session,
       ci.field_semester_name_value AS semester
     FROM {program_course} pc
     INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
     INNER JOIN {content_type_course_instance} ci
     ON
       c.nid=ci.field_course_id_nid AND
       pc.semester=ci.field_semester_name_value AND
       ci.field_sess_name_value='%s' AND
       ci.field_semester_name_value='%s'
     WHERE pc.programme_id=%d";
   $result = db_query($sql, $session, $semester, $programme_nid);

}


function show_verified_assigned_courses(&$result) {
  // ALAN 20110109 Does not seem to be used, verify and remove

  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>
    <th>Course Title</th>
    <th>Course Code</th>
    <th>level</th>
    <th>Credit Load</th>
    <th>Prerequisites Codes</th>
    <th>Prerequisites Description</th>
    <th>Course Semester</th>
    </tr>";$i=1;
  while ($f = db_fetch_object($result)) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
    //$course_type = array('1' => 'Core', 2 => 'Elective');$i++;
    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td>". $i++ ."</td>
      <td>". $f->course_title ."</td>
      <td>". $f->course_code ."</td>
      <td>". $f->level ."</td>
      <td>". $f->credit_load ."</td>
      <td>". $f->Prerequisites_codes ."</td>
      <td>". check_markup($f->prerequisites_description, FILTER_FORMAT_DEFAULT, FALSE) ."</td>
      <td>". $f->course_semester ."</td>

   </tr>";
  }
  $html .="
  </table>";
  echo $html;
}


function get_programme_running_courses ($programme_nid, $session, $semester) {

   $sql = "SELECT DISTINCT
        pc.level,
        c.field_code_value course_code,
        p.field_programme_name_value programme_name,
        d.field_department_name_value department_name,
        co.field_college_name_value faculty_name,
        pc.semester AS semester,
        pc.course_type,
        CONCAT( c.field_coursetitle_value, ' (', field_code_value  ,')') AS course_title,
        pc.credit_load AS credit_load,
        field_creditload_value old_credit_load,
        field_course_description_value course_description,
        field_prerequisite_codes_value prerequisites_codes,
        field_prerequisite_value prerequisites_description,
        pc.program_course_id,
        if(ci.nid IS NULL, NULL, 1) AS clean_nid
      FROM {program_course} pc
      INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
      LEFT JOIN {content_type_course_instance} ci
      ON
        c.nid=ci.field_course_id_nid AND
        pc.semester=ci.field_semester_name_value AND
        ci.field_sess_name_value='%s'
      INNER JOIN {content_type_program} p ON pc.programme_id=p.nid
      INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
      INNER JOIN {content_type_college} co ON d.field_college_id_nid=co.nid
      WHERE pc.semester='%s' AND p.nid=%d
      ORDER BY co.field_college_name_value, d.field_department_name_value, c.field_code_value, p.field_programme_name_value, pc.level";
    $result = db_query($sql, $session, $semester, $programme_nid);
    //drupal_set_message($param['session']);
  return $result;
}


function display_course_result(&$result, $formissing = false) {
  global $programmeInfo;
  $department_nid = $programmeInfo->department_nid;
  $programme_nid = $programmeInfo->programme_nid;

   $delete_assignment_js =<<< EOD
function fix_course(id) {
  if (confirm('Proceed to fixing problem?')) {
    $.get('/staff/ajax/fix_course/$programme_nid/'+id, function(data) { location.href='/staff/createeditcourse/$department_nid'; });
  }
}
EOD;
  drupal_add_js($delete_assignment_js, 'inline');

  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>
      <th>Level</th>
      <th>Course Code</th>
      <th>Department</th>";
    if ($formissing)
      $html .= "<th>Action</th>";

  $html .="

    </tr>";$i=1; $found = false;
  while ($f = db_fetch_object($result)) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
    //check for course to be highlighted in red
    if ($f->clean_nid == "") {
      $found = true;
      $rowColor = "color='#FF0000'";

    }
    else
      $rowColor = "color='#000000'";


    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td><font $rowColor >". $i++ ."</font></td>
      <td><font $rowColor >". $f->level ."</font></td>
      <td><font $rowColor >". $f->course_code ."</font></td>
      <td><font $rowColor >". $f->department_name ."</font></td>";
      if ($formissing) {
        $html .= "<td><input type='button' class='delete_btn' value='Fix Problem' onClick=\"fix_course({$f->program_course_id});\" /></td>";

      }
      $html .= "
   </tr>";
  }
  $html .="
  </table><br />";
  if ($found)
    $html .= "<b><font color='#ff0000'>Note: The HODs for the course(s) highlighted in Red above will have to assign a lecturer for the course(s) for this semester<br />
       If you are the HOD for those courses, you will be able to fix the problem yourself.<br />In any case, when the problem is resolved, you MUST come back to this screen to complete verification!</font></b>";
  echo $html;
}


function staff_assign_course_to_programme_form() {
  global $programmeInfo, $progCourse;

  if ($progCourse && ! preg_match("/^[0-9]{1,12}$/", $_POST['level'])) {
    $prog_course = $progCourse;
  }
  $levels = get_levels_from_programme_level_semester($programmeInfo->programme_nid);
  if (sizeof($levels) <= 1) drupal_set_message(Error_Types(122), 'error');

  //we want to put the courses of the department at the top and then others will follow
  //$departmentCourses = staff_course($programmeInfo->department_nid);
  //$nonedepartmentCourses = staff_course($programmeInfo->department_nid, true);
  //merge the two
  //$allcourses = $departmentCourses + $nonedepartmentCourses;

  $form = array(
    '#theme' => 'form_panel_table',
    '#form_panel_table_attributes' => array('border' => 0));
  $form['title_test'] = array(
    '#type' => 'item',
    '#value' => '<b>Course</b>',
    '#required' => TRUE,
    '#form_panel_col' => 1,
    '#form_panel_row' => 1);

  $form['programme_id'] = array(
    '#type' => 'select',
    '#options' => array($programmeInfo->programme_nid => $programmeInfo->programme_name), //staff_prg(),
    '#title' => 'Programme',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#required' => TRUE,
    '#form_panel_col' => 1,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['title_test']['#default_value'] = $prog_course->programme_id;

  $form['level'] = array(
    '#type' => 'select',
    '#options' => array('' => '' ) + $levels, //staff_level(),
    '#title' => 'Level',
    '#required' => TRUE,
    '#ahah' => array('path' => 'staff/ajax/course', 'event' => 'change', 'method' => 'replace', 'wrapper' => 'courses'),
    '#form_panel_col' => 2,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['level']['#default_value'] = $prog_course->level;

  $form['semester'] = array(
    '#type' => 'select',
    '#title' => 'Semester',
    '#required' => TRUE,
    '#options' => get_semester_from_programme_level_semester($programmeInfo->programme_nid),
    '#form_panel_col' => 3,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['semester']['#default_value'] = $prog_course->semester;

  $form['course_id'] = array(
    '#type' => 'select',
    '#title' => 'Course Code',
    '#options' => staff_course(),
    '#attributes' => array(
      'style' => 'width:100px'),
    '#prefix' => "<div id='courses'>",
    '#suffix' => "</div>",
    '#required' => TRUE,
    '#disabled' => TRUE,
    '#form_panel_col' => 4,
    '#form_panel_row' => 2);
  if(isset($prog_course)) {$form['course_id']['#default_value'] = $prog_course->course_id; $form['course_id']['#disabled'] = FALSE; }

  $form['course_type_id'] = array(
    '#type' => 'select',
    '#options' => array( 1 => 'Core', 2 => 'Elective'),
    '#title' => 'Course Type',
    '#required' => TRUE,
    '#form_panel_col' => 5,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['course_type_id']['#default_value'] = $prog_course->course_type;

  $form['credit_load'] = array(
    '#type' => 'textfield',
    '#title' => 'Credit Load',
    '#size' => 3,
    '#form_panel_col' => 6,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['credit_load']['#default_value'] = $prog_course->credit_load;

  $form['user_id'] = array(
    '#type' => 'select',
    '#options' => array('' => '' ) + get_Staff_in_Department(), //lecturer(),
    '#title' => 'Lecturer',
    '#required' => FALSE,
    '#form_panel_col' => 7,
    '#form_panel_row' => 2);
  if(isset($prog_course)) $form['user_id']['#default_value'] = $prog_course->lecturer_id;

  $form['explain'] = array(
    '#type' => 'item',
    '#value' => 'If Credit Load is not specified, it will be taken from the selected Course. Lecturer can be specified later or when courses are verified for a semester.',
    '#form_panel_col' => 1,
    '#form_panel_row' => 4);

  if (sizeof($levels) > 1) {
    $form['jambsubn'] = array(
      '#id' => 'edit-next',
      '#value' => 'Add',
      '#type' => 'submit',
      '#form_panel_col' => 1,
      '#form_panel_row' => 5);
    if(arg(3)) $form['jambsubn']['#value'] = "Update";;
  }
  $form['sep'] = array(
    '#type' => 'item',
    '#value' => '',
    '#form_panel_col' => 1,
    '#form_panel_row' => 6);

  return $form;
}


function staff_assign_course_to_programme_form_validate($form, &$form_state) {
 $values = $form_state['values'];

  if (empty($values['level']))
   form_set_error('level', Error_Types(114));

  if (empty($values['semester']))
   form_set_error('semester', Error_Types(114));

  //make sure the course does not exists for the same program/level/semester
  if (arg(3)) {
    $rs = db_query("SELECT program_course_id FROM {program_course} WHERE course_id=%d AND programme_id=%d AND level='%s' AND semester='%s' AND program_course_id !=%d ", $values['course_id'], $values['programme_id'], $values['level'], $values['semester'], arg(3) );
    if (db_affected_rows($rs) > 0)
      form_set_error('course_id', Error_Types(123));
  }
  else {
    $rs = db_query("SELECT program_course_id FROM {program_course} WHERE course_id=%d AND programme_id=%d AND level='%s' AND semester='%s'", $values['course_id'], $values['programme_id'], $values['level'], $values['semester'] );
    if (db_affected_rows($rs) > 0)
      form_set_error('course_id', Error_Types(123));
  }
 //return true;
}


function staff_assign_course_to_programme_form_submit($form, &$state) {
  $values = $state['values'];

  if (empty($values['credit_load']) || !preg_match("/^[0-9]{1,3}$/", $values['credit_load'])) {
    $sql = "SELECT field_creditload_value FROM {content_type_course} WHERE nid=%d";
    $rows = db_query($sql, $values['course_id']);
    $row = db_fetch_object($rows);
    if (!($values['credit_load'] === '0' || $values['credit_load'] === 0)) { // Allow a zero credit load if explicitly entered
      $values['credit_load'] = $row->field_creditload_value;
    }
  }

  $query = "SELECT program_course_id FROM {program_course} WHERE course_id=%d AND programme_id=%d AND level='%s' AND semester='%s'";
  $result = db_query($query, $values['course_id'], $values['programme_id'], $values['level'], $values['semester']);

  if ($row = db_fetch_object($result)) {
    $query = "UPDATE {program_course}
      SET course_id=%d, programme_id=%d, level='%s', semester='%s', course_type=%d, credit_load=%d, lecturer_id=%d, historical=0
      WHERE program_course_id=%d";
    db_query($query, $values['course_id'], $values['programme_id'], $values['level'], $values['semester'], $values['course_type_id'], $values['credit_load'], $values['user_id'], $row->program_course_id);
  }
  else {
    $query = "INSERT INTO {program_course}
      SET course_id=%d, programme_id=%d, level='%s', semester='%s', course_type=%d, credit_load=%d, lecturer_id=%d, historical=0";
    db_query($query, $values['course_id'], $values['programme_id'], $values['level'], $values['semester'], $values['course_type_id'], $values['credit_load'], $values['user_id']);
  }

  if (arg(3))
    drupal_set_message("Course was Updated");
  else
    drupal_set_message("Course Added to Programme");

  if (arg(3)) drupal_goto("staff/specifycourse/". arg(2));

}


function get_levels_from_programme_level_semester($programme_nid) {
  $result = db_query("SELECT DISTINCT(level) level, programme_id FROM {program_level_semester} WHERE programme_id=%d ORDER BY level", $programme_nid);
  if (db_affected_rows($result) > 0){
    while ($row = db_fetch_object($result))
      $return[$row->level] = $row->level;

  }
  else
   $return[] = strip_tags(Error_Types(106));

  return $return;
}


function get_semester_from_programme_level_semester($programme_nid) {
  $result = db_query("SELECT DISTINCT(semester) semester, programme_id FROM {program_level_semester} WHERE programme_id=%d ORDER BY semester", $programme_nid);
  if (db_affected_rows($result) > 0){
    while ($row = db_fetch_object($result)) {
      $return[$row->semester] = $row->semester;
    }
  }
  else
   $return[] = strip_tags(Error_Types(106));

  return $return;
}


function staff_specify_course_proceed_form() {
  $form['#title'] = 'Start Specifying Courses';

  $form['sprogramme_nid'] = array(
      '#type' => 'select',
      '#options' => programme(),
      '#title' => 'Programme Name');
  $form['showCourseAssignment'] = array(
       '#type' => 'hidden',
       '#default_value' => 1
   );
  $form['submit'] = array(
    '#value' => 'Start Specifying Course(s)',
    '#type' => 'submit'
  );

  return $form;

}


function staff_specify_course_proceed_form_submit($form, &$form_state) {
  drupal_goto("staff/specifycourse/" . $form_state['values']['sprogramme_nid']);
}


function staff_verify_course_proceed_form() {
  $form['#title'] = 'Start Verifying Courses';

  $form['session'] = array(
      '#type' => 'select',
      '#options' => get_all_sessions(),
      '#title' => 'Session');


  $form['vprogramme_nid'] = array(
      '#type' => 'select',
      '#options' => programme(),
      '#title' => 'Programme Name');

  $form['semester'] = array(
      '#type' => 'select',
      '#options' => array(1 => '1', 2 => '2'),
      '#title' => 'Semester');

  $form['showCourseAssignment'] = array(
       '#type' => 'hidden',
       '#default_value' => 1
   );
  $form['submit'] = array(
    '#value' => 'Start Verifying Course(s)',
    '#type' => 'submit'
  );

  return $form;

}


function staff_verify_course_proceed_form_submit($form, &$form_state) {
  $_SESSION['eduerp_verify']['semester'] = $form_state['values']['semester'];
  $_SESSION['eduerp_verify']['session'] = $form_state['values']['session'];
  drupal_goto("staff/verifycourse/" . $form_state['values']['vprogramme_nid']);

}


function course_specify_list(&$r) {
  global $canCreateModify;

  if (db_affected_rows($r) <= 0) {
    echo  strip_tags(Error_Types(106));
    return;
  }
  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>
    <th>Level</th>
    <th>Semester</th>
    <th>Course</th>
    <th>Course Type</th>
    <th>Credit Load</th>
    <th>Lecturer</th>
    <th>Prerequisites Codes</th>
    <th>Prerequisites Description</th>";
    if ($canCreateModify)
      $html .= "
    <th colspan=2 align='center'>Actions</th>";
    $html .= "
    </tr>";$i=1; $found = false;
  while ($f = db_fetch_object($r)) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
    $course_type = array('1' => 'Core', 2 => 'Elective');
    if ($f->clean_nid == "") { //found a course without a lectrer
      $found = true;
      $fcolor = "color='#FF0000'";
    }
    else
      $fcolor = '#000000';
    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td><font $fcolor>". $i++ ."</font></td>
      <td><font $fcolor>". $f->level ."</font></td>
      <td><font $fcolor>". $f->semester ."</font></td>
      <td><font $fcolor>". $f->course_title ."</font></td>
      <td><font $fcolor>". $course_type[$f->course_type] ."</font></td>
      <td><font $fcolor>". $f->credit_load ."</font></td>
      <td><font $fcolor>". $f->staff_name ."</font></td>
      <td><font $fcolor>". $f->prerequisites_codes ."</font></td>
      <td><font $fcolor>". check_markup($f->prerequisites_description, FILTER_FORMAT_DEFAULT, FALSE) ."</font></td>";
    if ($canCreateModify)
      $html .= "
      <td><input type='button' class='delete_btn' value='Delete' onClick=\"delete_assignment($f->program_course_id);\" /></td>
      <td><input type='button' class='delete_btn' value='Edit' onClick=\"edit_assignment($f->program_course_id);\" /></td>
   </tr>";

  }
  $html .= "
  </table><br /></br>";
  if ($found)
    $html .= "<b><font color='#ff0000'>Note: The HODs for the course(s) highlighted in Red above will have to assign a lecturer for the course(s) for this semester<br />
       If you are the HOD for those courses, you will be able to fix the problem yourself.<br />In any case, when the problem is resolved, you MUST come back to this screen to complete verification!</font></b>";

  echo $html;

}


function historical_course_list($programme_nid) {
  global $user_profile, $canCreateModify;

  $query = "
    SELECT courses.*, CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS staff_name
    FROM
      (SELECT
        pc.program_course_id,
        pc.course_type,
        pc.level AS level_name,
        pc.semester AS semester,
        pc.lecturer_id AS uid,
        p.field_programme_name_value AS programme_name,
        CONCAT( c.field_coursetitle_value, ' (', field_code_value  ,')') AS course_title,
        pc.credit_load AS credit_load,
        field_creditload_value old_credit_load,
        field_course_description_value course_description,
        field_prerequisite_codes_value prerequisites_codes,
        field_prerequisite_value prerequisites_description
      FROM {program_course} pc, {content_type_program} p, {content_type_course} c
      WHERE pc.programme_id=p.nid AND pc.course_id=c.nid AND p.nid=%d AND pc.historical=1
      ) AS courses
    LEFT JOIN {node} npro ON courses.uid=npro.uid AND npro.type='profile'
    LEFT JOIN {content_type_profile} pro ON npro.vid=pro.vid
    ORDER BY level_name, semester";
  $r = db_query($query, $programme_nid);
  if (db_affected_rows($r) <= 0) {
    //echo  strip_tags(Error_Types(106));
    drupal_set_message(Error_Types(106), 'error');
    return;
  }
  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>";
    if ($canCreateModify)
      $html .= "
    <th>Actions</th>";
    $html .= "
    <th>Level</th><th>Semester</th>
    <th>Course</th>
    <th>Course Type</th>
    <th>Credit Load</th>
    <th>Lecturer</th>
    <th>Prerequisites Codes</th>
    <th>Prerequisites Description</th>
    </tr>";$i=1;
  while ($f = db_fetch_object($r)) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
    $course_type = array('1' => 'Core', 2 => 'Elective');
    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td>". $i++ ."</td>";
    if ($canCreateModify)
      $html .= "
      <td><input type='button' class='delete_btn' value='Make Available' onClick=\"make_available($f->program_course_id);\" /></td>";
      $html .= "
      <td>". $f->level_name ."</td>
      <td>". $f->semester ."</td>
      <td>". $f->course_title ."</td>
      <td>". $course_type[$f->course_type] ."</td>
      <td>". $f->credit_load ."</td>
      <td>". $f->staff_name ."</td>
      <td>". $f->prerequisites_codes ."</td>
      <td>". check_markup($f->prerequisites_description, FILTER_FORMAT_DEFAULT, FALSE) ."</td>
   </tr>";

  }
  $html .= "
  </table>";
  echo  $html;

}


function staff_student_progress_qualification() {
  global $eduerp_levels, $eduerp_sessions, $eduerp_programmes, $eduerp_programmeName, $user;
  ob_start();
  if($_SESSION['eduerp_return_msg']) drupal_set_message($_SESSION['eduerp_return_msg']);

  $eduerp_levels = course_levels();
  $eduerp_sessions = get_all_sessions();
  $eduerp_programmes = get_programmes(0, true);
  $str = "
  <br /><hr /><br />

  <font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Student Progress towards Graduation</b></font><br /><br />
  <br /><hr /><br />";
  //get faculty and department info of the programme
   $progInfo = db_fetch_object(get_programmes($_SESSION['eduerp_qualification']['programme_nid']));

  if (staff_has_eduerp_role($user->uid, 0, 0, array('University Examination Viewer', 'University Grade Editor', 'Registrar', 'Vice-Chancellor')) ||
     staff_has_eduerp_role($user->uid, $progInfo->department_nid, 0, array('Department Examination Officer', 'Department Grade Editor', 'Head of Department')) ||
     staff_has_eduerp_role($user->uid, 0, $progInfo->faculty_nid, array('Faculty Examination Officer', 'Faculty Grade Editor', 'Dean of Faculty'))) {

    $str .= "<b>Student Progress Towards Graduation</b> - Please fill the form as appropriate<br /><br />";
    $str .= drupal_get_form('show_progress_qualification_form');
    $eduerp_programmeName = $eduerp_programmes[$_SESSION['eduerp_qualification']['programme_nid']];
    if (isset($_SESSION['eduerp_qualification'])) {
      $str .= "<br /><hr /><br />
      Students' Progress Towards Graduation for <b>Session: ". $eduerp_sessions[$_SESSION['eduerp_qualification']['session']] ."</b> |  <b>Programme: ". $eduerp_programmeName ."</b>  |  <b>Student current level: ". $eduerp_levels[$_SESSION['eduerp_qualification']['level']] ."</b>
      <br /><br />
      <div id='assigned_courses'>";
      $str .= get_progress_qualification_details();

      $str .= "
      </div>";
    }
  }
   else {
     //$str .=   Error_Types(127);
     drupal_set_message(Error_Types(127), 'error');
    }
  echo $str;
  unset($_SESSION['eduerp_return_msg']);
  return ob_get_clean();
}


function show_progress_qualification_form() {
  global $eduerp_levels, $eduerp_sessions, $eduerp_programmes;
  $form['#title'] = 'Create New Programme';

  $form['session'] = array(
    '#type' => 'select',
    '#options' => $eduerp_sessions,
    '#required' => TRUE,
    '#title' => 'Session');
  if ($_SESSION['eduerp_qualification']) $form['session']['#default_value'] = $_SESSION['eduerp_qualification']['session'];

  $form['programme_nid'] = array(
    '#type' => 'select',
    '#options' => $eduerp_programmes,
    '#required' => TRUE,
    '#title' => 'Programme Name');
  if ($_SESSION['eduerp_qualification']) $form['programme_nid']['#default_value'] = $_SESSION['eduerp_qualification']['programme_nid'];

  $form['level'] = array(
    '#type' => 'select',
    '#options' => $eduerp_levels,
    '#required' => TRUE,
    '#title' => 'Level');
  if ($_SESSION['eduerp_qualification']) $form['level']['#default_value'] = $_SESSION['eduerp_qualification']['level'];

  $form['submit'] = array(
      '#value' => 'Check Now',
      '#type' => 'submit'
    );
  return $form;
}


function show_progress_qualification_form_validate($form, &$form_state) {
  ;
}


function show_progress_qualification_form_submit($form, &$form_state) {
  $values = $form_state['values'];
  $_SESSION['eduerp_qualification']['session'] = $values['session'];
  $_SESSION['eduerp_qualification']['programme_nid'] = $values['programme_nid'];
  $_SESSION['eduerp_qualification']['level'] = $values['level'];
}


function display_progress_towards_qualification(&$result) {
  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>
    <th>Student Name</th>

    <th>Credit Load Completed</th>
    <th>Session</th>
    <th>Semester</th>
    <th>Level</th>
    <th>GPA</th>

    <th>C. Credit Load Completed</th>
    <th>Elapsed Year</th>
    <th>Duration</th>

    <th>Programme Min. Credit</th>
    <th>Programme Max. Duration</th>
    <th>Mode of Entry</th>

    <th>CGPA</th>
    </tr>";$i=1;
  //while ($f = db_fetch_object($result)) {
  foreach ($result as $v) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";

    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td>". $i++ ."</td>
      <td>". $v['student_name'] ."</td>

      <td>". $v['field_credit_load_completed_value'] ."</td>
      <td>". $v['field_sess_name_gpa_value'] ."</td>
      <td>". $v['field_semester_name_gpa_value'] ."</td>
      <td>". $v['field_level_name_gpa_value'] ."</td>
      <td>". $v['field_gpa_value'] ."</td>

      <td>". $v['field_credit_load_completed_sp_value'] ."</td>
      <td>". $v['elapsed_years'] ."</td>
      <td>". $v['field_duration_value'] ."</td>

      <td>". $v['field_min_credit_load_program_value'] ."</td>
      <td>". $v['field_max_duration_value'] ."</td>
      <td>". $v['field_profile_mode_of_entry_value'] ."</td>

      <td>". $v['field_cgpa_sp_value'] ."</td>
   </tr>";

  }
  $html .= "
  </table>";
  return  $html;

}


function  get_progress_qualification_details() {
  global $eduerp_uid, $eduerp_programmeName, $eduerp_programme_nid, $eduerp_studentName;

  $eduerp_programme_nid = $_SESSION['eduerp_qualification']['programme_nid'];
  $session = $_SESSION['eduerp_qualification']['session'];
  $level = $_SESSION['eduerp_qualification']['level'];

  //arrange the CGPA

  $cgpa = get_students_CGPA($session, $eduerp_programme_nid, $level);
  if (db_affected_rows($cgpa) > 0) {
    $cgpa_arr = array("field_cgpa_sp_value", "field_credit_load_completed_sp_value", "field_min_credit_load_program_value", "elapsed_years",
        "field_duration_value","field_max_duration_value", "field_profile_mode_of_entry_value", "student_name", "uid", "mat");
    while ($f = db_fetch_object($cgpa)) {
      foreach ($cgpa_arr as $v)
        $cGPA[$f->uid][$v] = $f->{$v};
    }
  }

  /*
  //test data
  $cGPA[1] = array('student_name'=>'Olu Jacobs','field_cgpa_sp_value'=>'40','field_credit_load_completed_sp_value'=>'39',
      'field_min_credit_load_program_value'=>'30','elapsed_years'=>'1',
      'field_duration_value'=>'4','field_max_duration_value'=>'12','field_profile_mode_of_entry_value'=>'UME', 'uid'=>'1');

  $cGPA[2] = array('student_name'=>'Obi Johnson','field_cgpa_sp_value'=>'60','field_credit_load_completed_sp_value'=>'55',
      'field_min_credit_load_program_value'=>'48','elapsed_years'=>'2',
      'field_duration_value'=>'4','field_max_duration_value'=>'12','field_profile_mode_of_entry_value'=>'UME', 'uid'=>'2');
  */
  //arrange the GPA

  $gpa = get_students_GPA($session, $eduerp_programme_nid, $level);
  if (db_affected_rows($gpa) > 0) {
    $gpa_arr = array("field_gpa_value", "field_credit_load_completed_value", "field_sess_name_gpa_value", "field_semester_name_gpa_value", "field_level_name_gpa_value", "uid");
    while ($f = db_fetch_object($gpa)) {
      foreach ($gpa_arr as $v)
        $GPA[$f->uid][$f->field_sess_name_gpa_value][$f->field_semester_name_gpa_value][$v] = $f->{$v};
    }
  }

  /*
    //test data
  $GPA[1]['2008/2009'][1] = array("field_gpa_value"=>'34.3', "field_credit_load_completed_value"=>'50', "field_sess_name_gpa_value"=>'2008/2009',
      "field_semester_name_gpa_value"=>'1', "field_level_name_gpa_value"=>'100');
  $GPA[1]['2008/2009'][2] = array("field_gpa_value"=>'20.3', "field_credit_load_completed_value"=>'5', "field_sess_name_gpa_value"=>'2008/2009',
      "field_semester_name_gpa_value"=>'2', "field_level_name_gpa_value"=>'100');

  $GPA[1]['2009/2010'][1] = array("field_gpa_value"=>'11.3', "field_credit_load_completed_value"=>'45', "field_sess_name_gpa_value"=>'2009/2010',
      "field_semester_name_gpa_value"=>'1', "field_level_name_gpa_value"=>'200');
  $GPA[1]['2009/2010'][2] = array("field_gpa_value"=>'67.3', "field_credit_load_completed_value"=>'75', "field_sess_name_gpa_value"=>'2009/2010',
      "field_semester_name_gpa_value"=>'2', "field_level_name_gpa_value"=>'200');

  $GPA[2]['2008/2009'][1] = array("field_gpa_value"=>'90.3', "field_credit_load_completed_value"=>'70', "field_sess_name_gpa_value"=>'2008/2009',
      "field_semester_name_gpa_value"=>'1', "field_level_name_gpa_value"=>'200');
  $GPA[2]['2008/2009'][2] = array("field_gpa_value"=>'70.3', "field_credit_load_completed_value"=>'5', "field_sess_name_gpa_value"=>'2008/2009',
      "field_semester_name_gpa_value"=>'2', "field_level_name_gpa_value"=>'200');
  */
  //arrange the faled courses

  $failed_courses = get_cumulative_list_of_failed_courses($session, $eduerp_programme_nid, $level);
  if (db_affected_rows($failed_courses) > 0) {
    $failed_arr = array("failedlist");
    while ($f = db_fetch_object($failed_courses)) {
      foreach ($failed_arr as $v)
        $failed[$f->uid] = $f->{$v};

    }
  }

  //test data for failed course
  //$failed[2] = "code1, code2";

  //build the table
  //note i am using cGPA as the root iterator because cGPA must exist for all students
  //print_r($cGPA);
  $html = "";
  if(isset($cGPA) && is_array($cGPA)) {
  $html = "
  <table border=1>";$i=1;
  foreach($cGPA as $k=> $v){

  //    drupal_set_message($v['field_cgpa_sp_value']);
    //build cGPA
    $html .= "
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>cGPA</th>
      <th>Total Credit Units Taken</th>
      <th>Total Units Required</th>
      <th>Years since Student Start</th>
      <th>Programme Duration</th>
      <th>Maximum Semesters allowed</th>
      <th>Mode of Entry</th>
   </tr>
   <tr>
            <td>". $i++ ."</td>
            <td>". $v['student_name'] . "<br />(" . $v['mat'] . ")</td>
            <td>". $v['field_cgpa_sp_value'] ."</td>
            <td>". $v['field_credit_load_completed_sp_value'] ."</td>
            <td>". $v['field_min_credit_load_program_value'] ."</td>
            <td>". $v['elapsed_years'] ."</td>
            <td>". $v['field_duration_value'] ."</td>
            <td>". $v['field_max_duration_value'] ."</td>
            <td>". $v['field_profile_mode_of_entry_value'] ."</td>
     </tr>";
    if (isset($failed[$k])) {
      //now build failed courses
      //$flist = "";
      //foreach($failed[$k] as $p) {
      //  $flist .= $p['failedlist'] .', ';
      //}
      ///$flist = substr($flist, 0, -2); //remove the trailing ', '
      $html .= "
      <tr>
        <td colspan=2>&nbsp;</td>
        <td colspan=7>
          <table border=1>
            <tr>
              <th>Failed Course(s)</th>
            </tr>
            <tr>
              <td>". $failed[$k] ."</td>
            </tr>
          </table>
        </td>
      </tr>";
    }
    //now build GPA
    if(isset($GPA[$k])) {
    $html .= "
      <tr>
        <td colspan=2>&nbsp;</td>
        <td colspan=7>
          <table border=1>
            <tr>
              <th>GPA</th>
            <th>Credit Units Taken</th>
            <th>Session</th>
            <th>Semester</th>
            <th>Level</th>
          </tr>";
          $GPA_details = array_slice($GPA, 2);

          foreach($GPA[$k] as $p) {
                $b = array_keys($p);
                //echo sizeof($b) .'<br />';
               // if(sizeof($b)){
               //       foreach($b as $h=>$a) echo $k . '=>'. $a .'<br />';
               // }
                foreach($b as $t){
          $html .= "
            <tr>
              <td>". $p[$t]['field_gpa_value'] ."</td>
              <td>". $p[$t]['field_credit_load_completed_value'] ."</td>
              <td>". $p[$t]['field_sess_name_gpa_value'] ."</td>
              <td>". $p[$t]['field_semester_name_gpa_value'] ."</td>
              <td>". $p[$t]['field_level_name_gpa_value'] ."</td>
            </tr>";
                  }
            }
            $html .="
          </table>
        </td>
      </tr>";
    }
    //link to student grade view
    $html .= "
      <tr>
        <td colspan=2>&nbsp;</td>
        <td colspan=7>
          <table border=1>
            <tr>
              <th>Student Grade View</th>
              <th>Student Record View</th>
            </tr>
            <tr>
              <td><a href=" . '"' . $base_url . '/studentgradedetails?uid=' . rawurlencode($v['mat']) . '"' . ">View Student Grade Details</a></td>
              <td><a href=" . '"' . $base_url . '/studentrecords?uid=' . rawurlencode($v['mat']) . '"' . ">View Student Record</a></td>
          </table>
        </td>
      </tr>";
      //now append the form here
      $html .="
      <tr>
        <td colspan=2>&nbsp;</td>
        <td colspan=7>";
          $eduerp_uid = $v['uid'];
          $eduerp_studentName = $v['student_name'];
          //$stud = new student_action_class($v['uid'], $programmeName, $programme_nid, $v['student_name']);
          $html .= drupal_get_form('staff_student_action_form');
          //$html .= $stud;
          //unset($_SESSION['eduerp_stud']);
        /*
          <table border=1>
            <tr>
              <td nowrap>Comment:<input type='text' name='comment'></td>
              <td nowrap>Event:<select name='studentevent' >
                <option value='Graduated'>Graduated</option>
                <option value='Left Voluntarily'>Left Voluntarily</option>
                <option value='Repeat Session'>Repeat Session</option>
                <option value='Defer Session'>Defer Session</option>
                <option value='Left Forced'>Left Forced</option>

                </select>
              </td>
              <td nowrap>Degree:<select name='studentdegree' >
                <option value='None'>None</option>
                <option value='First Class'>First Class</option>
                <option value='Second Class Upper'>Second Class Upper</option>
                <option value='Second Class Lower'>Second Class Lower</option>
                <option value='Third Class'>Third Class</option>
                <option value='Pass'>Pass</option>

                </select>
              </td>";
              $all_sessions = get_all_sessions();
              $html .="
              <td nowrap>Session:<select name='studentsession' >";
              foreach($all_sessions as $v){
                      $html .="
                <option value='". $v ."'>". $v ."</option>";
              }
              $html .="
                </select>
              <td><input type='button' class='delete_btn' value='Perform Action' onClick=\"student_action(". $v['uid'] .");\" /></td>
            </tr>
          </table>
          */
          $str .="
        </td>
      </tr>
      ";

  }
  $html .= "
  </table>";
  }
  else{
   //$html = strip_tags(Error_Types(106));
   drupal_set_message(Error_Types(106), 'error');
  }
  return $html;
  //unset($_SESSION['eduerp_qualification']);
}


function get_students_CGPA($session, $programme_nid, $level) {
  $sql = "SELECT
        sp.field_student_ref_sp_uid AS uid,
        u.name AS mat,
        sp.field_cgpa_sp_value,
        sp.field_credit_load_completed_sp_value,
        p.field_min_credit_load_program_value,
        SUBSTRING(spro.field_profile_reg_session_value, 1, 4) - spro.field_profile_yearofentry_value + 1 AS elapsed_years,
        p.field_duration_value,
        p.field_max_duration_value,
        CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS student_name, pro.nid student_key,
        spro.field_profile_mode_of_entry_value
      FROM {content_type_student_program} sp
      INNER JOIN {node} npro ON sp.field_student_ref_sp_uid=npro.uid AND npro.type='profile'
      INNER JOIN {content_type_profile} pro ON npro.vid=pro.vid
      INNER JOIN {node} nspro ON npro.uid=nspro.uid AND nspro.type='student_profile'
      INNER JOIN {content_type_student_profile} spro ON nspro.vid=spro.vid
      INNER JOIN {content_type_program} p
      INNER JOIN {users} u ON sp.field_student_ref_sp_uid=u.uid
      WHERE
        sp.field_student_ref_sp_uid IN (
          SELECT nspro0.uid
          FROM {node} nspro0
          INNER JOIN {content_type_student_profile} spro0 ON nspro0.vid=spro0.vid
          WHERE nspro0.type='student_profile' AND spro0.field_profile_first_choice_nid='%s' AND spro0.field_profile_reg_session_value='%s' AND spro0.field_profile_level_name_value='%s'
        ) AND
        sp.field_program_ref_sp_nid=spro.field_profile_first_choice_nid AND
        sp.field_program_ref_sp_nid=p.nid
      ORDER BY student_name";
  $result = db_query($sql, $programme_nid, $session, $level);
  return $result;
}


function get_students_GPA($session, $programme_nid, $level) {
  $sql = "SELECT
        gpa.field_student_ref_gpa_uid AS uid,
        gpa.field_gpa_value,
        gpa.field_credit_load_completed_value,
        gpa.field_sess_name_gpa_value,
        gpa.field_semester_name_gpa_value,
        gpa.field_level_name_gpa_value,
        CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS student_name, pro.nid student_key
      FROM {content_type_student_gpa} gpa
      INNER JOIN {node} npro ON gpa.field_student_ref_gpa_uid=npro.uid AND npro.type='profile'
      INNER JOIN {content_type_profile} pro ON npro.vid=pro.vid
      INNER JOIN {node} nspro ON npro.uid=nspro.uid AND nspro.type='student_profile'
      INNER JOIN {content_type_student_profile} spro ON nspro.vid=spro.vid
      WHERE
        gpa.field_student_ref_gpa_uid IN (
          SELECT nspro0.uid
          FROM {node} nspro0
          INNER JOIN {content_type_student_profile} spro0 ON nspro0.vid=spro0.vid
          WHERE nspro0.type='student_profile' AND spro0.field_profile_first_choice_nid='%s' AND spro0.field_profile_reg_session_value='%s' AND spro0.field_profile_level_name_value='%s'
        ) AND
        gpa.field_program_ref_gpa_nid=spro.field_profile_first_choice_nid
      ORDER BY student_name, gpa.field_level_name_gpa_value, gpa.field_sess_name_gpa_value, gpa.field_semester_name_gpa_value";
    $result = db_query($sql, $programme_nid, $session, $level);
  return $result;
}


function get_cumulative_list_of_failed_courses($session, $programme_nid, $level) {
  // Find any failed (and not since passed) courses for each student in this program/session/level
    // failedcourses sub-query below borrows from similar query in student.module & course_grades_footer.inc
    $sql = "SELECT
        failedcourses.uid,
        failedcourses.failedlist,
        CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS student_name, pro.nid student_key
      FROM
        (
          SELECT
            exams.field_mat_no_uid AS uid,
            GROUP_CONCAT(exams.field_code_value SEPARATOR ', ') AS failedlist
          FROM (
            SELECT DISTINCT
              IF(sg.field_gradepoint_value='-', 0, sg.field_gradepoint_value) AS gradepoint,
              sg.field_mat_no_uid,
              CONCAT(ci.field_sess_name_value, ci.field_semester_name_value, sg.nid) AS sess_sem,
              c.field_code_value
            FROM
              {content_type_student_grades} sg,
              {content_type_course_instance} ci,
              {content_type_course} c,
              {program_course} pc,
              {node} nspro,
              {content_type_student_profile} spro
            WHERE
              sg.field_mat_no_uid IN (
                SELECT nspro8.uid
                FROM {node} nspro8
                INNER JOIN {content_type_student_profile} spro8 ON nspro8.vid=spro8.vid
                WHERE nspro8.type='student_profile' AND spro8.field_profile_first_choice_nid='%s' AND spro8.field_profile_reg_session_value='%s' AND spro8.field_profile_level_name_value='%s'
              ) AND
              sg.field_course_instance_nid=ci.nid AND
              sg.field_examscorelocked_value>0 AND
              sg.field_dropped_value=0 AND
              ci.field_course_id_nid=c.nid AND
              ci.field_course_id_nid=pc.course_id AND
              pc.programme_id=spro.field_profile_first_choice_nid AND
              nspro.uid=sg.field_mat_no_uid AND
              nspro.type='student_profile' AND
              nspro.vid=spro.vid
            ) AS exams
          JOIN (
            SELECT
              sg0.field_mat_no_uid,
              MAX(CONCAT(ci0.field_sess_name_value, ci0.field_semester_name_value, sg0.nid)) AS sess_sem0,
              c0.field_code_value
            FROM
              {content_type_student_grades} sg0,
              {content_type_course_instance} ci0,
              {content_type_course} c0,
              {program_course} pc0,
              {node} nspro0,
              {content_type_student_profile} spro0
            WHERE
              sg0.field_mat_no_uid IN (
                SELECT nspro9.uid
                FROM {node} nspro9
                INNER JOIN {content_type_student_profile} spro9 ON nspro9.vid=spro9.vid
                WHERE nspro9.type='student_profile' AND spro9.field_profile_first_choice_nid='%s' AND spro9.field_profile_reg_session_value='%s' AND spro9.field_profile_level_name_value='%s'
              ) AND
              sg0.field_course_instance_nid=ci0.nid AND
              sg0.field_examscorelocked_value>0 AND
              sg0.field_dropped_value=0 AND
              ci0.field_course_id_nid=c0.nid AND
              ci0.field_course_id_nid=pc0.course_id AND
              pc0.programme_id=spro0.field_profile_first_choice_nid AND
              nspro0.uid=sg0.field_mat_no_uid AND
              nspro0.type='student_profile' AND
              nspro0.vid=spro0.vid
            GROUP BY c0.field_code_value, sg0.field_mat_no_uid
            ) AS most_recent_exam
          ON
            exams.field_code_value=most_recent_exam.field_code_value AND
            exams.sess_sem=most_recent_exam.sess_sem0 AND
            exams.field_mat_no_uid=most_recent_exam.field_mat_no_uid AND
            exams.gradepoint=0
          GROUP BY exams.field_mat_no_uid
          ORDER BY exams.field_code_value
        ) AS failedcourses
      INNER JOIN {node} npro ON failedcourses.uid=npro.uid AND npro.type='profile'
      INNER JOIN {content_type_profile} pro ON npro.vid=pro.vid
      ORDER BY student_name";
    $result = db_query($sql, $programme_nid, $session, $level, $programme_nid, $session, $level);
  return $result;
}


function get_all_sessions() {
  $result = db_query($sql = "SELECT session_id, sess_name FROM {session} ORDER BY sess_name DESC ");
  if (db_affected_rows($result) > 0) {
    while ($row = db_fetch_object($result))
      $session[$row->sess_name] = $row->sess_name;
  }
  else
    $session[] = strip_tags(Error_Types(106));

  return $session;
}


function get_unassigned_for_programme($programme, $session, $semester) {
  $sql ="
  SELECT DISTINCT
        pc.level,
        c.field_code_value course_code,
        d.field_department_name_value department_name,
        program_course_id
      FROM {program_course} pc
      INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
      LEFT JOIN {content_type_course_instance} ci
      ON
        c.nid=ci.field_course_id_nid AND
        pc.semester=ci.field_semester_name_value AND
        ci.field_sess_name_value='%s'
      INNER JOIN {content_type_program} p ON pc.programme_id=p.nid
      INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
      WHERE pc.semester='%s' AND p.nid=%d AND ci.nid IS NULL
      ORDER BY d.field_department_name_value, c.field_code_value, p.field_programme_name_value, pc.level";
    $result = db_query($sql, $session, $semester, $programme);
    return $result;
}


function staff_unregistered_students() {
 global $sessions;
  ob_start();
  $sessions = get_all_sessions();
  $str = "
  <br /><hr /><br />

  <font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;List of Students who have Not Registered for a Semester</b></font><br /><br />
  <br /><hr /><br />

  <b>List of Students who have Not Registered for a Semester</b> - Please fill the form as appropriate<br /><br />";

  $str .= drupal_get_form('show_unregistered_course_form');


  if ($_SESSION['eduerp_unreg']) {


    $unregStudents = get_unregistered_students($sessions[$_SESSION['eduerp_unreg']['session']], $_SESSION['eduerp_unreg']['semester']);

    $str .="
    <br /><hr /><br />
    <b>List of Students who have Not Registered for ". $sessions[$_SESSION['eduerp_unreg']['session']] ." Session | Semester ". $_SESSION['eduerp_unreg']['semester'] ."</b><br /><br />";
    if (db_affected_rows($unregStudents) > 0) {
      $str  .= display_list_of_unregistered_students($unregStudents);
    }
    else{
      //$str .= Error_Types(106);
      drupal_set_message(Error_Types(106), 'error');
    }
  }

  echo $str;
  return ob_get_clean();
}


function display_list_of_unregistered_students(&$result) {
  $html = "
  <table border ='1'>
    <tr>
      <th>#</th>
      <th>Student Name</th>
      <th>Matriculation Number</th>
      <th>Programme</th>
      <th>Level</th>
    </tr>";$i=1;
  while ($f = db_fetch_object($result)) {
    if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";

    $html .="
    <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
      <td>". $i++ ."</td>
      <td>". $f->student_name ."</td>
      <td>". $f->mat ."</td>
      <td>". $f->programme_name ."</td>
      <td>". $f->level ."</td>
    </tr>";
  }
  $html .= "
  </table>";
  return  $html;
}


function show_unregistered_course_form() {
  global $sessions;
  $form['#title'] = 'Unregistered Course form';

  $form['session'] = array(
    '#type' => 'select',
    '#options' => $sessions,
    '#required' => TRUE,
    '#title' => 'Session');
  if ($_SESSION['eduerp_unreg']) $form['session']['#default_value'] = $_SESSION['eduerp_unreg']['session'];


  $form['semester'] = array(
    '#type' => 'select',
    '#options' => array(1=>'1', 2=>'2'),
    '#required' => TRUE,
    '#title' => 'Semester');
  if ($_SESSION['eduerp_unreg']) $form['semester']['#default_value'] = $_SESSION['eduerp_unreg']['semester'];

  $form['submit'] = array(
      '#value' => 'Check Now',
      '#type' => 'submit'
    );
  return $form;
}


function show_unregistered_course_form_submit($form, &$form_state) {
  $values = $form_state['values'];
  $_SESSION['eduerp_unreg']['session'] = $values['session'];
  $_SESSION['eduerp_unreg']['semester'] = $values['semester'];
}


function get_unregistered_students($session, $semester) {
  $sql = "
  SELECT DISTINCT
    ur.uid,
    u.name AS mat,
    p.field_programme_name_value AS programme_name,
    spro.field_profile_level_name_value AS level,
    CONCAT(pro.field_profile_last_name_value, ', ', pro.field_profile_first_name_value, ' ', IFNULL(pro.field_profile_middle_name_value, '')) AS student_name
  FROM {role} r
  INNER JOIN {users_roles} ur ON r.rid=ur.rid
  INNER JOIN {node} npro ON ur.uid=npro.uid AND npro.type='profile'
  INNER JOIN {content_type_profile} pro ON npro.vid=pro.vid
  INNER JOIN {node} nspro ON npro.uid=nspro.uid AND nspro.type='student_profile'
  INNER JOIN {content_type_student_profile} spro ON nspro.vid=spro.vid
  INNER JOIN {content_type_student_program} sp ON ur.uid=sp.field_student_ref_sp_uid AND spro.field_profile_first_choice_nid=sp.field_program_ref_sp_nid
  INNER JOIN {content_type_program} p ON spro.field_profile_first_choice_nid=p.nid
  INNER JOIN {users} u ON ur.uid=u.uid
  LEFT JOIN {content_type_student_record} sr
  ON ur.uid=sr.field_student_ref_sr_uid AND
    sp.field_program_ref_sp_nid=sr.field_student_program_sr_nid AND
    sr.field_event_sr_value IN ('Graduated', 'Left Voluntarily', 'Left Forced')
  WHERE
    r.name='Student' AND
    (spro.field_profile_reg_session_value!='%s' OR spro.field_profile_reg_semester_value!='%s') AND
    sr.field_student_ref_sr_uid IS NULL
  ORDER BY programme_name, level, student_name
  ";
  $result = db_query($sql, $session, $semester);
  return $result;
}


function staff_student_action_form() {
  global $eduerp_uid, $eduerp_programmeName, $eduerp_programme_nid, $eduerp_studentName;
  $form = array(
    '#theme' => 'form_panel_table',
    '#form_panel_table_attributes' => array('border' => 0));
  $form['#title'] = 'Student Action';


  $form['comment'] = array(
    '#title' => 'Comment',
    '#type' => 'textfield',
    '#size' => 25,
    '#form_panel_col' => 1,
    '#form_panel_row' => 1
  );

  $form['uid'] = array(
    '#title' => 'uid',
    '#type' => 'hidden',
    '#default_value' => $eduerp_uid

  );

  $form['programmeName'] = array(
    '#title' => 'programmeName',
    '#type' => 'hidden',
    '#default_value' => $eduerp_programmeName

  );
  $form['programmeUID'] = array(
    '#title' => 'programmeUID',
    '#type' => 'hidden',
    '#default_value' => $eduerp_programme_nid

  );
  $form['studentName'] = array(
    '#title' => 'studentName',
    '#type' => 'hidden',
    '#default_value' => $eduerp_studentName

  );
  $form['event'] = array(
    '#type' => 'select',
    '#options' => array('Graduated'=>'Graduated','Left Voluntarily'=>'Left Voluntarily','Repeat Session'=>'Repeat Session','Defer Session'=>'Defer Session','Left Forced'=>'Left Forced','Note'=>'Note'),
    '#title' => 'Event',
    '#form_panel_col' => 2,
    '#form_panel_row' => 1
    );

    $form['degree'] = array(
    '#type' => 'select',
    '#options' => array('None'=>'None','First Class'=>'First Class', 'Second Class Upper'=>'Second Class Upper', 'Second Class Lower'=>'Second Class Lower','Third Class'=>'Third Class', 'Pass'=>'Pass'),
    '#title' => 'Degree',
    '#form_panel_col' => 3,
    '#form_panel_row' => 1
    );

  $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#title' => 'Session',
    '#form_panel_col' => 4,
    '#form_panel_row' => 1
    );

  $form['submit'] = array(
    '#value' => 'Add to Student Record',
    '#type' => 'submit',
    '#form_panel_col' => 5,
    '#form_panel_row' => 1
  );


  return $form;

}


function staff_student_action_form_validate($form, &$state) {
  $values = $state['values'];

  $degrees = array("First Class", "Second Class Upper", "Second Class Lower", "Third Class", "Pass");

  if(($values['event'] == 'Graduated' && $values['degree'] == 'None') || ($values['event'] != 'Graduated' && in_array($values['degree'], $degrees))) {
    form_set_error('degree1', "Wrong 'Degree' specified for 'Event'.");
  }
}


function staff_student_action_form_submit($form, &$state) {

  $values = $state['values'];
  //$programmes = get_programmes(0, true);
  // student_record CCK

  $studentRecord = array('title' =>  $values['studentName'] .' - '. $values['programmeName'],
  	                 'uid' => $values['uid'], 'event' => $values['event'], 'degree' => $values['degree'],
  	                 'session' => $values['session'], 'programmeUID' => $values['programmeUID'], 'comment' => $values['comment']

  	  );

  create_student_record_cck($studentRecord);
  drupal_set_message('<b>' . $values['event'] .'</b> with <b>'. $values['degree'] .'</b> for <b>'. $values['session'] .'</b> session was applied to <b>'. $values['studentName'] .'</b>');
}


function create_student_record_cck(&$studentRecord) {
  global $user;
  $node = new stdClass();
  $node->type                               = 'student_record';
  $node->uid                                = 1;  // Admin
  $node->status                             = 1;  // Published
  $node->promote                            = 0;
  $node->sticky                             = 0;
  $node->comment                            = 0;
  $node->title                              = $studentRecord['title']; //[Student Name] . ' - ' . [Programme Name];
  $node->field_student_ref_sr[0]['uid']     = $studentRecord['uid']; //uid of Student;
  $node->field_event_sr[0]['value']         = $studentRecord['event']; //select from Graduated, Left Voluntarily, Left Forced, Repeat Session
  $node->field_degree_sr[0]['value']        = $studentRecord['degree']; //select from degree class (None, First Class, Second Class Upper, Second Class Lower, Third Class, Pass
  $node->field_session_sr[0]['value']       = $studentRecord['session']; //session user graduated from or has been forced to repeat e.g. 2009/2010
  $node->field_student_program_sr[0]['nid'] = $studentRecord['programmeUID']; //node ID of program CCK that this record refers to
  $node->field_approver_sr[0]['uid']        = $user->uid; //uid of user who created this record;
  $node->field_comment_sr[0]['value'] = ! empty($studentRecord['comment']) ? $studentRecord['comment'] : null;
  node_save($node);

}


function staff_drop_registered_course() {
  global $user;
  ob_start();
  echo '<br /><hr /><br />';
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Mark a Course Registration as Dropped</font><br /><br />";
      $navi .= '<br /><hr /><br />';
  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registry', 'Registrar'))) {

    if (! isset($_SESSION['eduerp_drop_on']) && ! isset($_POST['eduerp_drop_on'])) {

      echo $navi;
      echo "<b>Get Student Registered Courses</b> - Please fill the form as appropriate<br /><br />";
      echo drupal_get_form('get_student_course_instance_form');

    }
    else {//show form to allow him drop courses
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href='". url('staff/dropcoursereg') ."'>Mark a Course Registration as Dropped</a>&nbsp; &raquo; &nbsp; Student: <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['mat_no'] ."</b></font><br /><br />";
      $navi .= '<br /><hr /><br />';
      echo $navi;
      //echo "<b></b> | <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['fname'] ."</b> - <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['mat_no'] ."</b> | <b>". $_SESSION['eduerp_drop_course_info']['session'] ." Session</b>  |  <b>Semester ". $_SESSION['eduerp_drop_course_info']['semester'] ."</b> - Select a Course to Drop it<br /><br />";
      echo "<b>List of Registered Courses by</b> | <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['fname'] ."</b> - <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['mat_no'] ."</b>
      | <b>". $_SESSION['eduerp_drop_course_info']['session'] ." Session</b>  |  <b>Semester ". $_SESSION['eduerp_drop_course_info']['semester'] ."</b>
      | <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['current_programme_name'] ."</b>
      | Student current level <b>". $_SESSION['eduerp_drop_course_info']['studentInfo']['level'] ." </b>
      <br /><br />- Select a Course to Drop it<br /><br />";
      echo drupal_get_form('get_student_drop_course_form');

    }

  }
  else {
    echo $navi;
    //echo Error_Types(127);
    drupal_set_message(Error_Types(127), 'error');

  }
  unset($_SESSION['eduerp_drop_on']);
  return ob_get_clean();
}


function get_student_drop_course_form() {
  $form['#title'] = 'Drop Course Form';
  $courses = array();
  if(isset($_SESSION['eduerp_drop_course_info'])) {
    $result = get_student_registered_courses($_SESSION['eduerp_drop_course_info']['studentInfo']['uid'], $_SESSION['eduerp_drop_course_info']['session'], $_SESSION['eduerp_drop_course_info']['semester']);

    if (db_affected_rows($result) > 0) {
      while($r = db_fetch_object($result))
      $courses[$r->nid] = $r->course_code;
    }
  }

 $form['student_grade_nid'] = array(
    '#type' => 'select',
    '#options' => array(''=>'') + $courses,
    '#title' => 'Registered Courses',
    '#required' =>TRUE
  );

  $form['eduerp_drop_on'] = array(
    '#type' => 'hidden',
    '#default_value'=>1,
    '#title' => 'keep showing form'
  );


  $form['submit'] = array(
      '#value' => 'Drop Course',
      '#type' => 'submit'
  );


  return $form;

}


function get_student_drop_course_form_validate($form, &$state) {
  $_SESSION['eduerp_drop_on'] = 1;//keep showing the form

  //check for remainders
  $result = get_student_registered_courses($_SESSION['eduerp_drop_course_info']['studentInfo']['uid'], $_SESSION['eduerp_drop_course_info']['session'], $_SESSION['eduerp_drop_course_info']['semester']);
  if(db_affected_rows($result) <= 0)
    drupal_set_message(Error_Types(126). 'error');
}


function get_student_drop_course_form_submit($form, &$state) {
  $values = $state['values'];
  $_SESSION['eduerp_drop_on'] = 1;//keep showing the form
  $sql = "UPDATE {content_type_student_grades} SET field_dropped_value = 1 WHERE nid = %d";
  db_query($sql, $values['student_grade_nid']);
  cache_clear_all('content:', content_cache_tablename(), TRUE);

  update_credit_load_registered($_SESSION['eduerp_drop_course_info']['studentInfo']['uid'], $_SESSION['eduerp_drop_course_info']['session'], $_SESSION['eduerp_drop_course_info']['semester']);

  drupal_set_message('The Course has been dropped!');
  //check for remainders
  $result = get_student_registered_courses($_SESSION['eduerp_drop_course_info']['studentInfo']['uid'], $_SESSION['eduerp_drop_course_info']['session'], $_SESSION['eduerp_drop_course_info']['semester']);
  if(db_affected_rows($result) <= 0)
    drupal_set_message(Error_Types(126), 'error');
}


function get_student_course_instance_form() {
  $form['#title'] = 'Get Student Registered Courses By Session and Semester ';

  $form['mat_no'] = array(
    '#type' => 'textfield',
    '#title' => 'Matriculation Number',
    '#required' => TRUE
  );

 $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#title' => 'Session'
  );
  $form['semester'] = array(
      '#type' => 'select',
      '#options' => array(1 => '1', 2 => '2', 3=>'3'),
      '#title' => 'Semester'
   );
  $form['submit'] = array(
      '#value' => 'Get Registered Courses',
      '#type' => 'submit'
  );


  return $form;

}


function get_student_course_instance_form_validate($form, &$state) {
  $values = $state['values'];
  $studentInfo = user_load(array('name'=>$values['mat_no']));


  if( ! $studentInfo) {
    form_set_error('mat_no', Error_Types(125));
  }
  else {

     //check for registered course
    $registeredCourses = get_student_registered_courses($studentInfo->uid, $values['session'], $values['semester']);
    if (db_affected_rows($registeredCourses) <= 0) {
      drupal_set_message(Error_Types(124), 'error');

    }
    else {//course reg info exists

      $student_profile = new UserProfile($studentInfo->uid);

      $rs = get_programmes($student_profile->profile_first_choice);
      $programmeInfo = db_fetch_object($rs);

      //drupal_set_message('ok');
      //build tableField=>formElement array
      $studInfo = array('uid'=>$studentInfo->uid, 'fname'=>$student_profile->profile_first_name, 'mat_no'=>$studentInfo->name,
        'level'=>$student_profile->profile_level_name,
        'current_programme_nid'=>$programmeInfo->programme_nid,
        'current_programme_name'=>$programmeInfo->programme_name
      );
      $_SESSION['eduerp_drop_on'] = 1;//keep showing the form
      unset($_SESSION['eduerp_drop_course_info']);
      //ini_ses($studentInfo->uid, "eduerp_drop_course_info");
      $_SESSION['eduerp_drop_course_info'] = array('studentInfo' => $studInfo, 'session' => $values['session'], 'semester' => $values['semester']);
    }
  }
}


function get_student_registered_courses($studentUID, $session, $semester) {
  $sql = "SELECT g.nid nid, t.nid ctci_nid, c.field_code_value course_code
  FROM {content_type_student_grades} g
    INNER JOIN {content_type_course_instance} t ON g.field_course_instance_nid = t.nid AND t.field_sess_name_value = '%s' AND t.field_semester_name_value = '%s'
    INNER JOIN {content_type_course} c ON t.field_course_id_nid = c.nid
    WHERE g.field_mat_no_uid = %d AND g.field_dropped_value=0 ";
  $result = db_query($sql, $session, $semester, $studentUID);

  return $result;


}


function staff_manual_course_reg() {
  global $user;
  ob_start();
  echo '<br /><hr /><br />';
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Manual Course Registration</font><br /><br />";
      $navi .= '<br /><hr /><br />';
  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registry', 'Registrar'))) {

    if (! isset($_SESSION['eduerp_reg_on']) && ! isset($_POST['eduerp_reg_on'])) {

      echo $navi;
      echo "<b>Get Student unRegistered Courses</b> - Please fill the form as appropriate<br /><br />";
      echo drupal_get_form('get_student_unreg_course_form');

    }
    else {//show form to allow him register courses
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href='". url('staff/manualcoursereg') ."'>Manual Course Registration</a>&nbsp; &raquo; &nbsp; Student: <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['mat_no'] ."</b></font><br /><br />";
      $navi .= '<br /><hr /><br />';
      echo $navi;
      //echo "<b>List of unRegistered Courses</b> | <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['fname'] ."</b> - <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['mat_no'] ."</b> | <b>". $_SESSION['eduerp_reg_course_info']['session'] ." Session</b>  |  <b>Semester ". $_SESSION['eduerp_reg_course_info']['semester'] ."</b> - Select a Course to Register it<br /><br />";
      echo "<b>List of unRegistered Courses for</b> | <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['fname'] ."</b> - <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['mat_no'] ."</b>
      | <b>". $_SESSION['eduerp_reg_course_info']['session'] ." Session</b>  |  <b>Semester ". $_SESSION['eduerp_reg_course_info']['semester'] ."</b>
      | <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['current_programme_name'] ."</b>
      |  Student current level <b>". $_SESSION['eduerp_reg_course_info']['studentInfo']['level'] ." </b>
      <br /><br />- Select a Course to Register it<br /><br />";
      echo drupal_get_form('get_student_reg_course_form');

    }

  }
  else {
    echo $navi;
    //echo Error_Types(127);
    drupal_set_message(Error_Types(127), 'error');

  }
  unset($_SESSION['eduerp_reg_on']);
  return ob_get_clean();
}


function get_student_unreg_course_form() {
  $form['#title'] = 'Get Student unRegistered Courses By Session and Semester ';

  $form['mat_no'] = array(
    '#type' => 'textfield',
    '#title' => 'Matriculation Number',
    '#required' => TRUE
  );

 $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#title' => 'Session'
  );
  $form['semester'] = array(
      '#type' => 'select',
      '#options' => array(1 => '1', 2 => '2', 3=>'3'),
      '#title' => 'Semester'
   );
  $form['submit'] = array(
      '#value' => 'Get unRegistered Courses',
      '#type' => 'submit'
  );


  return $form;

}


function get_student_unreg_course_form_validate($form, &$state) {
  $values = $state['values'];

  $studentInfo = user_load(array('name'=>$values['mat_no']));


  if( ! $studentInfo) {
    form_set_error('mat_no', Error_Types(125));
  }
  else {

    //check for unregistered course
    $unRegisteredCourses = get_student_unregistered_courses($studentInfo->uid, $values['session'], $values['semester']);
    if (db_affected_rows($unRegisteredCourses) <= 0) {
      drupal_set_message(Error_Types(128), 'error');

    }
    else {//course reg info exists
      $student_profile = new UserProfile($studentInfo->uid);

      $rs = get_programmes($student_profile->profile_first_choice);
      $programmeInfo = db_fetch_object($rs);


      //build tableField=>formElement array
      $studInfo = array('uid'=>$studentInfo->uid, 'fname'=>$student_profile->profile_first_name, 'mat_no'=>$studentInfo->name,
        'level'=>$student_profile->profile_level_name,
        'current_programme_nid'=>$programmeInfo->programme_nid,
        'current_programme_name'=>$programmeInfo->programme_name
      );
      $_SESSION['eduerp_reg_on'] = 1;//keep showing the form

      unset($_SESSION['eduerp_reg_course_info']);
      $_SESSION['eduerp_reg_course_info'] = array('studentInfo' => $studInfo, 'session'=>$values['session'] , 'semester'=>$values['semester'] );
    }
  }
}


function get_student_reg_course_form() {
  $form['#title'] = 'Register Course Form';
  $courses = array();
  if(isset($_SESSION['eduerp_reg_course_info'])) {
    $result = get_student_unregistered_courses($_SESSION['eduerp_reg_course_info']['studentInfo']['uid'], $_SESSION['eduerp_reg_course_info']['session'], $_SESSION['eduerp_reg_course_info']['semester']);

    if (db_affected_rows($result) > 0) {
      while($r = db_fetch_object($result))
      $courses[$r->course_instance] = check_plain($r->course_code);
    }
  }

 $form['course_instance_id'] = array(
    '#type' => 'select',
    '#options' => array(''=>'') + $courses,
    '#title' => 'unRegistered Courses',
    '#required' =>TRUE
  );

  $form['eduerp_reg_on'] = array(
    '#type' => 'hidden',
    '#default_value'=>1,
    '#title' => 'keep showing form'
  );


  $form['submit'] = array(
      '#value' => 'Register Course',
      '#type' => 'submit'
  );


  return $form;

}


function get_student_reg_course_form_validate($form, &$state) {
  $_SESSION['eduerp_reg_on'] = 1;//keep showing the form

  $values = $state['values'];

  // Insure that there is no already existing 'student_grades' CCK for the same student, session and semester for the same course
  $sql = "SELECT sg.nid, ci.nid, c.nid
    FROM {content_type_student_grades} sg
    INNER JOIN {content_type_course_instance} ci ON sg.field_course_instance_nid = ci.nid AND ci.field_sess_name_value = '%s' AND ci.field_semester_name_value = '%s'
    INNER JOIN {content_type_course} c ON ci.field_course_id_nid = c.nid
    WHERE sg.field_mat_no_uid = %d AND sg.field_dropped_value = 0 AND c.nid IN
      (
        SELECT c0.nid
        FROM {content_type_course} c0
        INNER JOIN {content_type_course_instance} ci0 ON c0.nid = ci0.field_course_id_nid
        WHERE ci0.nid = %d
      )";
  $result = db_query($sql, $_SESSION['eduerp_reg_course_info']['session'], $_SESSION['eduerp_reg_course_info']['semester'], $_SESSION['eduerp_reg_course_info']['studentInfo']['uid'], $values['course_instance_id']);

  if (db_affected_rows($result) > 0)
    form_set_error('course_instance_id', 'That course is already registered for this session and semester');

  //check for remainders
  $result = get_student_unregistered_courses($_SESSION['eduerp_reg_course_info']['studentInfo']['uid'], $_SESSION['eduerp_reg_course_info']['session'], $_SESSION['eduerp_reg_course_info']['semester']);
  if(db_affected_rows($result) <= 0)
    drupal_set_message(Error_Types(126), 'error');
}


function get_student_reg_course_form_submit($form, &$state) {
  $_SESSION['eduerp_reg_on'] = 1;//keep showing the form
  $values = $state['values'];

  $studentUID = $_SESSION['eduerp_reg_course_info']['studentInfo']['uid'];
  $student_profile = new UserProfile($studentUID);
  $session = $_SESSION['eduerp_reg_course_info']['session'];
  $semester = $_SESSION['eduerp_reg_course_info']['semester'];
  $studentname = '';
  if (!empty($student_profile->profile_first_name) && !empty($student_profile->profile_last_name)) {
    $middle = '';
    if (!empty($student_profile->profile_middle_name)) $middle = ' ' . $student_profile->profile_middle_name;
    $studentname = "{$student_profile->profile_last_name}, {$student_profile->profile_first_name}{$middle}";
  }

  // Find the program type
  $sql = "SELECT field_program_type_value FROM {content_type_program} WHERE nid=%d";
  $result = db_query($sql, $student_profile->profile_first_choice);
  $row = db_fetch_object($result);
  $program_type = abs($row->field_program_type_value);
  if ($program_type == 3 && $student_profile->profile_level_name == '100') $program_type = 0; // First year medicine does not use medicine type scales

  // Find the existing student_program
  $sql = "SELECT nid FROM {content_type_student_program} WHERE field_student_ref_sp_uid=%d AND field_program_ref_sp_nid=%d";
  $result = db_query($sql, $studentUID, $student_profile->profile_first_choice);
  $row = db_fetch_object($result);
  $student_program = $row->nid;

  $student->uid = $studentUID;
  $student_gpa = create_student_gpa($student, $student_profile, $studentname, $student_program, $session, $semester, 0);

  create_student_grades($student, $values['course_instance_id'], $student_gpa, $studentname, $program_type);

  update_credit_load_registered($studentUID, $session, $semester);

  drupal_set_message('Course was Registered Successfully!');

  //check for remainders
  $result = get_student_unregistered_courses($_SESSION['eduerp_reg_course_info']['studentInfo']['uid'], $session, $semester);
  if(db_affected_rows($result) <= 0)
    drupal_set_message(Error_Types(126), 'error');
}


function get_student_unregistered_courses($studentUID, $session, $semester) {
  //get the student's profile info
  $student_profile = new UserProfile($studentUID);
  $studInfo['fname'] = $student_profile->profile_first_name;

  //we need to get the courses he may have registered for reason being we will not be including those
  $registeredCourses = get_student_registered_courses($studentUID, $session, $semester);
  $strRegisteredCourses = "";
  if(db_affected_rows($registeredCourses) > 0) {
    //these are the courses he already registered for the session/semester
    //build content_type_instance_id array
    while ($r = db_fetch_object($registeredCourses)) {
      $exclude[] = $r->ctci_nid;
    }
    if (is_array($exclude) && sizeof($exclude)) {
      $registered_nids = implode (", ", $exclude);
      $strRegisteredCourses = " AND ci.nid NOT IN (". $registered_nids .") ";
    }
  }

  $sql = "SELECT DISTINCT
        ci.nid AS course_instance,
        CONCAT(c.field_code_value, IF(ci.field_location_value > 1, CONCAT(' (', CAST(ci.field_location_value AS CHAR), ': ', LEFT(ci.field_timetable_value, 100), ')'), '')) AS course_code
      FROM
        {content_type_course_instance} ci,
        {content_type_course} c,
        {program_course} pc
      WHERE
        ci.field_sess_name_value='%s' AND
        ci.field_semester_name_value='%s' AND
        ci.field_course_id_nid=c.nid AND
        c.nid=pc.course_id AND
        pc.programme_id=%d
        ". $strRegisteredCourses ."
      ORDER BY course_code";
  $result = db_query($sql, $session, $semester, $student_profile->profile_first_choice);
  return $result;
}


function update_credit_load_registered($uid, $session, $semester) {
  $sql = "
    SELECT SUM(sg.field_credit_load_sg_value) AS total_registered
    FROM {content_type_student_gpa} gpa
    INNER JOIN {content_type_student_grades} sg ON gpa.nid = sg.field_student_gpa_nid
    WHERE
      gpa.field_student_ref_gpa_uid = %d AND gpa.field_sess_name_gpa_value = '%s' AND gpa.field_semester_name_gpa_value = '%s' AND
      sg.field_dropped_value = 0";
  $sql = "
    SELECT SUM(sg.field_credit_load_sg_value) AS total_registered
    FROM {content_type_student_gpa} gpa
    INNER JOIN {content_type_student_grades} sg ON gpa.nid = sg.field_student_gpa_nid
    INNER JOIN {content_type_course_instance} ci ON sg.field_course_instance_nid = ci.nid
    INNER JOIN {content_type_course} c ON ci.field_course_id_nid = c.nid
    WHERE
      gpa.field_student_ref_gpa_uid = %d AND gpa.field_sess_name_gpa_value = '%s' AND gpa.field_semester_name_gpa_value = '%s' AND
      sg.field_dropped_value = 0";
  if ($semester != '3') {
      // Suppress courses failed in previous semesters which should not be counted towards registered credit (see same SQL in student_course_form_validate())
      // (except that in semester 3 they should be included)
      $sql .= " AND
      c.field_code_value NOT IN(
        SELECT DISTINCT
          cx.field_code_value
        FROM
          {content_type_student_grades} sgx,
          {content_type_course_instance} cix,
          {content_type_course} cx,
          {program_course} pcx,
          {node} nsprox,
          {content_type_student_profile} sprox
        WHERE
          IF(sgx.field_gradepoint_value='-', 0, sgx.field_gradepoint_value)=0 AND
          sgx.field_mat_no_uid=%d AND
          sgx.field_course_instance_nid=cix.nid AND
          sgx.field_examscorelocked_value>0 AND
          sgx.field_dropped_value=0 AND
          cix.field_course_id_nid=cx.nid AND
          cix.field_course_id_nid=pcx.course_id AND
          CONCAT(cix.field_sess_name_value, cix.field_semester_name_value)<'%s%s' AND
          pcx.programme_id=sprox.field_profile_first_choice_nid AND
          nsprox.uid=sgx.field_mat_no_uid AND
          nsprox.type='student_profile' AND
          nsprox.vid=sprox.vid
        )";
    $result = db_query($sql, $uid, $session, $semester, $uid, $session, $semester);
  }
  else {
    $result = db_query($sql, $uid, $session, $semester);
  }
  $r = db_fetch_object($result);

  $sql = "UPDATE {content_type_student_gpa} gpa1 SET field_credit_load_registered_value = %d
    WHERE gpa1.field_student_ref_gpa_uid = %d AND gpa1.field_sess_name_gpa_value = '%s' AND gpa1.field_semester_name_gpa_value = '%s'";
  db_query($sql, $r->total_registered, $uid, $session, $semester);
  cache_clear_all('content:', content_cache_tablename(), TRUE);
}


function staff_change_student_programme() {
  global $user;
  ob_start();
  echo '<br /><hr /><br />';
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Change a Student's Programme</font><br /><br />";
      $navi .= '<br /><hr /><br />';
  if(isset($_SESSION['eduerp_change_prog_on'])) $_POST['eduerp_change_prog_on'] = $_SESSION['eduerp_change_prog_on'];

  if (staff_has_eduerp_role($user->uid, 0, 0, array('Registry', 'Registrar'))) {

    if (! isset($_SESSION['eduerp_change_prog_on']) && ! isset($_POST['eduerp_change_prog_on'])) {

      echo $navi;
      echo "<b>Get Student Info</b> - Please fill the form as appropriate<br /><br />";
      echo drupal_get_form('get_student_info_form');

    }
    elseif ($_POST['eduerp_change_prog_on'] == 1) {//page1


        $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href='". url('staff/changeprogmme') ."'>Change a Student's Programme</a>&nbsp; &raquo; &nbsp; Student: <b>". $_SESSION['eduerp_change_prog_info']['mat_no'] ."</b>&nbsp; &raquo; &nbsp; Select New Programme</font><br /><br />";
        $navi .= '<br /><hr /><br />';
        echo $navi;
        echo "<b>Student Current Info</b> | <b>". $_SESSION['eduerp_change_prog_info']['fname'] ."</b> - <b>". $_SESSION['eduerp_change_prog_info']['mat_no'] ."</b>
        | <b>". $_SESSION['eduerp_change_prog_info']['current_programme_name'] ."</b>
        | Student current level <b>". $_SESSION['eduerp_change_prog_info']['level'] ."</b>
        <br /><br />- Select a New Programme for the Student<br /><br />";
        echo drupal_get_form('staff_student_change_programme_form');
        echo "<font color=#FF0000><b>Do NOT do this until the session in which the student will be taking courses for the new program has started (otherwise the student's level will get increased for the new session)</b></font>";

      }
      elseif($_POST['eduerp_change_prog_on'] == 2) { //page 2
        $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href='". url('staff/changeprogmme') ."'>Change a Student's Programme</a>&nbsp; &raquo; &nbsp; Student: <b>". $_SESSION['eduerp_change_prog_info']['mat_no'] ."</b>&nbsp; &raquo; &nbsp; Effect New Programme</font><br /><br />";
        $navi .= '<br /><hr /><br />';
        echo $navi;
        //echo "<b>Student Current Info</b> | <b>". $_SESSION['eduerp_change_prog_info']['fname'] ."</b> - <b>". $_SESSION['eduerp_change_prog_info']['mat_no'] ."</b>
        //| <b>". $_SESSION['eduerp_change_prog_info']['current_programme_name'] ."</b>
        //| Student current level <b>". $_SESSION['eduerp_change_prog_info']['level'] ." </b> ";


        //echo '<br /><br />';
        echo "<b>Student New Info</b> | <b>". $_SESSION['eduerp_change_prog_info']['fname'] ."</b> - ".
        $_SESSION['eduerp_change_prog_info']['new_mat_no'] ."
        | <b>". $_SESSION['eduerp_change_prog_info']['new_programme_name'] ."</b>
        | Student new level <b>". $_SESSION['eduerp_change_prog_info']['new_programme_level'] ." </b> ";

        echo '<br /><hr /><br />';
        echo '<b>List of Passed Courses</b>';
        echo '<br /><br />';
        echo "<p>Below is the list of all Courses previously entered for and passed by this student.<br />
        The student most probably is expected to move with some of their earned credits to the new programme.<br />
        The Courses ticked below will automatically be credited to the new Programme.<br />
        Those unticked will not be.<br />
        If you wish the student to carry the credits of the unticked Courses over to the new Programme,<br />
        then the HOD for the Programme (or you if you have rights) should go to the<br />
        'Specify Courses for a Programme' part of <a href='createmodifyprog' target='_new'>Create/Modify a Programme</a>.<br />
        Add the courses to the Programme and immediately \"Delete\" them from the Programme so that they are<br />
        marked as 'Historical' so they cannot be registered by students selecting courses for a semester.<br />
        You can also click on the links below to get there faster.</p>";

        //echo show_student_previous_programme_results($_SESSION['eduerp_change_prog_info']['uid'], $_SESSION['eduerp_change_prog_info']['current_programme_nid']);
        echo get_courses_passed_by_student($_SESSION['eduerp_change_prog_info']['new_programme_nid'], $_SESSION['eduerp_change_prog_info']['uid']);
        //echo "<br /><hr /><br />- Map the new Programme<br /><br />";
        //echo drupal_get_form('get_student_change_prog_form');
      }

  }
  else {
    echo $navi;
    //echo Error_Types(127);
    drupal_set_message(Error_Types(127), 'error');

  }
  unset($_SESSION['eduerp_change_prog_on']);
  return ob_get_clean();
}


function get_student_info_form() {
  $form['#title'] = 'Get Student Information ';

  $form['mat_no'] = array(
    '#type' => 'textfield',
    '#title' => 'Matriculation Number',
    '#required' => TRUE
  );

  $form['submit'] = array(
      '#value' => 'Get Student Info',
      '#type' => 'submit'
  );


  return $form;

}


function get_student_info_form_validate($form, &$state) {
  $values = $state['values'];
  $studentInfo = user_load(array('name'=>$values['mat_no']));


  if( ! $studentInfo) {
    form_set_error('mat_no', Error_Types(125));
  }
  else {

    //build tableField=>formElement array
    //drupal_set_message($studentInfo->uid);


    /*
    //make sure that GPA is not below 0.75
    $rs = get_student_current_GPA($studentUID, $level);

    if(db_affected_rows($rs) <= 0) {
      //either he is a new student or he has not sat for exams yet
      drupal_set_message(Error_Types(130));
      return;
    }
      elseif (db_affected_rows($rs) > 1) {
      //we have 1st and 2nd semester GPAs now use the 1 without zero starting from second semester
      while($row = db_fetch_object($rs)) {
        $gpa[$row->semester] = $row->gpa_value;

        //check the second semester
        if($gpa[2] > 0 && $gpa[2] < 0.75) {
          drupal_set_message(Error_Types(131));
          return;
        }
        //check the first semester
        if($gpa[1] > 0 && $gpa[1] < 0.75) {
          drupal_set_message(Error_Types(131));
          return;
        }
      }
    }
      else {
        $gpa = db_fetch_object($rs);
        if ($gpa->gpa_value < 0.75) {
          drupal_set_message(Error_Types(131));
          return;
        }
    }
    */
    $student_profile = new UserProfile($studentInfo->uid);
    //get the current programme name
    $rs = get_programmes($student_profile->profile_first_choice);
    $programmeInfo = db_fetch_object($rs);
    //  foreach($info as $k => $v)

    $studInfo = array('uid'=>$studentInfo->uid, 'fname'=>$student_profile->profile_first_name, 'mat_no'=>$studentInfo->name,
          'level'=>$student_profile->profile_level_name,
          'current_programme_nid'=>$programmeInfo->programme_nid,
          'current_programme_name'=>$programmeInfo->programme_name
          );

    unset($_SESSION['eduerp_change_prog_info']);
    $_SESSION['eduerp_change_prog_on'] = 1;//keep showing the form
    //ini_ses($studentInfo->uid, "eduerp_change_prog_info");
    $_SESSION['eduerp_change_prog_info'] = $studInfo;

  }
}


function staff_student_change_programme_form_submit($form, &$state) {
  $values = $state['values'];
  $rs = get_programmes($values['programme_nid']);
  $programmeInfo = db_fetch_object($rs);
  $student_profile = new UserProfile($_SESSION['eduerp_change_prog_info']['uid']);
  $_SESSION['eduerp_change_prog_info']['new_programme_nid'] = $values['programme_nid'];
  $_SESSION['eduerp_change_prog_info']['new_programme_name'] = $programmeInfo->programme_name;
  $_SESSION['eduerp_change_prog_info']['new_programme_level'] = $values['level_name'];

  $first_choice = $_SESSION['eduerp_change_prog_info']['new_programme_nid'];
  $level = $_SESSION['eduerp_change_prog_info']['new_programme_level'];
  //so go ahead with the change
  change_student_program($student_profile, $first_choice, $level);


  //create the content_type_student_record here
  $studentname = '';
  if (!empty($student_profile->profile_first_name) && !empty($student_profile->profile_last_name)) {
    $middle = '';
    if (!empty($student_profile->profile_middle_name)) $middle = ' ' . $student_profile->profile_middle_name;
    $studentname = "{$student_profile->profile_last_name}, {$student_profile->profile_first_name}{$middle}";
  }
  if ($student_profile->profile_reg_session !== variable_get('eduerp_current_session', '')) {

    $studentRecord = array('title' =>  $studentname .' - '. $_SESSION['eduerp_change_prog_info']['new_programme_name'],
  	                 'uid' => $_SESSION['eduerp_change_prog_info']['uid'], 'event' => 'Changed from Old Programme', 'degree' => 'None',
  	                 'session' => $student_profile->profile_reg_session, 'programmeUID' => $_SESSION['eduerp_change_prog_info']['new_programme_nid'],
  	                 'comment' => 'Changed from Old Programme'
  	  );

    create_student_record_cck($studentRecord);
  }

  $studentRecord = array('title' =>  $studentname .' - '. $_SESSION['eduerp_change_prog_info']['new_programme_name'],
  	                 'uid' => $_SESSION['eduerp_change_prog_info']['uid'], 'event' => 'Changed to New Programme', 'degree' => 'None',
  	                 'session' => variable_get('eduerp_current_session', ''), 'programmeUID' => $_SESSION['eduerp_change_prog_info']['new_programme_nid'],
  	                 'comment' => 'Changed to New Programme'
  	  );
   create_student_record_cck($studentRecord);

  drupal_set_message('The Student\'s Programme was changed successfully!');


  //get students new mat no
  $student_profile = new UserProfile($_SESSION['eduerp_change_prog_info']['uid']);
  $_SESSION['eduerp_change_prog_info']['new_mat_no'] = $student_profile->profile_matno;
  $_SESSION['eduerp_change_prog_on'] = 2;
  drupal_goto('staff/changeprogmme');//force a refresh

}


function staff_student_change_programme_form_validate($form, &$state) {
  ;

 /*
  //if(! empty($values['programme_nid'])) {
    //make sure that the new selected is not within the faculty
    $currentFaculty = get_programme_faculty($_SESSION['eduerp_change_prog_info']['current_programme_nid']);

    $newFaculty = get_programme_faculty($values['programme_nid']);
    //drupal_set_message('new is ' . $newFaculty);
    if ($currentFaculty == $newFaculty) {

      form_set_error('programme_nid', Error_Types(132));
      return;

    }
    else {
      $rs = get_programmes($values['programme_nid']);
      $programmeInfo = db_fetch_object($rs);

      $_SESSION['eduerp_change_prog_info']['new_programme_nid'] = $values['programme_nid'];
      $_SESSION['eduerp_change_prog_info']['new_programme_name'] = $programmeInfo->programme_name;
      $_SESSION['eduerp_change_prog_info']['new_programme_level'] = $values['level_name'];
      $_SESSION['eduerp_change_prog_on'] = 2;
      //$_POST['eduerp_change_prog_on'] = 2;
      drupal_goto('staff/changeprogmme');
      //drupal_set_message('done');
   // }

  //}
  */
}


function staff_student_change_programme_form() {
  $form['#title'] = "Change a Student's Programme";

 $form['programme_nid'] = array(
    '#type' => 'select',
    '#options' => array(' '=>' ') + get_programmes(0, true),
    '#title' => 'New Programme for Student',
    '#ahah' => array('path' => 'staff/ajax/programmelevel', 'event' => 'change', 'method' => 'replace', 'wrapper' => 'programmelevels'),
    '#required' => TRUE

  );
  //
 $form['level_name'] = array(
    '#type' => 'select',
    '#options' => staff_level(),
    '#title' => 'New Start Level',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#prefix' => "<div id='programmelevels'>",
    '#suffix' => "</div>",
    '#disabled' => TRUE,
    '#required' => TRUE
  );

 $form['eduerp_change_prog_on'] = array(
    '#type' => 'hidden',
    '#default_value'=>1,
    '#title' => 'keep showing form'
  );

  $form['submit'] = array(
      '#value' => 'Change Student Programme Now',
      '#type' => 'submit'
  );
  return $form;


}

/*
function get_student_prog_form() {
  $form['#title'] = 'Continue to Change Student Programme';

 $form['programme_nid'] = array(
    '#type' => 'select',
    '#required' => TRUE,
    '#options' => array(' '=>' ') + get_programmes(0, true),
    '#title' => 'New Programme for Student',
    '#ahah' => array('path' => 'staff/ajax/programmelevel', 'event' => 'change', 'method' => 'replace', 'wrapper' => 'programmelevels')

  );
 $form['level_name'] = array(
    '#type' => 'select',
    '#options' => staff_level(),
    '#title' => 'New Start Level',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#prefix' => "<div id='programmelevels'>",
    '#suffix' => "</div>",
    '#disabled' => TRUE,
    '#required' => TRUE
  );

 $form['eduerp_change_prog_on'] = array(
    '#type' => 'hidden',
    '#default_value'=>2,
    '#title' => 'keep showing form'
  );

  $form['submit'] = array(
      '#value' => 'Continue',
      '#type' => 'submit'
  );
  return $form;
}
*/
/*
function get_student_prog_validate($form, &$state) {
  form_set_error('programme_nid', Error_Types(132));
 $values = $state['values'];
 drupal_set_message('ok');
  //if(! empty($values['programme_nid'])) {
    //make sure that the new selected is not within the faculty
    $currentFaculty = get_programme_faculty($_SESSION['eduerp_change_prog_info']['current_programme_nid']);

    $newFaculty = get_programme_faculty($values['programme_nid']);
    //drupal_set_message('new is ' . $newFaculty);
    if ($currentFaculty == $newFaculty) {

      form_set_error('programme_nid', Error_Types(132));
      return;

    }
    else {
      $rs = get_programmes($values['programme_nid']);
      $programmeInfo = db_fetch_object($rs);

      $state['storage']['new_programme_nid'] = $values['programme_nid'];
      $state['storage']['new_programme_name'] = $programmeInfo->programme_name;
      $state['storage']['new_programme_level'] = $values['level_name'];
      $_SESSION['eduerp_change_prog_on'] = 2;
      //drupal_set_message('done');
    }

  //}

}
*/


function show_student_previous_programme_results($studentUID, $programmeNID) {

  ;

}


function get_student_current_GPA($studentUID, $level) {
  //note we do not need to apply session here because the student may have come after say 2 years to continue. We only need to use his last ever level

  $sql = "SELECT field_gpaforstudent_value gpa_value, field_semester_name_gpa_value semester FROM {content_type_student_gpa} WHERE field_student_ref_gpa_uid = %d AND field_level_name_gpa_value = '%s'";
  $rs = db_query($sql, $studentUID, $level);
  return $rs;

}


function get_programme_faculty($programm_nid) {
  $sql = "SELECT f.nid FROM {content_type_program} p
    INNER JOIN {content_type_department} d ON p.field_department_id_nid = d.nid
    INNER JOIN {content_type_college} f ON f.nid = d.field_college_id_nid
    WHERE p.nid = %d ";

  $rs = db_query($sql, $programm_nid);
  $r = db_fetch_object($rs);
  return $r->nid;
}


function get_courses_passed_by_student($first_choice, $uid) {
  $sql = "SELECT DISTINCT c.field_code_value, pc.course_id
       FROM {content_type_student_grades} sg,
 {content_type_course_instance}
  ci, {content_type_course} c
       LEFT JOIN {program_course} pc ON c.nid=pc.course_id AND
 pc.programme_id=%d
       WHERE
         sg.field_mat_no_uid=%d AND
         sg.field_course_instance_nid=ci.nid AND
         sg.field_examscorelocked_value>0 AND
         sg.field_dropped_value=0 AND
         ci.field_course_id_nid=c.nid AND
         IF(sg.field_gradepoint_value='-', 0, sg.field_gradepoint_value)>0";
     $result = db_query($sql, $first_choice, $uid);
     $html = '';
     if (db_affected_rows($result) > 0) {
       $html = "
         <table border=1>
           <tr>
             <th>#</th>
             <th>&nbsp;</th>
             <th>Course Code</th>
           </tr>";$i=1;
       while ($row = db_fetch_object($result)) {
         if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
         $html .="
           <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
             <td>". $i++ ."</td>";
         if (empty($row->course_id) || is_null($row->course_id))
           $html .="
             <td><input type='checkbox' disabled></td>
             <td><a href='specifycourse/$first_choice' target='_new'>". $row->field_code_value ."</a></td>";
         else
           $html .="
             <td><input type='checkbox' disabled checked></td>
             <td>". $row->field_code_value ."</td>";
         $html .= "
           </tr>";
       }
       $html .= "
         </table>";
     }
     else{
       //$html = strip_tags(Error_Types(106));
       drupal_set_message(Error_Types(106), 'error');
     }

     return $html;
}


function staff_check_verify_programme_courses() {
  global $user;
  ob_start();
  echo '<br /><hr /><br />';
      $navi = "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Check have all existing Courses required for all Programmes been Verified</font><br /><br />";
      $navi .= '<br /><hr /><br />';


  //if (staff_has_eduerp_role($user->uid, 0, 0, array('Registry', 'Registrar'))) {
    if (isset($_SESSION['eduerp_required']) ) {
      $str = display_verify_required_courses_for_programme() ."<br />";

    }
    echo $navi;
    echo "<b>Verify Courses for all Programmes</b> - Please fill the form as appropriate<br /><br />";
    echo drupal_get_form('get_verify_required_courses_for_programme_form');
    echo $str;


 // }
 // else {
 //   echo $navi;
 //   echo Error_Types(127);

 // }
  if(isset($_SESSION['eduerp_required'])) unset($_SESSION['eduerp_required']);
  return ob_get_clean();

}


function get_verify_required_courses_for_programme_form() {
  $form['#title'] = 'Verify Required Courses for A Programme';


  $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#title' => 'Session',
    '#default_value'=>variable_get('eduerp_current_session', ''),
    '#required' => TRUE,
    );

  $form['semester'] = array(
    '#type' => 'select',
    '#options' => array(1=>'1', 2=>'2', 3=>'3'),
    '#title' => 'Semester',
    '#default_value'=>variable_get('eduerp_current_semester', ''),
    '#required' => TRUE,

    );

  $form['showDetails'] = array(
    '#type' => 'hidden',
    '#default_value' => 1,
    '#title' => 'trigger display',
    );
  $form['submit'] = array(
    '#value' => 'Verify Now',
    '#type' => 'submit'
  );

  return $form;

}


function get_verify_required_courses_for_programme_form_submit($form, &$state) {
  $values = $state['values'];

  $_SESSION['eduerp_required'] = $values;
  drupal_goto("staff/checkverifyprogmme");
}


function display_verify_required_courses_for_programme() {
  $values = $_SESSION['eduerp_required'];

  $sql = "SELECT DISTINCT
        pc.level,
        c.field_code_value course_code,
        p.field_programme_name_value programme_name,
        d.field_department_name_value department_name,
        co.field_college_name_value faculty_name
      FROM {program_course} pc
      INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
      INNER JOIN {content_type_course_instance} ci
      ON
        c.nid=ci.field_course_id_nid AND
        pc.semester=ci.field_semester_name_value AND
        ci.field_sess_name_value='%s' AND
        ci.field_semester_name_value='%s'
      INNER JOIN {content_type_program} p ON pc.programme_id=p.nid
      INNER JOIN {content_type_department} d ON p.field_department_id_nid=d.nid
      INNER JOIN {content_type_college} co ON d.field_college_id_nid=co.nid
      LEFT JOIN {program_course_instance} pci
      ON
        ci.nid=pci.course_instance_id AND
        pc.programme_id=pci.programme_id AND
        pc.semester=pci.semester AND
        ci.field_sess_name_value=pci.session
      WHERE pci.programme_id is NULL
      ORDER BY co.field_college_name_value, d.field_department_name_value, p.field_programme_name_value, pc.level, c.field_code_value";
    $result = db_query($sql, $values['session'], $values['semester']); $i = 1;
    if(db_affected_rows($result) > 0 ) {
      $html = "
      <br /><hr /><br />
      List of any Course(s) that are running for <b>". $values['session'] ." Session</b> and <b>Semester ". $values['semester'] ."</b> but have not been Verified/Assigned to a Programme that needs them...<br />
      <table border ='1'>
        <tr>
          <th>#</th>
          <th>Faculty Name</th>
          <th>Department Name</th>
          <th>Programme Name</th>
          <th>Level</th>
          <th>Course</th>
        </tr>";
    	while ($f = db_fetch_object($result)) {
    	  if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
    	  $html .= "
    	  <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
    	    <td>". $i++ ."</td>
    	    <td>". $f->faculty_name ."</td>
    	    <td>". $f->department_name ."</td>
    	    <td>". $f->programme_name ."</td>
    	    <td>". $f->level ."</td>
    	    <td>". $f->course_code ."</td>
    	  </tr>";


    	}
     $html .="
      </table>
      <br />
      Address the above issues here: <a href='createmodifyprog'>Create or Modify a University Programme</a><br />
      (Address the issue in the section \"Verify all Courses needed for a Programme are being run for a Semester\".)
      <br />";
    return $html;
    }
    else
      drupal_set_message("All existing Course are Verified for all Programmes for ". $values['session'] ." Session and Semester ". $values['semester'] ." ");

}


function get_course_grade_weighting($course_nid = 0) {

  $sql = "SELECT number_of_ca, ca_approved_onebyone, max_mark_ca1, max_mark_ca2, max_mark_ca3, max_mark_ca4, max_mark_exam FROM course_grade_weightings WHERE course_id = $course_nid LIMIT 1 ";
  $result = db_query($sql);
  if (db_affected_rows($result) <= 0) {
    $sql = "SELECT number_of_ca, ca_approved_onebyone, max_mark_ca1, max_mark_ca2, max_mark_ca3, max_mark_ca4, max_mark_exam FROM course_grade_weightings WHERE course_id = 0 LIMIT 1 ";
    $result = db_query($sql);
  }

  $dbFields = array('number_of_ca', 'ca_approved_onebyone', 'max_mark_ca1', 'max_mark_ca2', 'max_mark_ca3', 'max_mark_ca4', 'max_mark_exam');
  while ($r = db_fetch_object($result)) {
    foreach($dbFields as $v)
      $ca[$v] = $r->$v;
  }

  return $ca;
}


function create_course_weighting_entries(&$values) {

  if ($values['course_nid'] != 0) {
    //delete previous enteries
    $sql = "DELETE FROM course_grade_weightings WHERE course_id = %d ";
    db_query($sql, $values['course_nid']);

    $sql = "INSERT INTO course_grade_weightings (course_id, number_of_ca, ca_approved_onebyone, max_mark_ca1, max_mark_ca2, max_mark_ca3, max_mark_ca4, max_mark_exam  ) VALUES
    	(%d, %d, %d, %d, %d, %d, %d, %d) ";

    db_query($sql, $values['course_nid'], $values['caNum'], $values['caApproval'], $values['ca1'], $values['ca2'], $values['ca3'], $values['ca4'], $values['exam_mark']);

  }

}


function staff_views_api() {

  return array(

    'api' => 2,

    'path' => drupal_get_path('module', 'staff'),
  );

}

function staff_check_for_missing_courses(){
  global $user;
  ob_start();

  //if (! staff_has_eduerp_role($user->uid, 0, 0, array('Role Assigner'))) $isAuthorized = false; else $isAuthorized = true;

  echo '<br /><hr /><br />';

  //if (! $isAuthorized) {
  //  echo Error_Types(104);

  //}
  //else {

      	echo "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;Check for Missing Courses for a Semester</font><br /><br />";
        echo '<hr /><br />';
        echo "<b>Check for Missing Courses for a Semester</b> - Please fill the form as appropriate<br />";

      echo drupal_get_form('staff_show_check_missing_courses_form');
  //}
  echo '<br /><hr /><br />';

  if(! isset($_SESSION['eduerp_check_missing_courses'])) {
    $_SESSION['eduerp_check_missing_courses']['session'] = variable_get('eduerp_current_session', '');
    $_SESSION['eduerp_check_missing_courses']['semester'] = variable_get('eduerp_current_semester', 1);
  }
    //echo '<br /><hr /><br />';
    echo staff_display_missing_courses_for_a_semester($_SESSION['eduerp_check_missing_courses']['session'], $_SESSION['eduerp_check_missing_courses']['semester']);

  //}
  return ob_get_clean();

}

function staff_show_check_missing_courses_form() {



  $form['#title'] = 'Check For Missing Courses';
  $form['session'] = array(
    '#type' => 'select',
    '#options' => get_all_sessions(),
    '#required' => TRUE,
    '#title' => 'Session');

  if ($_SESSION['eduerp_check_missing_courses']) $form['session']['#default_value'] = $_SESSION['eduerp_check_missing_courses']['session'];

   $form['semester'] = array(
      '#type' => 'select',
      '#options' => array(1 => '1', 2 => '2'),
      '#title' => 'Semester',
      '#required' => TRUE);
   if ($_SESSION['eduerp_check_missing_courses']) $form['semester']['#default_value'] = $_SESSION['eduerp_check_missing_courses']['semester'];

  $form['submit'] = array(
    '#value' => 'Show Now',
    '#type' => 'submit'
  );

  return $form;
}

function staff_show_check_missing_courses_form_submit($form, &$state) {
  $values = $state['values'];

  $_SESSION['eduerp_check_missing_courses']['session']  = $values['session'];
  $_SESSION['eduerp_check_missing_courses']['semester'] = $values['semester'];

}


function staff_display_missing_courses_for_a_semester($session, $semester) {

  $sql = "SELECT DISTINCT
        pc.level,
        c.field_code_value,
        p.field_programme_name_value,
        d.field_department_name_value,
        co.field_college_name_value
      FROM {program_course} pc
      INNER JOIN {content_type_course} c ON pc.course_id=c.nid AND pc.historical=0
      LEFT JOIN {content_type_course_instance} ci
      ON
        c.nid=ci.field_course_id_nid AND
        pc.semester=ci.field_semester_name_value AND
        ci.field_sess_name_value='%s'
      INNER JOIN {content_type_program} p ON pc.programme_id=p.nid
      INNER JOIN {content_type_department} d ON c.field_department_nid_nid=d.nid
      INNER JOIN {content_type_college} co ON d.field_college_id_nid=co.nid
      WHERE pc.semester='%s' AND ci.nid IS NULL
      ORDER BY co.field_college_name_value, d.field_department_name_value, c.field_code_value, p.field_programme_name_value, pc.level";
    $result = db_query($sql, $session, $semester);

  if(db_affected_rows($result) <=0) return "<b>List of Missing Courses for ". $semester ." Semester in ". $session ." Session</b><br /><br /><div><font color=green><b>All courses have been setup and assigned a lecturer.</b></font></div>";

  $str = "
  <div id='assigned_courses'>
  <b>List of Missing Courses for ". $semester ." Semester in ". $session ." Session</b><br />
  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Faculty Name</b></th>
      <th><b>Department Name</b></th>
      <th><b>Programme Name</b></th>
      <th><b>Course Code</b></th>
       <th><b>Level</b></th>
    </tr>";$i = 1;
    //$faculties = get_departments();
    //foreach ($result as $v){
    while($v = db_fetch_object($result)){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $str .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td>". $i++ ."</td>
           <td>". $v->field_college_name_value ."</td>
           <td>". $v->field_department_name_value ."</td>
           <td>". $v->field_programme_name_value ."</td>
           <td>". $v->field_code_value ."</td>
           <td>". $v->level ."</td>
         </tr>";
      }

  //}
  $str .= "
  <tr>
    <td colspan=6>&nbsp;</td>
  </tr>
  <tr>
    <td colspan=6><font color=#FF0000><b>The HOD should go to <a href='" . url('staff/createeditcourse') . "'>Create or Modify Courses for a Department</a>, Select a Department and Start Assigning Lecturers to Courses</b></font></td>
  </tr>
  </table>
  </div>";
  return $str;

}

//school fees module starts here

function staff_school_fees_admin(){
 global $user;
  ob_start();

  unset($_SESSION['eduerp_fee_setup']); $_SESSION['eduerp_fee_setup'] = null;
  unset($_SESSION['eduerp_authorise_scholarship']); $_SESSION['eduerp_authorise_scholarship'] = null;
  unset($_SESSION['eduerp_authorise_instalment']); $_SESSION['eduerp_authorise_instalment'] = null;


  //initialize tables with default settings
  initialize_school_fee_module_tables();



  //$isAuthorized = true;

  $html = '<br /><hr /><br />';

  //if (! $isAuthorized) {
    //echo Error_Types(104);
  //  drupal_set_message(Error_Types(104), 'error');

  //}
  //else {
    $html .= "<font size = '1px'><a href = 'semester/'>Semester Administration</a>&nbsp; &raquo; &nbsp;School Fees Administration</font><br /><br />";
    $html .= '<hr /><br />';

    $html .= "Welcome to <b>School Fees Administration</b>. Please click any of the links below to proceed<br />";
    $html .= '<br />';

    $html .= '<b>School Fees Setup</b> - Setup school fees elements<br />';
    $html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/createmodifyfeeitem') . '">Create / Modify School Fee Items</a><br />';
    $html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/createmodifyfeestup') . '">Create / Modify School Fees Setup</a><br />';
    $html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/updatesettings') . '">Update Fee Settings</a><br />';
    $html .= '<br />';


    $html .= '<b>Authorise Scholarship</b> - Enable a Student as being sponsored via Scholarship for the Current Session only.<br />';
    $html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/scholarshippayment') . '">Authorise Scholarship</a><br />';
    $html .= '<br />';


    $html .= '<b>Authorise Instalment Payment</b> - Enable a Student to pay his/her Fees in instalments  for the Current Session only.<br />';
    $html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/authoriseinstalment') . '">Authorise Instalment Payment</a>';


    $html .= '<br />';
    // $html .= '<br />';

    //$html .= '<b>Test Cart Entries</b> - Test how ubercart adds attributes and options to cart.<br />';
    //$html .= '&nbsp;&nbsp;&nbsp;<a href="' . url('staff/testattributes') . '">Proceed To Test</a>';
    //$html .= '<br /><br />';

  //}

  $html .= '<br /><hr /><br />';

  echo $html;
  return ob_get_clean();//staff_school_fees_setup


}


function staff_school_fees_create_modify_school_fee_item(){
  global $user;
  ob_start();
  if (! staff_has_eduerp_role($user->uid, 0, 0, array('Bursar'))) $isAuthorized = false; else $isAuthorized = true;
  $editMode = (arg(2) && is_fee_item_existing(arg(2))) ? true : false;
  $html = "";
  $html = '<br /><hr /><br />';
  $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;School Fees Setup | Create / Modify School Fee Item</font><br /><br />";
  $html .= '<hr /><br />';
  //$html .= "Welcome to <b>School Fees Setup</b>. This is where you Create/Modify Fee Items as well as Create/Modify School Fees Setup<br />";
  if($isAuthorized){
    $html .= ($editMode) ? '<br /><br /><b>Modify Fee Item</b> - Please modify the Item as appropriate<br /><br />' : '<br /><br /><b>Create Fee Item</b> - Please fill the form below to create Fee Item<br /><br />';
    $html .= drupal_get_form('staff_school_fees_create_modify_fee_item_form');
  }
  else{
    //$html .= Error_Types(104);
    drupal_set_message(Error_Types(104), 'error');
  }



  $html .= '<br /><hr /><br />';
  if(! $editMode)
    $html .= staff_display_school_fee_items();

  echo $html;
  return ob_get_clean();
}


function staff_school_fees_create_modify_school_fee_setup(){
  global $user;
  ob_start();

  //$sf = get_fee_items(954);
  //echo "<pre>";
  //$a = print_r($sf);
  //echo "</pre>";
  //if(is_fee_setup_existing_for_student(954)) drupal_set_message('Yes'); else drupal_set_message('No');

  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;
  if (! staff_has_eduerp_role($user->uid, 0, 0, array('Bursar'))) $isAuthorized = false; else $isAuthorized = true;

  $html = "";
  $html = '<br /><hr /><br />';
  $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;School Fees Setup | Create / Modify School Fee Setup</font><br /><br />";
  $html .= '<hr /><br />';
  //$html .= "Welcome to <b>School Fees Setup</b>. This is where you Create/Modify Fee Items as well as Create/Modify School Fees Setup<br />";
  if((isset($_SESSION['eduerp_page']) && $_SESSION['eduerp_page'] == 3) || (isset($_POST['eduerp_page']) && $_POST['eduerp_page']==3)){
    if($isAuthorized){
      $html .= '<b>School Fee Setup Summary (Step 3 of 3)</b> - Please verify the Fee Setup.<br /><br />';
      $html .= show_fee_setup_page_one_info();
      $html .= show_fee_setup_page_two_info();
      $html .= '<br /><hr /><br />';
      $html .= drupal_get_form('staff_school_fees_create_modify_fee_setup3_form');
    }
    else{
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }
  }
  elseif((isset($_SESSION['eduerp_page']) && $_SESSION['eduerp_page'] == 2) || (isset($_POST['eduerp_page']) && $_POST['eduerp_page']==2)){
    //for page two
    if($isAuthorized){
      $html .= ($editMode) ? '<b>Modify School Fee Setup (Step 2 of 3)</b> - Please modify the Item as appropriate<br /><br />' : '<b>Create School Fee Setup (Step 2 of 3)</b> - Please fill the form below to create Fee Setup<br /><br />';
      $html .= show_fee_setup_page_one_info();
      //$html .= '<br /><hr /><br />';

      $html .= '<br /><br />';
      $html .= drupal_get_form('staff_school_fees_create_modify_fee_setup2_form');
    }
    else{
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }

  }
  else{
    //show page one
    if($isAuthorized){
      $html .= ($editMode) ? '<b>Modify School Fee Setup (Step 1 of 3)</b> - Please modify the Item as appropriate<br /><br />' : '<b>Create School Fee Setup (Step 1 of 3)</b> - Please fill the form below to create Fee Setup<br /><br />';
      $html .= "";
      $html .= drupal_get_form('staff_school_fees_create_modify_fee_setup1_form');
    }
    else{
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }
    $html .= '<br /><hr /><br />';

    if(! $editMode) {
      //$html .= '<b>School Fee Setup Test</b><br /><br />';
      //$html .= "For the test to succeed, each <b>Fee Structure Type</b> and <b>Program Name</b> pair MUST have two entries for each <b>Student Type</b> (Freshmen | Returning Student) and single entry for each <b>Nationality Type</b> (Local | International).<br /><br />";
      //$html .= drupal_get_form('staff_school_fees_test_fee_setup_form');
      //$html .= '<br /><hr /><br />';
      $html .= staff_display_school_fee_setup();

    }

  }

  echo $html;
  //drupal_set_message("unset");
  unset($_SESSION['eduerp_page']);
  return ob_get_clean();
}

function staff_school_fees_scholarship_payment(){
  global $user;
  ob_start();

  $isAuthorized = staff_has_eduerp_role($user->uid, 0, 0, array('Bursar')) ? true : false;

  $html = "";
  $html = '<br /><hr /><br />';
  $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;Authorise Scholarship</font><br /><br />";
  $html .= '<hr /><br />';
  if(! isset($_SESSION['eduerp_authorise_scholarship']['studentUID'])){

    /*
    //get the payment summary type
    $rs = db_query("SELECT nid FROM {content_type_school_fee_payment_types} WHERE field_fee_payment_type_value='%s'", 'Full Payment');
    $r = db_fetch_object($rs);
    $_SESSION['eduerp_authorise_scholarship']['summaryPaymentType'] = $r->nid; //payment type is full payment
    */

    $html .= "<b>Authorise Scholarship</b> - Please provide either the JAMB or Matrculation Number of the Student.<br />";
    $html .= '<br />';
    if($isAuthorized){
      $html .= drupal_get_form('get_scholarship_payment_student_finder_form');
    }
    else {
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }

    //show those on scholarship for the current session
    $html .= '<br /><hr /><br />';
    $html .= staff_display_scholarship_authorisations(variable_get('eduerp_current_session', ''));

  }
  else{
    //show summary
    $html .= show_student_info($_SESSION['eduerp_authorise_scholarship']);
    $html .= '<br /><hr /><br />';
    $html .= show_school_fees_payment_option("eduerp_authorise_scholarship", $_SESSION['eduerp_authorise_scholarship']['studentUID'], $_SESSION['eduerp_authorise_scholarship']['programNID'], $_SESSION['eduerp_authorise_scholarship']['levelType'], $_SESSION['eduerp_authorise_scholarship']['nationalityType']);

    $html .="<br />";
    /*
    //we need to set some defaults for scholarship payments

    //get the sponsor NID for scholarship
    $rs = db_query("SELECT nid FROM {content_type_schoo_fee_payment_sponsors} WHERE field_payment_sponsor_value='%s'", 'Scholarships');
    $r = db_fetch_object($rs);
    $_SESSION['eduerp_authorise_scholarship']['payment_sponsor'] = $r->nid; //sponsor is scholarship

    //get the payment status NID for full payment
    $rs = db_query("SELECT nid FROM {content_type_school_fee_payment_status} WHERE field_fee_payment_status_value='%s'", 'Full Payment');
    $r = db_fetch_object($rs);
    $_SESSION['eduerp_authorise_scholarship']['payment_brief_status'] = $r->nid; //status is fully paid


    //get the payment summary status NID for
    $_SESSION['eduerp_authorise_scholarship']['summaryPaymentStatus'] = $_SESSION['eduerp_authorise_scholarship']['payment_brief_status']; //summary status is fully paid



    //defaults for order_nid is zero
    $_SESSION['eduerp_authorise_scholarship']['orderNID'] = 0;

    $studentUID = $_SESSION['eduerp_authorise_scholarship']['studentUID'];
    $programNID = $_SESSION['eduerp_authorise_scholarship']['program_nid'];
    $levelType = $_SESSION['eduerp_authorise_scholarship']['levelType'];
    $nationalityType = $_SESSION['eduerp_authorise_scholarship']['nationalityType'];
    $html .= show_school_fees_payment_option('eduerp_authorise_scholarship', $studentUID, $programNID, $levelType, $nationalityType);

    //ini the summary payment here
    $_SESSION['eduerp_authorise_scholarship']['summaryPaymentAmount'] = $_SESSION['eduerp_authorise_scholarship']['setup_total_amount'];

    */
    $html .="<br />";
    //$html .= "<br /><font color=#ff0000><b>By clicking 'Submit' you acknowledge that the student whose details appear above is under FULL Scholarship and that such Scholarship covers the School Fee Amount.</b></font><br /><br />";
    $html .= drupal_get_form('staff_show_pay_school_fees_scholarship_form');

  }
  echo $html;
  return ob_get_clean();
}


function staff_school_fees_authorise_instalment_payment(){
  global $user;
  ob_start();

  $isAuthorized = staff_has_eduerp_role($user->uid, 0, 0, array('Bursar')) ? true : false;

  $html = "";
  $html = '<br /><hr /><br />';
  $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;Authorise Instalment Payment</font><br /><br />";
  $html .= '<hr /><br />';
  if(! isset($_SESSION['eduerp_authorise_instalment']['studentUID'])){

    $html .= "<b>Authorise Instalment Payment - ". variable_get('eduerp_current_session', '') ."</b> - Please provide either the JAMB or Matrculation Number of the Student.<br />";
    $html .= '<br />';
    if($isAuthorized){
      $html .= drupal_get_form('get_authorise_instalment_student_finder_form');
    }
    else {
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }

    //show those on scholarship for the current session
    $html .= '<br /><hr /><br />';
    $html .= staff_display_instalment_authorisations(variable_get('eduerp_current_session', ''));

  }
  else{
    //show summary
    $html .= show_student_info($_SESSION['eduerp_authorise_instalment']);
    $html .= '<br /><hr /><br />';
    $html .= show_school_fees_payment_option("eduerp_authorise_instalment", $_SESSION['eduerp_authorise_instalment']['studentUID'], $_SESSION['eduerp_authorise_instalment']['programNID'], $_SESSION['eduerp_authorise_instalment']['levelType'], $_SESSION['eduerp_authorise_instalment']['nationalityType']);

    $html .="<br />";
    $html .= drupal_get_form('staff_show_authorise_instalment_form');

  }
  echo $html;
  return ob_get_clean();
}


function staff_school_fees_create_modify_fee_item_form() {
  $editMode = (arg(2) && is_fee_item_existing(arg(2))) ? true : false;
  if ($editMode) {
    if (empty($_POST['fee_item'])) {
      $result = db_query('SELECT field_fee_item_value AS name, 	IFNULL(field_is_scholarship_applicable_value, 2) AS is_scholarship_applicable FROM {content_type_school_fee_items} WHERE nid = %d', arg(2));
      $feeItem = db_fetch_object($result);
    }
  }

  $form['#title'] = 'Create / Modify Fee Item';

  $form['fee_item'] = array(
    '#title' => 'Fee Item',
    '#type' => 'textfield',
    '#size' => 25,
    '#required' => true,
   );
  if ($feeItem) $form['fee_item']['#value'] = $feeItem->name;

  $form['is_scholarship_applicable'] = array(
      '#type' => 'select',
      '#options' => array(1 => 'Yes', 2 => 'No'),
      '#title' => 'Scholarship Applies To This Item?',
      '#required' => true,
   );
   if ($feeItem) $form['is_scholarship_applicable']['#value'] = $feeItem->is_scholarship_applicable;

  $form['submit'] = array(
    '#value' => 'Create Fee Item',
    '#type' => 'submit'
  );
  if ($feeItem) $form['submit']['#value'] = 'Update Fee Item';
  return $form;

}


function staff_school_fees_create_modify_fee_item_form_validate($form, &$state) {

  $values = $state['values'];
  $editMode = (arg(2) && is_fee_item_existing(arg(2))) ? true : false;
  $itemNID = $editMode ? arg(2) : 0;
  //make sure that no duplicates exist

  // Security checks
  $formFields = array("fee_item");
  foreach($formFields as $v){
    $text = $state['values'][$v];
    if (!empty($text)) {
      if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
        form_set_error($v, Error_Types(168));
      }
    }
  }

  if( is_fee_item_existing($values['fee_item'], true, $itemNID)){
    form_set_error('fee_item', Error_Types(152));
  }


}


function staff_school_fees_create_modify_fee_item_form_submit($form, &$state) {

  $values = $state['values'];
  $editMode = (arg(2) && is_fee_item_existing(arg(2))) ? true : false;
  $values['fee_item'] = trim($values['fee_item']);

  if($editMode){
    //get the productNID
    $productNID = get_fee_item_productNID(arg(2));



    if($productNID->product_nid == 0){
      if(is_fee_item_existing_in_uc_products($values['fee_item'])){
      	//get the productNID from UC
      	$ucProductNID = get_fee_item_uc_products_nid($values['fee_item']);
      }
      else{
        //create the product
        $ucProductNID = create_uc_product($values['fee_item']);
      }
    }
    else {
      //we might need to update the name in UC Products
      $node = node_load($productNID->product_nid);
      $node->title = $values['fee_item'];
      node_save($node);
      $ucProductNID = $productNID->product_nid;

    }

    //make sure the product is assigned attribute
    //attach attribute to the Product
    $attribute = get_uc_attribute_info("fee_structure");
    $attributeInfo['productNID'] = $ucProductNID;
    $attributeInfo['aid'] = $attribute['aid'];
    $attributeInfo['label'] = "Fee Structure";

    if(! is_uc_attribute_attached_to_product($attributeInfo)){
      attach_uc_attribute_to_product($attributeInfo);
    }


    $node = node_load(arg(2));
    $node->title                              		= $values['fee_item'];
    $node->field_fee_item[0]['value']         		= $values['fee_item'];
    $node->field_is_scholarship_applicable[0]['value']  = $values['is_scholarship_applicable'];

    if(isset($ucProductNID))
       $node->field_uc_product_nid[0]['nid']  		= $ucProductNID;


    node_save($node);
    drupal_set_message($values['fee_item'] . ' School Fee Item was updated!<br />');
    drupal_goto("staff/createmodifyfeeitem");


  }
  else {

    //create the product
    $ucProductNID = create_uc_product($values['fee_item']);


    $node = new stdClass();
    $node->type                             		= 'school_fee_items';
    $node->uid                              		= 1;  // Admin
    $node->status                           		= 1;  // Published
    $node->promote                          		= 0;
    $node->sticky                           		= 0;
    $node->comment                          		= 0;
    $node->title                            		= $values['fee_item'];
    $node->field_fee_item[0]['value']       		= $values['fee_item'];
    $node->field_is_scholarship_applicable[0]['value']  = $values['is_scholarship_applicable'];
    $node->field_uc_product_nid[0]['nid']  		= $ucProductNID;


    node_save($node);
    drupal_set_message($values['fee_item'] .' School Fee Item was created!<br />');
  }
}


function staff_display_school_fee_items() {
  $html = "
  <div id='assigned_courses'>
  <b>Available School Fee Items</b><br /><br />";

  $feeItems = get_school_fee_items();
  if(! is_array($feeItems) || ! sizeof($feeItems)){
    //drupal_set_message(Error_Types(106), 'error');
    return $html .= Error_Types(106) .'</div>';
  }

  $html .="
  Please click on a Fee Item name to Edit it.<br />
  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Fee Item</b></th>
      <th><b>Scholarship Applicable</b></th>

    </tr>";$i = 1;

    foreach ($feeItems as $k => $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $html .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td width='30px'>". $i++ ."</td>";

           $html .="
           <td><a  href='" . url("staff/createmodifyfeeitem/$k") ."'>". $v['fee_item'] ."</a></td>
           <td>". $v['is_scholarship_applicable'] ."</td>
         </tr>";
      }

  $html .= "
  </table>
  </div>";
  return $html;

}


function staff_display_school_fee_setup() {
  $html = "
  <script type='text/javascript' src='../misc/drupal.js'></script>
  <script type='text/javascript' src='../misc/collapse.js'></script>
  <div id='assigned_courses'>
  <b>Available School Fee Setup</b><br /><br />";

  $feeSetup = get_school_fee_setup(variable_get('eduerp_current_session', ''));
  if(! is_array($feeSetup) || ! sizeof($feeSetup))
    return $html .= Error_Types(106) .'</div>';

  $html .="
  Please click on '<b>&raquo;</b>' to Edit the corresponding Block Fee Setup .<br />
  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th>&nbsp;</th>
      <th><b>Fee Structure Name</b></th>
      <th><b>Fee Structure Type</b></th>
      <th><b>Program Name</b></th>
      <th><b>Student Type</b></th>
      <th><b>Nationality Type</b></th>
      <th><b>Total Amount</b></th>


    </tr>";$i = 1;

    foreach ($feeSetup as $k => $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $html .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td width='30px'>". $i++ ."</td>";
           //<td><a  href='" . url("staff/createmodifyfeeitem/$k") ."'>". $v['fee_item'] ."</a></td>
           $html .="
           <td><a  href='" . url("staff/createmodifyfeestup/".$v['program_nid']) ."'><b>&raquo;</b></a></td>
           <td>". $v['fee_structure_name'] ."</td>
           <td>". $v['fee_structure_class_name'] ."</td>
           <td>". $v['program_name'] ."</td>
           <td>". $v['level_name'] ."</td>
           <td>". $v['nationality_name'] ."</td>
           <td>". number_format($v['setup_total_amount'], 2) ."</td>


         </tr>";
         //show the setup details here
         $html .="
         <tr>
           <td colspan=9>
             <fieldset class='collapsible collapsed'><legend>". $v['fee_structure_name'] ." - ". $v['level_name'] ." - ". $v['nationality_name'] ." - view details</legend>";
             //get the fee items
              $details = get_fee_setup_item_details($v['nid']);
              if(db_affected_rows($details) > 0){
                $html .="
                 <table>
                   <tr>
                     <th width='15px'>#</th>
                     <th width='250px'>Fee Item</th>
                     <th>Full Amount</th>
                     <th>First Instalment Amount</th>
                     <th>Second Instalment Amount</th>
                   </tr>";$l=1;
                   while($r = db_fetch_object($details)){
                     $html .="
                     <tr>
                       <td>". $l++ ."</td>
                       <td>". $r->item_name ."</td>
                       <td>". number_format($r->full_amount, 2) ."</td>
                       <td>". number_format($r->instalment1_amount, 2) ."</td>
                       <td>". number_format($r->instalment2_amount, 2) ."</td>
                     </tr>
                     ";

                   }

                 $html .="
               </table>";
               }
               else{
                 $html .= Error_Types(106);
               }
             $html .="
             </fieldset>
           </td>
         </tr>";
      }

  $html .= "
  </table>
  </div>";
  return $html;

}


function get_school_fee_items() {
  $r = db_query("SELECT nid, field_fee_item_value AS fee_item, IF(field_is_scholarship_applicable_value = 1, 'Yes', 'No') AS is_scholarship_applicable, field_uc_product_nid_nid AS uc_product_nid FROM {content_type_school_fee_items} ORDER BY field_fee_item_value ");
  $feeItems = array();
  while ($f = db_fetch_object($r)){
    $feeItems[$f->nid]['fee_item'] = $f->fee_item;
    $feeItems[$f->nid]['is_scholarship_applicable'] = $f->is_scholarship_applicable;
    $feeItems[$f->nid]['uc_product_nid'] = $f->uc_product_nid;


  }
  return $feeItems;
}


function is_fee_item_existing_in_uc_products($itemName){

  $rs = db_query("SELECT ctp.nid FROM {content_type_product} ctp
  	  INNER JOIN {node} n ON ctp.nid=n.nid
  	  WHERE n.title='%s' AND type='product' ", $itemName);

  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function get_fee_item_uc_products_nid($itemName){

  $rs = db_query("SELECT ctp.nid AS nid FROM {content_type_product} ctp
  	  INNER JOIN {node} n ON ctp.nid=n.nid
  	  WHERE n.title='%s' AND type='product' ", $itemName);

  $r = db_fetch_object($rs);

  return $r->nid;


}


function get_fee_item_productNID($itemNID){

  $rs = db_query("SELECT IFNULL(field_uc_product_nid_nid, 0) product_nid FROM {content_type_school_fee_items} WHERE nid=%d ", $itemNID);
  return db_fetch_object($rs);
}


function gen_fee_product_sku(){

  $rs = db_query("SELECT next_num, sku_name  FROM {gen_fee_item_sku} WHERE id = 1 FOR UPDATE ");

  $r = db_fetch_object($rs);

  $productSKU = $r->sku_name . '-'. $r->next_num;

  db_query("UPDATE {gen_fee_item_sku} SET next_num = next_num + 1 ");
  db_query("COMMIT");

  return $productSKU;
}


function create_uc_product($itemName, $amount=0.00, $attachAttributes=true){

  //generate SKU for this product
  $node = new stdClass();
  $node->type = 'product';

  //node_object_prepare($node); // This sets up all the default node fields so we don't accidentally leave something off.

  $node->uid 		= 1;
  $node->status 	= 1;
  $node->title 		= $itemName;
  //$node->created 	= $data->created;
  //$node->changed 	= $data->changed;

  // Set Ubercart variables
  $node->model 		= gen_fee_product_sku(); // the SKU is a required field
  $node->list_price 	= 0.00;
  $node->cost 		= 0.00;
  $node->sell_price 	= $amount;
  $node->default_qty 	= 1;
  $node->pkg_qty 	= 1;

  // Set taxonomy + menu etc if you need to
  $node->taxonomy 	= array();
  $node->menu 		= array();

  // Save the node
  node_save($node);  // This will update the $node object with the $node->nid which is important for the next step.

  $productNID = $node->nid;

  //we need to attach attribute fee_structure to the product

  //check if attribute fee_structure exists
  if(is_uc_attribute_existing("fee_structure")){
    $attribute = get_uc_attribute_info("fee_structure");

  }
  else{
    //create the attribute
    $info['name'] = "fee_structure";
    $info['label'] = "Fee Structure";
    create_uc_attribute($info);

    $attribute = get_uc_attribute_info("fee_structure");

  }

  if($attachAttributes){
    //attach attribute to the Product
    $info['productNID'] = $productNID;
    $info['aid'] = $attribute['aid'];
    $info['label'] = "Fee Structure";
    attach_uc_attribute_to_product($info);
  }
  return $productNID;

}


function is_uc_attribute_existing($attributeName){

  $rs = db_query("SELECT aid FROM {uc_attributes} WHERE name='%s'", $attributeName);

  if(db_affected_rows($rs) > 0) return true;

  return false;

}


function is_uc_attribute_option_existing(&$optionInfo){

  $rs = db_query("SELECT oid FROM {uc_attribute_options} WHERE aid=%d AND name='%s' ",$optionInfo['aid'], $optionInfo['name']);

  if(db_affected_rows($rs) > 0) return true;

  return false;

}


function is_uc_attribute_attached_to_product(&$optionInfo){

  $rs = db_query("SELECT nid FROM {uc_product_attributes} WHERE nid=%d AND aid=%d AND label='%s' ",$optionInfo['productNID'], $optionInfo['aid'], $optionInfo['label']);

  if(db_affected_rows($rs) > 0) return true;

  return false;

}


function is_uc_option_attached_to_product(&$optionInfo){

  $rs = db_query("SELECT oid FROM {uc_product_options} WHERE nid=%d AND oid=%d ",$optionInfo['productNID'], $optionInfo['oid']);

  if(db_affected_rows($rs) > 0) return true;

  return false;

}


function get_uc_attribute_info($attributeName){
  $rs = db_query("SELECT aid, name, label FROM {uc_attributes} WHERE name='%s'", $attributeName);

  if(db_affected_rows($rs) > 0) {
    while($r = db_fetch_object($rs)){
      $attribute['aid'] = $r->aid;
      $attribute['name'] = $r->name;
      $attribute['label'] = $r->label;
    }
    return $attribute;
  }

  return array();

}


function create_uc_attribute(&$info){

  db_query("INSERT INTO {uc_attributes} (name, label, ordering, required, display) VALUES ('%s', '%s', 0, 1, 1 ) ", $info['name'], $info['label']);

}


function create_uc_attribute_option(&$info){

  db_query("INSERT INTO {uc_attribute_options} (aid, name, price) VALUES (%d, '%s',  '%s') ", $info['aid'], $info['name'], $info['price']);

}


function attach_uc_option_to_product(&$info){

  db_query("INSERT INTO {uc_product_options} (nid, oid, price) VALUES (%d, %d, '%s') ", $info['productNID'], $info['oid'], $info['price']);

}


function update_uc_attribute_option(&$info){

  db_query("UPDATE {uc_attribute_options} SET price = '%s' WHERE name='%s' ", $info['price'], $info['name']);

}


function update_uc_product_option(&$info){

  db_query("UPDATE {uc_product_options} SET price = '%s' WHERE nid=%d AND oid=%d ", $info['price'], $info['productNID'], $info['oid']);

}


function get_uc_attribute_option_info($attributeOptionName){
  $rs = db_query("SELECT oid, aid, name, price FROM {uc_attribute_options} WHERE name='%s'", $attributeOptionName);

  if(db_affected_rows($rs) > 0) {
    while($r = db_fetch_object($rs)){
      $attributeOption['oid'] = $r->oid;
      $attributeOption['aid'] = $r->aid;
      $attributeOption['name'] = $r->name;
      $attributeOption['price'] = $r->price;
    }
    return $attributeOption;
  }

  return array();

}


function attach_uc_attribute_to_product(&$info){


  db_query("INSERT INTO {uc_product_attributes} (nid, aid, label, ordering, required, display) VALUES (%d, %d, '%s', 0, 1, 1 ) ", $info['productNID'], $info['aid'], $info['label']);

}


function get_school_fee_setup($sessionName, $NID=0, $bySetupNID=true, $returnObject=false) {
  $sql="SELECT ctsfis.nid nid, IFNULL(field_fee_setup_program_nid_value, 0) program_nid, field_fee_student_level_type_nid level_id,
  	  field_fee_nationality_type_nid nationality_id,
  	  field_fee_structure_type_nid fee_structure_nid,
  	  field_fee_structure_name_value AS fee_structure_name,
  	  field_fee_setup_session_value AS session_name,
  	  field_fee_setup_total_amount_value AS setup_total_amount, field_fee_setup_date_value setup_date,
  	  IFNULL(field_programme_name_value, 'N/A') program_name, field_level_type_value level_name, field_nationality_type_value nationality_name,
  	  field_structure_class_value fee_structure_class_name
  	  FROM {content_type_school_fee_item_setup} ctsfis
  	  LEFT JOIN {content_type_program} ctp ON ctsfis.field_fee_setup_program_nid_value=ctp.nid
  	  INNER JOIN {content_type_school_fee_level_types} ctsflt ON ctsfis.field_fee_student_level_type_nid=ctsflt.nid
  	  INNER JOIN {content_type_school_fee_nationality_types} ctsfnt ON ctsfis.field_fee_nationality_type_nid=ctsfnt.nid
  	  INNER JOIN {content_type_school_fee_structure_classes} ctsfsc ON ctsfis.field_fee_structure_type_nid=ctsfsc.nid ";

  	  /*
  	  field_fee_instalment1_amount_value AS setup_instalment1_amount,
  	  field_fee_instalment2_amount_value AS setup_instalment2_amount,
  	   field_fee_full_payment_amount_value AS setup_full_amount,
  	  */
  	  $sql .= " WHERE field_fee_setup_session_value='%s' ";
  	  if($bySetupNID){
  	    if($NID !=0) {
  	      $sql .= " AND ctsfis.nid=%d ";
  	    }

  	  }
  	  else {
  	    if($NID !=0) {
  	      $sql .= " AND ctsfis.field_fee_setup_program_nid_value=%d ";
  	    }
  	    else{
  	      $sql .= " AND (ctsfis.field_fee_setup_program_nid_value IS NULL OR ctsfis.field_fee_setup_program_nid_value=%d) ";
  	    }
  	  }



  	  $sql .="
  	  ORDER BY field_fee_structure_type_nid, program_name, field_fee_student_level_type_nid, field_fee_nationality_type_nid ";
  	//drupal_set_message($sql);
  $r = db_query($sql, $sessionName, $NID);

  if($returnObject) return $r;

  $feeSetup = array();
  $SQLheaders = array('nid', 'program_nid', 'level_id',  'nationality_id', 'fee_structure_nid',  'session_name',
  	   'setup_total_amount', 'setup_date', 'program_name', 'level_name',  'nationality_name', 'fee_structure_name', 'fee_structure_class_name');
  //'setup_instalment2_amount', 'setup_instalment1_amount',
  while ($f = db_fetch_object($r)){
    foreach($SQLheaders as $v){

      if($bySetupNID)
        $feeSetup[$f->nid][$v] = $f->$v;
      else
        $feeSetup[$f->program_nid][$v] = $f->$v;
    }

  }
  return $feeSetup;
}


function is_fee_item_existing($item, $byName=false, $forEditNID=0){

  $sql = "SELECT nid, field_fee_item_value AS fee_item FROM {content_type_school_fee_items} WHERE ";
  $sql .= ($byName) ? " field_fee_item_value='%s' " : " nid=%d ";

  if($forEditNID){
    $sql .= " AND nid != $forEditNID";
  }


  $r = db_query($sql, $item);

  if(db_affected_rows($r) > 0) return true;

  return false;
}


function is_fee_setup_existing($item, $sessionName){

  $sql = "SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value=%d AND field_fee_setup_session_value='%s'";

  $r = db_query($sql, $item, $sessionName);

  if(db_affected_rows($r) > 0) return true;

  return false;
}


/**
Start Update Defaults Here

*/
function initialize_school_fee_module_tables(){

  //the following tables need to be populated
  /**

  content_type_school_fee_level_types
  content_type_school_fee_nationality_types
  content_type_school_fee_payment_status
  content_type_school_fee_payment_types
  content_type_school_fee_settings
  content_type_school_fee_structure_classes
  content_type_schoo_fee_payment_sponsors

  */

  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_level_types}');
  if(db_affected_rows($rs) <= 0){
    $items = array('Freshman', 'Returning Student');

    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_level_types';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_level_type[0]['value']        	= $v;

      node_save($node);
    }
  }

  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_nationality_types}');
  if(db_affected_rows($rs) <= 0){
    $items = array('Local', 'International');
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_nationality_types';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_nationality_type[0]['value']        	= $v;

      node_save($node);
    }
  }
  /*
  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_payment_status}');
  if(db_affected_rows($rs) <= 0){
    $items = array('Full Payment', 'Part Payment', 'Pending');
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_payment_status';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_fee_payment_status[0]['value']       = $v;

      node_save($node);
    }
  }
  */
  /*
  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_payment_types}');
  if(db_affected_rows($rs) <= 0){
     $items = array('Full Payment', 'First Installment', 'Second Installment');
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_payment_types';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_fee_payment_type[0]['value']        	= $v;

      node_save($node);
    }
  }
  */
    //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_settings}');
  if(db_affected_rows($rs) <= 0){
    $items = array(array('name'=>'Activate Second Instalment Payment', 'data'=>'0'), array('name'=>'Last Date For Fee Payment Without Late Registration Charges', 'data'=>'2011-10-01'), array('name'=>'Late Registration Amount', 'data'=>'5000'), array('name'=>'Local Country Name', 'data'=>'156'),);
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_settings';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v['name'];
      $node->field_fee_settings_name[0]['value']        = $v['name'];
      $node->field_fee_settings_value[0]['value']       = $v['data'];

      node_save($node);
    }

    //create the product
    create_uc_product('Late Registration Charges', 0.00, false);

  }

  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_school_fee_structure_classes}');
  if(db_affected_rows($rs) <= 0){
    $items = array('General Fee Structure', 'Program Specific Fee Structure');
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'school_fee_structure_classes';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_structure_class[0]['value']        	= $v;

      node_save($node);
    }
  }
  /*
  //make sure that the table is not empty
  $rs = db_query('SELECT nid FROM {content_type_schoo_fee_payment_sponsors}');
  if(db_affected_rows($rs) <= 0){
    $items = array('Self or Guardian', 'Scholarships');
    foreach($items as $v){
      $node = new stdClass();
      $node->type                             		= 'schoo_fee_payment_sponsors';
      $node->uid                              		= 1;  // Admin
      $node->status                           		= 1;  // Published
      $node->promote                          		= 0;
      $node->sticky                           		= 0;
      $node->comment                          		= 0;
      $node->title                            		= $v;
      $node->field_payment_sponsor[0]['value']        	= $v;

      node_save($node);
    }
  }
  */
}


/**
End Update Defaults Here

*/

function staff_school_fees_update_settings(){
  global $user;
  ob_start();
  if (! staff_has_eduerp_role($user->uid, 0, 0, array('Bursar'))) $isAuthorized = false; else $isAuthorized = true;
  $editMode = (arg(2) && is_fee_setting_existing(arg(2))) ? true : false;
  $html = "";
  $html = '<br /><hr /><br />';



  if($editMode) {
    $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/updatesettings') ."'>Global Settings</a>&nbsp; &raquo; &nbsp;Modify Fee Setting</font><br />";
    $html .= '<br /><hr /><br />';
    if($isAuthorized){
      $html .= '<b>Modify Fee Setting</b> - Please modify the Item as appropriate<br /><br />';
      $html .= drupal_get_form('staff_school_fees_modify_fee_settings_form');
    }
    else {
      //$html .= Error_Types(104);
      drupal_set_message(Error_Types(104), 'error');
    }
  }
  else {
    $html .= "<font size = '1px'><a href = '". url('staff/semester') ."'>Semester Administration</a>&nbsp; &raquo; &nbsp;<a href = '". url('staff/schoolfeesadmin') ."'>School Fees Administration</a>&nbsp; &raquo; &nbsp;Global Settings</font><br />";
  }
  $html .= '<br /><hr /><br />';

  if(! $editMode)
    $html .= staff_display_school_fee_settings();

  echo $html;
  return ob_get_clean();
}


function get_school_fee_settings($settingsNID=0) {
  if($settingsNID != 0)
    $r = db_query("SELECT nid, field_fee_settings_name_value AS settings_name, field_fee_settings_value_value AS settings_value FROM {content_type_school_fee_settings} WHERE nid=%d  ", $settingsNID);
  else
    $r = db_query("SELECT nid, field_fee_settings_name_value AS settings_name, field_fee_settings_value_value AS settings_value FROM {content_type_school_fee_settings} ORDER BY field_fee_settings_name_value ");

  $feeSettings = array();
  while ($f = db_fetch_object($r)){
    $feeSettings[$f->nid]['settings_name'] = $f->settings_name;
    $feeSettings[$f->nid]['settings_value'] = $f->settings_value;
  }
  return $feeSettings;
}


function staff_display_school_fee_settings() {
  $html = "
  <div id='assigned_courses'>
  <b>Available School Fee Settings</b><br /><br />";

  $feeSettings = get_school_fee_settings();
  if(! is_array($feeSettings) || ! sizeof($feeSettings))
    return $html .= Error_Types(106) .'</div>';

  $html .="
  Please click on a Fee Setting name to Edit it.<br />
  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Fee Setting</b></th>
      <th><b>Value</b></th>
    </tr>";$i = 1;

    foreach ($feeSettings as $k => $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $html .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td width='30px'>". $i++ ."</td>
           <td><a  href='" . url("staff/updatesettings/$k") ."'>". $v['settings_name'] ."</a></td>";
           if(trim(strtolower(strtoupper($v['settings_name']))) == 'local country name'){
             //get the country name
             $countryInfo = get_country_info(trim($v['settings_value']));
             $html .="
              <td>". $countryInfo[trim($v['settings_value'])] ."</td>";
           }
           else {
           $html .="

           <td>". $v['settings_value'] ."</td>";
           }

           $html .="

         </tr>";
      }

  $html .= "
  </table>
  </div>";
  return $html;

}


function is_fee_setting_existing($settingsNID){

  $sql = "SELECT nid FROM {content_type_school_fee_settings} WHERE nid=%d";

  $r = db_query($sql, $settingsNID);

  if(db_affected_rows($r) > 0) return true;

  return false;
}


function staff_school_fees_modify_fee_settings_form() {
  $editMode = (arg(2) && is_fee_setting_existing(arg(2))) ? true : false;
  if ($editMode) {
    if (empty($_POST['fee_item'])) {
      $result = db_query('SELECT nid, field_fee_settings_name_value AS settings_name, field_fee_settings_value_value AS settings_value FROM {content_type_school_fee_settings} WHERE nid = %d', arg(2));
      $feeSettings = db_fetch_object($result);
    }

    $form['#title'] = 'Create / Modify Fee Item';
    if(trim(strtolower(strtoupper($feeSettings->settings_name))) == 'local country name'){
      $form[$feeSettings->nid] = array(
      '#type' => 'select',
      '#options' => array(''=>'--select one--') + get_country_info(),
      '#title' => $feeSettings->settings_name,
      '#required'  => TRUE,
      '#default_value' => $feeSettings->settings_value,
      );
      if ($feeItem) $form['fee_item']['#value'] = $feeItem->name;
    }
    elseif(trim(strtolower(strtoupper($feeSettings->settings_name))) == 'activate second instalment payment'){
      $form[$feeSettings->nid] = array(
      '#type' => 'select',
      '#options' => array(''=>'--select one--') + array('0'=>'No', '1'=>'Yes'),
      '#title' => $feeSettings->settings_name,
      '#required'  => TRUE,
      '#default_value' => $feeSettings->settings_value,
      );
      if ($feeItem) $form['fee_item']['#value'] = $feeItem->name;
    }
    else{
      $form[$feeSettings->nid] = array(
      '#title' => $feeSettings->settings_name,
      '#type' => 'textfield',
      '#size' => 25,
      '#required' => true,
      '#default_value' => $feeSettings->settings_value,
      );
      if ($feeItem) $form['fee_item']['#value'] = $feeItem->name;

    }

    $form['submit'] = array(
      '#value' => 'Update Fee Settings Item',
      '#type' => 'submit'
    );

   return $form;
 }

}


function staff_school_fees_modify_fee_settings_form_validate($form, &$state){
  $values = $state['values'];
  //for start date and late reg date make sure they are of type date
  //also if amount then make sure it conforms
  $editMode = (arg(2) && is_fee_setting_existing(arg(2))) ? true : false;
  if($editMode){
    //get the item
    $item = get_school_fee_settings(arg(2));
    if(trim(strtolower(strtoupper($item[arg(2)]['settings_name']))) == 'last date for fee payment without late registration charges'){
      if(! is_Date($values[arg(2)]))
        form_set_error(arg(2), Error_Types(114));
    }
    elseif(! is_numeric($values[arg(2)])) {
    	form_set_error(arg(2), Error_Types(107));
    }

    // Security checks
    $formFields = array(arg(2));
    foreach($formFields as $v){
      $text = $state['values'][$v];
      if (!empty($text)) {
        if (str_replace('&', '&amp;', $text) != htmlspecialchars($text, ENT_COMPAT, 'UTF-8')) { // Also validates UTF-8
          form_set_error($v, Error_Types(168));
        }
      }
    }
  }
  else {
    form_set_error('', Error_Types());
  }

}


function staff_school_fees_modify_fee_settings_form_submit($form, &$state){
  $values = $state['values'];

  $node = node_load(arg(2));
  $node->field_fee_settings_value[0]['value']  = $values[arg(2)];

  node_save($node);

  $item = get_school_fee_settings(arg(2));
  //drupal_set_message(trim(strtolower(strtoupper($item[arg(2)]['settings_name']))));
  if(trim(strtolower(strtoupper($item[arg(2)]['settings_name']))) == 'late registration amount'){//late registration amount
    //drupal_set_message('for late reg!<br />');
    //update late registration product amount
    if(is_uc_late_registration_existing("Late Registration Charges")){
      // drupal_set_message('for update!<br />');
      //update the amount
      $ucLateRegInfo = get_uc_late_registration_info("Late Registration Charges");
      $node = node_load($ucLateRegInfo['product_nid']);
      //$node->title = $values['fee_item'];
      $node->sell_price = $values[arg(2)];
      node_save($node);
    }
    else{
      // drupal_set_message('for create!<br />');
      //create late reg as a uc product
      create_uc_product("Late Registration Charges", $values[arg(2)], false);

    }
  }

  drupal_set_message('Fee Settings was updated!<br />');
  drupal_goto("staff/updatesettings");
}


function staff_school_fees_create_modify_fee_setup1_form() {

  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;
  if ($editMode && ! $_SESSION['eduerp_fee_setup']['page_one_assigned']) {
    //if (empty($_POST['fee_structure_type'])) {
      //prepare the edit data
      prepare_fee_setup_for_edit(arg(2));
      $feeSetup = $_SESSION['eduerp_fee_setup'];
      $_SESSION['eduerp_fee_setup']['page_one_assigned'] = true;

    //}
  }


  if(! isset($feeSetup) && isset($_SESSION['eduerp_fee_setup']) && is_array($_SESSION['eduerp_fee_setup']) && sizeof($_SESSION['eduerp_fee_setup']) && empty($_POST['fee_structure_type'])){
    $feeSetup['fee_structure_type'] = $_SESSION['eduerp_fee_setup']['fee_structure_type'];

  }


  $form['#title'] = 'Create / Modify Fee Setup';

  $form['fee_structure_type'] = array(
      '#type' => 'select',
      '#options' => array(''=>'--select one--') + get_fee_structue_types(),
      '#title' => 'Fee Structure Type',
      //'#required'  => TRUE

      );
  if ($feeSetup) $form['fee_structure_type']['#value'] = $feeSetup['fee_structure_type'];
  if ($editMode) $form['fee_structure_type']['#options'] = array(''=>'--select one--') + get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type'], true);



  //if ($feeSetup){
    $form['cmdCancel'] = array(
      '#value' => 'Cancel',
      '#type' => 'submit'
    );
  //}

  $form['submit'] = array(
    '#value' => 'Continue',
    '#type' => 'submit'
  );

  return $form;

}


function staff_school_fees_create_modify_fee_setup1_form_validate($form, &$state){
  //make sure that fee items exists first before going to the second page
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'continue':
      if(empty($values['fee_structure_type'])){
        form_set_error('fee_structure_type', Error_Types(114));
      }
      /*
      if(empty($values['fee_student_level_type'])){
        form_set_error('fee_student_level_type', Error_Types(114));
      }

      if(empty($values['fee_student_nationality_type'])){
        form_set_error('fee_student_nationality_type', Error_Types(114));
      }
      */
      $rs = db_query("SELECT nid, field_fee_item_value AS fee_item FROM {content_type_school_fee_items} LIMIT 1 ");
      if(db_affected_rows($rs) <= 0){
        form_set_error('', Error_Types(153));
        return;
      }


      break;



  }
}


function staff_school_fees_create_modify_fee_setup1_form_submit($form, &$state){
  $values = $state['values'];
  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;
  /*
  if($form_state['storage']['page'] == 1) {
    $form_state['rebuild'] = TRUE;
    $form_state['storage']['page']++;
  }
  */
  //$form_state['rebuild'] = TRUE;
  //$form_state['storage']['page'] = 2;
  switch(trim(strtolower(strtoupper($values['op'])))){
    case'continue':
      if(! $editMode){
        $_SESSION['eduerp_fee_setup']['fee_structure_type'] = $values['fee_structure_type'];
        //$_SESSION['eduerp_fee_setup']['fee_student_level_type'] = $values['fee_student_level_type'];
        //$_SESSION['eduerp_fee_setup']['fee_student_nationality_type'] = $values['fee_student_nationality_type'];
      }


      //store the data
      $_SESSION['eduerp_page'] = 2;
      //drupal_set_message("Page is ". $_SESSION['eduerp_page']);
      $feeStructure = get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type']);
      if(trim(strtolower(strtoupper(substr($feeStructure['name'],0,7)))) != 'program' && isset($_SESSION['eduerp_fee_setup']['programme_nid'])){
        unset($_SESSION['eduerp_fee_setup']['programme_nid']); // = null;
      }

      break;

    case 'cancel':
      unset($_SESSION['eduerp_fee_setup']); $_SESSION['eduerp_fee_setup'] = null;
      unset($_SESSION['eduerp_page']); $_SESSION['eduerp_page']=null;
      drupal_goto('staff/createmodifyfeestup');

    break;
  }
}


function staff_school_fees_create_modify_fee_setup2_form() {
  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;
  //display the list of all available fee items
  //get fee items
  $feeItems = get_school_fee_items();

  $feeStructure = get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type']);
  $assignDefault=false;

  $studentLevels = get_fee_student_level_types();
  $studentNationalities = get_fee_student_nationality_types();

  if($editMode && ! $_SESSION['eduerp_fee_setup']['page_two_assigned']){//isset($_POST[$k."txt"]
    unset($_SESSION['eduerp_fee_setup']['items']); $_SESSION['eduerp_fee_setup']['items']=null;
    $feeSetup = get_school_fee_setup(variable_get('eduerp_current_session', ''), arg(2), false, true);
    //$r = db_fetch_object($feeSetup);
    /*
    $_SESSION['eduerp_fee_setup']['first_installment'] = is_numeric($feeSetup[arg(2)]['first_instalment']) ? substr($feeSetup[arg(2)]['first_instalment'],0,-3) : $feeSetup[arg(2)]['first_instalment'];
    $_SESSION['eduerp_fee_setup']['second_installment'] = is_numeric($feeSetup[arg(2)]['second_instalment']) ? substr($feeSetup[arg(2)]['second_instalment'],0,-3) : $feeSetup[arg(2)]['second_instalment'];
    $_SESSION['eduerp_fee_setup']['programme_nid'] = is_numeric($feeSetup[arg(2)]['program_nid']) ? $feeSetup[arg(2)]['program_nid'] : null;
    $_SESSION['eduerp_fee_setup']['fee_structure_name'] = $feeSetup[arg(2)]['fee_structure_name'];

    */

    while($p = db_fetch_object($feeSetup)){//four records are expected
    	    //drupal_set_message($p->nid);
      if(! isset($_SESSION['eduerp_fee_setup']['programme_nid']))
      $_SESSION['eduerp_fee_setup']['programme_nid'] = is_numeric($p->program_nid) ? $p->program_nid : null;

      //if(! isset($_SESSION['eduerp_fee_setup']['fee_structure_name']))
      //$_SESSION['eduerp_fee_setup']['fee_structure_name'] = $p->fee_structure_name;

      $feeSetupDetails = get_fee_setup_item_details($p->nid); //$feeSetupDetails = get_fee_setup_item_details(arg(2));
      while($r = db_fetch_object($feeSetupDetails)){
        $_SESSION['eduerp_fee_setup']['items'][$p->level_id ."-". $p->nationality_id ."-". $r->item_nid .'-full_amount'] = substr($r->full_amount, 0, -3);

        $_SESSION['eduerp_fee_setup']['items'][$p->level_id ."-". $p->nationality_id ."-". $r->item_nid .'-instalment1_amount'] = ($r->instalment1_amount != 0) ? substr($r->instalment1_amount, 0, -3) : 'N/A';
        $_SESSION['eduerp_fee_setup']['items'][$p->level_id ."-". $p->nationality_id ."-". $r->item_nid .'-instalment2_amount'] = ($r->instalment2_amount != 0) ? substr($r->instalment2_amount, 0, -3) : 'N/A';
      }
    }


    $_SESSION['eduerp_fee_setup']['page_two_assigned'] = true;
  }

  foreach($studentLevels as $slID => $slName){
    foreach($studentNationalities as $snID => $snName){

      foreach($feeItems as $k => $v) {
        //if(! isset($_POST[$slID.$snID.$k.'full_amount'])){
        if(! isset($_POST[$slID ."-". $snID ."-". $k. '-full_amount']) && isset($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'])){
          $assignDefault=true;
          //$selFeeItems[$slID.$snID.$k.'full_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID.$snID.$k.'full_amount'];
          $selFeeItems[$slID ."-". $snID ."-". $k .'-full_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k  .'-full_amount'];
        }

        //if(! isset($_POST[$slID.$snID.$k.'instalment1_amount'])){
        if(! isset($_POST[$slID ."-". $snID ."-". $k .'-instalment1_amount']) && isset($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'])){
          $assignDefault=true;
          //$selFeeItems[$slID.$snID.$k.'instalment1_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID.$snID.$k.'instalment1_amount'];
          $selFeeItems[$slID ."-". $snID ."-". $k .'-instalment1_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'];
        }

        if(! isset($_POST[$slID ."-". $snID ."-". $k .'-instalment2_amount']) && isset($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'])){
          $assignDefault=true;
          //$selFeeItems[$slID.$snID.$k.'instalment1_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID.$snID.$k.'instalment1_amount'];
          $selFeeItems[$slID ."-". $snID ."-". $k .'-instalment2_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'];
        }
      }
    }
  }

  if($assignDefault){
    if(isset($_SESSION['eduerp_fee_setup']['programme_nid'])){
      $selFeeItems['programme_nid'] = $_SESSION['eduerp_fee_setup']['programme_nid'];
    }
    /*
    if(isset($_SESSION['eduerp_fee_setup']['first_installment'])){
      $selFeeItems['first_installment'] = $_SESSION['eduerp_fee_setup']['first_installment'];
    }

    if(isset($_SESSION['eduerp_fee_setup']['second_installment'])){
      $selFeeItems['second_installment'] = $_SESSION['eduerp_fee_setup']['second_installment'];
    }

    if(isset($_SESSION['eduerp_fee_setup']['fee_student_level_type'])){
      $feeSetup['fee_student_level_type'] = $_SESSION['eduerp_fee_setup']['fee_student_level_type'];
    }

    if(isset($_SESSION['eduerp_fee_setup']['fee_student_nationality_type'])){
      $feeSetup['fee_student_nationality_type'] = $_SESSION['eduerp_fee_setup']['fee_student_nationality_type'];
    }
    */
    if(isset($_SESSION['eduerp_fee_setup']['fee_structure_name'])){
      $feeSetupDefault['fee_structure_name'] = $_SESSION['eduerp_fee_setup']['fee_structure_name'];
    }
    //
  }
  //echo "<pre>";
  //print_r($selFeeItems);
  //echo "</pre>";
  $form['#title'] = 'Create / Modify Fee Setup Page2';
  /*
  $form['fee_structure_name'] = array(
    '#title' => 'Fee Structure Name',
    '#type' => 'textfield',
    '#size' => 50,
    //'#required' => true,
   );
  if ($feeSetupDefault) $form['fee_structure_name']['#value'] = $feeSetupDefault['fee_structure_name'];
  */


  if(trim(strtolower(strtoupper(substr($feeStructure['name'],0,7)))) == 'program'){
    $form['programme_nid'] = array(
      '#type' => 'select',
      //'#required' => TRUE,
      '#options' => array(''=>'---select one---') + get_programmes(0, true),
      '#title' => 'Program Name',

    );
    if($selFeeItems['programme_nid']) $form['programme_nid']['#value'] = $selFeeItems['programme_nid'];
    if ($editMode) $form['programme_nid']['#options'] = array(''=>'--select one--') + get_programmes($_SESSION['eduerp_fee_setup']['programme_nid'], true);
  }

  $form['item'] = array(
    '#value' => "Below is the list of Four (4) Groups of Fees for the selected Fee Structure Type and all available Fee Items. Kindly enter amounts for those associated with the fees you are creating.<br />
      <b>Note:</b><br />
      1. All Fee Items having 'N/A' as Amount will not be included.<br />
      2. You MUST enter Amounts for at least one Fee Item in a given Group.<br />
      3. Any non-zero value in 'First Instalment' activates instalment payment for such item.<br />
      4. If First Instalment is specified then (Full Amount - First Instalment = Second Instalment) is assumed.",
    '#type' => 'item',

   );

  foreach($studentLevels as $slID => $slName){
    foreach($studentNationalities as $snID => $snName){

	  //$form['extra'.$slID.$snID] = array(
	  $form["extra".$slID.$snID] = array(
	    '#type' => 'fieldset',
	    '#title' => $slName .' - '. $snName .' - ' . 'Available Fee Items',
	    '#collapsed' => false,
	    '#collapsible' => TRUE);
	  $form["extra".$slID . $snID]["fee_item_header-".$slID."-".$snID] = array(
	    '#type' => 'item',
	    '#value' => '<b>Fee Item</b>',
	    '#size' => 20,
	    '#prefix' => "<table border=1><tr><td width='50px;'>#</td><td width='250px;'>",
	    '#suffix' => '</td>');

	    $form["extra".$slID . $snID]["fee_full_amount_header-". $slID ."-". $snID] = array(
	    '#type' => 'item',
	    '#value' => '<b>Full Amount</b>',
	    '#size' => 20,
	    '#prefix' => '<td>',
	    '#suffix' => '</td>');

	    $form["extra".$slID . $snID]["fee_instalment1_amount_header-".$slID. "-". $snID] = array(
	    '#type' => 'item',
	    '#value' => '<b>First Instalment Amount</b>',
	    '#size' => 20,
	    '#prefix' => '<td>',
	    '#suffix' => '</td></tr>');
	    $i=1;
	    foreach($feeItems as $k => $v) {
	      $form["extra".$slID . $snID][$slID ."-". $snID. "-". $k. "-lbl"] = array(
		'#type' => 'item',
		'#value' => $v['fee_item'],
		'#prefix' => "<tr><td>". $i++ ."</td><td width='250px;'>",
		'#suffix' => '</td>');
	      $form["extra".$slID . $snID][$slID ."-". $snID ."-". $k. "-full_amount"] = array(
		'#type' => 'textfield',
		'#default_value' => 'N/A',
		'#size' => 10,
		'#prefix' => '<td>',
		'#suffix' => '</td>');
	      if ($selFeeItems[$slID. "-" .$snID ."-". $k .'-full_amount']) $form["extra".$slID . $snID][$slID ."-". $snID ."-". $k .'-full_amount']['#value'] = $selFeeItems[$slID ."-". $snID ."-". $k .'-full_amount'];

	      $form['extra'.$slID.$snID][$slID ."-". $snID ."-". $k .'-instalment1_amount'] = array(
		'#type' => 'textfield',
		'#default_value' => 'N/A',
		'#size' => 10,
		'#prefix' => '<td>',
		'#suffix' => '</td></tr>');
	      if ($selFeeItems[$slID ."-". $snID ."-". $k .'-instalment1_amount']) $form['extra'.$slID . $snID][$slID ."-". $snID ."-". $k .'-instalment1_amount']['#value'] = $selFeeItems[$slID ."-". $snID ."-". $k .'-instalment1_amount'];

	    }


	  $form['extra'.$slID.$snID]['sess1'] = array(
	    '#type' => 'item',
	    '#value' => '&nbsp;', //variable_get('eduerp_current_session', ''),
	    '#prefix' => "<tr><td colspan='4'>",
	    '#suffix' => '</td></tr></table>',
	    '#size' => 15);
    }
  }


  $form['eduerp_page'] = array(
    '#title' => 'Page',
    '#type' => 'hidden',
    '#value' => 2,
   );
  //if ($feeItem) $form['fee_item']['#value'] = $feeItem->name;

  $form['previous'] = array(
    '#value' => 'Back',
    '#type' => 'submit'
  );
  $form['cmdCancel'] = array(
    '#value' => 'Cancel',
    '#type' => 'submit'
  );

  $form['submit'] = array(
    '#value' => 'Continue',
    '#type' => 'submit'
  );

  return $form;
}

//! is_numeric($values[$k.'txt'])
function staff_school_fees_create_modify_fee_setup2_form_validate($form, &$state) {
  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;

  $values = $state['values'];
  //echo "<pre>";
  //print_r($values);
  //echo "</pre>";

  //drupal_set_message(print_r($values));
  $feeItems = get_school_fee_items();
  $feeStructure = get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type']);
  $studentLevels = get_fee_student_level_types();
  $studentNationalities = get_fee_student_nationality_types();

  $totalAmount = 0;
  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'continue':
      /*
      if(empty($values['fee_structure_name'])){
      	  form_set_error('fee_structure_name', Error_Types(114));
      }
      */
      foreach($studentLevels as $slID => $slName){
        foreach($studentNationalities as $snID => $snName){
           foreach($feeItems as $k => $v) {
             $famount = 0;
             $iamount = 0;

             //$feeBlock[$slID][$snID] = false;

             if((empty($values[$slID ."-". $snID ."-". $k .'-full_amount']) || ! preg_match("/^[0-9]{1,9}$/", $values[$slID ."-". $snID ."-". $k .'-full_amount'])) && trim($values[$slID ."-". $snID ."-". $k .'-full_amount']) != 'N/A'){
               form_set_error($slID ."-". $snID ."-". $k .'-full_amount', Error_Types(107));
             }
             else{
               $famount = $values[$slID ."-". $snID ."-". $k .'-full_amount'];
             }

             if((empty($values[$slID ."-". $snID ."-". $k .'-instalment1_amount']) || ! preg_match("/^[0-9]{1,9}$/", $values[$slID ."-". $snID ."-". $k .'-instalment1_amount'])) && trim($values[$slID ."-". $snID ."-". $k .'-instalment1_amount']) != 'N/A'){
               form_set_error($slID ."-". $snID ."-". $k .'-instalment1_amount', Error_Types(107));
             }
             else{
               $iamount = $values[$slID ."-". $snID ."-". $k .'-instalment1_amount'];
             }

             //make sure for every first instalment specified there is a corresponding full amount
             if(is_numeric($iamount) && ! is_numeric($famount)){
               form_set_error($slID ."-". $snID ."-". $k .'-full_amount', Error_Types(165));
             }

             //make sure if first instalment is specified that it is less than total amount
             if(is_numeric($iamount) && is_numeric($famount) && $famount <= $iamount){
               form_set_error($slID ."-". $snID ."-". $k .'-instalment1_amount', Error_Types(164));

             }

             //make sure that value exists for at least one fee item in all groups
             if(is_numeric($famount) && $famount > 0){
              $feeBlock[$slID][$snID] = true;
             }

             if(is_numeric($famount)){
               //if(! isset($_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID])) $_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID] = 0;
               if(! isset($totalFeeBlock[$slID][$snID])) $totalFeeBlock[$slID][$snID] = 0;
               //get the totals
               //$_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID] += $famount;
               $totalFeeBlock[$slID][$snID] += $famount;
             }
           }

        }
      }

      $_SESSION['eduerp_fee_setup']['totalAmount'] = $totalFeeBlock;

      //make sure that amount was entered for at least one Fee Item in each Fee Block
       foreach($studentLevels as $slID => $slName){
        foreach($studentNationalities as $snID => $snName){
          if(! $feeBlock[$slID][$snID]){
            form_set_error('', Error_Types(166));

          }

        }
       }




      if(trim(strtolower(strtoupper(substr($feeStructure['name'],0,7)))) == 'program'){
        if(empty($values['programme_nid'])){
          form_set_error('programme_nid', Error_Types(114));
        }

      }


      /*
      if((empty($values['first_installment']) || ! preg_match("/^[0-9]{1,9}$/", $values['first_installment'])) && trim($values['first_installment']) != 'N/A'){
        form_set_error($values['first_installment'], Error_Types(107));
      }

      if((empty($values['second_installment']) || ! preg_match("/^[0-9]{1,9}$/", $values['second_installment'])) && trim($values['second_installment']) != 'N/A'){
        form_set_error($values['second_installment'], Error_Types(107));
      }

      if((is_numeric($values['first_installment']) && ! is_numeric($values['second_installment'])) || (is_numeric($values['second_installment']) && ! is_numeric($values['first_installment']))){
      	form_set_error($values['first_installment'], Error_Types(154));

      }

      if(is_numeric($values['first_installment']) && is_numeric($values['second_installment']) && ($values['first_installment'] + $values['second_installment'] != $totalAmount)){
      	form_set_error($values['first_installment'], Error_Types(155));
      }
      */
    break;
  }

  if(trim(strtolower(strtoupper(substr($feeStructure['name'],0,7)))) == 'program' && isset($values['programme_nid'])){
    if(! $editMode)
    $_SESSION['eduerp_fee_setup']['programme_nid'] = $values['programme_nid'];
  }
  else{
    unset($_SESSION['eduerp_fee_setup']['programme_nid']); // = null;
  }

  //store the data
  foreach($studentLevels as $slID => $slName){
    foreach($studentNationalities as $snID => $snName){
      foreach($feeItems as $k => $v) {
        if(isset($values[$slID ."-". $snID ."-". $k . '-full_amount'])){// || $values[$k.'txt'] == '0'
          $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] = $values[$slID ."-". $snID ."-". $k .'-full_amount'];
        }
        else {
          $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] = 'N/A';
        }


        if(isset($values[$slID ."-". $snID ."-". $k .'-instalment1_amount'])){// || $values[$k.'txt'] == '0'
          $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'] = $values[$slID ."-". $snID ."-". $k .'-instalment1_amount'];
        }
        else {
          $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'] = 'N/A';
        }

        //store values for instalment2
        if(is_numeric($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount']) && is_numeric($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'])){
          $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] - $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'];
        }
	else{
	  $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'] = 'N/A';

	}

      }
    }
  }

  //$_SESSION['eduerp_fee_setup']['fee_structure_name'] = $values['fee_structure_name'];


  //$_SESSION['eduerp_fee_setup']['first_installment'] = $values['first_installment'];
  //$_SESSION['eduerp_fee_setup']['second_installment'] = $values['second_installment'];

  //$_SESSION['eduerp_fee_setup']['totalAmount'] = $totalAmount;

  //drupal_goto('staff/createmodifyfeestup');
}


function staff_school_fees_create_modify_fee_setup2_form_submit($form, &$state) {
  $values = $state['values'];
  //drupal_set_message("3 Page is ". $_SESSION['eduerp_page']);

  switch(trim(strtolower(strtoupper($values['op'])))){

    case 'back':
      $_SESSION['eduerp_page'] = 1; unset($_POST['eduerp_page']);
      if((arg(2) || is_numeric(arg(2))))
       	 drupal_goto('staff/createmodifyfeestup/'. arg(2));
       else
         drupal_goto('staff/createmodifyfeestup');
      //drupal_set_message("back");
    break;

    case 'continue':
       $_SESSION['eduerp_page'] = 3; unset($_POST['eduerp_page']);
       if((arg(2) || is_numeric(arg(2))))
       	 drupal_goto('staff/createmodifyfeestup/'. arg(2));
       else
         drupal_goto('staff/createmodifyfeestup');
       //drupal_set_message("continue");
    break;
    case 'cancel':
      unset($_SESSION['eduerp_fee_setup']); $_SESSION['eduerp_fee_setup'] = null;
      unset($_SESSION['eduerp_page']); $_SESSION['eduerp_page']=null;
      drupal_goto('staff/createmodifyfeestup');

     break;

  }
}



function staff_school_fees_create_modify_fee_setup3_form() {
  $form['#title'] = 'School Fee Setup Page 3';
  $form['eduerp_page'] = array(
    '#title' => 'Page',
    '#type' => 'hidden',
    '#value' => 3,
   );

  $form['previous'] = array(
    '#value' => 'Back',
    '#type' => 'submit'
  );
  $form['cmdCancel'] = array(
    '#value' => 'Cancel',
    '#type' => 'submit'
  );
  $form['submit'] = array(
    '#value' => 'Submit',
    '#type' => 'submit'
  );

  return $form;
}


function staff_school_fees_create_modify_fee_setup3_form_validate($form, &$state) {
   $values = $state['values'];
  //make sure that the combination is not existing
  $editMode = ((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))) ? true : false;
  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'submit':
      $programNID = is_numeric($_SESSION['eduerp_fee_setup']['programme_nid']) ? $_SESSION['eduerp_fee_setup']['programme_nid'] : 0;
      //echo $programNID;
      if(is_fee_setup_existing($programNID, variable_get('eduerp_current_session', '')) && ! $editMode){
        form_set_error('submit', Error_Types(167));
        $_SESSION['eduerp_page'] = 3;
      }
      /*
      if(! $editMode && is_fee_setup_combination_existing($programNID, $_SESSION['eduerp_fee_setup']['fee_student_level_type'], $_SESSION['eduerp_fee_setup']['fee_student_nationality_type'])){

        form_set_error('submit', Error_Types(156));
        $_SESSION['eduerp_page'] = 3;
      }
      */
  }
}


function staff_school_fees_create_modify_fee_setup3_form_submit($form, &$state) {
  global $user;
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'cancel':
      unset($_SESSION['eduerp_fee_setup']); $_SESSION['eduerp_fee_setup'] = null;
      unset($_SESSION['eduerp_page']); $_SESSION['eduerp_page']=null;
      drupal_goto('staff/createmodifyfeestup');

      break;
    case 'back':
      $_SESSION['eduerp_page'] = 2; unset($_POST['eduerp_page']);
      if((arg(2) || is_numeric(arg(2))))
       	 drupal_goto('staff/createmodifyfeestup/'. arg(2));
       else
         drupal_goto('staff/createmodifyfeestup');

    break;

    case 'submit':

      //we need to check if attribute exists if not create it.
      if(is_uc_attribute_existing("fee_structure")){
        $attribute = get_uc_attribute_info("fee_structure");

      }
      else{
        //create the attribute
	$info['name'] = "fee_structure";
	$info['label'] = "Fee Structure";
	create_uc_attribute($info);

	$attribute = get_uc_attribute_info("fee_structure");

      }

       $_SESSION['eduerp_page'] = 3;

       $feeStructure = get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type']);
       //$feeNationality = get_fee_student_nationality_types($_SESSION['eduerp_fee_setup']['fee_student_nationality_type']);
       //$feeLevelType = get_fee_student_level_types($_SESSION['eduerp_fee_setup']['fee_student_level_type']);

       $feeItems = get_school_fee_items();
       $studentLevels = get_fee_student_level_types();
       $studentNationalities = get_fee_student_nationality_types();



       //this is where we'll submit the entire fee setup
       // fee setup CCK
       $programNID = (isset($_SESSION['eduerp_fee_setup']['programme_nid']) && is_numeric($_SESSION['eduerp_fee_setup']['programme_nid'])) ? $_SESSION['eduerp_fee_setup']['programme_nid'] : 0;

       $programInfo = get_programmes($programNID, true);
       $_SESSION['eduerp_fee_setup']['fee_structure_name'] = ($programNID == 0) ? 'General Fee Structure' : $programInfo[$programNID];

       foreach($studentLevels as $slID => $slName){
        foreach($studentNationalities as $snID => $snName){
	       if((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))){
		 //for update

		 //get the node nid
		 $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup}
		 	 WHERE field_fee_nationality_type_nid=%d AND
		 	 field_fee_student_level_type_nid=%d AND
		 	 field_fee_setup_program_nid_value=%d AND
		 	 field_fee_setup_session_value='%s'", $snID, $slID, arg(2), variable_get('eduerp_current_session', ''));
		 $j = db_fetch_object($rs);

		 $node =  node_load($j->nid);
		 //$node->field_setup_first_instalment[0]['value']        = $_SESSION['eduerp_fee_setup']['first_installment'];
		 //$node->field_setup_second_instalment[0]['value']    	= $_SESSION['eduerp_fee_setup']['second_installment'];
		 $node->field_fee_setup_total_amount[0]['value']        = $_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID];

		 node_save($node);
		 $feeSetupNID = $j->nid;
		 drupal_set_message('The Fee Setup was updated successfully!');
	       }
	       else {
		 //for insert
		 $node = new stdClass();
		 $node->type                               		= 'school_fee_item_setup';
		 $node->uid                                		= 1;  // Admin
		 $node->status                             		= 1;  // Published
		 $node->promote                            		= 0;
		 $node->sticky                             		= 0;
		 $node->comment                            		= 0;
		 $node->title                              		= $feeStructure['name'] .' - '. $snName .' - '. $slName .' - '. $programNID;//$feeStructure['name'] .' - '. $feeNationality['name'] .' - '. $feeLevelType['name'] .' - '. $programNID;
		 $node->field_fee_nationality_type[0]['nid']          	= $snID; //$_SESSION['eduerp_fee_setup']['fee_student_nationality_type'];
		 $node->field_fee_structure_type[0]['nid']           	= $_SESSION['eduerp_fee_setup']['fee_structure_type'];
		 $node->field_fee_student_level_type[0]['nid'] 		= $slID; //$_SESSION['eduerp_fee_setup']['fee_student_level_type'];
		 //$node->field_setup_first_instalment[0]['value']        = $_SESSION['eduerp_fee_setup']['first_installment'];
		 //$node->field_setup_second_instalment[0]['value']    	= $_SESSION['eduerp_fee_setup']['second_installment'];
		 $node->field_fee_setup_total_amount[0]['value']        = $_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID];
		 $node->field_setup_officer[0]['uid']         		= $user->uid;
		 $node->field_fee_setup_program_nid[0]['value']        	= is_numeric($programNID) ? $programNID : 0 ;
		 $node->field_fee_structure_name[0]['value']        	= $_SESSION['eduerp_fee_setup']['fee_structure_name'];
		 $node->field_fee_setup_session[0]['value']        	= variable_get('eduerp_current_session', '');
		 $node->field_fee_setup_date[0]['value']        	= date("Y-m-d H:i:s");

		 node_save($node);
		 $feeSetupNID = $node->nid;
		 drupal_set_message('The Fee Setup was created successfully!');
	       }




	       if((arg(2) || is_numeric(arg(2))) && is_fee_setup_existing(arg(2), variable_get('eduerp_current_session', ''))){
		 //we need to delete all previous inserts
		 //get previous details

		 $feeSetupDetails = get_fee_setup_item_details($feeSetupNID);
		 while($r = db_fetch_object($feeSetupDetails)){
		   delete_node($r->nid);
		 }
	       }

	       //insert the fee item details
	       //foreach($_SESSION['eduerp_fee_setup']['items'] as $k => $v){
	       foreach($feeItems as $k => $feeItem) {
		 //if(is_numeric($v) && $v > 0){
		 if(is_numeric($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount']) && $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] > 0){

		   //we need to check if attribute options exists else we'll create them

		   //construct the names of the option
		   $ucOptionName[0]['name'] = $_SESSION['eduerp_fee_setup']['fee_structure_name'] ." - ". $slName ." - ". $snName ." (". $feeItem['fee_item'] . " - Full Amount)";
		   $ucOptionName[0]['price'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'];

		   $ucOptionName[1]['name'] = $_SESSION['eduerp_fee_setup']['fee_structure_name'] ." - ". $slName ." - ". $snName ." (". $feeItem['fee_item'] . " - Instalment1)";
		   $ucOptionName[1]['price'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'];

		   $ucOptionName[2]['name'] = $_SESSION['eduerp_fee_setup']['fee_structure_name'] ." - ". $slName ." - ". $snName ." (". $feeItem['fee_item'] . " - Instalment2)";
		   $ucOptionName[2]['price'] = $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'];

		   foreach($ucOptionName as $u){

		     $optionInfo['aid']=$attribute['aid'];
		     $optionInfo['name'] = $u['name'];
		     $optionInfo['price'] = $u['price'];
		     if(is_uc_attribute_option_existing($optionInfo)){
		       //fine, update the amount

		       update_uc_attribute_option($optionInfo);

		     }
		     else{
		       //create it
		       create_uc_attribute_option($optionInfo);

		     }
		     //get the option info
		     $attributeOptionInfo = get_uc_attribute_option_info($u['name']);

		     //enable option for product $v['fee_item']
		     //we need the product_nid, oid, price

		     $productOption['productNID'] = $feeItem['uc_product_nid'];
		     $productOption['oid'] = $attributeOptionInfo['oid'];
		     $productOption['price'] = $u['price'];

		     //first make sure that the option is not already attached to the product
		     if(is_uc_option_attached_to_product($productOption)){
		       //fine, update the amount
		       update_uc_product_option($productOption);
		     }
		     else{
		       //create it
		       attach_uc_option_to_product($productOption);
		     }

		   }


		   $node = new stdClass();
		   $node->type                               		= 'school_fee_item_setup_details';
		   $node->uid                                		= 1;  // Admin
		   $node->status                             		= 1;  // Published
		   $node->promote                            		= 0;
		   $node->sticky                             		= 0;
		   $node->comment                            		= 0;
		   $node->title                              		= 'Fee Setup Details' .' - '. $k .' - '. $feeSetupNID;
		   $node->field_fee_item_fk[0]['nid']          		= $k;
		   $node->field_fee_item_setup_fk[0]['nid']           	= $feeSetupNID;
		   $node->field_fee_full_payment_amount[0]['value'] 	= $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'];//$v;
		   $node->field_fee_instalment1_amount[0]['value'] 	= $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'];
		   $node->field_fee_instalment2_amount[0]['value'] 	= $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'];
		   //$node->field_fee_uc_oid[0]['value'] 			= $oid;

		   node_save($node);


		 }
	       }
	}
       }

       unset($_SESSION['eduerp_fee_setup']);
       unset($_SESSION['eduerp_page']); unset($_POST['eduerp_page']);
       drupal_goto('staff/createmodifyfeestup');

    break;
    /*



    */

  }
}


function get_fee_structue_types($nid=0, $forCombo=false) {

  $sql = "SELECT nid, field_structure_class_value name FROM {content_type_school_fee_structure_classes}  ";
  if($nid != 0) $sql .= " WHERE nid=%d ";

  $result = db_query($sql, $nid);
  if (db_affected_rows($result) > 0) {

    while ($row = db_fetch_object($result)){
      if($nid != 0 && ! $forCombo){
      	$return['name'] = $row->name;
        $return['nid'] = $row->nid;
        break;
      }
      else{
        $return[$row->nid] = $row->name;

      }
    }
  }
  else
    $return[] = strip_tags(Error_Types(106));

  return $return;
}


function get_fee_student_level_types($nid=0, $forCombo=false) {
  $sql = "SELECT nid, field_level_type_value name FROM {content_type_school_fee_level_types}  ";
  if($nid != 0) $sql .= " WHERE nid=%d ";

  $result = db_query($sql, $nid);

  if (db_affected_rows($result) > 0) {
    while ($row = db_fetch_object($result)){
      if($nid != 0 && ! $forCombo){
      	$return['name'] = $row->name;
        $return['nid'] = $row->nid;
        break;
      }
      else{
        $return[$row->nid] = $row->name;

      }
    }
  }
  else
    $return[] = strip_tags(Error_Types(106));

  return $return;
}


function get_fee_student_nationality_types($nid=0, $forCombo=false) {

  $sql = "SELECT nid, field_nationality_type_value name FROM {content_type_school_fee_nationality_types}  ";
  if($nid != 0) $sql .= " WHERE nid=%d ";
  $result = db_query($sql, $nid);

  if (db_affected_rows($result) > 0) {
     while ($row = db_fetch_object($result)){
      if($nid != 0 && ! $forCombo){
      	$return['name'] = $row->name;
        $return['nid'] = $row->nid;
        break;
      }
      else{
        $return[$row->nid] = $row->name;

      }
    }
  }
  else
    $return[] = strip_tags(Error_Types(106));

  return $return;
}

/*
function is_fee_setup_combination_existing($programID, $studentTypeID, $nationalityTypeID){

  if($programID == 0){
     $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE
    field_fee_nationality_type_nid=%d AND
    (field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value = 0) AND
    field_fee_student_level_type_nid=%d", $nationalityTypeID, $studentTypeID);

  }
  else{
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE
    field_fee_nationality_type_nid=%d AND
    field_fee_setup_program_nid_value=%d AND
    field_fee_student_level_type_nid=%d", $nationalityTypeID, $programID, $studentTypeID);
  }

  if(db_affected_rows($rs) > 0) return true;

  return false;

}
*/
/*
function is_fee_setup_existing($programID){

  if($programID == 0){
     $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE
    field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value = 0 ");

  }
  else{
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE
    field_fee_setup_program_nid_value=%d ", $programID);
  }

  if(db_affected_rows($rs) > 0) return true;

  return false;

}
*/

function show_fee_setup_page_one_info(){

  if(! isset($_SESSION['eduerp_fee_setup']) || ! sizeof($_SESSION['eduerp_fee_setup']))
    drupal_goto('staff/createmodifyfeestup');


  $feeStructure = get_fee_structue_types($_SESSION['eduerp_fee_setup']['fee_structure_type']);
  //$feeNationality = get_fee_student_nationality_types($_SESSION['eduerp_fee_setup']['fee_student_nationality_type']);
  //$feeLevelType = get_fee_student_level_types($_SESSION['eduerp_fee_setup']['fee_student_level_type']);
  $html = "
  <div id='assigned_courses'><br />
  <b>School Fee Setup Info</b><br />";

  $html .="
  <table border=1 > ";
  if($_SESSION['eduerp_fee_setup']['fee_structure_name']){
    $html .="
    <tr>
      <td width='200px;'>Fee Structure Name:</td>
      <td><b>". $_SESSION['eduerp_fee_setup']['fee_structure_name'] ."</b></td>
    </tr>";
  }

  $html .="
    <tr>
      <td width='200px;'>Fee Structure Type:</td>
      <td><b>". $feeStructure['name'] ."</b></td>
    </tr>";

    if(isset($_SESSION['eduerp_fee_setup']['programme_nid'])){
      $rs = get_programmes($_SESSION['eduerp_fee_setup']['programme_nid']);
      $row = db_fetch_object($rs);
      $html .="
      <tr>
        <td >Program Name:</td>
        <td><b>". $row->programme_name ."</b></td>
      </tr>";

    }
    /*
    $html .="
    <tr>
      <td >Fee Nationality Type:</td>
      <td><b>". $feeNationality['name'] ."</b></td>
    </tr>
    <tr>
      <td >Fee Level Type:</td>
      <td><b>". $feeLevelType['name'] ."</b></td>
    </tr>";
    */
    $html .="
  </table>
  </div>";



  return $html;
}


function show_fee_setup_page_two_info(){

  if(! isset($_SESSION['eduerp_fee_setup']) || ! sizeof($_SESSION['eduerp_fee_setup']))
    drupal_goto('staff/createmodifyfeestup');


  $feeItems = get_school_fee_items();
  $studentLevels = get_fee_student_level_types();
  $studentNationalities = get_fee_student_nationality_types();
  $html ="";

    foreach($studentLevels as $slID => $slName){
        foreach($studentNationalities as $snID => $snName){
          $html .= "
	  <div id='assigned_courses'><br />
	  <b>". $slName ." - ". $snName ." - List of Selected Fee Items</b><br />";
          $html .="
	  <table border=1 >
	    <tr>
	      <th width='15px;'>#</th>
	      <th width='200px;'>Fee Item</th>
	      <th>Full Amount</th>
	      <th>First Instalment Amount</th>
	      <th>Second Instalment Amount</th>
	    </tr>";
	    $i=1; $totalAmount=0;
          foreach($feeItems as $k => $v) {
            //if(isset($values[$k.'txt']) && $values[$k.'txt'] != 'N/A' && $values[$k.'txt'] > 0 ){
            if(isset($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount']) && $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] != 'N/A' && $_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'] > 0 ){
              //form_set_error($values[$k.'txt'], Error_Types(107));
              $html .="
              <tr>
                <td>". $i++ ."</td>
                <td>". $v['fee_item'] ."</td>
                <td><b>". number_format($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-full_amount'], 2) ."</b></td>
                <td>". ($x = is_numeric($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount']) ? "<b>". number_format($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment1_amount'], 2) ."</b>" : 'N/A') . "</td>
                <td>". ($x = is_numeric($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount']) ? "<b>". number_format($_SESSION['eduerp_fee_setup']['items'][$slID ."-". $snID ."-". $k .'-instalment2_amount'], 2) ."</b>" : 'N/A') . "</td>
              </tr>";

              //$totalAmount += $_SESSION['eduerp_fee_setup']['items'][$slID.$snID.$k.'full_amount'];
            }

          }

          //<td><b>". number_format($totalAmount, 2) ."</b></td>
          $html .="
          <tr>
            <td colspan=2 align='right'>Total Fee Amount:&nbsp;</td>
            <td><b>". number_format($_SESSION['eduerp_fee_setup']['totalAmount'][$slID][$snID], 2) ."</b></td>
          </tr>
        </table>
     </div>";
        }
    }


  return $html;
}


function get_fee_setup_item_details($setupNID){

  $rs = db_query('SELECT ctsfisd.nid nid, field_uc_product_nid_nid product_nid, field_fee_full_payment_amount_value full_amount, IFNULL(field_fee_instalment1_amount_value, 0) AS instalment1_amount, IFNULL(field_fee_instalment2_amount_value, 0) AS instalment2_amount, field_fee_item_value item_name, field_fee_item_fk_nid item_nid, field_is_scholarship_applicable_value is_scholarship_applicable
  	  FROM {content_type_school_fee_item_setup_details} ctsfisd
  	  INNER JOIN {content_type_school_fee_items} ctsfi ON ctsfisd.field_fee_item_fk_nid=ctsfi.nid
  	  WHERE field_fee_item_setup_fk_nid=%d ', $setupNID);
 return $rs;
}


function staff_school_fees_test_fee_setup_form() {

    $form['#title'] = 'Test Fee Setup';

    $form['submit'] = array(
      '#value' => 'Test available School Fee Setup for completeness',
      '#type' => 'submit'
    );

   return $form;


}


function get_late_registration_info(){

  $r = db_query("SELECT field_fee_settings_name_value AS settings_name, field_fee_settings_value_value AS settings_value
  	  FROM {content_type_school_fee_settings} WHERE field_fee_settings_name_value='%s' OR field_fee_settings_name_value='%s'", "Last Date For Fee Payment Without Late Registration Charges", "Late Registration Amount");

  while($rs = db_fetch_object($r)){
    //echo $rs->settings_name;
    $name = ($rs->settings_name == 'Last Date For Fee Payment Without Late Registration Charges') ? 'last_date' : 'late_reg_amount';
    $lateRegInfo[$name] = $rs->settings_value;
  }

  return $lateRegInfo;
}


function is_second_instalment_activated(){

  $r = db_query("SELECT field_fee_settings_name_value settings_name, field_fee_settings_value_value settigs_value FROM {content_type_school_fee_settings} WHERE field_fee_settings_name_value='%s'", "activate second instalment payment");

  $rs = db_fetch_object($r);
  if($rs->settigs_value == '1') return true;

  return false;

}

/*
function get_uc_late_registration_info(){

  $r = db_query("SELECT field_fee_settings_name_value settings_name, field_fee_settings_value_value settigs_value FROM content_type_school_fee_settings WHERE field_fee_settings_name_value='%s' OR field_fee_settings_name_value='%s'", "Last Date For Fee Payment Without Late Registration Charges", "Late Registration Amount");

  while($rs = db_fetch_object($r)){
    $name = ($rs->settings_name == 'Last Date For Fee Payment Without Late Registration Charges') ? 'last_date' : 'late_reg_amount';
    $lateRegInfo[$name] = $rs->settings_value;
  }

  return $lateRegInfo;
}
*/

function is_uc_late_registration_existing($name){

  $rs = db_query("SELECT p.nid FROM node n
  	  INNER JOIN content_type_product ctp ON n.nid=ctp.nid
  	  INNER JOIN uc_products p ON ctp.nid=p.nid
  	  WHERE n.title='%s' AND n.type='product'", $name);

  if(db_affected_rows($rs) >= 1) return true;

  return false;

}


function get_uc_late_registration_info($name){

  $rs = db_query("SELECT p.nid, title, sell_price FROM node n
  	  INNER JOIN content_type_product ctp ON n.nid=ctp.nid
  	  INNER JOIN uc_products p ON ctp.nid=p.nid
  	  WHERE n.title='%s' AND n.type='product'", $name);

  if(db_affected_rows($rs) >= 1) {
    $r = db_fetch_object($rs);

    $info['product_nid'] = $r->nid;
    $info['name'] = $r->title;
    $info['amount'] = $r->sell_price;
    return $info;

  }

  return 0;

}


function staff_school_fees_test_fee_setup_form_submit($form, &$state) {

  $val = is_fee_setup_correct();

  if($val == 1)
    drupal_set_message('Test was successful! School Fee Setup is OK.');
  else
    form_set_error('', Error_Types($val));
}


function is_fee_setup_correct(){

  //get all fee item setup
  $sql = "SELECT DISTINCT(IFNULL(field_fee_setup_program_nid_value, 0)) program_nid FROM {content_type_school_fee_item_setup} ";
  $rs = db_query($sql);
  if(db_affected_rows($rs) <= 0){
    //form_set_error('', Error_Types(157));
    return 157;
  }

  while($r = db_fetch_object($rs)){
    //check the entries


    //for each, student type must appear twice, nationality must appear twice

    //get student types
    $rs1 = db_query("SELECT nid student_level_type_nid FROM {content_type_school_fee_level_types} ");
    if(db_affected_rows($rs1) <= 0){
      //form_set_error('', Error_Types(158));
      return 158;
    }

    while($r1 = db_fetch_object($rs1)){
      if($r->program_nid <= 0){
    	$rs2 = db_query("SELECT COUNT(nid) num FROM {content_type_school_fee_item_setup} WHERE (field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value = 0) AND field_fee_student_level_type_nid=%d GROUP BY field_fee_nationality_type_nid ", $r1->student_level_type_nid);
      }
      else{
        $rs2 = db_query("SELECT COUNT(nid) num FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value=%d AND field_fee_student_level_type_nid=%d GROUP BY field_fee_nationality_type_nid ", $r->program_nid, $r1->student_level_type_nid);
      }

      if(db_affected_rows($rs2) < 2){
        //form_set_error('', Error_Types(158));
        return 158;
      }

      /*
      //$r2 = db_fetch_object($rs2);
      while($r2 = db_fetch_object($rs2)){
        if($r2->num < 2){
          form_set_error('', Error_Types(158));
          return;
        }
      }
      */
    }


    //get nationality types
    $rs1 = db_query("SELECT nid nationality_type_nid FROM {content_type_school_fee_nationality_types} ");
    if(db_affected_rows($rs1) <= 0){
      //form_set_error('', Error_Types(158));
      return 158;
    }

    while($r1 = db_fetch_object($rs1)){
    	    /*
      $rs2 = db_query("SELECT COUNT(nid) num FROM {} WHERE field_fee_setup_program_nid_value=%d AND field_fee_nationality_type_nid=%d

      	      GROUP BY  field_fee_student_level_type_nid ", $r->program_nid, $r1->nationality_type_nid);
      */
      if($r->program_nid <= 0){
    	$rs2 = db_query("SELECT COUNT(nid) num FROM {content_type_school_fee_item_setup} WHERE (field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value =0) AND field_fee_nationality_type_nid=%d GROUP BY field_fee_student_level_type_nid ", $r1->nationality_type_nid);
      }
      else{
        $rs2 = db_query("SELECT COUNT(nid) num FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value=%d AND field_fee_nationality_type_nid=%d GROUP BY field_fee_student_level_type_nid  ", $r->program_nid, $r1->nationality_type_nid);
      }

      if(db_affected_rows($rs2) < 2){
        //form_set_error('', Error_Types(158));
        return 158;
      }

      /*
      //$r2 = db_fetch_object($rs2);
      while($r2 = db_fetch_object($rs2)){
        if($rs2->num < 2){
          form_set_error('', Error_Types(158));
          return;
        }
      }
      */
    }


  }


  return 1;
}


function prepare_fee_setup_for_edit($setupNID){

  unset($_SESSION['eduerp_fee_setup']); $_SESSION['eduerp_fee_setup']=null;


  $feeSetup = get_school_fee_setup(variable_get('eduerp_current_session', ''), $setupNID, false);
  //tbl=>formfield
  $elements = array("fee_structure_nid"=>"fee_structure_type", "level_id"=>"fee_student_level_type", "nationality_id"=>"fee_student_nationality_type",
  	  "program_nid"=>"programme_nid");
  foreach($elements as $k => $v){
    //if($k == "first_instalment" || $k == "second_instalment")
    //  $_SESSION['eduerp_fee_setup'][$v] = substr($feeSetup[$setupNID][$k],0,-3);
    //else
      $_SESSION['eduerp_fee_setup'][$v] = $feeSetup[$setupNID][$k];

  }


}


function get_scholarship_payment_student_finder_form(){

  $form['#title'] = 'Student Finder';
  $form['mat_number'] = array(
      '#title' => 'Matriculation / JAMB Number',
      '#type' => 'textfield',
      '#size' => 40,
      '#required' => TRUE
    );

  $form['submit'] = array(
    '#value' => 'Search Now',
    '#type' => 'submit'
  );

  return $form;

}



function get_scholarship_payment_student_finder_form_validate($form, &$state){

}


function get_scholarship_payment_student_finder_form_submit($form, &$state){
  global $EDUERPstudentInitiated;
  $values = $state['values'];

  $returnURL = 'staff/scholarshippayment';
  ini_student_fee_profile($values['mat_number'], 'eduerp_authorise_scholarship', $returnURL);

}


function ini_student_fee_profile($studentNumber, $varName, $returnURL){
  global $EDUERPstudentInitiated;
  //$values = $state['values'];
  if($EDUERPstudentInitiated)
     $studentInfo = user_load($EDUERPstudentInitiated);
  else
    $studentInfo = user_load(array('name'=>$studentNumber));


  $found = false;
  if( ! $studentInfo) {
    //check if it a valid jamb number
    $studInfo = get_student_info_by_jamb_number($studentNumber);
    if(! db_affected_rows($studInfo) > 0) {
      form_set_error('mat_number', Error_Types(125));

      unset($_SESSION[$varName]); $_SESSION[$varName]=null;
      drupal_goto($returnURL);
    }
    else {
      //ok! the jamb number is valid!
      $studentInfo = db_fetch_object($studInfo);
      $found = true;
    }
  }
  else {
    //a student with correct mat num
    $found = true;

  }

  if($found) {

    //if(! $EDUERPstudentInitiated) {//if request is from student then do not show this
      $student_profile = new UserProfile($studentInfo->uid);
      //make sure no payment info exists for the student for the current session
      //if(is_school_fee_info_existing($studentInfo->uid)){
      //drupal_set_message($_SESSION[$varName]['summaryPaymentType']);


      /**
      The check below is no longer applcable

      */
      /*
      if(is_school_fee_payment_type_info_existing($studentInfo->uid, $_SESSION[$varName]['summaryPaymentType'])){
      	form_set_error('mat_number', Error_Types(160));

      	unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      }

      */

      if($varName == "eduerp_authorise_scholarship"){
      	//make sure he is not already enabled for instalment
      	if(is_instalment_authorisation_existing($studentInfo->uid, variable_get('eduerp_current_session', ''))){
	  drupal_set_message('Instalment Authorisation for the Student already exists');
	  return;
	}

        //specific checks for scholarships
        if(is_scholarship_authorisation_existing($studentInfo->uid, variable_get('eduerp_current_session', ''))){
	  drupal_set_message('Scholarship Authorisation for the Student already exists');
	  return;
	}

      }


      if($varName == "eduerp_authorise_instalment"){
      	//specific checks for scholarships
        if(is_scholarship_authorisation_existing($studentInfo->uid, variable_get('eduerp_current_session', ''))){
	  drupal_set_message('Scholarship Authorisation for the Student already exists');
	  return;
	}

        //specific checks for instalment payment
        if(is_instalment_authorisation_existing($studentInfo->uid, variable_get('eduerp_current_session', ''))){
	  drupal_set_message('Instalment Authorisation for the Student already exists');
	  return;
	}

      }

      //drupal_set_message('MOE is '. $student_profile->profile_mode_of_entry);
      //valid mat or JAMB number was found
      $_SESSION[$varName]['studentUID'] = $student_profile->uid;
      $_SESSION[$varName]['full_name'] = $student_profile->profile_last_name .', '. $student_profile->profile_first_name;
      $_SESSION[$varName]['first_choice_nid'] = $student_profile->profile_first_choice;
      $_SESSION[$varName]['level_name'] = $student_profile->profile_level_name;
      $_SESSION[$varName]['mat_num'] = ! empty($student_profile->profile_matno) ? $student_profile->profile_matno : 'N/A';
      $_SESSION[$varName]['jamb_num'] = $student_profile->profile_jambno;
      $_SESSION[$varName]['gender'] = strtolower($student_profile->profile_gender);
      $_SESSION[$varName]['mode_of_entry'] = strtolower($student_profile->profile_mode_of_entry);
      //$_SESSION['eduerp_authorise_scholarship']['health_status'] = strtolower($student_profile->profile_health_status);
      $_SESSION[$varName]['programNID'] = $student_profile->profile_first_choice;

      $_SESSION[$varName]['country_name'] = ! empty($student_profile->profile_country_name) ? $student_profile->profile_country_name : 'N/A';


      $programmeName = get_programmes($student_profile->profile_first_choice, true);
      $_SESSION[$varName]['programme_name'] = $programmeName[$student_profile->profile_first_choice];



      if(! isset($_SESSION[$varName]['jamb_num']) || $_SESSION[$varName]['jamb_num'] == ""){
        form_set_error('mat_number', Error_Types(143));

        unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
        return;
      }

      //get level types
      $rs = db_query('SELECT nid, field_level_type_value level_type_name FROM {content_type_school_fee_level_types} ');
      if(db_affected_rows($rs) <= 0){
      	form_set_error('mat_number', Error_Types(158));

      	unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      	return;
      }
      $_SESSION[$varName]['levelType'] = null;


      //get the level of the student
      $studentLevel = student_next_level($student_profile->uid, variable_get('eduerp_current_session', ''));

      if(trim($studentLevel) == '100' || trim($studentLevel) == '1'){
        $levelStatus = "freshman";
      }
      elseif((trim($studentLevel) == '200' || trim($studentLevel) == '2') && strtoupper(strtolower($student_profile->profile_mode_of_entry)) == "DE"){
      	$levelStatus = "freshman";

      }
      else{
        $levelStatus = "returning student";
      }

      while($r = db_fetch_object($rs)){
        if($levelStatus == "freshman" && trim(strtolower(strtoupper($r->level_type_name))) == "freshman"){
      	  $_SESSION[$varName]['levelType'] = $r->nid;
      	  break;
        }

        if($levelStatus == "returning student" && trim(strtolower(strtoupper($r->level_type_name))) == "returning student"){
      	  $_SESSION[$varName]['levelType'] = $r->nid;
      	  break;
        }
      }

      if(! $_SESSION[$varName]['levelType']){
        form_set_error('mat_number', Error_Types(143));

        unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      	return;
      }

      //get nationality types
      $rs = db_query('SELECT nid, field_nationality_type_value nationality_type_name FROM {content_type_school_fee_nationality_types} ');
      if(db_affected_rows($rs) <= 0){
      	form_set_error('mat_number', Error_Types(158));

      	unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      	return;
      }

      //get the local country name from setting
      $rs1 = db_query("SELECT country_id, country_name FROM {eduerp_countries} WHERE country_id= (SELECT field_fee_settings_value_value FROM {content_type_school_fee_settings} WHERE field_fee_settings_name_value = 'Local Country Name')  ");
      if(db_affected_rows($rs1) <= 0){
      	form_set_error('mat_number', Error_Types(143));

      	unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      	return;
      }

      $_SESSION[$varName]['nationalityType'] = null;
      $localCountry = db_fetch_object($rs1);

      while($r = db_fetch_object($rs)){
      	if(trim(strtolower(strtoupper($student_profile->profile_country_name))) == trim(strtolower(strtoupper($localCountry->country_name)))){
      	  if(trim(strtolower(strtoupper($r->nationality_type_name))) == 'local'){
      	    $_SESSION[$varName]['nationalityType'] = $r->nid;
      	    //return;
      	    break;
      	  }

      	}
      	if(trim($student_profile->profile_country_name) != trim($localCountry->country_name)){
      	  if(trim(strtolower(strtoupper($r->nationality_type_name))) == 'international'){
      	    $_SESSION[$varName]['nationalityType'] = $r->nid;
      	    //return;
      	    break;
      	  }

      	}

      }

      if(! $_SESSION[$varName]['nationalityType']){
        form_set_error('mat_number', Error_Types(143));

        unset($_SESSION[$varName]); $_SESSION[$varName]=null;
        drupal_goto($returnURL);
      	return;
      }

  }

}


function show_student_info($info){

  $html ="
  <div id='assigned_courses'>
  <table style='width:700px;' border=1>
    <tr>
      <td align='center' colspan=2><b>STUDENT INFO</b></td>
    </tr>
    <tr>
      <td style='width:150px;'>Current Session:</td>
      <td>". variable_get('eduerp_current_session', '') ."</td>
    </tr>
    <tr>
      <td style='width:150px;'>JAMB Number:</td>
      <td>". strtoupper(strtolower($info['jamb_num'])) ."</td>
    </tr>
    <tr>
      <td style='width:150px;'>Matriculation Number:</td>
      <td>". strtoupper(strtolower($info['mat_num'])) ."</td>
    </tr>
    <tr>
      <td style='width:150px;'>Mode of Entry:</td>
      <td>". strtoupper(strtolower($info['mode_of_entry'])) ."</td>
    </tr>
    <tr>
      <td>Full Name:</td>
      <td>". strtoupper(strtolower($info['full_name'])) ."</td>
    </tr>
    <tr>
      <td>Gender:</td>
      <td>". strtoupper(strtolower($info['gender'])) ."</td>
    </tr>";
    if(isset($info['health_status']))
    $html .="
    <tr>
      <td>Health Status:</td>
      <td>". strtoupper(strtolower($info['health_status'])) ."</td>
    </tr>";

    $html .="
    <tr>
      <td>Course Name:</td>
      <td>". strtoupper(strtolower($info['programme_name'])) ."</td>
    </tr>";
    if(isset($info['level_name']))
      $html .= "
      <tr>
        <td>Country Name:</td>
        <td>". strtoupper(strtolower($info['country_name'])) ."</td>
      </tr>

    ";

    $html .="
    <tr>
      <td>Level:</td>
      <td>". strtoupper(strtolower($info['level_name'])) ."</td>
    </tr>
  </table>
  </div>";

  return $html;

}



function staff_show_pay_school_fees_scholarship_form(){


  $form['#title'] = 'School Fees Scholarship Payment';
  /*
  $form['previous'] = array(
    '#value' => 'Back',
    '#type' => 'submit'
  );
  */
   $form['remarks'] = array(
    '#type' => 'textarea',
    '#title' => 'Remarks - Brief details about the Scholarship',
    '#size' => 255,
    //'#required' => true
  );
   $form['lbl01'] = array(
    '#type' => 'item',
    '#value' => "<font color=#FF0000><b>By clicking 'Authorise Scholarship!' you acknowledge that the student whose details appear above is under FULL Scholarship and that such Scholarship covers the School Fee Amount.</b></font>",

  );
  $form['cmdCancel'] = array(
    '#value' => 'Cancel',
    '#type' => 'submit'
  );
  $form['submit'] = array(
    '#value' => 'Authorise Scholarship!',
    '#type' => 'submit'
  );

  return $form;
}



function staff_show_pay_school_fees_scholarship_form_validate($form, &$state){
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'authorise scholarship!':

      if(empty($values['remarks'])){
    	form_set_error('remarks', Error_Types(161));
      }

      if(is_scholarship_authorisation_existing($_SESSION['eduerp_authorise_scholarship']['studentUID'], variable_get('eduerp_current_session', ''))){
      	form_set_error('', Error_Types(162));
        return;
      }
      if(is_instalment_authorisation_existing($_SESSION['eduerp_authorise_scholarship']['studentUID'], variable_get('eduerp_current_session', ''))){
      	form_set_error('', Error_Types(163));
        return;
      }
    break;
  }

}



function staff_show_pay_school_fees_scholarship_form_submit($form, &$state){
  global $user;
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'authorise scholarship!':


      $node = new stdClass();
      $node->type                             	= 'school_fee_approved_scholarships';
      $node->uid                              	= 1;  // Admin
      $node->status                           	= 1;  // Published
      $node->promote                          	= 0;
      $node->sticky                           	= 0;
      $node->comment                          	= 0;
      $node->title                            	= 'Authorise Scholarship - '. $_SESSION['eduerp_authorise_scholarship']['studentUID'] .' - '. variable_get('eduerp_current_session', '');
      $node->field_sas_student[0]['uid']       	= $_SESSION['eduerp_authorise_scholarship']['studentUID'];
      $node->field_sas_session_name[0]['value'] = variable_get('eduerp_current_session', '');
      $node->field_sas_remarks[0]['value']      = $values['remarks'];
      $node->field_sas_staff[0]['uid']       	= $user->uid;
      $node->field_sas_date[0]['value']     	= date("Y-m-d H:i:s");

      node_save($node);
      drupal_set_message('Scholarship Authorisation was successful!');
      unset($_SESSION['eduerp_authorise_scholarship']); $_SESSION['eduerp_authorise_scholarship'] = null;
      //}

    break;

    case 'cancel':
      unset($_SESSION['eduerp_authorise_scholarship']); $_SESSION['eduerp_authorise_scholarship'] = null;

    break;

  }
}


function is_scholarship_authorisation_existing($studentUID, $sessionName){

  $rs = db_query("SELECT nid FROM {content_type_school_fee_approved_scholarships} WHERE field_sas_student_uid=%d AND field_sas_session_name_value='%s' ", $studentUID, $sessionName);

  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function is_instalment_authorisation_existing($studentUID, $sessionName){

  $rs = db_query("SELECT nid FROM {content_type_school_fee_approved_instalments} WHERE field_sai_student_uid=%d AND field_sai_session_name_value='%s' ", $studentUID, $sessionName);

  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function get_student_info_by_jamb_number($jambno){

 $sql ="SELECT nspro.uid uid
   FROM {node} nspro
   INNER JOIN {content_type_student_profile} spro ON nspro.vid=spro.vid
   WHERE nspro.type='student_profile' AND spro.field_profile_jambno_value='%s'  ";
 //, {content_type_profile} pro , IFNULL(field_profile_jambno_value, 'N/A') profile_jambno, IFNULL(field_profile_matno_value, 'N/A') profile_matno, field_profile_last_name_value profile_last_name, field_profile_first_name_value profile_first_name, field_profile_first_choice_nid profile_first_choice, field_profile_level_name_value profile_level_name, field_profile_gender_value profile_gender, field_profile_health_status_value profile_health_status
 return $rs = db_query($sql, $jambno);
 //if(db_affected_rows($rs) > 0) return true; else return false;

}


function show_school_fees_payment_option($varName, $studentUID, $programNID, $levelType, $nationalityType){
  //return;
  $feeOption = array();
  //make sure that fee setup is correct
  $val = is_fee_setup_correct();
  if($val != 1){
    form_set_error('', Error_Types($val));
    return;
  }

  //test if his/her program has program specific setup
  $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value=%d  AND field_fee_setup_session_value='%s' ", $programNID, variable_get('eduerp_current_session', ''));
  if(db_affected_rows($rs) <=0){
    //now test if general setup exists
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value=0  AND field_fee_setup_session_value='%s'", variable_get('eduerp_current_session', ''));
    if(db_affected_rows($rs) <=0){
      return Error_Types(159);
    }
    //get fee setup details
    $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), 0, false);

    $id = 0;

  }
  else{
    //get fee setup details
    $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), $programNID, false);
    $id = $programNID;
  }


  if(! isset($feeOption) || ! is_array($feeOption) || ! sizeof($feeOption)){
    return Error_Types(159);

  }

  //fine. Now get his/her own particular fee structure
  if($id == 0)
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_nationality_type_nid=%d AND field_fee_student_level_type_nid=%d AND (field_fee_setup_program_nid_value=0 OR field_fee_setup_program_nid_value IS NULL)  AND field_fee_setup_session_value='%s'  ", $nationalityType, $levelType, variable_get('eduerp_current_session', ''));
  else
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_nationality_type_nid=%d AND field_fee_student_level_type_nid=%d AND field_fee_setup_program_nid_value=%d AND field_fee_setup_session_value='%s' ", $nationalityType, $levelType, $id, variable_get('eduerp_current_session', ''));

  $feeSetup = db_fetch_object($rs);
  $setupNID = $feeSetup->nid;

  $_SESSION[$varName]['studentFeeSetupNID'] = $setupNID;

  //drupal_set_message('setup total is '.$feeOption[$setupNID]['setup_total_amount']);
  $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), $feeSetup->nid);

  $_SESSION[$varName]['setup_total_amount'] = $feeOption[$setupNID]['setup_total_amount'];
  //$_SESSION[$varName]['first_instalment'] = $feeOption[$setupNID]['first_instalment'];
  //$_SESSION[$varName]['second_instalment'] = $feeOption[$setupNID]['second_instalment'];

  $_SESSION[$varName]['fee_structure_nid'] = $feeOption[$setupNID]['fee_structure_nid'];
  $_SESSION[$varName]['fee_program_nid'] = $feeOption[$setupNID]['program_nid '];

  //display the fee setup
  $html = "
  <div id='assigned_courses'><br />
  <script type='text/javascript' src='../misc/drupal.js'></script>
  <script type='text/javascript' src='../misc/collapse.js'></script>
  <b>Matching School Fee Setup - ". variable_get('eduerp_current_session', '') ."</b><br />";

  $html .="
  <table border=1 >
    <tr>
      <td width='200px;'>Fee Structure Name:</td>
      <td><b>". $feeOption[$setupNID]['fee_structure_name'] ."</b></td>
    </tr>
    <tr>
      <td width='200px;'>Fee Structure Type:</td>
      <td><b>". $feeOption[$setupNID]['fee_structure_class_name'] ."</b></td>
    </tr>";

    if(isset($feeOption[$setupNID]['program_nid']) && $feeOption[$setupNID]['program_nid'] != 0){
      $rs = get_programmes($feeOption[$setupNID]['programme_nid'], true);
      //$row = db_fetch_object($rs);
      $html .="
      <tr>
        <td >Program Name:</td>
        <td><b>". $rs[$feeOption[$setupNID]['program_nid']] ."</b></td>
      </tr>";

    }

    $html .="
    <tr>
      <td >Fee Nationality Type:</td>
      <td><b>". $feeOption[$setupNID]['nationality_name'] ."</b></td>
    </tr>
    <tr>
      <td >Fee Level Type:</td>
      <td><b>". $feeOption[$setupNID]['level_name'] ."</b></td>
    </tr>
    <tr>
      <td >Fee Amount:</td>
      <td><b>". number_format($feeOption[$setupNID]['setup_total_amount'], 2) ."</b></td>
    </tr>
  </table>
  </div>";

  //show the details here
  $html .="
  <div id='assigned_courses'><br />
  <table border=0>";

         //show the setup details here
         $html .="
         <tr>
           <td colspan=9>
             <fieldset class='collapsible collapsed'><legend>". $feeOption[$setupNID]['fee_structure_class_name'] ." - ". $feeOption[$setupNID]['level_name'] ." - ". $feeOption[$setupNID]['nationality_name'] ." - View details</legend>";
             //get the fee items
              $details = get_fee_setup_item_details($setupNID);
              if(db_affected_rows($details) > 0){
                $html .="
                 <table>
                   <tr>
                     <th width='15px'>#</th>
                     <th width='250px'>Fee Item</th>
                     <th>Full Amount</th>
                     <th>First Instalment Amount</th>
                     <th>Second Instalment Amount</th>
                   </tr>";$l=1;
                   while($r = db_fetch_object($details)){
                     $html .="
                     <tr>
                       <td>". $l++ ."</td>
                       <td>". $r->item_name ."</td>
                       <td>". number_format($r->full_amount, 2) ."</td>
                       <td>". number_format($r->instalment1_amount, 2) ."</td>
                       <td>". number_format($r->instalment2_amount, 2) ."</td>
                     </tr>
                     ";

                   }

                 $html .="
               </table>";
               }
               else{
                 $html .= Error_Types(106);
               }
             $html .="
             </fieldset>
           </td>
         </tr>";
     // }

   $html .="
   </table>
   </div>";
  return $html;

}


function is_school_fee_info_existing($studentUID){

  $rs = db_query("SELECT nid FROM {content_type_school_fee_payments} WHERE field_student_uid_fk_uid=%d AND field_fee_session_name_value='%s' ", $studentUID, variable_get('eduerp_current_session', ''));
  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function is_school_fee_payment_type_info_existing($studentUID, $paymentType){

  $rs = db_query("SELECT ctsfp.nid FROM {content_type_school_fee_payments} ctsfp
  	  INNER JOIN {content_type_school_fee_payment_summary} ctsfps ON ctsfp.nid=ctsfps.field_fee_payment_fk1_nid
  	  WHERE field_student_uid_fk_uid=%d AND field_fee_payment_type_fk_nid=%d AND field_fee_session_name_value='%s' ", $studentUID, $paymentType, variable_get('eduerp_current_session', ''));
  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function is_school_fee_details_info_existing($paymentBriefNID){

  $rs = db_query("SELECT nid FROM {content_type_school_fee_payment_details} WHERE field_fee_payment_fk_nid=%d ", $paymentBriefNID);
  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function is_school_fee_summary_info_existing($paymentBriefNID, $summaryPaymentType){

  $rs = db_query("SELECT nid FROM {content_type_school_fee_payment_summary} WHERE field_fee_payment_fk1_nid=%d AND field_fee_payment_type_fk_nid=%d ", $paymentBriefNID, $summaryPaymentType);
  if(db_affected_rows($rs) > 0) return true;

  return false;
}


function post_fee_payment($varName){

  //insert payment info
  if(! is_school_fee_info_existing($_SESSION[$varName]['studentUID'])){
    $_SESSION[$varName]['paymentBriefNID'] = insert_payment_brief_info($varName);


  }
  else{
    //get the payment NID

  }

  if(! is_school_fee_details_info_existing($_SESSION[$varName]['paymentBriefNID'])){//make sure no previous details exists
    //insert payment details info
    insert_payment_details_info($varName);
  }


  //make sure no such summary already exists
  if(! is_school_fee_summary_info_existing($_SESSION[$varName]['paymentBriefNID'], $_SESSION[$varName]['summaryPaymentType'])){
    //insert payment summary info
    insert_payment_summary_info($varName);
  }

  return 1;

}


function insert_payment_brief_info($varName){

  $node = new stdClass();
  $node->type                               	= 'school_fee_payments';
  $node->uid                                	= 1;  // Admin
  $node->status                             	= 1;  // Published
  $node->promote                            	= 0;
  $node->sticky                             	= 0;
  $node->comment                           	= 0;
  $node->title                              	= "Payment brief - ". $_SESSION[$varName]['studentUID'] .' - '. variable_get('eduerp_current_session', '');
  $node->field_fee_payment_sponsor_fk[0]['nid']	= $_SESSION[$varName]['payment_sponsor'];
  $node->field_fee_payment_status_fk[0]['nid']  = $_SESSION[$varName]['payment_brief_status'];
  $node->field_student_uid_fk[0]['uid']        	= $_SESSION[$varName]['studentUID'];
  $node->field_fee_session_name[0]['value']     = variable_get('eduerp_current_session', '');
  $node->field_fee_total_amount[0]['value'] 	= $_SESSION[$varName]['setup_total_amount'];

  $node->field_fee_structure_type_fk[0]['nid'] 		= $_SESSION[$varName]['fee_structure_nid'];
  $node->field_fee_student_level_type_fk[0]['nid'] 	= $_SESSION[$varName]['levelType'];
  $node->field_fee_nationality_type_fk[0]['nid'] 	= $_SESSION[$varName]['nationalityType'];
  $node->field_fee_program_fk[0]['nid'] 		= $_SESSION[$varName]['fee_program_nid'];


  node_save($node);

  return $node->nid;
}


function insert_payment_details_info($varName){

  //get all the fee items associated with the fee setup
  $feeItems = get_fee_setup_item_details($_SESSION[$varName]['studentFeeSetupNID']);
  while($r = db_fetch_object($feeItems)){

    $node = new stdClass();
    $node->type                               		= 'school_fee_payment_details';
    $node->uid                                		= 1;  // Admin
    $node->status                             		= 1;  // Published
    $node->promote                            		= 0;
    $node->sticky                             		= 0;
    $node->comment                           		= 0;
    $node->title                              		= "Payment details - ". $_SESSION[$varName]['paymentBriefNID'];
    $node->field_fee_payment_fk[0]['nid']		= $_SESSION[$varName]['paymentBriefNID'];
    $node->field_fee_item_name[0]['value']  		= $r->item_name;
    $node->field_fee_payment_item_amount[0]['value']    = $r->amount;


    node_save($node);

  }
}


function insert_payment_summary_info($varName){

  $node = new stdClass();
  $node->type                               		= 'school_fee_payment_summary';
  $node->uid                                		= 1;  // Admin
  $node->status                             		= 1;  // Published
  $node->promote                            		= 0;
  $node->sticky                             		= 0;
  $node->comment                           		= 0;
  $node->title                              		= "Payment summary - ". $_SESSION[$varName]['paymentBriefNID'];
  $node->field_fee_payment_status_fk1[0]['nid']		= $_SESSION[$varName]['summaryPaymentStatus'];
  $node->field_fee_payment_type_fk[0]['nid']  		= $_SESSION[$varName]['summaryPaymentType'];
  $node->field_fee_payment_fk1[0]['nid']        	= $_SESSION[$varName]['paymentBriefNID'];
  $node->field_fee_payment_date[0]['value']     	=  date("Y-m-d H:i:s");
  $node->field_fee_summary_amount_paid[0]['value'] 	= $_SESSION[$varName]['summaryPaymentAmount'];
  $node->field_fee_order_nid[0]['nid']        		= $_SESSION[$varName]['orderNID'];


  node_save($node);

  //return $node->nid;
}


function staff_display_scholarship_authorisations($sessionName) {
  $html = "
  <div id='assigned_courses'>
  <b>Available List of Scholarship Authorisations - ". $sessionName ."</b><br /><br />";

  $scholarshipAuthorisations = get_scholarship_authorisations($sessionName);
  if(! is_array($scholarshipAuthorisations) || ! sizeof($scholarshipAuthorisations))
    return $html .= Error_Types(106) .'</div>';
  //Please click on a Fee Item name to Edit it.<br />
  $html .="

  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Mat. Num.</b></th>
      <th><b>Full Name</b></th>
      <th><b>Program Name</b></th>

      <th><b>Remarks</b></th>
      <th><b>Date</b></th>

    </tr>";$i = 1;

    foreach ($scholarshipAuthorisations as $k => $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $html .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td width='30px'>". $i++ ."</td>";
           $student_profile = new UserProfile($v['student_uid']);
           $programmeName = get_programmes($student_profile->profile_first_choice, true);

           //<td><a  href='" . url("staff/createmodifyfeeitem/$k") ."'>". $v['fee_item'] ."</a></td>
           //<td>". $v['session_name'] ."</a></td>  <th><b>Session Name</b></th>
           $html .="
           <td>". $x = (! empty($student_profile->profile_matno) ? $student_profile->profile_matno : 'N/A') ."</td>
           <td>". $student_profile->profile_last_name .', '. $student_profile->profile_first_name ."</a></td>
           <td>". $programmeName[$student_profile->profile_first_choice] ."</a></td>

           <td>". check_markup($v['remarks'], FILTER_FORMAT_DEFAULT, FALSE) ."</a></td>
           <td>". $v['date'] ."</a></td>

         </tr>";
      }

  $html .= "
  </table>
  </div>";
  return $html;

}


function get_scholarship_authorisations($sessionName) {
  $r = db_query("SELECT nid, field_sas_student_uid AS student_uid, field_sas_session_name_value AS session_name, field_sas_remarks_value AS remarks, DATE_FORMAT(field_sas_date_value, '%%D %%b %%Y') AS date FROM {content_type_school_fee_approved_scholarships} WHERE field_sas_session_name_value='%s' ORDER BY field_sas_session_name_value ", $sessionName);
  $rs = array();
  while ($f = db_fetch_object($r)){
    $rs[$f->nid]['student_uid'] = $f->student_uid;
    $rs[$f->nid]['session_name'] = $f->session_name;
    $rs[$f->nid]['remarks'] = $f->remarks;
    $rs[$f->nid]['date'] = $f->date;

  }
  return $rs;
}


function get_instalment_authorisations($sessionName) {
  $r = db_query("SELECT nid, field_sai_student_uid AS student_uid, field_sai_session_name_value AS session_name, field_sai_remarks_value AS remarks, DATE_FORMAT(field_sai_date_value, '%%D %%b %%Y') AS date FROM {content_type_school_fee_approved_instalments} WHERE field_sai_session_name_value='%s' ORDER BY field_sai_session_name_value ", $sessionName);
  $rs = array();
  while ($f = db_fetch_object($r)){
    $rs[$f->nid]['student_uid'] = $f->student_uid;
    $rs[$f->nid]['session_name'] = $f->session_name;
    $rs[$f->nid]['remarks'] = $f->remarks;
    $rs[$f->nid]['date'] = $f->date;

  }
  return $rs;
}


function get_authorise_instalment_student_finder_form(){

  $form['#title'] = 'Student Finder';
  $form['mat_number'] = array(
      '#title' => 'Matriculation / JAMB Number',
      '#type' => 'textfield',
      '#size' => 40,
      '#required' => TRUE
    );

  $form['submit'] = array(
    '#value' => 'Search Now',
    '#type' => 'submit'
  );

  return $form;

}



function get_authorise_instalment_student_finder_form_validate($form, &$state){

}


function get_authorise_instalment_student_finder_form_submit($form, &$state){
  global $EDUERPstudentInitiated;
  $values = $state['values'];

  $returnURL = 'staff/authoriseinstalment';
  ini_student_fee_profile($values['mat_number'], 'eduerp_authorise_instalment', $returnURL);

}


function staff_display_instalment_authorisations($sessionName) {
  $html = "
  <div id='assigned_courses'>
  <b>Available List of Instalment Authorisations - ". $sessionName ."</b><br /><br />";

  $authorisations = get_instalment_authorisations($sessionName);
  if(! is_array($authorisations) || ! sizeof($authorisations))
    return $html .= Error_Types(106) .'</div>';
  //Please click on a Fee Item name to Edit it.<br />
  $html .="

  <table border=1>
    <tr>
      <th><b>#</b></th>
      <th><b>Mat. Num.</b></th>
      <th><b>Full Name</b></th>
      <th><b>Program Name</b></th>

      <th><b>Remarks</b></th>
      <th><b>Date</b></th>

    </tr>";$i = 1;

    foreach ($authorisations as $k => $v){
      if ($i%2) $rcolor = "#E5E5E5"; else $rcolor = "#FFFFFF";
        $html .= "
         <tr bgcolor = \"$rcolor\" onMouseOver = \"this.bgColor = '#FDD381';\" onMouseOut = \"this.bgColor = '$rcolor';\">
           <td width='30px'>". $i++ ."</td>";
           $student_profile = new UserProfile($v['student_uid']);
           $programmeName = get_programmes($student_profile->profile_first_choice, true);

           //<td><a  href='" . url("staff/createmodifyfeeitem/$k") ."'>". $v['fee_item'] ."</a></td>
           //<td>". $v['session_name'] ."</a></td>  <th><b>Session Name</b></th>
           $html .="
           <td>". $x = (! empty($student_profile->profile_matno) ? $student_profile->profile_matno : 'N/A') ."</td>
           <td>". $student_profile->profile_last_name .', '. $student_profile->profile_first_name ."</a></td>
           <td>". $programmeName[$student_profile->profile_first_choice] ."</a></td>

           <td>". check_markup($v['remarks'], FILTER_FORMAT_DEFAULT, FALSE) ."</a></td>
           <td>". $v['date'] ."</a></td>

         </tr>";
      }

  $html .= "
  </table>
  </div>";
  return $html;

}


function staff_show_authorise_instalment_form(){


  $form['#title'] = 'School Fees Instalment Payment';
  /*
  $form['previous'] = array(
    '#value' => 'Back',
    '#type' => 'submit'
  );
  */
   $form['remarks'] = array(
    '#type' => 'textarea',
    '#title' => 'Remarks - Brief details about the Instalment Payment',
    '#size' => 255,
    //'#required' => true
  );
   $form['lbl01'] = array(
    '#type' => 'item',
    '#value' => "<font color=#FF0000><b>By clicking 'Authorise Instalment Payment!' you acknowledge that the student whose details appear above has been authorised to pay his/her School Fees in Instalments for the Current Session only.</b></font>",

  );
  $form['cmdCancel'] = array(
    '#value' => 'Cancel',
    '#type' => 'submit'
  );
  $form['submit'] = array(
    '#value' => 'Authorise Instalment Payment!',
    '#type' => 'submit'
  );

  return $form;
}



function staff_show_authorise_instalment_form_validate($form, &$state){
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'authorise instalment payment!':

      if(empty($values['remarks'])){
    	form_set_error('remarks', Error_Types(161));
      }

      if(is_scholarship_authorisation_existing($_SESSION['eduerp_authorise_instalment']['studentUID'], variable_get('eduerp_current_session', ''))){
      	form_set_error('', Error_Types(162));
        return;
      }
      if(is_instalment_authorisation_existing($_SESSION['eduerp_authorise_instalment']['studentUID'], variable_get('eduerp_current_session', ''))){
      	form_set_error('', Error_Types(163));
        return;
      }


    break;
  }

}



function staff_show_authorise_instalment_form_submit($form, &$state){
  global $user;
  $values = $state['values'];

  switch(trim(strtolower(strtoupper($values['op'])))){
    case 'authorise instalment payment!':

      $node = new stdClass();
      $node->type                             	= 'school_fee_approved_instalments';
      $node->uid                              	= 1;  // Admin
      $node->status                           	= 1;  // Published
      $node->promote                          	= 0;
      $node->sticky                           	= 0;
      $node->comment                          	= 0;
      $node->title                            	= 'Authorise Instalment - '. $_SESSION['eduerp_authorise_instalment']['studentUID'] .' - '. variable_get('eduerp_current_session', '');
      $node->field_sai_student[0]['uid']       	= $_SESSION['eduerp_authorise_instalment']['studentUID'];
      $node->field_sai_session_name[0]['value'] = variable_get('eduerp_current_session', '');
      $node->field_sai_remarks[0]['value']      = $values['remarks'];
      $node->field_sai_staff[0]['uid']       	= $user->uid;
      $node->field_sai_date[0]['value']     	= date("Y-m-d H:i:s");

      node_save($node);
      drupal_set_message('Instalment Authorisation was successful!');
      unset($_SESSION['eduerp_authorise_instalment']); $_SESSION['eduerp_authorise_instalment'] = null;

    break;

    case 'cancel':
      unset($_SESSION['eduerp_authorise_instalment']); $_SESSION['eduerp_authorise_instalment'] = null;

    break;

  }
}


//school fee module ends here

function delete_node($nodeID){
   //node_delete() copied from student.module
  $node = node_load($nodeID);

   db_query('DELETE FROM {node} WHERE nid = %d', $node->nid);
   db_query('DELETE FROM {node_revisions} WHERE nid = %d', $node->nid);

   // Call the node-specific callback (if any):
   node_invoke($node, 'delete');
   node_invoke_nodeapi($node, 'delete');

   // Clear the page and block caches.
   cache_clear_all();

   // Remove this node from the search index if needed.
   if (function_exists('search_wipe')) {
     search_wipe($node->nid, 'node');
   }

}


function get_country_info($countryID=0){

  $sql = "SELECT country_id, country_name FROM {eduerp_countries} ";
  if($countryID != 0) $sql .= " WHERE country_id=%d ";

  $rs = db_query($sql, $countryID);

  if(db_affected_rows($rs) > 0) {
     while ($row = db_fetch_object($rs))
       $countries[$row->country_id] = $row->country_name;
  }
  else
    $countries[] = strip_tags(Error_Types(106));

    return $countries;
}


function fees_ini_student_profile($studentUID){

      $student_profile = new UserProfile($studentUID);

      if(! is_object($student_profile)) return 0;

      $studentFeeProfile['studentUID'] = $student_profile->uid;
      $studentFeeProfile['full_name'] = $student_profile->profile_last_name .', '. $student_profile->profile_first_name;
      $studentFeeProfile['first_choice_nid'] = $student_profile->profile_first_choice;
      $studentFeeProfile['level_name'] = $student_profile->profile_level_name;
      $studentFeeProfile['mat_num'] = ! empty($student_profile->profile_matno) ? $student_profile->profile_matno : 'N/A';
      $studentFeeProfile['jamb_num'] = $student_profile->profile_jambno;
      $studentFeeProfile['gender'] = strtolower($student_profile->profile_gender);
      $studentFeeProfile['mode_of_entry'] = strtolower($student_profile->profile_mode_of_entry);
      //$_SESSION['eduerp_authorise_scholarship']['health_status'] = strtolower($student_profile->profile_health_status);
      $studentFeeProfile['programNID'] = $student_profile->profile_first_choice;

      $studentFeeProfile['country_name'] = ! empty($student_profile->profile_country_name) ? $student_profile->profile_country_name : 'N/A';


      $programmeName = get_programmes($student_profile->profile_first_choice, true);
      $studentFeeProfile['programme_name'] = $programmeName[$student_profile->profile_first_choice];



      if(! isset($studentFeeProfile['jamb_num']) || $studentFeeProfile['jamb_num'] == ""){
        //echo "no JAMB Number";
        return 0;
      }

      //get level types
      $rs = db_query('SELECT nid, field_level_type_value level_type_name FROM {content_type_school_fee_level_types} ');
      if(db_affected_rows($rs) <= 0){

      	return 0;
      }

      //get the level of the student
      $studentLevel = student_next_level($student_profile->uid, variable_get('eduerp_current_session', ''));

      if(trim($studentLevel) == '100' || trim($studentLevel) == '1'){
        $levelStatus = "freshman";
      }
      elseif((trim($studentLevel) == '200' || trim($studentLevel) == '2') && strtoupper(strtolower($student_profile->profile_mode_of_entry)) == "DE"){
      	$levelStatus = "freshman";

      }
      else{
        $levelStatus = "returning student";
      }

      while($r = db_fetch_object($rs)){
        if($levelStatus == "freshman" && trim(strtolower(strtoupper($r->level_type_name))) == "freshman"){
      	  $studentFeeProfile['levelType'] = $r->nid;
      	  break;
        }

        if($levelStatus == "returning student" && trim(strtolower(strtoupper($r->level_type_name))) == "returning student"){
      	  $studentFeeProfile['levelType'] = $r->nid;
      	  break;
        }
      }

      if(! $studentFeeProfile['levelType']){

      	return 0;
      }

      //get nationality types
      $rs = db_query('SELECT nid, field_nationality_type_value nationality_type_name FROM {content_type_school_fee_nationality_types} ');
      if(db_affected_rows($rs) <= 0){

      	return 0;
      }

      //get the local country name from setting
      $rs1 = db_query("SELECT country_id, country_name FROM {eduerp_countries} WHERE country_id= (SELECT field_fee_settings_value_value FROM {content_type_school_fee_settings} WHERE field_fee_settings_name_value = 'Local Country Name')  ");
      if(db_affected_rows($rs1) <= 0){

      	return 0;
      }


      $localCountry = db_fetch_object($rs1);

      while($r = db_fetch_object($rs)){
      	if(trim($student_profile->profile_country_name) == trim($localCountry->country_name)){
      	  if(trim(strtolower(strtoupper($r->nationality_type_name))) == 'local'){
      	    $studentFeeProfile['nationalityType'] = $r->nid;
      	    break;
      	  }

      	}
      	if(trim($student_profile->profile_country_name) != trim($localCountry->country_name)){
      	  if(trim(strtolower(strtoupper($r->nationality_type_name))) == 'international'){
      	    $studentFeeProfile['nationalityType'] = $r->nid;
      	    break;
      	  }

      	}

      }

      if(! $studentFeeProfile['nationalityType']){

      	return 0;
      }

      //print_r($studentFeeProfile);
  return $studentFeeProfile;

}


function fees_ini_student_fee_option($studentUID, $programNID, $levelType, $nationalityType, $checkFeesOnly=false){
  //return;
  $feeOption = array();
  $feeStudentOption = array();
  /*
  //make sure that fee setup is correct
  $val = is_fee_setup_correct();
  if($val != 1){
    //form_set_error('', Error_Types($val));
    return 0;
  }
  */

  //test if his/her program has program specific setup
  $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_setup_program_nid_value=%d AND field_fee_setup_session_value='%s' ", $programNID, variable_get('eduerp_current_session', ''));
  if(db_affected_rows($rs) <=0){
    //now test if general setup exists
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE (field_fee_setup_program_nid_value IS NULL OR field_fee_setup_program_nid_value=0) AND field_fee_setup_session_value='%s' ", variable_get('eduerp_current_session', ''));
    if(db_affected_rows($rs) <=0){
      //return Error_Types(159);

      return $feeStudentOption;
    }
    //get fee setup details
    $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), 0, false);

    $id = 0;

  }
  else{
    //get fee setup details
    $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), $programNID, false);
    $id = $programNID;
  }


  if(! isset($feeOption) || ! is_array($feeOption) || ! sizeof($feeOption)){
    //return Error_Types(159);
    return $feeStudentOption;
  }

  //fine. Now get his/her own particular fee structure
  if($id == 0)
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_nationality_type_nid=%d AND field_fee_student_level_type_nid=%d AND (field_fee_setup_program_nid_value=0 OR field_fee_setup_program_nid_value IS NULL)  AND field_fee_setup_session_value='%s'  ", $nationalityType, $levelType, variable_get('eduerp_current_session', ''));
  else
    $rs = db_query("SELECT nid FROM {content_type_school_fee_item_setup} WHERE field_fee_nationality_type_nid=%d AND field_fee_student_level_type_nid=%d AND field_fee_setup_program_nid_value=%d AND field_fee_setup_session_value='%s' ", $nationalityType, $levelType, $id, variable_get('eduerp_current_session', ''));

  if(db_affected_rows($rs) <=0) return array();

  $feeSetup = db_fetch_object($rs);
  $setupNID = $feeSetup->nid;



  //drupal_set_message('setup total is '.$feeOption[$setupNID]['setup_total_amount']);
  $feeOption = get_school_fee_setup(variable_get('eduerp_current_session', ''), $feeSetup->nid);

  if(! $feeOption || ! is_array($feeOption) || ! sizeof($feeOption)) return $feeStudentOption;

  //echo "<pre>";
  //print_r($feeOption);
  //echo "</pre>";



  $feeStudentOption['studentFeeSetupNID'] = $setupNID;
  $feeStudentOption['nationality_name'] = $feeOption[$setupNID]['nationality_name'];
  $feeStudentOption['fee_structure_name'] = $feeOption[$setupNID]['fee_structure_name'];
  $feeStudentOption['level_name'] = $feeOption[$setupNID]['level_name'];


  //test if student is on scholarship
  $feeStudentOption['is_student_on_scholarship'] = is_scholarship_authorisation_existing($studentUID, variable_get('eduerp_current_session', '')) == true ? '1' : '0';

  //test if student is authorised to pay in instalments
  $feeStudentOption['instalment_payment_authorised'] = is_instalment_authorisation_existing($studentUID, variable_get('eduerp_current_session', '')) == true ? '1' : '0';

  //get session name
  $feeStudentOption['session_name'] = variable_get('eduerp_current_session', '');


  $details = get_fee_setup_item_details($setupNID);
  if(db_affected_rows($details) <=0) return array();


  $i=0;
  while($r = db_fetch_object($details)){

    if($feeStudentOption['instalment_payment_authorised'] == '1'){
      //for instalment payments
      $feeStudentOption['fee_item_details'][$i]['item_description'] = $feeStudentOption['fee_structure_name'] ." - ". $feeStudentOption['level_name'] ." - ". $feeStudentOption['nationality_name'] ." (". $r->item_name . " - Instalment1)";
      $feeStudentOption['fee_item_details'][$i]['amount'] = $r->instalment1_amount;
      $feeStudentOption['fee_item_details'][$i]['product_nid'] = $r->product_nid;
      $feeStudentOption['fee_item_details'][$i]['is_scholarship_applicable'] = $r->is_scholarship_applicable;

      $attributeOptionInfo = get_uc_attribute_option_info($feeStudentOption['fee_item_details'][$i]['item_description']);

      //now make sure that each fee product returned has attribute and option (no more asumptions!)
      if(! is_array($attributeOptionInfo) || ! sizeof($attributeOptionInfo)) return array();

      //make sure attribute and option is attached to the product
      $aInfo['productNID'] = $r->product_nid;;
      $aInfo['aid'] = $attributeOptionInfo['aid'];
      $aInfo['oid'] = $attributeOptionInfo['oid'];
      $aInfo['label'] = "Fee Structure";
      if(! is_uc_attribute_attached_to_product($aInfo) || ! is_uc_option_attached_to_product($aInfo)) return array();


      $feeStudentOption['fee_item_details'][$i]['option_id'] = $attributeOptionInfo['oid'];
      $feeStudentOption['fee_item_details'][$i]['attribute_id'] = $attributeOptionInfo['aid'];

      //check if second instalment collection is activated
      if(is_second_instalment_activated()){
        //second instalment collection is activated
        $i++;
        $feeStudentOption['fee_item_details'][$i]['item_description'] = $feeStudentOption['fee_structure_name'] ." - ". $feeStudentOption['level_name'] ." - ". $feeStudentOption['nationality_name'] ." (". $r->item_name . " - Instalment2)";
        $feeStudentOption['fee_item_details'][$i]['amount'] = $r->instalment2_amount;
        $feeStudentOption['fee_item_details'][$i]['product_nid'] = $r->product_nid;
        $feeStudentOption['fee_item_details'][$i]['is_scholarship_applicable'] = $r->is_scholarship_applicable;

        $attributeOptionInfo = get_uc_attribute_option_info($feeStudentOption['fee_item_details'][$i]['item_description']);

        //now make sure that each fee product returned has attribute and option (no more asumptions!)
        if(! is_array($attributeOptionInfo) || ! sizeof($attributeOptionInfo)) return array();

        //make sure attribute and option is attached to the product
        $aInfo['productNID'] = $r->product_nid;;
      	$aInfo['aid'] = $attributeOptionInfo['aid'];
      	$aInfo['oid'] = $attributeOptionInfo['oid'];
      	$aInfo['label'] = "Fee Structure";
      	if(! is_uc_attribute_attached_to_product($aInfo) || ! is_uc_option_attached_to_product($aInfo)) return array();


        $feeStudentOption['fee_item_details'][$i]['option_id'] = $attributeOptionInfo['oid'];
        $feeStudentOption['fee_item_details'][$i]['attribute_id'] = $attributeOptionInfo['aid'];

      }

    }
    else{
      //for one time payments
      $feeStudentOption['fee_item_details'][$i]['item_description'] = $feeStudentOption['fee_structure_name'] ." - ". $feeStudentOption['level_name'] ." - ". $feeStudentOption['nationality_name'] ." (". $r->item_name . " - Full Amount)";
      $feeStudentOption['fee_item_details'][$i]['amount'] = $r->full_amount;
      $feeStudentOption['fee_item_details'][$i]['product_nid'] = $r->product_nid;
      $feeStudentOption['fee_item_details'][$i]['is_scholarship_applicable'] = $r->is_scholarship_applicable;

      $attributeOptionInfo = get_uc_attribute_option_info($feeStudentOption['fee_item_details'][$i]['item_description']);

      //now make sure that each fee product returned has attribute and option (no more asumptions!)
      if(! is_array($attributeOptionInfo) || ! sizeof($attributeOptionInfo)) return array();

      //make sure attribute and option is attached to the product
      $aInfo['productNID'] = $r->product_nid;;
      $aInfo['aid'] = $attributeOptionInfo['aid'];
      $aInfo['oid'] = $attributeOptionInfo['oid'];
      $aInfo['label'] = "Fee Structure";
      if(! is_uc_attribute_attached_to_product($aInfo) || ! is_uc_option_attached_to_product($aInfo)) return array();

      $feeStudentOption['fee_item_details'][$i]['option_id'] = $attributeOptionInfo['oid'];
      $feeStudentOption['fee_item_details'][$i]['attribute_id'] = $attributeOptionInfo['aid'];


      //;
    }

    $i++;
  }


  //now if this is to check fees only then do not check for late reg
  if(! $checkFeesOnly){
    //now check for late registration info

    $ucLateRegInfo = get_uc_late_registration_info("Late Registration Charges");

    $lateRegInfo = get_late_registration_info();

    //echo "<pre>";
    //print_r($lateRegInfo);
    //echo "</pre>";

    $feeStudentOption['late_reg_info']['last_registration_date'] = $lateRegInfo['last_date'];
    if( Date('Y-m-d') > $lateRegInfo['last_date']){

      $feeStudentOption['late_reg_info']['amount'] = $lateRegInfo['late_reg_amount'];
      $feeStudentOption['late_reg_info']['product_nid'] = $ucLateRegInfo['product_nid'];
      $feeStudentOption['late_reg_info']['product_description'] = $ucLateRegInfo['name'];
    }
  }

  //now if this is to check fees only then do not check for hostel
  if(! $checkFeesOnly){
    //now check for hostel
    if(is_reservation_existing($studentUID)){
      $ri = get_reservation_info($studentUID);
      $reservationInfo = db_fetch_object($ri);

      $hostelDescription = "Room: ". $reservationInfo->room_name ."<br />";
      $hostelDescription .= "Block: ". $reservationInfo->block_name ."<br />";
      $hostelDescription .= "Hostel: ". $reservationInfo->hostel_name;

      $feeStudentOption['hostel_info']['product_nid'] = $reservationInfo->product_nid;
      $feeStudentOption['hostel_info']['hostel_description'] = $hostelDescription;
      $feeStudentOption['hostel_info']['expiry_date'] = $reservationInfo->normal_expiry_date;
      $feeStudentOption['hostel_info']['amount'] = $reservationInfo->hostel_price;

    }
  }
  return $feeStudentOption;
}


function get_fee_items($studentUID){

  //ini student profile
  $studentFeeProfile = fees_ini_student_profile($studentUID);

  //echo "<pre>";
  //print_r($studentFeeProfile);
  //echo "</pre>";
  if(! is_array($studentFeeProfile) || ! sizeof($studentFeeProfile)) return array();

  //echo "1 done! ";
  $feeItem = fees_ini_student_fee_option($studentUID, $studentFeeProfile['programNID'], $studentFeeProfile['levelType'], $studentFeeProfile['nationalityType']);

  //echo "<pre>";
  //print_r($feeItem);
  //echo "</pre>";

  return $feeItem;
}


function is_fee_setup_existing_for_student($studentUID){

  $studentFeeProfile = fees_ini_student_profile($studentUID);
  if(! is_array($studentFeeProfile) || ! sizeof($studentFeeProfile)) return false;

  $studentFeeItem = fees_ini_student_fee_option($studentUID, $studentFeeProfile['programNID'], $studentFeeProfile['levelType'], $studentFeeProfile['nationalityType'], True);

  if(! is_array($studentFeeItem) || ! sizeof($studentFeeItem)) return false;

  return true;
}


function staff_school_fees_test_attr(){
 global $user;
  ob_start();
  $html = drupal_get_form('show_attr_test_form');

  echo $html;
  return ob_get_clean();

}

function show_attr_test_form(){
  $form['#title'] = 'Test Data';

  $form['submit'] = array(
    '#value' => 'Add Test Data to Cart',
    '#type' => 'submit'
  );

  return $form;

}

function show_attr_test_form_submit($form, &$state){
  /*
  //for tests on my local copy
  $nid = 5286;
  $qty = 1;
  $data = array(
  	  'attributes' => array('4'=>'9')
  	  );
  uc_cart_add_item($nid, $qty, $data);

  */
/*
  //for test on staging server
  $nid = 5268; //product NID
  $qty = 1;
  $data = array(
  	  'attributes' => array('1'=>'49') //where 1 = attribute ID and 49 = option ID
  	  );
  uc_cart_add_item($nid, $qty, $data);
  */
}
?>
