<?php
include(drupal_get_path('module', 'veritas') . '/veritas_global.inc');

function staff_menu() {
  $items['staff/registration']=array(
    'title'=>'Staff Registration',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_registration_form'),
    'access arguments' => array('staff register'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/list']=array(
    'title'=>'Staff List',
    'page callback' => 'search_staff_list',
    'access arguments' => array('staff list'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/department']=array(
    'title'=>'Staff List',
    'page callback' => 'staff_department_list',
    'access arguments' => array('staff department list'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/viewlecturer']=array(
    'title'=>'Staff List',
    'page callback' => 'staff_course_list',
    'access arguments' => array('staff view lecturer'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/registrablecourse']=array(
    'title'=>'Course Program Assign',
    'page callback' => 'staff_course_assign',
    //'page arguments'=>array('staff_cousrse_assign_form'),
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/profile']=array(
    'title'=>'Staff Profile',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_profile_form'),
     'access arguments' => array('staff profile'),
     'type' => MENU_CALLBACK,
  );

  $items['staff/view']=array(
    'title'=>'Staff Profile',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_view_form'),
    'access arguments' => array('staff view'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/assignrole']=array(
    'title'=>'Staff Profile',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_assign_role_form'),
    'access arguments' => array('staff assign role'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/registration/success']=array(
    'page callback' => 'registartion_success',
    'access arguments' => array('student register'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/clearance']=array(
    'title'=>'Clearance',
    'page callback' => '_staff_clearance',
    'access arguments' => array('staff clearance'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/begin_clearance']=array(
    'title'=>'Begin Clearance',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_begin_clearance_form'),
    'access arguments' => array('staff clearance'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/viewstudent']=array(
    'title' => 'View Student',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('view_student_form'),
    'access arguments' => array('student data'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/viewstaff']=array(
    'title' => 'View Staff',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('view_staff_form'),
    'access arguments' => array('staff data'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/staffsearch']=array(
    'title' => 'Staff Search',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('search_staff_form'),
    'access arguments' => array('staff search'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/sa_viewstudent']=array(
    'title' => 'View Student',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sa_view_student_form'),
    'access arguments' => array('sa student'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/studentpayments']=array(
    'title' => 'View Student Payments',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('view_student_payments_form'),
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/download_studentpayments']=array(
    'title' => 'Download Student Payments',
    'page callback' => 'download_student_payments',
    'access arguments' => array('student payments'),
    'type' => MENU_CALLBACK,
  );
  $items['staff/cleared']=array(
    'page callback' => 'staff_cleared_student',
    'access arguments' => array('staff clearance'),
    'type' => MENU_CALLBACK,
  );
  /*Special Menu's For Registrar.*/
  $items['staff/not_cleared']=array(
    'page callback' => 'staff_notcleared_student',
    'access arguments' => array('staff clearance'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/create_ar']=array(
    'title'=>'Create Asistant Registrar',
    'page callback' => 'drupal_get_form',
    'page arguments'=>array('staff_create_ar_form'),
    'access arguments' => array('staff create ar'),
    'type' => MENU_CALLBACK,
  );

  $items['staff/ajax']=array(
    'title' => 'AJAX Routines',
    'page callback' => '_staff_ajax',
    'access arguments' => array('staff register course'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}


function _staff_ajax() {
  $task = arg(2);

  switch ($task):
    case 'course':
      $courses[""] = "";

      $program = $_POST['programme_id'];
      $level = $_POST['level'];

      // Retrieve available courses that have not been assigned
      $sql = "SELECT c.nid AS course_id, c.field_coursetitle_value AS course_title FROM {content_type_course} c
        WHERE c.nid NOT IN (SELECT pc.course_id FROM {program_course} pc WHERE pc.programme_id=%d AND pc.level='%s' AND pc.historical=0)
        ORDER BY c.field_code_value ASC";
      $rs = db_query($sql, $program, $level);
      while ($row = db_fetch_object($rs)) {
        $courses[$row->course_id] = $row->course_title;
      }

      $form['course_id'] = array(
        '#type' => 'select',
        '#title' => 'Course',
        '#options' => $courses,
        '#attributes' => array('style' => 'width:100px'),
        '#required' => TRUE);

      $output = _staff_ahah_render($form, 'staff-course-assign-form1');
      print drupal_to_js(array('data' => $output, 'status' => true));
      break;
    case 'delete':
      $allocation_id = arg(3);

      // Delete this allocation
      $sql = "UPDATE {program_course} SET historical=1 WHERE program_course_id=%d";
      $rs = db_query($sql, $allocation_id);

      if (db_affected_rows() > 0) echo "OK";
      else echo "FAIL";
      break;
  endswitch;
  exit();
}


function staff_course_assign_form1_validate($form, &$form_state) {
  return true;
}
/*
  This function is largely based on the poll module, its been simplified for reuse.
  $fields is the specific form elements you want to attach via ahah,
  $name is the form fields array key... e.g. the name for $form['title'] is "title"
*/
function _staff_ahah_render($fields, $name) {

  drupal_alter('form', $fields, array(), 'staff_course_form');

  $form_state = array('submitted' => FALSE,'#values'=>$_POST);
  $form_build_id = $_POST['form_build_id'];
  // Add the new element to the stored form. Without adding the element to the
  // form, Drupal is not aware of this new elements existence and will not
  // process it. We retreive the cached form, add the element, and resave.
  $form = form_get_cache($form_build_id, $form_state);
  if($form[$name]['#required'] == true){
    $fields['#required'] =  true;
  }
  $form[$name] = $fields;
  form_set_cache($form_build_id, $form, $form_state);
  $form += array(
    '#post' => $_POST,
    '#programmed' => FALSE,
  );
   $form_state = array('submitted' => FALSE);

  // Rebuild the form.
  $form = form_builder($_POST['form_id'], $form, $form_state);

  // Render the new output.
  $new_form = $form[$name];
  return drupal_render($new_form);
}


/*Function to get the staff permission.*/
function staff_perm() {
  return array('staff register','staff create ar','staff not cleared list','staff cleared list','staff clearance','staff assign role','staff view','staff profile','staff register course','staff view lecturer','staff department list','staff list', 'student data', 'sa student', 'staff data', 'staff search', 'student payments');
}

function staff_assign_role_form_submit($form,&$state) {

  $values = $form['#post'];
  if ($state['storage']['step'] == 1) {
    $query = 'Update veritas_staff set usrname = "'.$values['username'].'" , password = "'.$values['password'].'" ,  role_id ="'.$values['staff_role'].'" where staff_id='.$values['staff_id'];
    db_query($query);
  }

  if ($state['storage']['step'] == 2) {

    $query = 'Update veritas_staff set parent_id ="'.$values['staff_parent'].'" where staff_id='.$values['staff_id'];
    db_query($query);
    $query = 'delete from  veritas_staff_department  where staff_id='.arg(2);
    db_query($query);
    $query = "insert veritas_staff_department set staff_id=".arg(2)." , department_id='".$state['values']['staff_department']."' ";
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['storage']['step'] == 3) {

    $query = 'delete from  veritas_staff_college  where staff_id='.arg(2);
    db_query($query);
    $query = "insert veritas_staff_college set staff_id=".arg(2)." , assigned_college='".$state['values']['staff_college']."' ";
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['storage']['step'] == 4) {

    $query = 'Update veritas_staff set parent_id ="'.$values['staff_parent'].'" where staff_id='.$values['staff_id'];
    db_query($query);
    $query = 'delete from  veritas_staff_college  where staff_id='.arg(2);
    db_query($query);
    $query = "insert veritas_staff_college set staff_id=".arg(2)." , assigned_college='".$state['values']['staff_college']."' ";
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['storage']['step'] == 5) {

    $query = 'Update veritas_staff set parent_id ="'.$values['staff_parent'].'" where staff_id='.$values['staff_id'];
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['storage']['step'] == 6) {

    $query = 'Update veritas_staff set parent_id ="'.$values['staff_parent'].'" where staff_id='.$values['staff_id'];
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['storage']['step'] == 7) {

    $query = 'Update veritas_staff set parent_id ="'.$values['staff_parent'].'" where staff_id='.$values['staff_id'];
    db_query($query);
    drupal_set_message('Role Assigned');

    drupal_goto("superadmin/stafflist");
  }
  if ($state['clicked_button']['#id'] == 'edit-previous') {

    $state['storage']['step']--;
    $state['#rebuild']=true;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state[storage][values][$state[storage][step]] = $state[values];
    $state['#rebuild']=true;
    if ($state['storage']['step'] == 1) {

      switch($values['staff_role']) {

        case 7:
          $state['storage']['step']++;
          break;
        case 6:
          $state['storage']['step'] = 3;
          break;
        case 5:
        case 4:
          $state['storage']['step'] = 4;
          break;
        case 8 :
          $state['storage']['step'] = 5;
          break;
        case 10 :
          $state['storage']['step'] = 7;
          break ;
        case 1:
        case 2:
        case 3:
        case 11:
        case 13:
          drupal_set_message('Role Assigned');

          drupal_goto("staff/list");
          break;
        case 14 :
          $state['storage']['step'] = 6;
          break ;
      }
    }
    return;
  }
}


function staff_assign_role_form(&$obj) {

  if (!$obj[storage][step])
  $obj[storage][step]=1;
  $st=$obj[storage][step];

  if ($st==1) {
 //return _student_reg_form6($obj);
 //   return _student_reg_form5($obj);
    return assign_role_form1($obj);

  } elseif ($st==2) {

   return assign_role_form_hod($obj);

  } elseif ($st==3) {

    return assign_role_form_assign_college($obj);

  } elseif ($st==4) {

    return assign_role_form_assign_registrar($obj);

  } elseif ($st==5) {
    return assign_role_form_assign_hod($obj);
  } elseif ($st==6) {
    return assign_role_form_assign_vc($obj);
  } elseif ($st==7) {
    return assign_role_form_assign_bursar($obj);
  }
}


function search_staff_list() {
  ob_start();

  echo  drupal_get_form('staff_search_form');

  staff_search_list();

  return ob_get_clean();
}


function staff_course_list() {
  ob_start();
  $query = "SELECT courses.*, CONCAT(pv0.value, ', ', pv1.value, ' ', pv2.value) AS staff_name
    FROM
      (SELECT
        c.field_coursetitle_value AS course_title,
        ci.field_lecturer_uid AS uid
      FROM {content_type_course} c, {content_type_course_instance} ci
      WHERE
        c.field_department_nid_nid=%d AND c.nid=ci.field_course_id_nid
      ) AS courses
    INNER JOIN {profile_fields} pf0 ON pf0.name='profile_last_name'
    INNER JOIN {profile_fields} pf1 ON pf1.name='profile_first_name'
    INNER JOIN {profile_fields} pf2 ON pf2.name='profile_middle_name'
    LEFT  JOIN {profile_values} pv0 ON courses.uid=pv0.uid AND pv0.fid=pf0.fid
    LEFT  JOIN {profile_values} pv1 ON courses.uid=pv1.uid AND pv1.fid=pf1.fid
    LEFT  JOIN {profile_values} pv2 ON courses.uid=pv2.uid AND pv2.fid=pf2.fid";
  $result = db_query($query, arg(2));
?>
    <table border='1' align='center'  cellpadding="5" cellspacing="5">
    <tr bgcolor='#ACCFCC'><td><b>Lecturer</b></td><td><b>Course</b></td></tr>
<?php
  while ($f=db_fetch_object($result)) {
?>
      <tr>
      <td><a href="view/<?php echo $f->uid?>"><? echo $f->staff_name; ?></a></td>
      <td><? echo $f->course_title; ?></td>
      </tr>
<?php
  }
?>
    </table>
<?php
  return ob_get_clean();
}


function staff_department_list() {
  ob_start();
  $r = db_query("SELECT courses.*, er.uid AS hod_uid, CONCAT(pv0.value, ', ', pv1.value, ' ', pv2.value) AS hod_name
    FROM
      (SELECT
        d.nid AS department_id,
        d.field_department_name_value AS department_name
      FROM
        {veritas_staff} vs,
        {content_type_department} d0,
        {content_type_department} d
      WHERE
        vs.staff_id=%d AND
        vs.department_id=d0.nid AND
        d0.field_college_id_nid=d.field_college_id_nid
      ) AS courses
    LEFT  JOIN {eduerp_roles} er ON courses.department_id=er.department_id AND er.role='Head of Department'
    INNER JOIN {profile_fields} pf0 ON pf0.name='profile_last_name'
    INNER JOIN {profile_fields} pf1 ON pf1.name='profile_first_name'
    INNER JOIN {profile_fields} pf2 ON pf2.name='profile_middle_name'
    LEFT  JOIN {profile_values} pv0 ON er.uid=pv0.uid AND pv0.fid=pf0.fid
    LEFT  JOIN {profile_values} pv1 ON er.uid=pv1.uid AND pv1.fid=pf1.fid
    LEFT  JOIN {profile_values} pv2 ON er.uid=pv2.uid AND pv2.fid=pf2.fid",
    $_SESSION['staff']['data']->staff_id);
?>
    <table border='1' align='center'  cellpadding="5" cellspacing="5">
    <tr bgcolor='#ACCFCC'><td><b>Department</b></td><td><b>HOD</b></td><td><b>Action</b></td></tr>
<?php
  while ($f = db_fetch_object($r)) {
?>
      <tr>
      <td><? echo $f->department_name; ?></td>
      <td><a href="view/<?php echo $f->hod_uid?>"><? echo $f->hod_name; ?></a></td>
      <td><a href="viewlecturer/<? echo $f->department_id; ?>">View Courses/Lecturers</a></td>
      </tr>
<?php
  }
?>
    </table>
<?php
  return ob_get_clean();
}


function staff_search_list() {
  $search_keys = array('gender', 'department_id', 'staff_type_id', 'grade_level_id', 'state');
  $search_values = array(
    'gender' => '',
    'department_id',
    'staff_type_id',
    'grade_level_id',
    'state');
  $data = array_filter($_POST);
  $condition = array();
  foreach ($search_keys as $value) {
    if (isset($data['$value'])) {
      $condition[] = "s .". $value ."='". $data[$value] ."'";
    }
  }
  if (implode(' and ', $condition) != '') {
    $condition = " where ". implode(' and ', $condition);
  }
  else {
    $condition  = '';
  }
  $query = "SELECT vs.*, GROUP_CONCAT(er.role SEPARATOR ', ') AS role_name
    FROM {veritas_staff} vs LEFT JOIN {eduerp_roles} er ON vs.user_id=er.uid
    $condition GROUP BY vs.staff_id ORDER BY staff_last_name ASC";
  $result = db_query($query);
?>
    <table border='1' align='center'>
    <tr bgcolor='#ACCFCC'><td colspan='7'><b>Staff List</b></td></tr>
    <tr><td><b>Last Name</b></td><td><b>Middle Name</b></td><td><b>First Name</b></td><td><b>Roles</b></td><td><b>View</b></td><td><b>Action</b></td></tr>
<?php
  while ($f = db_fetch_object($result)) {
?>
      <tr>
      <td><?php echo $f->staff_last_name; ?></td>
      <td><?php echo $f->staff_middle_name; ?></td>
      <td><?php echo $f->staff_first_name; ?></td>
      <td><? echo $f->role_name; ?></td>
      <td><a href="view/<? echo $f->user_id; ?>">View</a></td>
      <td><a href="<?php echo url('staff/assignrole/'. $f->user_id)?>">Assign Roles</a></td>
      </tr>
<?php
  }
?>
    </table>
<?php
}


function staff_view_form(&$obj) {
  $query = "SELECT vs.*, GROUP_CONCAT(er.role SEPARATOR ', ') AS role_name
    FROM {veritas_staff} vs LEFT JOIN {eduerp_roles} er ON vs.user_id=er.uid
    WHERE user_id='" . arg(2) . "' GROUP BY vs.staff_id";
  $result = db_query($query);
  $data = db_fetch_object($result);
  $form['staff_type'] = array(
    '#type' => 'select',
    '#options' => staff_type(),
    '#title' => 'Staff Type',
    '#default_value' => $data->staff_type_id);
  $form['employment_type'] = array(
    '#type' => 'select',
    '#options' => employment_type(),
    '#title' => 'Employment Type',
    '#default_value' => $data->employment_type_id );
  $form['staff_number'] = array(
  '#title' => 'Staff Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#required' => TRUE,
    '#default_value' => $data->staff_no);
  $form['staff_position'] = array(
    '#type' => 'select',
    '#options' => staff_position(),
    '#title' => 'Position',
    '#default_value' => $data->position_id );
  $form['staff_tax_number'] = array(
    '#title' => 'Tax Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#required' => TRUE,
    '#default_value' => $data->tax_number);
  $form['staff_department'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department',
    '#default_value' => $data->department_id);
  $form['staff_room'] = array(
    '#title' => 'Room',
    '#type' => 'textfield',
    '#size' => 20,
    '#required' => FALSE,
    '#default_value' => $data->room_number);
  $form['salary_garde_level'] = array(
    '#type' => 'select',
    '#options' => salary_grade(),
    '#title' => 'Salary Grade Level',
    '#default_value' => $data->grade_level_id);
  $form['appointment_date'] = array(
    '#type' => 'date',
    '#title' => 'Appointment date',
    '#default_value' => $data->appointment_date);
  $form['assumption_date'] = array(
    '#type' => 'date',
    '#title' => 'Assumption  date',
    '#default_value' => $data->assumption_date);
  $form['ressumption_date'] = array(
    '#type' => 'date',
    '#title' => 'Ressumption  date',
    '#default_value' => $data->resumption_date);
  $form['bank'] = array(
    '#type' => 'select',
    '#options' => staff_banks(),
    '#title' => 'Bank',
    '#default_value' => $data->bank_id);
  $form['account_number'] = array(
    '#title' => 'Account Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#required' => TRUE,
    '#default_value' => $data->account_id);
  $form['staff_role'] = array(
    '#value' => '<b>Roles:</b><br />' . $data->role_name);
  $form['staff_id'] = array(
    '#type' => 'hidden',
    '#title' => 'Role',
    '#default_value' => $data->staff_id,
    '#required' => TRUE);
  return $form;
}


function staff_course_assign() {
  $delete_assignment_js =<<< EOD
function delete_course(id) {
  if (confirm('Are you sure you want to delete this course assignment?')) {
    $.get('/staff/ajax/delete/'+id, function(data) { location.href='/staff/registrablecourse'; });
  }
}
EOD;
  drupal_add_js($delete_assignment_js, 'inline');

  ob_start();
  echo  drupal_get_form('staff_course_assign_form1');
  echo "<div id='assigned_courses'>";
  course_assign_list();
  echo "</div>";
?>
<?php
  return ob_get_clean();
}
function staff_search_form(&$obj) {
  $form = array(
    '#theme' => 'form_panel_table',
    '#form_panel_table_attributes' => array('border' => 0),
    '#redirect' => FALSE);
  $form['department_id'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#form_panel_col' => 1,
    '#form_panel_row' => 1);
  $form['gender'] = array(
    '#type' => 'select',
    '#options' => array(
      '' => 'Select',
      'M' => 'Male',
      'F' => 'Female'),
    '#title' => 'Gender',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#form_panel_col' => 2,
    '#form_panel_row' => 1);
  $form['staff_type_id'] = array(
    '#type' => 'select',
    '#options' => staff_type(),
    '#title' => 'Staff Type',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#form_panel_col' => 3,
    '#form_panel_row' => 1);
  $form['grade_level_id'] = array(
    '#type' => 'select',
    '#options' => salary_grade(),
    '#title' => 'Grade Level',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#form_panel_col' => 4,
    '#form_panel_row' => 1);
  $form['state'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#title' => 'State of origin',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#form_panel_col' => 5,
    '#form_panel_row' => 1);
  $form['jambsubn'] = array(
    '#id' => 'edit-next',
    '#value' => 'Search',
    '#type' => 'submit',
    '#form_panel_col' => 6,
    '#form_panel_row' => 1);
  return $form ;
}
function staff_course_assign_form1(&$obj) {
  $form = array(
    '#theme' => 'form_panel_table',
    '#form_panel_table_attributes' => array('border' => 0));
  $form['title_test'] = array(
    '#type' => 'item',
    '#value' => '<b>Course</b>',
    '#required' => TRUE,
    '#form_panel_col' => 1,
    '#form_panel_row' => 1);
  $form['programme_id'] = array(
    '#type' => 'select',
    '#options' => staff_prg(),
    '#title' => 'Programme',
    '#attributes' => array(
      'style' => 'width:100px'),
    '#required' => TRUE,
    '#form_panel_col' => 1,
    '#form_panel_row' => 2);
  $form['level'] = array(
    '#type' => 'select',
    '#options' => staff_level(),
    '#title' => 'Level',
    '#required' => TRUE,
    '#ahah' => array('path' => 'staff/ajax/course', 'event' => 'change', 'method' => 'replace', 'wrapper' => 'courses'),
    '#form_panel_col' => 2,
    '#form_panel_row' => 2);
  $form['course_id'] = array(
    '#type' => 'select',
    '#title' => 'Course',
    '#options' => staff_course(),
    '#attributes' => array(
      'style' => 'width:100px'),
    '#prefix' => "<div id='courses'>",
    '#suffix' => "</div>",
    '#required' => TRUE,
    '#disabled' => TRUE,
    '#form_panel_col' => 3,
    '#form_panel_row' => 2);
  $form['course_type_id'] = array(
    '#type' => 'select',
    '#options' => array( 1 => 'Core', 2 => 'Elective'),
    '#title' => 'Course Type',
    '#required' => TRUE,
    '#form_panel_col' => 4,
    '#form_panel_row' => 2);
  $form['user_id'] = array(
    '#type' => 'select',
    '#options' => lecturer(),
    '#title' => 'Lecturer',
    '#required' => FALSE,
    '#form_panel_col' => 5,
    '#form_panel_row' => 2);
  $form['min_credit_load'] = array(
    '#type' => 'textfield',
    '#title' => 'Min Credit',
    '#required' => TRUE,
    '#default_value' => ($_SESSION['staff']['min_load']) ? $_SESSION['staff']['min_load'] : "",
    '#size' => 10,
    '#form_panel_col' => 1,
    '#form_panel_row' => 3);
  $form['max_credit_load'] = array(
    '#type' => 'textfield',
    '#title' => 'Max Credit',
    '#required' => TRUE,
    '#default_value' => ($_SESSION['staff']['max_load']) ? $_SESSION['staff']['max_load'] : "",
    '#size' => 10,
    '#form_panel_col' => 2,
    '#form_panel_row' => 3);
  $form['jambsubn'] = array(
    '#id' => 'edit-next',
    '#value' => 'Add',
    '#type' => 'submit',
    '#form_panel_col' => 1,
    '#form_panel_row' => 4);
  $form['sep'] = array(
    '#type' => 'item',
    '#value' => '',
    '#form_panel_col' => 1,
    '#form_panel_row' => 5);
  return $form;
}
function course_assign_list() {
  $query = "
    SELECT courses.*, CONCAT(pv0.value, ', ', pv1.value, ' ', pv2.value) AS staff_name
    FROM
      (SELECT
        pc.program_course_id,
        pc.course_type,
        pc.level AS level_name,
        pc.lecturer_id AS uid,
        p.field_programme_name_value AS programme_name,
        c.field_coursetitle_value AS course_title
      FROM {program_course} pc, {content_type_program} p, {content_type_course} c
      WHERE pc.programme_id=p.nid AND pc.course_id=c.nid AND p.field_department_id_nid=%d AND pc.historical=0
      ) AS courses
    INNER JOIN {profile_fields} pf0 ON pf0.name='profile_last_name'
    INNER JOIN {profile_fields} pf1 ON pf1.name='profile_first_name'
    INNER JOIN {profile_fields} pf2 ON pf2.name='profile_middle_name'
    LEFT  JOIN {profile_values} pv0 ON courses.uid=pv0.uid AND pv0.fid=pf0.fid
    LEFT  JOIN {profile_values} pv1 ON courses.uid=pv1.uid AND pv1.fid=pf1.fid
    LEFT  JOIN {profile_values} pv2 ON courses.uid=pv2.uid AND pv2.fid=pf2.fid";
  $r = db_query($query, $_SESSION['staff']['data']->department_id);
  $html = "<tr><th>Programme</th><th>Level</th><th>Course</th><th>Course Type</th><th>Lecturer</th><th>Actions</th></tr>";
  while ($f = db_fetch_object($r)) {
    $course_type = array('1' => 'Core', 2 => 'Elective');
    $html .=<<<EOD
<tr>
  <td>{$f->programme_name}</td><td>{$f->level_name}&nbsp;</td>
  <td>{$f->course_title}</td><td>{$course_type[$f->course_type]}</td>
  <td>{$f->staff_name}</td>
  <td><input type="button" class="delete_btn" value="Delete" onClick="delete_course({$f->program_course_id});" /></td>
</tr>
EOD;
  }
?>
<table border ="1">
<?php echo  $html; ?>
</table>
<?php
}
function staff_course_assign_form1_submit(&$form, &$state) {
  $values = $state['values'];

  // Semester is 1 below here because the form does not support semester yet
  $query = "SELECT program_course_id FROM {program_course} WHERE course_id=%d, programme_id=%d, level='%s', semester='%s'";
  $result = db_query($query, $values['course_id'], $values['programme_id'], $values['level'], '1');

  if ($row = db_fetch_object($result)) {
    $query = "UPDATE {program_course}
      SET course_id=%d, programme_id=%d, level='%s', semester='%s', course_type=%d, lecturer_id=%d, historical=0
      WHERE program_course_id=%d";
    db_query($query, $values['course_id'], $values['programme_id'], $values['level'], '1', $values['course_type_id'], $values['user_id'], $row->program_course_id);
  }
  else {
    $query = "INSERT INTO {program_course}
      SET course_id=%d, programme_id=%d, level='%s', semester='%s', course_type=%d, lecturer_id=%d, historical=0";
    db_query($query, $values['course_id'], $values['programme_id'], $values['level'], '1', $values['course_type_id'], $values['user_id']);
  }

  drupal_set_message("Course Added to Programme");
  drupal_goto("staff/registrablecourse");
}
function lecturer() {
  $titles['']="Select";
  $r=db_query("select * from {veritas_staff} where department_id = %d order by staff_first_name", $_SESSION['staff']['data']->department_id);
    while ($f=db_fetch_object($r))
      $titles[$f->user_id] = sprintf('%s %s', $f->staff_first_name, $f->staff_last_name);
  return  $titles;
}
function staff_prg() {
  $titles[''] = "";
  $sql = "SELECT nid, field_programme_name_value AS value FROM {content_type_program} WHERE field_department_id_nid=%d ORDER BY field_programme_name_value";
  $rows = db_query($sql, $_SESSION['staff']['data']->department_id);
  while ($row = db_fetch_object($rows)) {
    $titles[$row->nid] = $row->value;
  }
  return $titles;
}
function staff_level() {
  $titles['']="";
  $r=db_query("select * from `level` order by level_name");
    while ($f=db_fetch_object($r))
      $titles[$f->level_name] = $f->level_name;
  return  $titles;
}
function staff_course() {
  $titles[''] = "";
  //$r=db_query("select * from `course` c inner join veritas_staff_department sd on sd.department_id=c.department_id where sd.staff_id=". $_SESSION['staff']['data']->staff_id ." order by course_title");
  $r = db_query("SELECT nid, field_coursetitle_value AS value FROM {content_type_course} ORDER BY field_coursetitle_value");
  while ($f = db_fetch_object($r))
    $titles[$f->nid] = $f->value;
  return  $titles;
}
function staff_registration_form(&$obj) {
  unset($_SESSION['student']);
  unset($_SESSION['veritas']);
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1) {
    return staff_registration_form1($obj);
  }
  elseif ($st == 2) {
    return staff_registration_form2($obj);
  }
  elseif ($st == 3) {
    return staff_registration_form3($obj);
  }
}
function staff_registration_form2(&$obj) {
  $form['title_test'] = array(
    '#type' => 'item',
    '#value' => '<b>Staff Information</b>');
  $form['staff_type'] = array(
    '#type' => 'select',
    '#options' => staff_type(),
    '#title' => 'Staff Type',
    '#default_value' => $_POST['staff_type'],
    '#required' => TRUE);
  $form['employment_type'] = array(
    '#type' => 'select',
    '#options' => employment_type(),
    '#default_value' => $_POST['employment_type'],
    '#title' => 'Employment Type',
    '#required' => TRUE);
  $form['staff_number'] = array(
    '#title' => 'Staff Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_POST['staff_number'],
    '#required' => TRUE);
  $form['staff_position'] = array(
    '#type' => 'select',
    '#options' => staff_position(),
    '#title' => 'Position',
    '#default_value' => $_POST['staff_position'],
    '#required' => TRUE);
  $form['staff_tax_number'] = array(
    '#title' => 'Tax Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_POST['staff_tax_number'],
    '#required' => TRUE);
  $form['staff_department'] = array(
    '#type' => 'select',
    '#options' => department(),
    '#title' => 'Department',
    '#default_value' => $_POST['staff_department'],
    '#required' => FALSE);
  $form['staff_room']=array(
    '#title' => 'Room',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_POST['staff_room'],
    '#required' => FALSE);
  $form['salary_garde_level'] = array(
    '#type' => 'select',
    '#options' => salary_grade(),
    '#default_value' => $_POST['salary_garde_level'],
    '#title' => 'Salary Grade Level');
  $form['appointment_date'] = array(
    '#type' => 'date',
    '#title' => 'Appointment date',
    '#default_value' => $_POST['appointment_date'],
    '#required' => TRUE);
  $form['assumption_date'] = array(
    '#type' => 'date',
    '#title' => 'Assumption  date',
    '#default_value' => $_POST['assumption_date'],
    '#required' => TRUE);
  $form['ressumption_date'] = array(
    '#type' => 'date',
    '#title' => 'Ressumption  date',
    '#default_value' => $_POST['ressumption_date'],
    '#required' => TRUE);
  $form['bank']=array(
    '#type' => 'select',
    '#options' => staff_banks(),
    '#title' => 'Bank',
    '#default_value' => $_POST['bank'],
    '#required' => TRUE);
  $form['account_number'] = array(
    '#title' => 'Account Number',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_POST['account_number'],
    '#required' => TRUE);
  $form['jambsubp'] = array(
    '#id' => 'edit-previous',
    '#value' => 'Previous',
    '#type' => 'submit');
  $form['jambsubn'] = array(
    '#id' => 'edit-next',
    '#value' => 'Next',
    '#type' => 'submit');
  return $form;
}
function staff_banks() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r=db_query("select * from `veritas_bank`  order by name");
    while ($f = db_fetch_object($r))
      $titles[$f->id]=$f->name;
  }
  return  $titles;
}
function salary_grade() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r=db_query("select * from `veritas_salary_grade`  order by salary_grade_level");
    while ($f=db_fetch_object($r))
      $titles[$f->id]=$f->salary_grade_level;
  }
  return  $titles;
}
function staff_type() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r=db_query("select * from {veritas_staff_type}  order by staff_type_name");
    while ($f=db_fetch_object($r))
      $titles[$f->staff_type_id]=$f->staff_type_name;
  }
  return  $titles;
}
function employment_type() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r=db_query("select * from `veritas_employment_type`  order by name");
    while ($f=db_fetch_object($r))
      $titles[$f->id]=$f->name;
  }
  return  $titles;
}
function staff_position() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r=db_query("select * from `veritas_staff_position`  order by name");
    while ($f=db_fetch_object($r))
      $titles[$f->id]=$f->name;
  }
  return  $titles;
}

function department() {
  static $titles;
  if (!$titles) {
    $titles = array();
    $r = db_query("SELECT nid, field_department_name_value AS value FROM {content_type_department} ORDER BY field_department_name_value");
    while ($f = db_fetch_object($r))
      $titles[$f->nid] = $f->value;
  }
  return  $titles;
}

function staff_registration_form1(&$obj) {
  $form['#attributes'] = array(
    'enctype' => "multipart/form-data");
  $form['title_test'] = array(
    '#type' => 'item',
    '#value' => '<b>Personal Information</b>');
  $form['title'] = array(
    '#type' => 'select',
    '#options' => _veritas_titles() /*array('Mr'=>'Mr','Ms'=>'Ms','Mrs'=>'Mrs')*/,
    '#required' => TRUE,
    '#default_value' => $_POST['title'],
    '#title' => 'Title');
  $form['lastname'] = array(
    '#title' => 'Last Name',
    '#type' => 'textfield',
    '#required' => TRUE,
    '#default_value' => $_POST['lastname'],
    '#size' => 20);
  $form['firstname'] = array(
    '#title' => 'First Name',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_POST['firstname'],
    '#required' => TRUE);
  $form['middlename'] = array(
    '#title' => 'Middle Name',
    '#type' => 'textfield',
    '#default_value' => $_POST['middlename'],
    '#size' => 20);
  $form['dob'] = array(
    '#type' => 'date',
    '#default_value' => $_POST['dob'],
    '#title' => 'Date Of Birth');
  $nationality = 156 ; /*nigeria*/
  $form['nat'] = array(
    '#type' => 'select',
    '#default_value' => $_POST['nat'] ? $_POST['nat'] : $nationality,
    '#options' => _veritas_country(),
    '#title' => 'Nationality',
    '#required' => TRUE);
  $form['state'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#required' => TRUE,
    '#title' => 'State Of Origin (Only for Nigeria)',
    '#ahah' => array(
    'event' => 'change',
    '#default_value' => $_POST['state'],
    'wrapper' => 'ilga',
    'path' => 'student/ajaxlga/state',
    'method' => 'html'));
  $form['lga'] = array(
    '#type' => 'select',
    '#default_value' => $_POST['lga'],
    '#options' => veritas_lga(),
    '#required' => TRUE ,
    '#title' => 'LGA',
    '#prefix' => '<div id="ilga">',
    '#suffix' => '</div>',
    '#attributes' => array('disabled' => 'disabled', 'class' => 'form-select'));
  $form['sex'] = array(
    '#type' => 'radios',
    '#default_value' => $_POST['sex'],
    '#title' => "Gender",
    '#options' => array(
      'male' => 'Male',
      'female' => 'Female'),
    '#required' => TRUE);
  $form['mar'] = array(
    '#type' => 'radios',
    '#options' => array(
      'married' => 'Married',
      'single' => 'Single'),
    '#default_value' => $_POST['mar'],
    '#title' => 'MARITAL STATUS',
    '#required' => TRUE);
  $form['maiden'] = array(
    '#title' => 'Maiden Name',
    '#type' => 'textfield',
    '#default_value' => $_POST['maiden'],
    '#size' => 20);
  $form['per_home_address'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['per_home_address'],
    '#required' => TRUE,
    '#title' => 'Permanent Home Address');
  $form['per_city_address'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['per_city_address'],
    '#required' => TRUE,
    '#title' => 'Permanent City Address');
  $form['tmp_home_address'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['tmp_home_address'],
    '#required' => TRUE,
    '#title' => 'Temporary  Home Address');
  $form['tmp_city_address'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#required' => TRUE,
    '#default_value' => $_POST['tmp_city_address'],
    '#title' => 'Temporary City Address');
  $form['tel'] = array(
    '#type' => 'textfield',
    '#size' => 25,
    '#default_value' => $_POST['tel'],
    '#title' => 'Landline');
  $form['gsm'] = array(
    '#type' => 'textfield',
    '#size' => 25,
    '#title' => 'Mobile Number',
    '#default_value' => $_POST['gsm'],
    '#required' => TRUE);
  $form['gsm2'] = array(
    '#type' => 'textfield',
    '#size' => 25,
    '#default_value' => $_POST['gsm2'],
    '#title' => 'Mobile Number 2');
  $form['email'] = array(
    '#type' => 'textfield',
    '#title' => 'Personal Email',
    '#default_value' => $_POST['email'],
    '#size' => 45);
  $form['medical_part1']['blood_group'] = array(
    '#type' => 'select',
    '#options' => array(
      'O+' => 'O+',
      'O-' => 'O-',
      'A+' => 'A+',
      'A-' => 'A-',
      'B+' => 'B+',
      'B-' => 'B-',
      'AB+' => 'AB+',
      'AB-' => 'AB-') ,
    '#title' => 'Blood Group',
    '#default_value' => $_POST['blood_group'],
    '#required' => TRUE);
  $form['pic']=array(
    '#type' => 'file',
    '#title' => 'Upload Passport Picture');
  $form['signature'] = array(
    '#type' => 'file',
    '#title' => 'Upload Signature Picture');
  $form['username'] = array(
    '#type' => 'textfield',
    '#size' => 25,
    '#default_value' => $_POST['username'],
    '#title' => 'Username');
  $form['password'] = array(
    '#type' => 'password',
    '#size' => 25,
    '#title' => 'Password');
  $form['cpassword'] = array(
    '#type' => 'password',
    '#size' => 25,
    '#title' => 'Confirm Password');
  /*$form['jambsubp'] = array(
    '#id' => 'edit-previous',
    '#value' => 'Previous',
    '#type' => 'submit');*/
  $form['jambsubn'] = array(
    '#id' => 'edit-next',
    '#value' => 'Next',
    '#type' => 'submit');
  return $form;
}
function staff_registration_form3(&$obj) {
  //$form['#title']=t('Next of Kin Details');
  $form['title_test'] = array(
    '#type' => 'item',
    '#value' => '<b>Next of Kin Details</b>');
  $form['kin_name'] = array(
    '#type' => 'textfield',
    '#title' => 'Name',
    '#default_value' => $_POST['kin_name'],
    '#size' => 45,
    '#required' => TRUE);
  $form['kin_relation'] = array(
    '#type' => 'select',
    '#options' => _staff_rel(),
    '#title' => 'Relationship',
    '#default_value' => $_POST['kin_relation'],
    '#required' => TRUE);
  $form['kin_address'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['kin_address'],
    '#required' => TRUE,
    '#title' => 'Address');
  $form['kin_city'] =array(
    '#type' => 'textfield',
    '#size' => 60,
    '#required' => TRUE,
    '#default_value' => $_POST['kin_city'],
    '#title' => 'City');
  $form['kin_telephone'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['kin_telephone'],
    '#title' => 'Telephone');
  $form['kin_mobile'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#required' => TRUE,
    '#default_value' => $_POST['kin_mobile'],
    '#title' => 'Mobile');
  $form['kin_email'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => $_POST['kin_email'],
    '#title' => 'Email');
  $form['jambsubp'] = array(
    '#id' => 'edit-previous',
    '#value' => 'Previous',
    '#type' => 'submit');
  $form['jambsubn'] = array(
    '#id' => 'edit-next',
    '#value' => 'Next',
    '#type' => 'submit');
  return $form;
}
function staff_registration_form_submit(&$form, &$state) {
  if ($state['storage']['step'] == 1) {
    //print_R($form);
    $state['storage']['values'][$state['storage']['step']] = $data = $form['#post'];
  }
  if ($state['storage']['step'] == 2) {
    $state['storage']['values'][$state['storage']['step']]=$data = $form['#post'];
  }
  if ($state['storage']['step'] == 3) {
    $state['storage']['values'][$state['storage']['step']] = $data = $form['#post'];
    ///insert drupal_user
    $data = $state['storage']['values'];

    if (empty($data[1]['middlename'])) $data[1]['middlename'] = ''; // ALAN 20090830
    $timezone = variable_get('date_default_timezone', 0); // ALAN 20090903

    $drupal_data = array(
      'mail' => $data[1]['email'],
      'pass' => $data[1]['password'],
      'name' => $data[1]['username'],
      'roles' => array(),
      'init' => $data[1]['email'],
      'status' => 0

      // ALAN 20090830
      ,
      'timezone' => $timezone
      // END ALAN
      );
    $user = user_save(NULL, $drupal_data);

    $query = "insert {veritas_staff} set
staff_first_name='%s' ,
staff_last_name='%s',
staff_middle_name='%s',
staff_maiden_name='%s',
dob='%s',
staff_title='%s',
nationality='%s',
state='%s',
lga='%s',
address='%s',
city='%s',
tel='%s' ,
gsm='%s' ,
personal_email='%s' ,
marital_status ='%s' ,
gender='%s',
blood_group = '%s' ,
staff_no = '%s',
staff_type_id ='%s',
department_id = '%s',
position_id = '%s',
grade_level_id = '%s',
room_number = '%s',
appointment_date = '%s',
assumption_date = '%s',
resumption_date = '%s',
bank_id = '%s',
account_id  = '%s',
gsm2 = '%s',
pic = '%s',
signature = '%s',
permanent_home_address = '%s',
permanent_city_address = '%s',
temp_home_address = '%s',
temp_city_address = '%s',
employment_type_id = '%s',
tax_number = '%s' ,
user_id ='%s'
";
    $gender = array('female' => 'F', 'male' => 'M');
    $data[1]['sex'] = $gender[$data[1]['sex']];
    db_query($query,
      $data[1]['firstname'],
      $data[1]['lastname'],
      $data[1]['middlename'],
      $data[1]['maiden'],
      $data[1]['dob']['year'] ."-". $data[1]['dob']['month'] ."-". $data[1]['dob']['day'],
      $data[1]['title'],
      $data[1]['nat'],
      $data[1]['state'],
      $data[1]['lga'],
      $data[1]['address'],
      $data[1]['city'],
      $data[1]['tel'],
      $data[1]['gsm'],
      $data[1]['email'],
      $data[1]['mar'],
      $data[1]['sex'],
      $data[1]['blood_group'],
      $data[2]['staff_number'],
      $data[2]['staff_type'],
      $data[2]['staff_department'],
      $data[2]['staff_position'],
      $data[2]['salary_garde_level'],
      $data[2]['staff_room'],
      $data[2]['appointment_date']['year'] ."-". $data[2]['appointment_date']['month'] ."-". $data[2]['appointment_date']['day'],
      $data[2]['assumption_date']['year'] ."-". $data[2]['assumption_date']['month'] ."-". $data[2]['assumption_date']['day'],
      $data[2]['ressumption_date']['year'] ."-". $data[2]['ressumption_date']['month'] ."-". $data[2]['ressumption_date']['day'],
      $data[2]['bank'],
      $data[2]['account_number'],
      $data[1]['gsm2'],
      $data['pic'],
      $data['signature'],
      $data[1]['per_home_address'],
      $data[1]['per_city_address'],
      $data[1]['tmp_home_address'],
      $data[1]['tmp_city_address'],
      $data[2]['employment_type'],
      $data[2]['staff_tax_number'],
      $user->uid);
    $staff_id = db_last_insert_id('veritas_staff', 'id');
    $query = "insert veritas_staff_kin set
 name = '%s',
 relation_id='%s',
 address='%s',
 city='%s',
 telephone='%s',
 mobile='%s',
 email='%s',
 staff_id='%s'
 ";
    db_query($query,
      $data[3]['kin_name'],
      $data[3]['kin_relation'],
      $data[3]['kin_address'],
      $data[3]['kin_city'],
      $data[3]['kin_telephone'],
      $data[3]['kin_mobile'],
      $data[3]['kin_email'],
      $staff_id
      );

    // ALAN 20091112
    require_once './' . drupal_get_path('module', 'veritas') . '/staff/staff_eduerp_profile.inc';
    save_staff_eduerp_profile($user->uid);
    // END ALAN

    drupal_goto('staff/registration/success');
  }
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    $state['storage']['step']--;
    // return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    $nextstep=  $state['storage']['step']++;
  }
}
function registartion_success() {
  ob_start();
  echo "Registration successfull";
  return ob_get_clean();
}
function staff_registration_form_validate(&$form, &$state) {
  if ($state['storage']['step'] == 1) {
    $pic = file_save_upload_name('pic', array(), variable_get('file_directory_path', NULL) .'/staff/pic/', FALSE, NULL);
    if (!$pic) {
      form_set_error('pic', 'Picture cannot be uploaded ');
      //return;
    }
    $state['storage']['pic'] = $pic->fid;
    $signature=file_save_upload_name('signature', array(), variable_get('file_directory_path', NULL) .'/staff/signature', FALSE, NULL);
    if (!$signature) {
      form_set_error('signature', 'Signature cannot be uploaded ');
      //return;
    }
    $state['storage']['signature'] = $signature->fid;
    if ($form['#post']['cpassword'] != $form['#post']['password']) {
      form_set_error('submitted[cpassword]', "Password not match with  Confirm Password");
      return;
    }
    /* $query ="select * from veritas_staff where usrname = '".$form['#post']['username']."'";
    $result = db_query($query);
    if ($result && db_fetch_object($result)) {
      form_set_error('submitted[username]',"Username already exists.");
    }*/
  }
  if ($state['storage']['step'] ==2) {
  }
  if ($state['storage']['step'] ==3) {
  }
  return;
}


function staff_begin_clearance_form(&$obj) {
  if (arg(2)) {
    //echo "<br>2 ".arg(2);
    $_SESSION['staff']['mat']=arg(2);
    //$_SESSION['staff']['mat'];
    $obj['storage']['step']=2;
    return staff_begin_clearance_form2($obj);
  }
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1)
    return staff_begin_clearance_form1($obj);
  else if ($st == 2)
    return staff_begin_clearance_form2($obj);
  //else if ($st==3)
    //return staff_begin_clearance_form3($obj);
  //else if ($st==4)
    //return staff_begin_clearance_form($obj);
}


function view_student_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1 or $st == 3)
    return view_student_form1($obj);
  else if ($st == 2)
    return view_student_form2($obj);
}
function view_staff_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1 or $st == 3)
    return view_staff_form1($obj);
  else if ($st == 2)
    return view_staff_form2($obj);
}
function sa_view_student_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1 or $st == 3)
    return sa_view_student_form1($obj);
  else if ($st == 2)
    return sa_view_student_form2($obj);
}
function search_staff_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1 or $st == 3)
    return search_staff_form1($obj);
  else if ($st == 2)
    return search_staff_form2($obj);
}
function view_student_payments_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st == 1 or $st == 3)
    return view_student_payments_form1($obj);
  else if ($st == 2)
    return view_student_payments_form2($obj);
}


function staff_user($op, &$edit, &$account, $category) {
  switch ($op) {
    case 'login':
      $query ="select COUNT(*) AS count from {veritas_staff} where user_id = %d";
      $result = db_query($query, $account->uid);
	    $rows = db_fetch_array($result);

	    if ($result && intval($rows['count']) > 0) {
        $result = db_query("SELECT * FROM {veritas_staff} as vs LEFT JOIN {veritas_staff_type} AS vst ON vs.staff_type_id=vst.staff_type_id
          WHERE vs.user_id='" . $account->uid . "'");

        if ($result && ($data = db_fetch_object($result))) {
          $_SESSION['staff']['data'] = $data;
        }
      }
    break;
  }
}


/*Code adding started on 24/02/2009 for staff profile form.*/
function staff_profile_form(&$obj) {
  if (!isset($_SESSION['staff']['data']->staff_id)) {
    drupal_goto('user');
  }
  if (isset($_SESSION['staff']['data']->staff_id)) {
    $qry = "select * from {veritas_staff} where staff_id='". $_SESSION['staff']['data']->staff_id ."'";
    $res = db_query($qry);
    if ($res && ($data = db_fetch_object($res))) {
      $_SESSION['staff']['user'] = $data->usrname;
      $_SESSION['staff']['data'] = $data;
      //echo $_SESSION['staff']['data']->state;
    }
  }
  $form['#title'] = t('Staff Profile');
  $form['title'] = array(
    '#type' => 'select',
    '#options' => _veritas_titles() /*array('Mr'=>'Mr','Ms'=>'Ms','Mrs'=>'Mrs')*/,
    '#required' => TRUE,
    '#title' => 'Title',
    '#default_value' => $_SESSION['staff']['data']->staff_title);
  $form['fname'] = array(
    '#title' => 'First Name',
    '#type' => 'textfield',
    '#size' => 20,
    '#required' => TRUE,
    '#default_value' => $_SESSION['staff']['data']->staff_first_name);
  $form['mname'] = array(
    '#title' => 'Middle Name',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_SESSION['staff']['data']->staff_middle_name);
  $form['lname'] = array(
    '#title' => 'Last Name',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_SESSION['staff']['data']->staff_last_name,
    '#required' => TRUE);
  $form['maidname'] = array(
    '#title' => 'Maiden Name',
    '#type' => 'textfield',
    '#size' => 20,
    '#default_value' => $_SESSION['staff']['data']->staff_maiden_name,
    '#required' => TRUE);
  $form['gender'] = array(
    '#title' => 'Gender',
    '#type' => 'select',
    '#options' => array('M' => 'Male', 'F' => 'Female'),
    '#default_value' => $_SESSION['staff']['data']->gender,
    '#required' => TRUE);
  $form['nation'] = array(
    '#title' => 'Nationality',
    '#type' => 'select',
    '#options' => _veritas_country(),
    '#default_value' => $_SESSION['staff']['data']->nationality,
    '#required' => TRUE);
  $form['state'] = array(
    '#title' => 'State',
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $_SESSION['staff']['data']->state,
    '#required' => TRUE);
  $form['address'] = array(
    '#title' => 'Address',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->address,
    '#required' => TRUE);
  $form['city'] = array(
    '#title' => 'City',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->city,
    '#required' => TRUE);
  $form['tel'] = array(
    '#title' => 'Telephone',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->tel,
    '#required' => TRUE);
  $form['gsm'] = array(
    '#title' => 'GSM',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->gsm,
    '#required' => TRUE);
  $form['pemail'] = array(
    '#title' => 'Personal Email',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->personal_email,
    '#required' => TRUE);
  $form['mstatus'] = array(
    '#title' => 'Marital Status',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->marital_status,
    '#required' => TRUE);
  $form['location'] = array(
    '#title' => 'Location',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->location);
  $form['blood'] = array(
    '#title' => 'Blood Group',
    '#type' => 'textfield',
    '#default_value' => $_SESSION['staff']['data']->blood_group,
    '#size' => 5);
  /*$form['dob']=array('#type'=>'date','#title'=>'Date Of Birth', '#default_value'=>$_SESSION['staff']['data']->dob);*/
  $form['dob'] = array(
    '#type' => 'date',
    '#title' => 'Date Of Birth',
    '#default_value' => array(
      'day' => (int)substr($_SESSION['staff']['data']->dob, -2),
      'month' => (int)substr($_SESSION['staff']['data']->dob, 5, 2),
      'year' => substr($_SESSION['staff']['data']->dob, 0, 4)));
  $form['submit'] = array(
    '#id' => 'enter',
    '#value' => 'Submit',
    '#type' => 'submit');
  return $form;
}
/*Code adding ended on 24/02/2009 for staff profile form.*/


function staff_profile_form_validate($form, &$states) {
  ob_start();
  $dob = $form['#post']['dob']['year'] ."-". $form['#post']['dob']['month'] ."-". $form['#post']['dob']['day'];
  $qry = "update {veritas_staff} set staff_title='". $form['#post']['title'] ."', staff_first_name='". $form['#post']['fname'] ."', staff_last_name='". $form['#post']['lname'] ."', staff_middle_name='". $form['#post']['mname'] ."', staff_maiden_name='". $form['#post']['maidname'] ."', gender='". $form['#post']['gender'] ."', nationality='". $form['#post']['nation'] ."', state='". $form['#post']['state'] ."', address='". $form['#post']['address'] ."', city='". $form['#post']['city'] ."', tel='". $form['#post']['tel'] ."', gsm='". $form['#post']['gsm'] ."', dob='". $dob ."', personal_email='". $form['#post']['pemail'] ."', blood_group='". $form['#post']['blood'] ."', marital_status='". $form['#post']['mstatus'] ."', location='". $form['#post']['location'] ."'
      where  staff_id='". $_SESSION['staff']['data']->staff_id ."'";
  $result = db_query($qry);
  if ($result && db_affected_rows() > 0) {
    drupal_set_message('You have successfully updated your details.');
    drupal_goto('user');
  }
}


/*Code adding started on 25/02/2009 for staff clearance form. */
function _staff_clearance() {
  /*if (!isset($_SESSION['staff']['data']->staff_id)) {
    drupal_goto('user');
  }*/
  ob_start();

  // $qry2 = "SELECT * FROM student AS a LEFT OUTER JOIN department AS d ON a.first_choice=d.department_id LEFT OUTER JOIN college AS c ON d.college_id=c.college_id WHERE a.staff_id='".$_SESSION['staff']['data']->staff_id."'";
  // $qry2 = "SELECT * FROM `admitted_student` AS a LEFT OUTER JOIN programme AS p ON a . first_choice=p . programme_id left join department d on p . department_id = d . department_id LEFT OUTER JOIN college AS c ON d . college_id=c . college_id  WHERE 1=1 or a . clearance_status=1 OR a . clearance_status=2";
  // $qry2 = "SELECT * FROM `admitted_studen`t AS a LEFT OUTER JOIN programme AS p ON a . first_choice=p . programme_id inner join department d on p . department_id = d . department_id LEFT OUTER JOIN college AS c ON d . college_id=c . college_id inner join veritas_staff_college vc on vc . assigned_college = c . college_id and vc.staff_id = ". $_SESSION['staff']['data']->staff_id ." WHERE a . clearance_status=1   ORDER BY a . last_name ASC";
  $qry2 = "SELECT a.*, d.field_department_name_value AS department_name, c.field_college_name_value AS college_name
    FROM {admitted_student} a, {content_type_program} p, {content_type_department} d, {content_type_college} c
    WHERE a.first_choice=p.nid AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid AND a.clearance_status=1 ORDER BY a.last_name ASC";
  $result2 = db_query($qry2);
  $found = FALSE;
?>
  <table border='1' align='center'>
  <tr bgcolor='#ACCFCC'><td colspan='7'><b>Cleared Student List</b></td></tr>
  <tr><td><b>Last Name</b></td><td><b>Middle Name</b></td><td><b>First Name</b></td><td><b>Mat. No.</b></td><td><b>College</b></td><td><b>Department</b></td><td><b>Clearance Date</b></td></tr>
<?php
  while ($f = db_fetch_object($result2)) {
    $found = TRUE;
?>
    <tr>
    <td><?php echo $f->last_name; ?></td>
    <td><?php echo $f->middle_name; ?></td>
    <td><?php echo $f->first_name; ?></td>
    <td><?php echo $f->matriculation_no; ?></td>
    <td><?php echo $f->college_name; ?></td>
    <td><?php echo $f->department_name; ?></td>
    <td><?php echo $f->clearance_date; ?></td>
    </tr>
<?php
  }
?>
  </table>
<?php
  if (!$found) {
    drupal_set_message('No students found.');
  }
  return ob_get_clean();
}


function staff_begin_clearance_form1(&$obj) {
/*
  if (!isset($_SESSION['staff']['data']->staff_id)) {
    drupal_goto('user');
  }
*/
  if (isset($_SESSION['staff']['mat'])) {
    unset($_SESSION['staff']['mat']);
  }
  if (isset($_SESSION['staff']['jamb'])) {
    unset($_SESSION['staff']['jamb']);
  }
  $form['#title'] = t('Begin Clearance');
  $form['matno'] = array(
    '#title' => 'Matriculation No .',
    '#type' => 'textfield',
    '#default_value' => $_POST['matno'],
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['jambno'] = array(
    '#title' => 'JAMB No .',
    '#default_value' => $_POST['jambno'],
    '#type' => 'textfield',
    '#size' => 20);
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  return $form;
}
     /* Code adding ended on 27/02/2009 for student clearance page. */

    /* Code adding started on 27/02/2009 for student clearance page validation. */
function staff_begin_clearance_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
   // $state['#rebuild']=true;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    /*$values=$form['verify']['#post'];
if ($values['result']=='yes') {

//die;
 //echo $values['result'];
 $state['storage']['step']= 2;
}else if ($values['result']=='no') {

 $state['storage']['step']= 3;
}*/
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    $state['storage']['step']++;
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function staff_begin_clearance_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    //print_R($form);
    $values=$form['lbl_or']['#post'];
    $jambno=$values['jambno'];
    if ($form['#post']['matno'] != '' && $jambno!='') {
      drupal_set_message('Please enter either Matriculation no or JAMB no.');
    }
    else {
      if ($jambno != '' && $form['#post']['matno']=='') {
        $qry = "select * from {admitted_student} where jambno='%s'";
        $res = db_query($qry, $jambno);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
          $_SESSION['staff']['jamb']=$jambno;
        }
        else {
          form_set_error('jambno', "Jamb number not valid.");
        }
        if ($result->clearance_status == 1 && $result->verify_status == 1) form_set_error('jambno', 'This student has already been cleared');
      }
      else {
        $qry = "select * from {admitted_student} where matriculation_no='%s'";
        $res = db_query($qry, $form['#post']['matno']);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
        }
        else {
          form_set_error('matno', "Matriculation number not valid.");
        }
        if ($result->clearance_status == 1 && $result->verify_status == 1) form_set_error('matno', 'This student has already been cleared');
      }
    }
  }
  if ($state['storage']['step'] == 2) {
    $results=$form['verify']['#post'];
    $results1=$form['clear']['#post'];
    $results2=$form['approve']['#post'];
    if (!veritas_has_role($user, 'Registrar')) {
      if ($results['result'] == '' && $results1['cleared']=='') {
        drupal_set_message('Please specify verify and clearance status');
      }
      if ($results1['cleared'] == 'no' && $results1['reject'] == '') {
        drupal_set_message('Please explain reason for rejection.');
      }
      if ($results1['cleared'] == 'no' && $results['result'] == 'no') {
        $dt = date('Y-m-d');
        $qry = "update {admitted_student} set clearance_status=0, verify_status=0, clearance_date='". $dt ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res = db_query($qry);
        if ($res && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
      if ($results1['cleared'] == 'yes' && $results['result'] == 'yes') {
        $dt = date('Y-m-d');
        $qry = "update {admitted_student} set clearance_status=1, verify_status=1, clearance_date='". $dt ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res = db_query($qry);
        if ($res && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          drupal_set_message(sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance')));
          $userid = db_fetch_object(db_query("SELECT user_id FROM {admitted_student} WHERE student_id=%d", $_SESSION['staff']['stud_info']));
          $user_account = user_load($userid->user_id);
          veritas_set_role($user_account, 'Student');
          drupal_goto('staff/cleared');
        }
      }
      if ($results1['cleared'] == 'no' && $results['result'] == 'yes') {
        $dt = date('Y-m-d');
        $qry = "update {admitted_student} set clearance_status=0, verify_status=1, clearance_date='". $dt ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res = db_query($qry);
        if ($res && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
      if ($results['result'] == 'yes') {
        $dt = date('Y-m-d');
        $qry = "update {admitted_student} set verify_status=1, clearance_date='". $dt ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res = db_query($qry);
        if ($res && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
      if ($results['result'] == 'no') {
        $dt = date('Y-m-d');
        $qry = "update {admitted_student} set verify_status=0, clearance_date='" . $dt ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res = db_query($qry);
        if ($res && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
      if ($results1['cleared'] == 'yes' && $results['result'] == 'no') {
          $_SESSION['staff']['msg']= sprintf('Students can only be cleared when their data are verified. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
        drupal_set_message(sprintf('Students can only be cleared when their data are verified. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance')));
      }
    }
    if (veritas_has_role($user, 'Registrar')) {
      if ($results2['accept'] == 'no') {
        $dt1 = date('Y-m-d');
        $qry_rej = "update {admitted_student} set clearance_status=0, verify_status=0, clearance_date='". $dt1 ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res_rej = db_query($qry_rej);
        if ($res_rej && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
      if ($results2['accept'] == 'yes') {
        $dt2 = date('Y-m-d');
        $qry_acc = "update {admitted_student} set clearance_status=2, clearance_date='". $dt2 ."' where student_id='". $_SESSION['staff']['stud_info'] ."'";
        $res_acc = db_query($qry_acc);
        if ($res_acc && db_affected_rows()>0) {
          $_SESSION['staff']['msg']= sprintf('Student status updated sucessfully. <a href="%s">Continue Clearance</a>', url('staff/begin_clearance'));
          //drupal_set_message('Student status updated sucessfully.');
          drupal_goto('staff/cleared');
        }
      }
    }
  }
}
    /* Code adding ended on 27/02/2009 for student clearance page validation. */

    /* Code adding started on 27/02/2009 for student clearance main page. */
function staff_begin_clearance_form2(&$obj) {
  global $user;

  if (isset($_SESSION['staff']['jamb'])) {
    $qry = "select * from {admitted_student} where jambno='%s' AND (verify_status != 1 OR clearance_status != 1)";
    $res = db_query($qry, $_SESSION['staff']['jamb']);
  }
  else {
    $qry = "select * from {admitted_student} where matriculation_no='%s' AND (verify_status != 1 OR clearance_status != 1)";
    $res = db_query($qry, $_SESSION['staff']['mat']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['stud_info']=$result->student_id;
    $qry1 = "select * from {admitted_next_of_kin} where student_id='". $result->student_id ."'";
    $res1 = db_query($qry1, $result->student_id);
    if ($res1 && ($result1=db_fetch_object($res1))) {
      $qry2 = "SELECT a.ext_exam_rec_id, a.exam_body, a.exam_date, a.exam_center_name, a.exam_number, b.exam_body_name FROM `admitted_ext_exam_record` AS a LEFT OUTER JOIN ext_exam_body AS b ON a.exam_body=b.exam_body_id WHERE a.exam_student_id=%d";
      $res2 = db_query($qry2, $result->student_id);

      $data_key = array();
      while ($result2 = db_fetch_object($res2)) {
        $data[$result2->ext_exam_rec_id] = array(
          'exam_body' => $result2->exam_body,
          'exam_date' => $result2->exam_date,
          'exam_center_name' => $result2->exam_center_name,
          'exam_number' => $result2->exam_number,
        );
        $query3 = "SELECT * FROM admitted_ext_exam_detail WHERE ext_exam_record_id=%d";
        $r=db_query($query3, $result2->ext_exam_rec_id);
        while ($f=db_fetch_object($r)) {
          $data[$result2->ext_exam_rec_id]['subjects'][] = array('subject' => $f->subject_id, 'grade' => $f->grade_id);
          if (!in_array($result2->ext_exam_rec_id, $data_key)) {
            $data_key[] = $result2->ext_exam_rec_id;
          }
        }
      }

      $qry4 = "SELECT
          p.nid AS programme_id,
          p.field_programme_name_value AS programme_name,
          d.nid AS department_id,
          d.field_department_name_value AS department_name,
          c.field_college_abbreviation_value AS college_abbreviation,
          c.field_college_name_value AS college_name
        FROM {content_type_program} p, {content_type_department} d, {content_type_college} c
        WHERE p.nid=%d AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid";
      $res4 = db_query($qry4, $result->first_choice);
      $result4 = db_fetch_object($res4);
      $qry5 = "select a . session_id, b . sess_name from `current_session_semester` as a join session as b on a . session_id=b . session_id";
      $res5 = db_query($qry5);
      $result5 = db_fetch_object($res5);
      $qry6 = "select * from `admitted_next_of_kin` where student_id='". $result->student_id ."'";
      $res6 = db_query($qry6);
      $result6 = db_fetch_object($res6);
      $qry7 = "select * from `admitted_sponsor` where student_id='". $result->student_id ."'";
      $res7 = db_query($qry7);
      $result7 = db_fetch_object($res7);
    }
  }
  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Admission Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['extra']['college0'] = array(
    '#type' => 'item',
    '#title' => 'College',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['college1'] = array(
    '#type' => 'item',
    '#value' => $result4->college_abbreviation,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept0'] = array(
    '#type' => 'item',
    '#title' => 'Department',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept1'] = array(
    '#type' => 'item',
    '#value' => $result4->department_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  //$form['extra']['space13']=array('#type'=>'item','#prefix'=>'<td>&nbsp;','#suffix'=>'</td>');
  $form['extra']['programme0'] = array(
    '#type' => 'item',
    '#title' => 'Programme',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme1'] = array(
    '#type' => 'item',
    '#value' => $result4->programme_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['study_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Study',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['study_mode1'] = array(
    '#type' => 'item',
    '#value' => $result->mode_of_study,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['space14'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['extra']['entry_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Entry',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_mode1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->mode_of_entry,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess0'] = array(
    '#type' => 'item',
    '#title' => 'SESSION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess1'] = array(
    '#type' => 'item',
    '#value' => $result5->sess_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  /*$form['personal'][img_lbl]=array('#type'=>'item', '#title'=>'Student Image');
  $form['personal']['img_sig']=array('#title'=>'Student Image','#value'=>'<img src="'.load_image().'" width="200" />');*/
  $form['personal']['img_lbl0'] = array(
    '#type' => 'item',
    '#title' => 'Student Image',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['img_lbl1'] = array(
    '#value' => '<img src="'. load_image() .'" width="200" />',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['img_sig0'] = array(
    '#type' => 'item',
    '#title' => 'Student Signature',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig1'] = array(
    '#value' => '<img src="'. load_signature() .'" width="300" />',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['matno0'] = array(
    '#type' => 'item',
    '#title' => 'Matriculation No.',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['matno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->matriculation_no,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['jambno0'] = array(
    '#type' => 'item',
    '#title' => 'JAMB No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['jambno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->jambno,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->first_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space1'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->middle_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space2'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->last_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $result->dob,
    '#prefix' => '<td colspan="7">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->gender,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space3'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->state_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['lga0'] = array(
    '#type' => 'item',
    '#title' => 'LGA Of Origin',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['lga1'] = array(
    '#type' => 'select',
    '#options' => veritas_lga(),
    '#default_value' => $result->lkup_lga_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space4'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => $result->marital_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Permanent Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->permanent_address1,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space5'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['city1'] = array(
    '#type' => 'item',
    '#value' => $result->permanent_address_city,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['state0'] = array(
    '#type' => 'item',
    '#title' => 'State',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['state1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->permanent_address_state,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space6'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result->mobile_number,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $result->email_address,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space15'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['health0'] = array(
    '#type' => 'item',
    '#title' => 'Health Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['health1'] = array(
    '#type' => 'item',
    '#value' => $result->physical_health_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['nextofkin'] = array(
    '#type' => 'fieldset',
    '#title' => 'Sponsor/Next of Kin Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['nextofkin']['nofkin0'] = array(
    '#type' => 'item',
    '#title' => 'Next of Kin Name',
    '#prefix' => '<table cellspacing="10" cellpadding="10"><tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['nofkin1'] = array(
    '#type' => 'item',
    '#value' => $result6->name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['relation0'] = array(
    '#type' => 'item',
    '#title' => 'Relationship',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['relation1'] = array(
    '#type' => 'item',
    '#value' => $result6->relationship,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result6->mobile,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['nextofkin']['sponsor0'] = array(
    '#type' => 'item',
    '#title' => 'Sponsor',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['sponsor1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result7->name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  if ($result7->mobile != $result6->mobile) {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td>');
    $form['nextofkin']['smobile1'] = array(
      '#type' => 'item',
      '#size' => 20,
      '#value' => $result7->mobile,
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  else {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  $form['fs'] = array(
    '#type' => 'fieldset',
    '#title' => 'O-Level Results 1st  Sitting',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['fs']['qualification0'] = array(
    '#type' => 'item',
    '#title' => 'QUALIFICATION',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['fs']['qualification1'] = array(
    '#type' => 'item',
    '#value' => $result->h_qualification1,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['space22'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['institution0'] = array(
    '#type' => 'item',
    '#title' => 'INSTITUTION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['institution1'] = array(
    '#type' => 'item',
    '#value' => $result->h_institution1,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['fs']['ebd0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM BODY',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs']['ebd1'] = array(
    '#type' => 'select',
    '#options' => _student_bod(),
    '#default_value' => $data[$data_key[0]]['exam_body'],
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs']['space8'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['edate0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM DATE',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  //$form[fs]['edate1'] = array('#type'=>'date','#default_value'=>$data[$data_key[0]]['exam_date'],'#prefix'=>'<td>','#suffix'=>'</td></tr>','#attributes'=>array('disabled' => 'disabled'));
  $form['fs']['edate1'] = array(
    '#type' => 'date',
    '#default_value' => array(
      'day' => (int)substr($data[$data_key[0]]['exam_date'], -2),
      'month' => (int)substr($data[$data_key[0]]['exam_date'], 5, 2),
      'year' => substr($data[$data_key[0]]['exam_date'], 0, 4)),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs']['ec0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM CENTER',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs']['ec1'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[0]]['exam_center_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['space9'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['eno0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM NO',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['eno1'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[0]]['exam_number'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['fs']['ms1'] = array(
    '#type' => 'item',
    '#value' => 'SUBJECTS',
    '#prefix' => '<table><tr><td></td><th>',
    '#suffix' => '</th>');
  $form['fs']['ms2'] = array(
    '#type' => 'item',
    '#value' => 'GRADE',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $temp=0;
  for ($i=1;$i<=9;$i++) {
    $temp = $i-1;
    $form['fs']["m1$i"] = array(
      '#value' => '<tr><td>'. $i,
      '#suffix' => '</td>');
    $form['fs']["s1$i"] = array(
      '#type' => 'select',
      '#options' => _student_sub(),
      '#prefix' => '<td>',
      '#suffix' => '</td>',
      '#default_value' => $data[$data_key[0]]['subjects'][$temp]['subject'],
      '#attributes' => array('disabled' => 'disabled'));
    if ($i == 9)
      $tend="</table>";
    $form['fs']["g1$i"] = array(
      '#type' => 'select',
      '#options' => _student_gr(),
      '#prefix' => '<td>',
      '#suffix' => '</td></tr>'. $tend,
      '#default_value' => $data[$data_key[0]]['subjects'][$temp]['grade'],
      '#attributes' => array('disabled' => 'disabled'));
    $temp = 0;
  }
//  unset($data[$data_key[0]]);
//$form[fs]["m12"]=array('#value'=>'</table>');
//ext_exam_rec_id  exam_date  exam_center_name  exam_number  exam_body  exam_student_id  ext_exam_record_id  subject_id  grade_id
  $form['fs2'] = array(
    '#id' => 'setting_sec',
    '#type' => 'fieldset',
    '#title' => 'O-Level Results 2nd Sitting',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['fs2']['qualification10'] = array(
    '#type' => 'item',
    '#title' => 'QUALIFICATION',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['qualification11'] = array(
    '#type' => 'item',
    '#value' => $result->h_qualification2,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['space25'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['institution10'] = array(
    '#type' => 'item',
    '#title' => 'INSTITUTION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['institution11'] = array(
    '#type' => 'item',
    '#value' => $result->h_institution2,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['fs2']['ebd20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM BODY',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['ebd21'] = array(
    '#type' => 'select',
    '#options' => _student_bod(),
    '#default_value' => $data[$data_key[1]]['exam_body'],
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs2']['space10'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['edate20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM DATE',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  //$form[fs2]['edate21'] = array('#type'=>'date','#default_value'=>$data[$data_key[1]]['exam_date'], '#prefix'=>'<td>','#suffix'=>'</td></tr>','#attributes'=>array('disabled' => 'disabled'));
  $form['fs2']['edate21'] = array(
    '#type' => 'date',
    '#default_value' => array(
      'day' => (int)substr($data[$data_key[1]]['exam_date'], -2),
      'month' => (int)substr($data[$data_key[1]]['exam_date'], 5, 2),
      'year' => substr($data[$data_key[1]]['exam_date'], 0, 4)),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs2']['ec20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM CENTER',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['ec21'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $data[$data_key[1]]['exam_center_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['eno20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM NO',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['eno21'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[1]]['exam_number'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['fs2']['ms11']=array(
    '#type' => 'item',
    '#value' => 'SUBJECTS',
    '#prefix' => '<table><tr><td></td><th>',
    '#suffix' => '</th>');
  $form['fs2']['ms12'] = array(
    '#type' => 'item',
    '#value' => 'GRADE',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $tend='';
  for ($i=1;$i<=9;$i++) {
    $temp = $i-1;
    $form['fs2']["m2$i"] = array(
      '#value' => '<tr><td>'. $i,
      '#suffix' => '</td>');
    $form['fs2']["s2$i"] = array(
      '#type' => 'select',
      '#options' => _student_sub(),
      '#prefix' => '<td>',
      '#suffix' => '</td>',
      '#default_value' => $data[$data_key[1]]['subjects'][$temp]['subject'],
      '#attributes' => array('disabled' => 'disabled'));
    if ($i == 9)
      $tend="</table>";
    $form['fs2']["g2$i"] = array(
      '#type' => 'select',
      '#options' => _student_gr(),
      '#prefix' => '<td>',
      '#suffix' => '</td></tr>'. $tend,
      '#default_value' => $data[$data_key[1]]['subjects'][$temp]['grade'],
      '#attributes' => array('disabled' => 'disabled'));
    $temp = 0;
  }
  if (!veritas_has_role($user, 'Registrar')) {
    $form['verify'] = array(
      '#type' => 'fieldset',
      '#title' => 'Verified Results',
      '#collapsed' => TRUE,
      '#collapsible' => TRUE);
    $form['verify']['result'] = array(
      '#type' => 'radios',
      '#title' => 'Is Verified',
      '#options' => array('yes' => 'Yes', 'no' => 'No'));
    $form['clear'] = array(
      '#type' => 'fieldset',
      '#title' => 'Clear Student',
      '#collapsed' => TRUE,
      '#collapsible' => TRUE);
    $form['clear']['cleared'] = array(
      '#type' => 'radios',
      '#title' => 'Is Cleared',
      '#options' => array('yes' => 'Yes', 'no' => 'No'));
    $form['clear']['reject'] = array(
      '#type' => 'textarea',
      '#title' => 'Reason for Rejection',
      '#prefix' => '<div id="reason">',
      '#suffix' => '</div>');
  }
  if (veritas_has_role($user, 'Registrar')) {
    $form['approve'] = array(
      '#type' => 'fieldset',
      '#title' => 'Approve Student',
      '#collapsed' => TRUE,
      '#collapsible' => TRUE);
    $form['approve']['accept'] = array(
      '#type' => 'radios',
      '#options' => array('yes' => 'Accept', 'no' => 'Reject'));
  }
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Submit',
    '#type' => 'submit');
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}
function load_image() {
  global $result;
  $qry9 = "select a . pic_id, b . filepath from `admitted_student` as a join files as b on a . pic_id=b . fid where a . student_id='". $_SESSION['staff']['stud_info'] ."'";
  $res9=db_query($qry9);
  if ($res9 && ($result9=db_fetch_object($res9))) {
    //print_R($result9);
    $pic_path=$result9->filepath;
    /*$host=$_SERVER['HTTP_HOST'];
    $repalce=$_SERVER['DOCUMENT_ROOT'];
    $file_path='http://';
    $file_path .=str_replace($repalce, $host, $pic_path);
    $file_path=strip_tags($file_path);*/
    $file_path = file_create_url($pic_path);
    //$path='<img src="'.$file_path.'" />';
  }
  else {
    //$path='No Images Available';
    // TODO: Fix this situation
  }
  return $file_path;
}
function load_signature() {
  //global $result;
  $qry10 = "select a . signature_pic_id, b . filepath from `admitted_student` as a join files as b on a . signature_pic_id=b . fid where a . student_id='". $_SESSION['staff']['stud_info'] ."'";
  $res10=db_query($qry10);
  if ($res10 && ($result10=db_fetch_object($res10))) {
    //print_R($result10);
   //echo $_SESSION['staff']['stud_info'];
    $pic_path=$result10->filepath;
/*    $host=$_SERVER['HTTP_HOST'];
    $repalce=$_SERVER['DOCUMENT_ROOT'];
    $file_path='http://';
    $file_path .=str_replace($repalce, $host, $pic_path);
    $file_path = strip_tags($file_path);*/
    $file_path = file_create_url($pic_path);
    //$path='<img src="'.$file_path.'" />';
  }
  else {
    //$path='No Images Available';
  }
  return $file_path;
}
function staff_begin_clearance_form4(&$obj) {
  $message=drupal_mail(
    'staff',
    'rejection',
    $_SESSION['student']['data']->email_address,
    language_default(),
    array(),
    NULL,
    FALSE);
  $message['body']=veritas_student_receipt($f, TRUE);
  $message['subject']='Transaction Receipt';
  $message['headers'] = array_merge(
    $message['headers'],
    array( 'MIME-Version' => '1.0',
      'Content-Type'  => 'text/html;
 charset=UTF-8'));
  drupal_mail_send($message);
}
function staff_cleared_student() {
  $msg=$_SESSION['staff']['msg'];
  ob_start();
?>
  <center><h5><? echo $msg; ?></h5>
<?php
  $d=ob_get_clean();
  return $d;
}
function staff_notcleared_student() {
  global $user;

/*
  if (!isset($_SESSION['staff']['data']->staff_id)) {
    drupal_goto('user');
  }*/
  if (!veritas_has_role($user, 'Registrar')) {
    $_SESSION['staff']['msg']='You are not authorized to access this page.';
    drupal_goto('staff/cleared');
  }
  ob_start();
  if (isset($_SESSION['staff']['mat'])) {
    unset($_SESSION['staff']['mat']);
  }
  /*Query to fetch all the data's from student, department and college table.*/
  $qry2 = "
    SELECT `as`.*, d.field_department_name_value AS department_name, c.field_college_name_value AS college_name
    FROM {admitted_student} `as`, {content_type_program} p, {content_type_department} d, {content_type_college} c
    WHERE as.first_choice=p.nid AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid AND as.clearance_status=2 ORDER BY a.last_name ASC";
  $result2 = db_query($qry2);
  //echo db_error();
  if (!db_fetch_object($result2)) {
    drupal_set_message('No students for clearance.');
  }
?>
  <table border='1' align='center'>
  <tr bgcolor='#ACCFCC'><td colspan='7'><b>Not Cleared Student List</b></td></tr>
  <tr><td><b>Mat. No.</b></td><td><b>Last Name</b></td><td><b>Middle Name</b></td><td><b>First Name </b></td><td><b>College</b></td><td><b>Department</b></td><!--<td><b>Clearance Date</b></td>--></tr>
<?php
  while ($f=db_fetch_object($result2)) {
?>
    <tr>
    <td><a href='<?php echo 'begin_clearance/'. $f->matriculation_no;?>'><?php echo $f->matriculation_no;?></a></td>
    <!--<td><? url('begin_clearance');?><? $data[]=$f->matriculation_no; $_SESSION['staff']['mat']=$data; echo $f->matriculation_no; ?></td>-->
    <td><?php echo $f->last_name; ?></td>
    <td><?php echo $f->middle_name; ?></td>
    <td><? echo $f->first_name; ?></td>
    <!--<td><? echo $f->matriculation_no; ?></td>-->
    <td><?php echo $f->college_name; ?></td>
    <td><?php echo $f->department_name; ?></td>
    <!--<td><? echo $f->clearance_date; ?></td>-->
    </tr>
<?php
  }
?>
  </table>
<?php
  return ob_get_clean();
}
function staff_create_ar_form(&$obj) {
  if (!$obj['storage']['step'])
    $obj['storage']['step']=1;
  $st=$obj['storage']['step'];
  if ($st==1)
    return staff_create_ar_form1($obj);
}
function staff_create_ar_form1(&$obj) {
  global $user;

  if (!isset($_SESSION['staff']['data']->staff_id)) {
    drupal_goto('user');
  }
  if (!veritas_has_role($user, 'Registrar')) {
    $_SESSION['staff']['msg']='You are not authorized to view this page.';
    drupal_goto('staff/cleared');
  }
  $form['#title']=t('Create Staff Profile');
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['title0'] = array(
    '#type' => 'item',
    '#title' => 'Title',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['title1'] = array(
    '#type' => 'select',
    '#options' => _veritas_titles(),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['fname0'] = array(
    '#title' => 'First Name',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#title' => 'Middle Name',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['lname0'] = array(
    '#title' => 'Last Name',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space1'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['maidname0'] = array(
    '#title' => 'Maiden Name',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['maidname1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#title' => 'Gender',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'select',
    '#options' => array(
      'M' => 'Male',
      'F' => 'Female'),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space2'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['blood0'] = array(
    '#title' => 'Blood Group',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['blood1'] = array(
    '#type' => 'select',
    '#options' => array(
      'O+' => 'O+',
      'O-' => 'O-',
      'A+' => 'A+',
      'A-' => 'A-',
      'B+' => 'B+',
      'B-' => 'B-',
      'AB+' => 'AB+',
      'AB-' => 'AB-'),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'date',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space3'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'select',
    '#options' => array('married' => 'Married', 'single' => 'Single'),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['address'] = array(
    '#type' => 'fieldset',
    '#title' => 'Address Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['address']['nation0'] = array(
    '#title' => 'Nationality',
    '#type' => 'item',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['address']['nation1'] = array(
    '#type' => 'select',
    '#options' => _veritas_country(),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['address']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['address']['state0'] = array(
    '#title' => 'State',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['address']['state1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['address']['add0'] = array(
    '#title' => 'Address',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['address']['add1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#size' => 30);
  $form['address']['space1'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['address']['city0'] = array(
    '#title' => 'City',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['address']['city1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#size' => 30);
  $form['address']['tel0']  = array(
    '#title' => 'Telephone',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['address']['tel1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#size' => 30);
  $form['address']['space2'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['address']['gsm0'] = array(
    '#title' => 'GSM',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['address']['gsm1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#size' => 30);
  $form['address']['pemail0'] = array(
    '#title' => 'Personal Email',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['address']['pemail1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#size' => 30);
  $form['address']['space3'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['address']['location0'] = array(
    '#title' => 'Location',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['address']['location1'] = array(
    '#type' => 'textfield',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#size' => 30);
  $form['address']['lga0'] = array(
    '#title' => 'LGA',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['address']['lga1'] = array(
    '#type' => 'select',
    '#options' => veritas_lga(),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['loginfo'] = array(
    '#type' => 'fieldset',
    '#title' => 'Account Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['loginfo']['user0'] = array(
    '#title' => 'User Name',
    '#type' => 'item',
    '#required' => TRUE,
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['loginfo']['user1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['loginfo']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['loginfo']['uemail0'] = array(
    '#title' => 'University Email',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['loginfo']['uemail1'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['loginfo']['newpass0'] = array(
    '#title' => 'New Password',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['loginfo']['newpass1'] = array(
    '#type' => 'password',
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#size' => 20);
  $form['loginfo']['space1'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['loginfo']['confpass0'] = array(
    '#title' => 'Confirm Password',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['loginfo']['confpass1'] = array(
    '#type' => 'password',
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['loginfo']['type0'] = array(
    '#title' => 'Staff Type',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['loginfo']['type1'] = array(
    '#type' => 'select',
    '#options' => find_staff(),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['loginfo']['space2'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['loginfo']['dept0'] = array(
    '#title' => 'Department',
    '#type' => 'item',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['loginfo']['dept1'] = array(
    '#type' => 'select',
    '#options' => find_dept(),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['loginfo']['college0'] = array(
    '#title' => 'Assign College',
    '#type' => 'item',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['loginfo']['college1'] = array(
    '#type' => 'select',
    '#options' => find_college(),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['submit'] = array(
    '#id' => 'enter',
    '#value' => 'Submit',
    '#type' => 'submit');
  return $form;
}
/*function staff_create_ar_form_validate($form,&$state)
{
 if ($state['storage']['step'] == 1)
 {

       $values=$form['loginfo']['#post'];
    if ($values['user1']!='')
   {
   if ($values['newpass1']!='')
  {

             if ($values['confpass1']=='')
   {
     drupal_set_message('Please enter confirmation password');
   }

  }

   if ($values['confpass1']!='')
  {

             if ($values['newpass1']=='')
   {
     drupal_set_message('Please enter new password');
   }

  }
        if ($values['newpass1']=='' && $values['confpass1']=='')
  {
           drupal_set_message('Please specify password.');
  }
  }
     if ($values['newpass1']!='')
  {
   if ($values['confpass1']!='')
  {

             if ($values['user1']=='')
   {
     drupal_set_message('Please enter user id.');
   }

  }

  }
}

}*/
function staff_create_ar_form_submit($form, &$state) {
  if ($state['storage']['step'] == 1) {
    $values=$form['loginfo']['#post'];
    if ($values['user1'] != '') {
      if ($values['newpass1'] != '') {
        if ($values['confpass1'] == '') {
          drupal_set_message('Please enter confirmation password');
        }
      }
      if ($values['confpass1'] != '') {
        if ($values['newpass1'] == '') {
          drupal_set_message('Please enter new password');
        }
      }
      if ($values['newpass1'] == '' && $values['confpass1'] == '') {
        drupal_set_message('Please specify password.');
      }
    }
    if ($values['newpass1'] != '') {
      if ($values['confpass1']!='') {
        if ($values['user1'] == '') {
          drupal_set_message('Please enter user id.');
        }
      }
    }
    add_registrar($form);
  }
}
function add_registrar($form) {
  $result1 = $form['personal']['#post'];
  $result2 = $form['address']['#post'];
  $result3 = $form['loginfo']['#post'];
}
function find_college() {
  $qry = "SELECT nid, field_college_abbreviation_value AS value FROM {content_type_college} ORDER BY field_college_abbreviation_value";
  $res = db_query($qry);
  while ($result = db_fetch_object($res)) {
    $titles[$result->nid] = $result->value;
  }
  return $titles;
}
function find_staff() {
  $qry="select * from `staff_type`";
  $res=db_query($qry);
  while ($result=db_fetch_object($res)) {
    $titles[$result->staff_type_id]=$result->staff_type_name;
  }
  return $titles;
}
function find_dept() {
  $titles = array();
  $r = db_query("SELECT nid, field_department_name_value AS value FROM {content_type_department} ORDER BY field_department_name_value");
  while ($f = db_fetch_object($r)) {
    $titles[$f->nid] = $f->value;
  }
  return $titles;
}
function view_student_form1(&$obj) {
  if (isset($_SESSION['staff']['mat'])) {
    unset($_SESSION['staff']['mat']);
  }
  if (isset($_SESSION['staff']['jamb'])) {
    unset($_SESSION['staff']['jamb']);
  }
  $form['#title'] = t('Search Student');
  $form['matno'] = array(
    '#title' => 'Matriculation No .',
    '#type' => 'textfield',
    '#default_value' => $_POST['matno'],
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['jambno'] = array(
    '#title' => 'JAMB No .',
    '#default_value' => $_POST['jambno'],
    '#type' => 'textfield',
    '#size' => 20);
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  return $form;
}
function view_student_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    // Prevent the counter from going beyond 2
    $state['storage']['step'] = (++$state['storage']['step'] > 2) ? 1 : $state['storage']['step'];
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function view_student_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    $values=$form['lbl_or']['#post'];
    $jambno=$values['jambno'];
    if ($form['#post']['matno'] != '' && $jambno!='') {
      drupal_set_message('Please enter either Matriculation no or JAMB no.');
    }
    else {
      if ($jambno != '' && $form['#post']['matno']=='') {
        $qry = "select * from {admitted_student} where jambno='%s'";
        $res = db_query($qry, $jambno);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
          $_SESSION['staff']['jamb']=$jambno;
        }
        else {
          form_set_error('jambno', "Jamb number not valid.");
        }
      }
      else {
        $qry = "select * from {admitted_student} where matriculation_no='%s'";
        $res = db_query($qry, $form['#post']['matno']);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
        }
        else {
          form_set_error('matno', "Matriculation number not valid.");
        }
      }
    }
  }
}
function view_student_form2(&$obj) {
  global $user;

  if (isset($_SESSION['staff']['jamb'])) {
    $qry = "select * from {admitted_student} where jambno='%s'";
    $res = db_query($qry, $_SESSION['staff']['jamb']);
  }
  else {
    $qry = "select * from {admitted_student} where matriculation_no='%s'";
    $res = db_query($qry, $_SESSION['staff']['mat']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['stud_info']=$result->student_id;
    $qry1 = "select * from {admitted_next_of_kin} where student_id='". $result->student_id ."'";
    $res1 = db_query($qry1, $result->student_id);
    if ($res1 && ($result1=db_fetch_object($res1))) {
      $qry2 = "SELECT a.ext_exam_rec_id, a.exam_body, a.exam_date, a.exam_center_name, a.exam_number, b.exam_body_name FROM `admitted_ext_exam_record` AS a LEFT OUTER JOIN ext_exam_body AS b ON a.exam_body=b.exam_body_id WHERE a.exam_student_id=%d";
      $res2 = db_query($qry2, $result->student_id);

      $data_key = array();
      while ($result2 = db_fetch_object($res2)) {
        $data[$result2->ext_exam_rec_id] = array(
          'exam_body' => $result2->exam_body,
          'exam_date' => $result2->exam_date,
          'exam_center_name' => $result2->exam_center_name,
          'exam_number' => $result2->exam_number,
        );
        $query3 = "SELECT * FROM admitted_ext_exam_detail WHERE ext_exam_record_id=%d";
        $r=db_query($query3, $result2->ext_exam_rec_id);
        while ($f=db_fetch_object($r)) {
          $data[$result2->ext_exam_rec_id]['subjects'][] = array('subject' => $f->subject_id, 'grade' => $f->grade_id);
          if (!in_array($result2->ext_exam_rec_id, $data_key)) {
            $data_key[] = $result2->ext_exam_rec_id;
          }
        }
      }

      $qry4 = "SELECT
          p.nid AS programme_id,
          p.field_programme_name_value AS programme_name,
          d.nid AS department_id,
          d.field_department_name_value AS department_name,
          c.field_college_abbreviation_value AS college_abbreviation,
          c.field_college_name_value AS college_name
        FROM {content_type_program} p, {content_type_department} d, {content_type_college} c
        WHERE p.nid=%d AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid";
      $res4 = db_query($qry4, $result->first_choice);
      $result4 = db_fetch_object($res4);
      $qry5 = "select a . session_id, b . sess_name from `current_session_semester` as a join session as b on a . session_id=b . session_id";
      $res5 = db_query($qry5);
      $result5 = db_fetch_object($res5);
      $qry6 = "select * from `admitted_next_of_kin` where student_id='". $result->student_id ."'";
      $res6 = db_query($qry6);
      $result6 = db_fetch_object($res6);
      $qry7 = "select * from `admitted_sponsor` where student_id='". $result->student_id ."'";
      $res7 = db_query($qry7);
      $result7 = db_fetch_object($res7);
    }
  }
  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Admission Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['img_lbl0'] = array(
    '#type' => 'item',
    '#title' => 'Student Image',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['img_lbl1'] = array(
    '#value' => '<img src="'. load_image() .'" width="200" />',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['img_sig0'] = array(
    '#type' => 'item',
    '#title' => 'Student Signature',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig1'] = array(
    '#value' => '<img src="'. load_signature() .'" width="300" />',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['extra']['college0'] = array(
    '#type' => 'item',
    '#title' => 'College',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['college1'] = array(
    '#type' => 'item',
    '#value' => $result4->college_abbreviation,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept0'] = array(
    '#type' => 'item',
    '#title' => 'Department',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept1'] = array(
    '#type' => 'item',
    '#value' => $result4->department_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme0'] = array(
    '#type' => 'item',
    '#title' => 'Programme',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme1'] = array(
    '#type' => 'item',
    '#value' => $result4->programme_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['study_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Study',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['study_mode1'] = array(
    '#type' => 'item',
    '#value' => $result->mode_of_study,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['space14'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['extra']['entry_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Entry',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_mode1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->mode_of_entry,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess0'] = array(
    '#type' => 'item',
    '#title' => 'SESSION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess1'] = array(
    '#type' => 'item',
    '#value' => $result5->sess_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['img_lbl0'] = array(
    '#type' => 'item',
    '#title' => 'Student Image',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['img_lbl1'] = array(
    '#value' => '<img src="'. load_image() .'" width="200" />',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['img_sig0'] = array(
    '#type' => 'item',
    '#title' => 'Student Signature',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig1'] = array(
    '#value' => '<img src="'. load_signature() .'" width="300" />',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['matno0'] = array(
    '#type' => 'item',
    '#title' => 'Matriculation No.',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['matno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->matriculation_no,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['jambno0'] = array(
    '#type' => 'item',
    '#title' => 'JAMB No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['jambno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->jambno,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->first_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space1'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->middle_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space2'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->last_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $result->dob,
    '#prefix' => '<td colspan="7">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->gender,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space3'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->state_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['lga0'] = array(
    '#type' => 'item',
    '#title' => 'LGA Of Origin',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['lga1'] = array(
    '#type' => 'select',
    '#options' => veritas_lga(),
    '#default_value' => $result->lkup_lga_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space4'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => $result->marital_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Permanent Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->permanent_address1,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space5'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['city1'] = array(
    '#type' => 'item',
    '#value' => $result->permanent_address_city,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['state0'] = array(
    '#type' => 'item',
    '#title' => 'State',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['state1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->permanent_address_state,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space6'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result->mobile_number,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $result->email_address,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space15'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['health0'] = array(
    '#type' => 'item',
    '#title' => 'Health Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['health1'] = array(
    '#type' => 'item',
    '#value' => $result->physical_health_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['nextofkin'] = array(
    '#type' => 'fieldset',
    '#title' => 'Sponsor/Next of Kin Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['nextofkin']['nofkin0'] = array(
    '#type' => 'item',
    '#title' => 'Next of Kin Name',
    '#prefix' => '<table cellspacing="10" cellpadding="10"><tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['nofkin1'] = array(
    '#type' => 'item',
    '#value' => $result6->name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['relation0'] = array(
    '#type' => 'item',
    '#title' => 'Relationship',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['relation1'] = array(
    '#type' => 'item',
    '#value' => $result6->relationship,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result6->mobile,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['nextofkin']['sponsor0'] = array(
    '#type' => 'item',
    '#title' => 'Sponsor',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['sponsor1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result7->name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  if ($result7->mobile != $result6->mobile) {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td>');
    $form['nextofkin']['smobile1'] = array(
      '#type' => 'item',
      '#size' => 20,
      '#value' => $result7->mobile,
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  else {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  $form['fs'] = array(
    '#type' => 'fieldset',
    '#title' => 'O-Level Results 1st Sitting',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['fs']['qualification0'] = array(
    '#type' => 'item',
    '#title' => 'QUALIFICATION',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['fs']['qualification1'] = array(
    '#type' => 'item',
    '#value' => $result->h_qualification1,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['space22'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['institution0'] = array(
    '#type' => 'item',
    '#title' => 'INSTITUTION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['institution1'] = array(
    '#type' => 'item',
    '#value' => $result->h_institution1,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['fs']['ebd0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM BODY',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs']['ebd1'] = array(
    '#type' => 'select',
    '#options' => _student_bod(),
    '#default_value' => $data[$data_key[0]]['exam_body'],
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs']['space8'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['edate0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM DATE',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['edate1'] = array(
    '#type' => 'date',
    '#default_value' => array(
      'day' => (int)substr($data[$data_key[0]]['exam_date'], -2),
      'month' => (int)substr($data[$data_key[0]]['exam_date'], 5, 2),
      'year' => substr($data[$data_key[0]]['exam_date'], 0, 4)),
    '#prefix' => '<td>',
    '#element_validate' => array('validate_always_true'),
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs']['ec0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM CENTER',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs']['ec1'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[0]]['exam_center_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['space9'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs']['eno0'] = array(
    '#type' => 'item',
    '#title' => 'EXAM NO',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs']['eno1'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[0]]['exam_number'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['fs']['ms1'] = array(
    '#type' => 'item',
    '#value' => 'SUBJECTS',
    '#prefix' => '<table><tr><td></td><th>',
    '#suffix' => '</th>');
  $form['fs']['ms2'] = array(
    '#type' => 'item',
    '#value' => 'GRADE',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $temp=0;
  for ($i=1;$i<=9;$i++) {
    $temp = $i-1;
    $form['fs']["m1$i"] = array(
      '#value' => '<tr><td>'. $i,
      '#suffix' => '</td>');
    $form['fs']["s1$i"] = array(
      '#type' => 'select',
      '#options' => _student_sub(),
      '#prefix' => '<td>',
      '#suffix' => '</td>',
      '#default_value' => $data[$data_key[0]]['subjects'][$temp]['subject'],
      '#attributes' => array('disabled' => 'disabled'));
    if ($i == 9)
      $tend="</table>";
    $form['fs']["g1$i"] = array(
      '#type' => 'select',
      '#options' => _student_gr(),
      '#prefix' => '<td>',
      '#suffix' => '</td></tr>'. $tend,
      '#default_value' => $data[$data_key[0]]['subjects'][$temp]['grade'],
      '#attributes' => array('disabled' => 'disabled'));
    $temp = 0;
  }
  $form['fs2'] = array(
    '#id' => 'setting_sec',
    '#type' => 'fieldset',
    '#title' => 'O-Level Results 2nd Sitting',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['fs2']['qualification10'] = array(
    '#type' => 'item',
    '#title' => 'QUALIFICATION',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['qualification11'] = array(
    '#type' => 'item',
    '#value' => $result->h_qualification2,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['space25'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['institution10'] = array(
    '#type' => 'item',
    '#title' => 'INSTITUTION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['institution11'] = array(
    '#type' => 'item',
    '#value' => $result->h_institution2,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['fs2']['ebd20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM BODY',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['ebd21'] = array(
    '#type' => 'select',
    '#options' => _student_bod(),
    '#default_value' => $data[$data_key[1]]['exam_body'],
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs2']['space10'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['edate20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM DATE',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['edate21'] = array(
    '#type' => 'date',
    '#default_value' => array(
      'day' => (int)substr($data[$data_key[1]]['exam_date'], -2),
      'month' => (int)substr($data[$data_key[1]]['exam_date'], 5, 2),
      'year' => substr($data[$data_key[1]]['exam_date'], 0, 4)),
    '#prefix' => '<td>',
    '#element_validate' => array('validate_always_true'),
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['fs2']['ec20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM CENTER',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['fs2']['ec21'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $data[$data_key[1]]['exam_center_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['fs2']['eno20'] = array(
    '#type' => 'item',
    '#title' => 'EXAM NO',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['fs2']['eno21'] = array(
    '#type' => 'item',
    '#size' => '20',
    '#value' => $data[$data_key[1]]['exam_number'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['fs2']['ms11']=array(
    '#type' => 'item',
    '#value' => 'SUBJECTS',
    '#prefix' => '<table><tr><td></td><th>',
    '#suffix' => '</th>');
  $form['fs2']['ms12'] = array(
    '#type' => 'item',
    '#value' => 'GRADE',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $tend='';
  for ($i=1;$i<=9;$i++) {
    $temp = $i-1;
    $form['fs2']["m2$i"] = array(
      '#value' => '<tr><td>'. $i,
      '#suffix' => '</td>');
    $form['fs2']["s2$i"] = array(
      '#type' => 'select',
      '#options' => _student_sub(),
      '#prefix' => '<td>',
      '#suffix' => '</td>',
      '#default_value' => $data[$data_key[1]]['subjects'][$temp]['subject'],
      '#attributes' => array('disabled' => 'disabled'));
    if ($i == 9)
      $tend="</table>";
    $form['fs2']["g2$i"] = array(
      '#type' => 'select',
      '#options' => _student_gr(),
      '#prefix' => '<td>',
      '#suffix' => '</td></tr>'. $tend,
      '#default_value' => $data[$data_key[1]]['subjects'][$temp]['grade'],
      '#attributes' => array('disabled' => 'disabled'));
    $temp = 0;
  }
  if (!veritas_has_role($user, 'Registrar')) {
    $form['verify'] = array(
      '#type' => 'fieldset',
      '#title' => 'Verified Results',
      '#collapsed' => TRUE,
      '#collapsible' => TRUE);
    $form['verify']['result'] = array(
      '#type' => 'radios',
      '#title' => 'Is Verified',
      '#attributes' => array('disabled' => 'disabled'),
      '#default_value' => $result->verify_status ? 'yes' : 'no',
      '#options' => array('yes' => 'Yes', 'no' => 'No'));
    $form['clear'] = array(
      '#type' => 'fieldset',
      '#title' => 'Clear Student',
      '#collapsed' => TRUE,
      '#collapsible' => TRUE);
    $form['clear']['cleared'] = array(
      '#type' => 'radios',
      '#title' => 'Is Cleared',
      '#attributes' => array('disabled' => 'disabled'),
      '#default_value' => $result->clearance_status ? 'yes' : 'no',
      '#options' => array('yes' => 'Yes', 'no' => 'No'));
  }
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Continue',
    '#type' => 'submit');
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}
function validate_always_true($element, &$form_state){
  // Defined to provide a means of suppressing certain validation errors
}
function sa_view_student_form1(&$obj) {
  if (isset($_SESSION['staff']['mat'])) {
    unset($_SESSION['staff']['mat']);
  }
  if (isset($_SESSION['staff']['jamb'])) {
    unset($_SESSION['staff']['jamb']);
  }
  $form['#title'] = t('Search Student');
  $form['matno'] = array(
    '#title' => 'Matriculation No .',
    '#type' => 'textfield',
    '#default_value' => $_POST['matno'],
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['jambno'] = array(
    '#title' => 'JAMB No .',
    '#default_value' => $_POST['jambno'],
    '#type' => 'textfield',
    '#size' => 20);
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  return $form;
}
function sa_view_student_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    // Prevent the counter from going beyond 2
    $state['storage']['step'] = (++$state['storage']['step'] > 2) ? 1 : $state['storage']['step'];
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function sa_view_student_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    $values=$form['lbl_or']['#post'];
    $jambno=$values['jambno'];
    if ($form['#post']['matno'] != '' && $jambno!='') {
      drupal_set_message('Please enter either Matriculation no or JAMB no.');
    }
    else {
      if ($jambno != '' && $form['#post']['matno']=='') {
        $qry = "select * from {admitted_student} where jambno='%s'";
        $res = db_query($qry, $jambno);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
          $_SESSION['staff']['jamb']=$jambno;
        }
        else {
          form_set_error('jambno', "Jamb number not valid.");
        }
      }
      else {
        $qry = "select * from {admitted_student} where matriculation_no='%s'";
        $res = db_query($qry, $form['#post']['matno']);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
        }
        else {
          form_set_error('matno', "Matriculation number not valid.");
        }
      }
    }
  }
}
function sa_view_student_form2(&$obj) {
  if (isset($_SESSION['staff']['jamb'])) {
    $qry = "select * from {admitted_student} where jambno='%s'";
    $res = db_query($qry, $_SESSION['staff']['jamb']);
  }
  else {
    $qry = "select * from {admitted_student} where matriculation_no='%s'";
    $res = db_query($qry, $_SESSION['staff']['mat']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['stud_info']=$result->student_id;

    $qry4 = "SELECT
        p.nid AS programme_id,
        p.field_programme_name_value AS programme_name,
        d.nid AS department_id,
        d.field_department_name_value AS department_name,
        c.field_college_abbreviation_value AS college_abbreviation,
        c.field_college_name_value AS college_name
      FROM {content_type_program} p, {content_type_department} d, {content_type_college} c
      WHERE p.nid=%d AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid";
    $res4 = db_query($qry4, $result->first_choice);
    $result4 = db_fetch_object($res4);
    $qry5 = "select a . session_id, b . sess_name from `current_session_semester` as a join session as b on a . session_id=b . session_id";
    $res5 = db_query($qry5);
    $result5 = db_fetch_object($res5);
    $qry7 = "select * from `admitted_sponsor` where student_id='". $result->student_id ."'";
    $res7 = db_query($qry7);
    $result7 = db_fetch_object($res7);
    $qry8 = "SELECT ah.name as `name`, at.name as `type` FROM `accomodation_hostels` ah, `accomodation_types` at, `admitted_student_accomodation` asa WHERE asa.student_id=%d AND ah.id=asa.hostel_id AND at.id=ah.accomodation_type_id";
    $res8 = db_query($qry8, $result->student_id);
    $result8 = db_fetch_object($res8);
  }
  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Admission Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['extra']['college0'] = array(
    '#type' => 'item',
    '#title' => 'College',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['college1'] = array(
    '#type' => 'item',
    '#value' => $result4->college_abbreviation,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept0'] = array(
    '#type' => 'item',
    '#title' => 'Department',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept1'] = array(
    '#type' => 'item',
    '#value' => $result4->department_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme0'] = array(
    '#type' => 'item',
    '#title' => 'Programme',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme1'] = array(
    '#type' => 'item',
    '#value' => $result4->programme_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['study_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Study',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['study_mode1'] = array(
    '#type' => 'item',
    '#value' => $result->mode_of_study,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['space14'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['extra']['entry_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Entry',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_mode1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->mode_of_entry,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess0'] = array(
    '#type' => 'item',
    '#title' => 'SESSION',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['sess1'] = array(
    '#type' => 'item',
    '#value' => $result5->sess_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['img_lbl0'] = array(
    '#type' => 'item',
    '#title' => 'Student Image',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['img_lbl1'] = array(
    '#value' => '<img src="'. load_image() .'" width="200" />',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space11'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['img_sig0'] = array(
    '#type' => 'item',
    '#title' => 'Student Signature',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig1'] = array(
    '#value' => '<img src="'. load_signature() .'" width="300" />',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['matno0'] = array(
    '#type' => 'item',
    '#title' => 'Matriculation No.',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['matno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->matriculation_no,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space0'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['jambno0'] = array(
    '#type' => 'item',
    '#title' => 'JAMB No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['jambno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->jambno,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->first_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->middle_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->last_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $result->dob,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space7'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['hobbies0'] = array(
    '#type' => 'item',
    '#title' => 'Hobbies',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['hobbies1'] = array(
    '#type' => 'item',
    '#value' => $result->hobbies,
    '#prefix' => '<td colspan="4">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->gender,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space3'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->state_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['lga0'] = array(
    '#type' => 'item',
    '#title' => 'LGA Of Origin',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['lga1'] = array(
    '#type' => 'select',
    '#options' => veritas_lga(),
    '#default_value' => $result->lkup_lga_origin,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space4'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => $result->marital_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Permanent Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result->permanent_address1,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space5'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['city1'] = array(
    '#type' => 'item',
    '#value' => $result->permanent_address_city,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['state0'] = array(
    '#type' => 'item',
    '#title' => 'State',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['state1'] = array(
    '#type' => 'select',
    '#options' => veritas_states(),
    '#default_value' => $result->permanent_address_state,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['space6'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result->mobile_number,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $result->email_address,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['space15'] = array(
    '#type' => 'item',
    '#prefix' => '<td>&nbsp;',
    '#suffix' => '</td>');
  $form['personal']['health0'] = array(
    '#type' => 'item',
    '#title' => 'Health Status',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['health1'] = array(
    '#type' => 'item',
    '#value' => $result->physical_health_status,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['nextofkin'] = array(
    '#type' => 'fieldset',
    '#title' => 'Sponsor Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['nextofkin']['sponsor0'] = array(
    '#type' => 'item',
    '#title' => 'Sponsor',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['sponsor1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result7->name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  if ($result7->mobile != $result6->mobile) {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td>');
    $form['nextofkin']['smobile1'] = array(
      '#type' => 'item',
      '#size' => 20,
      '#value' => $result7->mobile,
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  else {
    $form['nextofkin']['smobile0'] = array(
      '#type' => 'item',
      '#title' => 'Mobile',
      '#prefix' => '<td>',
      '#suffix' => '</td></tr></table>');
  }
  $form['accomodation'] = array(
    '#type' => 'fieldset',
    '#title' => 'Accomodation Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['accomodation']['hostelname0'] = array(
    '#type' => 'item',
    '#title' => 'Hostel Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['accomodation']['hostelname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result8->name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['accomodation']['hosteltype0'] = array(
    '#type' => 'item',
    '#title' => 'Hostel Type',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['accomodation']['hosteltype1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result8->type,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Continue',
    '#type' => 'submit');
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}
function view_staff_form1(&$obj) {
  if (isset($_SESSION['staff']['staff_no'])) {
    unset($_SESSION['staff']['staff_no']);
  }
  $form['#title'] = t('Search Staff');
  $form['staff_no'] = array(
    '#title' => 'Staff No.',
    '#type' => 'textfield',
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['user_id'] = array(
    '#title' => 'Staff Name',
    '#type' => 'select',
    '#options' => _get_staff_list());
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  return $form;
}
function _get_staff_list() {
  $q = "SELECT user_id, staff_last_name, staff_first_name FROM {veritas_staff}";
  $rs = db_query($q);
  $staff_list = array(0 => "Select One");

  while ($row = db_fetch_object($rs)) {
    $staff_list[$row->user_id] = sprintf("%s %s", trim($row->staff_last_name), trim($row->staff_first_name));
  }

  return $staff_list;
}
function view_staff_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    // Prevent the counter from going beyond 2
    $state['storage']['step'] = (++$state['storage']['step'] > 2) ? 1 : $state['storage']['step'];
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function view_staff_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    $values=$form['lbl_or']['#post'];
    $staff_no=$values['staff_no'];
    if ($staff_no != '' && !$form['#post']['user_id']) {
      $qry = "select * from {veritas_staff} where staff_no='%s'";
      $res = db_query($qry, $staff_no);
      if ($res && ($result = db_fetch_object($res))) {
        $_SESSION['staff']['staff_no']=$result->staff_no;
        $_SESSION['staff']['user_id']=$result->user_id;
      }
      else {
        form_set_error('staff_no', "Staff number is not valid.");
      }
    }
    else {
      $qry = "select * from {veritas_staff} where user_id=%d";
      $res = db_query($qry, $form['#post']['user_id']);
      if ($res && ($result = db_fetch_object($res))) {
        $_SESSION['staff']['user_id'] = $result->user_id;
      }
      else {
        form_set_error('user_id', "Please select a staff from the list or enter the Staff Number.");
      }
    }
  }
}
function view_staff_form2(&$obj) {
  if (isset($_SESSION['staff']['user_id'])) {
    $qry = "select * from {veritas_staff} where user_id=%d";
    $res = db_query($qry, $_SESSION['staff']['user_id']);
  }
  else {
    $qry = "select * from {veritas_staff} where staff_no='%s'";
    $res = db_query($qry, $_SESSION['staff']['staff_no']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['staff_info']=$result->user_id;
    // TODO: fix the remaining queries
    $q = "SELECT
    st.staff_type_name AS staff_type,
    vsp.name AS staff_position,
    vsg.amount AS salary,
    vsg.salary_grade_level AS grade_level,
    vs.appointment_date,
    vet.name AS employment_type,
    vs.staff_title,
    vs.staff_last_name,
    vs.staff_first_name,
    vs.staff_middle_name,
    vs.dob, vs.nationality,
    c.country_name AS country,
    s.state_name AS state,
    l.lga_name AS lga,
    vs.gender,
    vs.marital_status,
    vs.staff_maiden_name,
    vs.permanent_home_address,
    vs.permanent_city_address,
    vs.tel,
    vs.gsm,
    vs.gsm2,
    vs.university_email,
    b.name AS bank_name,
    vs.account_id
    FROM
    veritas_bank b,
    lga l,
    veritas_staff_type st,
    veritas_staff vs,
    veritas_staff_position vsp,
    veritas_salary_grade vsg,
    veritas_employment_type vet,
    country c,
    state s
    WHERE s.state_id=vs.state
    AND l.lga_id=vs.lga
    AND b.id = vs.bank_id
    AND vet.id=employment_type_id
    AND c.country_id=vs.nationality
    AND vsg.id=vs.grade_level_id
    AND vsp.id=vs.position_id
    AND st.staff_type_id=vs.staff_type_id
    AND vs.user_id=%d";
    $rs = db_query($q, $_SESSION['staff']['staff_info']);
    $result2 = db_fetch_object($rs);
  }

  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Staff Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['extra']['staff_no0'] = array(
    '#type' => 'item',
    '#title' => 'Staff No.',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['staff_no1'] = array(
    '#type' => 'item',
    '#value' => $result->staff_no,
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['extra']['type0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Type',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['type1'] = array(
    '#type' => 'item',
    '#value' => $result2->staff_type,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['posn0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Position',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['posn1'] = array(
    '#type' => 'item',
    '#value' => $result2->staff_position,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['grade0'] = array(
    '#type' => 'item',
    '#title' => 'Grade Level',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['grade1'] = array(
    '#type' => 'item',
    '#value' => $result2->grade_level,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['salary0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Salary',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['salary1'] = array(
    '#type' => 'item',
    '#value' => $result2->salary,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['employ_type0'] = array(
    '#type' => 'item',
    '#title' => 'Employment Type',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['employ_type1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->employment_type,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['appt_date0'] = array(
    '#type' => 'item',
    '#title' => 'Appointment Date',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['appt_date1'] = array(
    '#type' => 'item',
    '#value' => date('jS F, Y', strtotime($result2->appointment_date)),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_first_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_middle_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_last_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $result2->dob,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => ucfirst($result2->gender),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'item',
    '#value' => $result2->state,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['lga0'] = array(
    '#type' => 'item',
    '#title' => 'LGA Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lga1'] = array(
    '#type' => 'item',
    '#value' => $result2->lga,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => ucfirst($result->marital_status),
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Permanent Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->permanent_home_address,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['city1'] = array(
    '#type' => 'item',
    '#value' => $result2->permanent_city_address,
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['tel0'] = array(
    '#type' => 'item',
    '#title' => 'Tel. No.',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['tel1'] = array(
    '#type' => 'item',
    '#value' => $result2->tel,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'GSM No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result2->gsm,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile20'] = array(
    '#type' => 'item',
    '#title' => 'GSM No.(2)',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile21'] = array(
    '#type' => 'item',
    '#value' => $result2->gsm2,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $result2->university_email,
    '#size' => 20,
    '#prefix' => '<td colspan="6">',
    '#suffix' => '</td></tr></table>');
  $form['payment'] = array(
    '#type' => 'fieldset',
    '#title' => 'Payment Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['payment']['bank0'] = array(
    '#type' => 'item',
    '#title' => 'Bank Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['payment']['bank1'] = array(
    '#type' => 'item',
    '#value' => $result2->bank_name,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['acct0'] = array(
    '#type' => 'item',
    '#title' => 'Account Number',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['acct1'] = array(
    '#type' => 'item',
    '#value' => $result2->account_id,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Continue',
    '#type' => 'submit');
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}
function search_staff_form1(&$obj) {
  if (isset($_SESSION['staff']['staff_no'])) {
    unset($_SESSION['staff']['staff_no']);
  }
  $form['#title'] = t('Search Staff');
  $form['staff_no'] = array(
    '#title' => 'Staff No.',
    '#type' => 'textfield',
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['user_id'] = array(
    '#title' => 'Staff Name',
    '#type' => 'select',
    '#options' => _get_staff_list());
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  return $form;
}
function search_staff_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    // Prevent the counter from going beyond 2
    $state['storage']['step'] = (++$state['storage']['step'] > 2) ? 1 : $state['storage']['step'];
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function search_staff_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    $values=$form['lbl_or']['#post'];
    $staff_no=$values['staff_no'];
    if ($staff_no != '' && !$form['#post']['user_id']) {
      $qry = "select * from {veritas_staff} where staff_no='%s'";
      $res = db_query($qry, $staff_no);
      if ($res && ($result = db_fetch_object($res))) {
        $_SESSION['staff']['staff_no']=$result->staff_no;
        $_SESSION['staff']['user_id']=$result->user_id;
      }
      else {
        form_set_error('staff_no', "Staff number is not valid.");
      }
    }
    else {
      $qry = "select * from {veritas_staff} where user_id=%d";
      $res = db_query($qry, $form['#post']['user_id']);
      if ($res && ($result = db_fetch_object($res))) {
        $_SESSION['staff']['user_id'] = $result->user_id;
      }
      else {
        form_set_error('user_id', "Please select a staff from the list or enter the Staff Number.");
      }
    }
  }
}
function search_staff_form2(&$obj) {
  // TODO: Fill out remaining sections
  if (isset($_SESSION['staff']['user_id'])) {
    $qry = "select * from {veritas_staff} where user_id=%d";
    $res = db_query($qry, $_SESSION['staff']['user_id']);
  }
  else {
    $qry = "select * from {veritas_staff} where staff_no='%s'";
    $res = db_query($qry, $_SESSION['staff']['staff_no']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['staff_info']=$result->user_id;
    // TODO: fix the remaining queries
    $q = "SELECT
    st.staff_type_name AS staff_type,
    vsp.name AS staff_position,
    vsg.amount AS salary,
    vsg.salary_grade_level AS grade_level,
    vs.appointment_date,
    vet.name AS employment_type,
    vs.staff_title,
    vs.staff_last_name,
    vs.staff_first_name,
    vs.staff_middle_name,
    vs.dob, vs.nationality,
    c.country_name AS country,
    s.state_name AS state,
    l.lga_name AS lga,
    vs.gender,
    vs.marital_status,
    vs.staff_maiden_name,
    vs.permanent_home_address,
    vs.permanent_city_address,
    vs.temp_home_address,
    vs.temp_city_address,
    vs.tel,
    vs.gsm,
    vs.gsm2,
    vs.university_email,
    vs.personal_email,
    vsk.name AS kin_name,
    vsk.relation_id AS kin_relation_id,
    vsk.address AS kin_address,
    vsk.city AS kin_city,
    vsk.telephone AS kin_telephone,
    vsk.mobile AS kin_mobile,
    vsk.email AS kin_email,
    b.name AS bank_name,
    vs.account_id
    FROM
    veritas_staff_kin vsk,
    veritas_bank b,
    lga l,
    veritas_staff_type st,
    veritas_staff vs,
    veritas_staff_position vsp,
    veritas_salary_grade vsg,
    veritas_employment_type vet,
    country c,
    state s
    WHERE s.state_id=vs.state
    AND l.lga_id=vs.lga
    AND vsk.staff_id = vs.staff_id
    AND b.id = vs.bank_id
    AND vet.id=employment_type_id
    AND c.country_id=vs.nationality
    AND vsg.id=vs.grade_level_id
    AND vsp.id=vs.position_id
    AND st.staff_type_id=vs.staff_type_id
    AND vs.user_id=%d";
    $rs = db_query($q, $_SESSION['staff']['staff_info']);
    $result2 = db_fetch_object($rs);
  }

  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Staff Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['extra']['staff_no0'] = array(
    '#type' => 'item',
    '#title' => 'Staff No.',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['staff_no1'] = array(
    '#type' => 'item',
    '#value' => $result->staff_no,
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['extra']['type0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Type',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['type1'] = array(
    '#type' => 'item',
    '#value' => $result2->staff_type,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['posn0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Position',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['posn1'] = array(
    '#type' => 'item',
    '#value' => $result2->staff_position,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['grade0'] = array(
    '#type' => 'item',
    '#title' => 'Grade Level',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['grade1'] = array(
    '#type' => 'item',
    '#value' => $result2->grade_level,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['salary0'] = array(
    '#type' => 'item',
    '#title' => 'Staff Salary',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['salary1'] = array(
    '#type' => 'item',
    '#value' => $result2->salary,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['employ_type0'] = array(
    '#type' => 'item',
    '#title' => 'Employment Type',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['employ_type1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->employment_type,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['appt_date0'] = array(
    '#type' => 'item',
    '#title' => 'Appointment Date',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['appt_date1'] = array(
    '#type' => 'item',
    '#value' => date('jS F, Y', strtotime($result2->appointment_date)),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_first_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_middle_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->staff_last_name,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $result2->dob,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => ucfirst($result2->gender),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'item',
    '#value' => $result2->state,
    '#prefix' => '<td>',
    '#suffix' => '</td>',
    '#attributes' => array('disabled' => 'disabled'));
  $form['personal']['lga0'] = array(
    '#type' => 'item',
    '#title' => 'LGA Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lga1'] = array(
    '#type' => 'item',
    '#value' => $result2->lga,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => ucfirst($result->marital_status),
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Permanent Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->permanent_home_address,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['city1'] = array(
    '#type' => 'item',
    '#value' => $result2->permanent_city_address,
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['t_address0'] = array(
    '#type' => 'item',
    '#title' => 'Temporary Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['t_address1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $result2->temp_home_address,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['t_city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['t_city1'] = array(
    '#type' => 'item',
    '#value' => $result2->temp_city_address,
    '#size' => 20,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['tel0'] = array(
    '#type' => 'item',
    '#title' => 'Tel. No.',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['tel1'] = array(
    '#type' => 'item',
    '#value' => $result2->tel,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'GSM No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $result2->gsm,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile20'] = array(
    '#type' => 'item',
    '#title' => 'GSM No.(2)',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile21'] = array(
    '#type' => 'item',
    '#value' => $result2->gsm2,
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $result2->university_email,
    '#size' => 20,
    '#prefix' => '<td colspan="6">',
    '#suffix' => '</td></tr></table>');
  $form['nextofkin'] = array(
    '#type' => 'fieldset',
    '#title' => 'Next of Kin Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  // TODO: From here
  $form['nextofkin']['kin_name0'] = array(
    '#type' => 'item',
    '#title' => 'Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_name1'] = array(
    '#type' => 'item',
    '#value' => $result2->kin_name,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_relation0'] = array(
    '#type' => 'item',
    '#title' => 'Relationship',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_relation1'] = array(
    '#type' => 'item',
    '#value' => (is_array(_staff_rel($result2->kin_relation_id))) ? "Not Defined" : _staff_rel($result2->kin_relation_id),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_address0'] = array(
    '#type' => 'item',
    '#title' => 'Address',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_address1'] = array(
    '#type' => 'item',
    '#value' => $result2->kin_address,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['nextofkin']['kin_city0'] =array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_city1'] =array(
    '#type' => 'item',
    '#value' => $result2->kin_city,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_telephone0'] = array(
    '#type' => 'item',
    '#title' => 'Telephone',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_telephone1'] = array(
    '#type' => 'item',
    '#value' => $result2->kin_telephone,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_mobile1'] = array(
    '#type' => 'item',
    '#value' => $result2->kin_mobile,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['nextofkin']['kin_email0'] = array(
    '#type' => 'item',
    '#title' => 'Email',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['nextofkin']['kin_email1'] = array(
    '#type' => 'item',
    '#value' => $result2->kin_email,
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr></table>');
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Continue',
    '#type' => 'submit');
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}
function _staff_rel($id = 0) {
  static $titles;
  if (!$titles) {
    $r = db_query("select * from {kin_relationship} order by relation");
    while ($f = db_fetch_object($r))
      $titles[$f->relid]=trim($f->relation);
  }
  return ($id) ? $titles[$id] : $titles;
}
function view_student_payments_form1(&$obj) {
  if (isset($_SESSION['staff']['mat'])) {
    unset($_SESSION['staff']['mat']);
  }
  if (isset($_SESSION['staff']['jamb'])) {
    unset($_SESSION['staff']['jamb']);
  }
  $form['#title'] = t('Search Student');
  $form['matno'] = array(
    '#title' => 'Matriculation No .',
    '#type' => 'textfield',
    '#default_value' => $_POST['matno'],
    '#size' => 20);
  $form['lbl_or'] = array(
    '#type' => 'fieldset',
    '#title' => 'Or');
  $form['lbl_or']['jambno'] = array(
    '#title' => 'JAMB No .',
    '#default_value' => $_POST['jambno'],
    '#type' => 'textfield',
    '#size' => 20);
  $form['submit'] = array(
    '#value' => 'Next',
    '#type' => 'submit',
    '#id' => 'edit-next');
  $form['download'] = array(
    '#type' => 'markup',
    '#value' => '<input ' . drupal_attributes(array('type' => 'button', 'value' => 'Download Payments Data', 'onclick' => "location.href='".url('staff/download_studentpayments')."';")) . "/>");
  return $form;
}
function view_student_payments_form_submit($form, &$state) {
  if ($state['clicked_button']['#id'] == 'edit-previous') {
    $state['storage']['step']--;
    return;
  }
  elseif ($state['clicked_button']['#id'] == 'edit-next') {
    $state['storage']['values'][$state['storage']['step']]=$state['values'];
    // Prevent the counter from going beyond 2
    $state['storage']['step'] = (++$state['storage']['step'] > 2) ? 1 : $state['storage']['step'];
    $state['#rebuild']=TRUE;
  }
  else
    return;
}
function view_student_payments_form_validate($form, &$state) {
  global $user;

  if ($state['storage']['step'] == 1) {
    $values=$form['lbl_or']['#post'];
    $jambno=$values['jambno'];
    if ($form['#post']['matno'] != '' && $jambno!='') {
      drupal_set_message('Please enter either Matriculation no or JAMB no.');
    }
    else {
      if ($jambno != '' && $form['#post']['matno']=='') {
        $qry = "select * from {admitted_student} where jambno='%s'";
        $res = db_query($qry, $jambno);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
          $_SESSION['staff']['jamb']=$jambno;
        }
        else {
          form_set_error('jambno', "Jamb number not valid.");
        }
      }
      else {
        $qry = "select * from {admitted_student} where matriculation_no='%s'";
        $res = db_query($qry, $form['#post']['matno']);
        if ($res && ($result = db_fetch_object($res))) {
          $_SESSION['staff']['mat']=$result->matriculation_no;
        }
        else {
          form_set_error('matno', "Matriculation number not valid.");
        }
      }
    }
  }
}
function view_student_payments_form2(&$obj) {
  if (isset($_SESSION['staff']['jamb'])) {
    $qry = "select * from {admitted_student} where jambno='%s'";
    $res = db_query($qry, $_SESSION['staff']['jamb']);
  }
  else {
    $qry = "select * from {admitted_student} where matriculation_no='%s'";
    $res = db_query($qry, $_SESSION['staff']['mat']);
  }
  if ($res && ($result=db_fetch_object($res))) {
    $_SESSION['staff']['stud_info']=$result->student_id;
    $results = student_payment_data($result->student_id);
    $debtor_prefix = "DEBTOR " . variable_get('veritas_current_session', '');

    // Obtain transactions made this session
    $q = "SELECT at.receipt_no, at.trans_amount, at.trans_time FROM {admitted_transaction} at, {session} s WHERE s.session_id=at.session_id AND at.student_id=%d AND s.sess_name='%s'";
    $rs = db_query($q, $result->student_id, variable_get('veritas_current_session', ''));
    $payments = array();
    while ($row = db_fetch_array($rs)):
      $payments[] = $row;
    endwhile;
  }
  $form['extra'] = array(
    '#type' => 'fieldset',
    '#title' => 'Admission Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['extra']['college0'] = array(
    '#type' => 'item',
    '#title' => 'College',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['extra']['college1'] = array(
    '#type' => 'item',
    '#value' => $results['admission_college'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept0'] = array(
    '#type' => 'item',
    '#title' => 'Department',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['dept1'] = array(
    '#type' => 'item',
    '#value' => $results['admission_department'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme0'] = array(
    '#type' => 'item',
    '#title' => 'Programme',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['programme1'] = array(
    '#type' => 'item',
    '#value' => $results['admission_programme'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['extra']['study_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Study',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['extra']['study_mode1'] = array(
    '#type' => 'item',
    '#value' => $results['admission_mode_of_study'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_mode0'] = array(
    '#type' => 'item',
    '#title' => 'Mode of Entry',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_mode1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['admission_mode_of_entry'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_year0'] = array(
    '#type' => 'item',
    '#title' => 'Year of Study',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['extra']['entry_year1'] = array(
    '#type' => 'item',
    '#value' => $results['admission_year_of_study'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>',
    '#size' => 15);
  $form['personal'] = array(
    '#type' => 'fieldset',
    '#title' => 'Personal Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['personal']['img_lbl0'] = array(
    '#type' => 'item',
    '#title' => 'Student Image',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['img_lbl1'] = array(
    '#value' => '<img src="'. load_image() .'" width="200" />',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig0'] = array(
    '#type' => 'item',
    '#title' => 'Student Signature',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['img_sig1'] = array(
    '#value' => '<img src="'. load_signature() .'" width="300" />',
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['personal']['matno0'] = array(
    '#type' => 'item',
    '#title' => 'Matriculation No.',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['personal']['matno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['matriculation_no'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['jambno0'] = array(
    '#type' => 'item',
    '#title' => 'JAMB No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['jambno1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['jamb_no'],
    '#prefix' => '<td colspan="3">',
    '#suffix' => '</td></tr>');
  $form['personal']['fname0'] = array(
    '#type' => 'item',
    '#title' => 'First Name',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['fname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['first_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname0'] = array(
    '#type' => 'item',
    '#title' => 'Middle Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['middle_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname0'] = array(
    '#type' => 'item',
    '#title' => 'Last Name',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['lname1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['last_name'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['personal']['dob0'] = array(
    '#type' => 'item',
    '#title' => 'Date of Birth',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['dob1'] = array(
    '#type' => 'item',
    '#value' => $results['birth_date'],
    '#prefix' => '<td colspan="5">',
    '#suffix' => '</td></tr>');
  $form['personal']['gender0'] = array(
    '#type' => 'item',
    '#title' => 'Gender',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['gender1'] = array(
    '#type' => 'item',
    '#size' => 20,
    '#value' => $results['gender'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin0'] = array(
    '#type' => 'item',
    '#title' => 'State Of Origin',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['origin1'] = array(
    '#type' => 'item',
    '#value' => $results['state_of_origin'],
    '#prefix' => '<td colspan="3">',
    '#suffix' => '</td></tr>');
  $form['personal']['mstatus0'] = array(
    '#type' => 'item',
    '#title' => 'Marital Status',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['personal']['mstatus1'] = array(
    '#type' => 'item',
    '#value' => $results['marital_status'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $results['personal_mobile'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['email0'] = array(
    '#type' => 'item',
    '#title' => 'E-mail address',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['personal']['email1'] = array(
    '#type' => 'item',
    '#value' => $results['personal_email'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['sponsor'] = array(
    '#type' => 'fieldset',
    '#title' => 'Sponsor Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['sponsor']['sponsor0'] = array(
    '#type' => 'item',
    '#title' => 'Sponsor Name',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['sponsor']['sponsor1'] = array(
    '#type' => 'item',
    '#value' => $results['sponsor_name'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['tel0'] = array(
    '#type' => 'item',
    '#title' => 'Telephone No.',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['tel1'] = array(
    '#type' => 'item',
    '#value' => $results['sponsor_tel'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['mobile0'] = array(
    '#type' => 'item',
    '#title' => 'Mobile',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['mobile1'] = array(
    '#type' => 'item',
    '#value' => $results['sponsor_mobile'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['sponsor']['address0'] = array(
    '#type' => 'item',
    '#title' => 'Address',
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['sponsor']['address1'] = array(
    '#type' => 'item',
    '#value' => $results['sponsor_address'],
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['city0'] = array(
    '#type' => 'item',
    '#title' => 'City',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['sponsor']['city1'] = array(
    '#type' => 'item',
    '#value' => $results['sponsor_city'],
    '#prefix' => '<td colspan="3">',
    '#suffix' => '</td></tr></table>');
  $form['hostel'] = array(
    '#type' => 'fieldset',
    '#title' => 'Accomodation Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['hostel']['hostel0'] = array(
    '#type' => 'item',
    '#title' => 'Hostel',
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['hostel']['hotel1'] = array(
    '#type' => 'item',
    '#value' => $results['hostel_name'],
    '#size' => 20,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['hostel']['type0'] = array(
    '#type' => 'item',
    '#title' => 'Space Type',
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['hostel']['type1'] = array(
    '#type' => 'item',
    '#value' => $results['hostel_type'],
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  $form['payment'] = array(
    '#type' => 'fieldset',
    '#title' => 'Payment Information',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $form['payment']['accomodation0'] = array(
    '#type' => 'item',
    '#title' => $debtor_prefix . " ACCOMODATION",
    '#prefix' => '<table><tr><td>',
    '#suffix' => '</td>');
  $form['payment']['accomodation1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['debtor_accomodation'],2),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['tuition0'] = array(
    '#type' => 'item',
    '#title' => $debtor_prefix . " TUITION" ,
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['tuition1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['debtor_tuition'],2),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['payment']['others0'] = array(
    '#type' => 'item',
    '#title' => $debtor_prefix . " OTHER CHARGES",
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['payment']['others1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['debtor_others'],2),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['total_session0'] = array(
    '#type' => 'item',
    '#title' => "TOTAL SESSION FEES PAYABLE",
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['total_session1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['total_session_payable'], 2),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr>');
  $form['payment']['previous_sessions0'] = array(
    '#type' => 'item',
    '#title' => variable_get('veritas_current_session', '') . " FEE DEBT B/F",
    '#prefix' => '<tr><td>',
    '#suffix' => '</td>');
  $form['payment']['previous_sessions1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['total_outstanding_payable'], 2),
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['total_paybal0'] = array(
    '#type' => 'item',
    '#title' => "TOTAL FEES PAYABLE",
    '#prefix' => '<td>',
    '#suffix' => '</td>');
  $form['payment']['total_payable1'] = array(
    '#type' => 'item',
    '#value' => number_format($results['total_session_payable'] + $results['total_outstanding_payable'], 2),
    '#prefix' => '<td>',
    '#suffix' => '</td></tr></table>');
  // Section for payments
  $form['payment_history'] = array(
    '#type' => 'fieldset',
    '#title' => 'Payments History',
    '#collapsed' => TRUE,
    '#collapsible' => TRUE);
  $output = "";
  foreach ($payments as $payment):
    $output .= sprintf("<tr><td>%s</td><td>%s</td><td>%s</td></tr>", $payment['trans_time'], $payment['receipt_no'], number_format($payment['trans_amount'], 2));
  endforeach;
  $form['payment_history']['history'] = array(
    '#type' => 'item',
    '#value' => $output,
    '#prefix' => '<table><tr><th>Date</th><th>Receipt No.</th><th>Amount Paid</th></tr>',
    '#suffix' => '</table>');
  $form['submit'] = array(
    '#id' => 'edit-next',
    '#value' => 'Continue',
    '#type' => 'submit');
  $form['download'] = array(
    '#type' => 'markup',
    '#value' => '<input ' . drupal_attributes(array('type' => 'button', 'value' => 'Download Payments Data', 'onclick' => "location.href='".url('staff/download_studentpayments')."';")) . "/>");
  $form['#multistep']=TRUE;
  $form['#redirect']=FALSE;
  return $form;
}

function student_payment_data($student_id) {
  $res = db_query("SELECT * FROM {admitted_student} WHERE student_id=%d", $student_id);
  $return = array();

  if ($result = db_fetch_object($res)):
    $return['first_name'] = $result->first_name;
    $return['last_name'] = $result->last_name;
    $return['middle_name'] = $result->middle_name;
    $return['matriculation_no'] = $result->matriculation_no;
    $return['jamb_no'] = $result->jambno;
    $return['birth_date'] = $result->dob;
    $return['gender'] = $result->gender;
    $return['state_of_origin'] = veritas_states($result->state_origin);
    $return['marital_status'] = $result->marital_status;
    $return['personal_mobile'] = $result->mobile_number;
    $return['personal_email'] = $result->email_address;

    $qry2 = "SELECT
        p.nid AS programme_id,
        p.field_programme_name_value AS programme_name,
        d.nid AS department_id,
        d.field_department_name_value AS department_name,
        c.field_college_abbreviation_value AS college_abbreviation,
        c.field_college_name_value AS college_name
      FROM {content_type_program} p, {content_type_department} d, {content_type_college} c
      WHERE p.nid=%d AND p.field_department_id_nid=d.nid AND d.field_college_id_nid=c.nid";
    $res2 = db_query($qry2, $result->first_choice);
    $result2 = db_fetch_object($res2);

    $return['admission_college'] = $result2->college_abbreviation;
    $return['admission_department'] = $result2->department_name;
    $return['admission_programme'] = $result2->programme_name;
    $return['admission_mode_of_study'] = $result->mode_of_study;
    $return['admission_mode_of_entry'] = $result->mode_of_entry;
    $return['admission_year_of_study'] = $result->yearofentry;

    $qry4 = "SELECT * FROM {admitted_sponsor} WHERE student_id=%d";
    $res4 = db_query($qry4, $student_id);
    $result4 = db_fetch_object($res4);
    $return['sponsor_name'] = $result4->name;
    $return['sponsor_tel'] = $result4->telephone;
    $return['sponsor_mobile'] = $result4->mobile;
    $return['sponsor_address'] = $result4->address1;
    $return['sponsor_city'] = $result4->city;

    $qry5 = "SELECT asa.college_id, ah.cost, ah.name, at.name AS type FROM admitted_student_accomodation asa,
    accomodation_types at, accomodation_hostels ah WHERE asa.student_id=%d AND ah.id=asa.hostel_id AND at.id=ah.accomodation_type_id";
    $res5 = db_query($qry5, $result->student_id);
    $result_accomodation = db_fetch_object($res5);
    $return['hostel_name'] = $result_accomodation->name;
    $return['hostel_type'] = $result_accomodation->type;


    $qry6 = "SELECT sum(at.trans_amount) AS total_amount FROM admitted_transaction at, session s WHERE
    at.student_id = %d AND at.session_id = s.session_id AND s.sess_name = '%s'";
    $res6 = db_query($qry6, $result->student_id, variable_get('veritas_current_session', ''));
    $result_session_payment = db_fetch_object($res6);
    $debtor_acceptance = 100000;
    $debtor_accomodation = str_replace(',', '', $result_accomodation->cost);
    $debtor_tuition = 150000;
    $debtor_others = ($result_accomodation->college_id == 1) ? 45000 : 50000;
    $total_debt = $debtor_acceptance + $debtor_accomodation + $debtor_tuition + $debtor_others;
    $total_paid = $result_session_payment->total_amount;

    if ($total_paid <= $debtor_acceptance):
      $debtor_acceptance -= $total_paid;
    elseif ($total_paid <= ($debtor_acceptance + $debtor_accomodation) && $total_paid > $debtor_acceptance):
      $debtor_acceptance = 0;
      $debtor_accomodation = ($debtor_acceptance + $debtor_accomodation) - $total_paid;
    elseif ($total_paid <= ($debtor_acceptance + $debtor_accomodation + $debtor_tuition) && $total_paid > ($debtor_acceptance + $debtor_accomodation)):
      $debtor_acceptance = $debtor_accomodation = 0;
      $debtor_tuition = ($debtor_acceptance + $debtor_accomodation + $debtor_tuition) - $total_paid;
    elseif ($total_paid <= ($debtor_acceptance + $debtor_accomodation + $debtor_tuition + $debtor_others) && $total_paid > ($debtor_acceptance + $debtor_accomodation + $debtor_tuition)):
      $debtor_acceptance = $debtor_accomodation = $debtor_tuition = 0;
      $debtor_others = ($debtor_acceptance + $debtor_accomodation + $debtor_tuition + $debtor_others) - $total_paid;
    else:
      $debtor_acceptance = $debtor_accomodation = $debtor_tuition = $debtor_others = 0;
    endif;

    $total_session_payable = $debtor_acceptance + $debtor_tuition + $debtor_accomodation + $debt_others;

    // Calculate total amount owed from previous sessions omitting current session
    // this is going to be a problem subsequently when payment fees change
    $qry7 = "SELECT s.sess_name, SUM(at.trans_amount) AS total FROM admitted_transaction at, session s, session s2 WHERE at.student_id=%d AND at.session_id=s.session_id AND at.session_id != s2.session_id AND s2.sess_name='%s' GROUP BY at.session_id";
    $res7 = db_query($qry7, $result->student_id, variable_get('veritas_current_session', ''));
    $total_outstanding_previous_sessions = 0;
    while ($result_payment = db_fetch_array($res7)):
      $total_outstanding_previous_sessions += ($total_debt - $result_payment['total']);
    endwhile;
    $return['debtor_acceptance'] = $debtor_acceptance;
    $return['debtor_accomodation'] = $debtor_accomodation;
    $return['debtor_tuition'] = $debtor_tuition;
    $return['debtor_others'] = $debtor_others;
    $return['total_session_paid'] = $total_paid;
    $return['total_session_payable'] = $total_session_payable;
    $return['total_outstanding_payable'] = $total_outstanding_previous_sessions;
  endif;

  return $return;
}

function download_student_payments() {
  // This function provides a means to download all payment data for students
  $q = "SELECT student_id FROM {admitted_student}";
  $rs = db_query($q);

  header('Content-Type: text/csv');
  header('Content-Disposition: attachment;filename=payments.csv');

  echo "firstname,middlename,lastname,course_of_study,year_of_study,college,hostel,space_type,birth_date,gender,marital_status,";
  echo "state_of_origin,student_telephone,student_email,sponsor_name,sponsor_address,sponsor_tel,sponsor_mobile,matriculation_no,jamb_no,";
  echo "debtor_tuition,debtor_accomodation,debtor_others,total_session_debt,total_outstanding_debt,grand_total_debt\n";

  while ($student_row = db_fetch_array($rs)):
    $spd = student_payment_data($student_row['student_id']);
    $output = sprintf("\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",%f,%f,%f,%f,%f,%f",
      $spd['first_name'],
      $spd['middle_name'],
      $spd['last_name'],
      $spd['admission_programme'],
      $spd['admission_year_of_study'],
      $spd['admission_college'],
      $spd['hostel_name'],
      $spd['hostel_type'],
      $spd['birth_date'],
      $spd['gender'],
      $spd['marital_status'],
      $spd['state_of_origin'],
      $spd['personal_mobile'],
      $spd['personal_email'],
      $spd['sponsor_name'],
      $spd['sponsor_address'],
      $spd['sponsor_tel'],
      $spd['sponsor_mobile'],
      $spd['matriculation_no'],
      $spd['jamb_no'],
      $spd['debtor_tuition'],
      $spd['debtor_accomodation'],
      $spd['debtor_others'],
      $spd['total_session_payable'],
      $spd['total_outstanding_payable'],
      $spd['total_session_payable'] + $spd['total_outstanding_payable']);
    echo $output . "\n";
  endwhile;
}
