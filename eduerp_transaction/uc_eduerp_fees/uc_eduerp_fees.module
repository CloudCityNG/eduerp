<?php 

/**
 * @file
 * Ubercart integration of EduERP fees
 */ 

/**
 * Add fees object to cart
 * 
 */ 
function uc_eduerp_fees_add_to_cart($fees) {
	
	$fees = module_invoke_all('uc_eduerp_fees_eduerp_fees');
	//(object)$fees = uc_eduerp_fees_fees();
	
	$type = $fees->type;
	// get the fees description
	
	// get the fees type name e.g Full Fees or First Installment or Second installment
	
	// test to know if the fees is paid for or not.
	
	// if the type of fees is second installment, test to see if first installment has 
	// been paid. If yes, add only the second installment to cart. If no, return NULL
	if($fees->type == $fees[2]){ // assuming $fees[2] holds for second installment
		// test if $fees[1] is paid for
		// if FALSE
		// $fees = NULL;
		// return NULL;
	}
	
	$data = $fees['data']; // All other fee setup values as data, both for Fees and hostel
	
	$added = FALSE;
	if(!empty($fees)) {
		foreach($fees as $fee) {
			// With this we are going to have 2 items in cart; fees and hostel
			uc_cart_add_item($fee->nid, $qty = 1, $data, $cid = NULL, $msg = TRUE, $check_redirect = TRUE, $rebuild = TRUE);
		}
		$added = TRUE;
	}
	if($added) {
		drupal_goto("cart");
	}
	return $added;
}

/**
 * Implementation of hook_eduerp_fees
 * 
 * Fees with all necessary setup information included
 * Describes the fees structure.
 * 
 * @return 
 * 	- $fees: The Fees object including it's type, setup
 */ 
function uc_eduerp_fees_eduerp_fees($fees) {
	$global $user;
	
	$fees = array();
	
	$type = ''; // Full Fees or First Installment or Second installment
	$uid = user_load($user);
	$fees_item = get_fees_items($uid);
	
	$fees['fees'] = array(
		'item' => $fees_item,
		'description' => t('Selected fees description'),
		'options' => $fees_item['options']
	);
	$fees['hostel'] = array(
		'item' => get_hostel_fees($uid),
		'description' => t('Hostel fees description'),
	);
	return $fees;
}

/**
 * Hook to define fees_structure
 * 
 * @param $fees
 * 	- The fees
 */ 
function uc_eduerp_fees_eduerp_fees_hook($fees) {
  foreach (module_implements('eduerp_fees') as $module) {
    $function = $module . '_eduerp_fees';
    $function($fees);
  }
  return $fees;
}

/**
 * All paid fees items
 * 
 */ 
function uc_eduerp_fees_paid_items() {
	
}